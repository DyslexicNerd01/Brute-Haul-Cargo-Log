
  <!-- Admin Lock Icon (top right) -->
  <div id="adminLockContainer" style="position:fixed;top:24px;right:3vw;z-index:1000;">
    <button id="adminLockBtn" title="Admin Login" style="background:transparent;border:none;cursor:pointer;padding:0;outline:none;">
      <svg width="38" height="38" viewBox="0 0 24 24" fill="none" stroke="#781d15" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
    </button>
  </div>

  <!-- Admin Requests Modal -->
  <div id="adminRequestsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:2000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:12px;max-width:800px;width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.18);position:relative;">
      <button id="closeAdminModal" style="position:absolute;top:12px;right:12px;background:transparent;border:none;font-size:1.8em;color:#781d15;cursor:pointer;">&times;</button>
      <h2 style="color:#781d15;margin-top:0;">Admin: Transport Requests</h2>
      <div id="adminRequestsContent" style="margin-top:18px;min-height:60px;"></div>
    </div>
  </div>
  <script>
  // Admin lock icon logic
  const adminLockBtn = document.getElementById('adminLockBtn');
  const adminModal = document.getElementById('adminRequestsModal');
  const closeAdminModal = document.getElementById('closeAdminModal');
  const adminContent = document.getElementById('adminRequestsContent');
  adminLockBtn.addEventListener('click', function() {
    const password = prompt('Enter admin password to view transport requests:');
    if (!password) return;
    // Try to check password with server, but allow offline login
    let offlineAuthed = false;
    const allowOffline = (password === 'password');
    fetch('/cgi-bin/list_requests.py', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'password=' + encodeURIComponent(password)
    })
    .then(async r => {
      let data;
      try { data = await r.json(); } catch (e) { data = null; }
      if (Array.isArray(data) || (data && Array.isArray(data.requests))) {
        sessionStorage.setItem('adminAuthed', '1');
        window.location.href = 'admin_requests.html';
      } else if (data && data.error) {
        if (allowOffline) {
          sessionStorage.setItem('adminAuthed', '1');
          window.location.href = 'admin_requests.html';
        } else {
          alert('Access denied: ' + data.error);
        }
      } else {
        if (allowOffline) {
          sessionStorage.setItem('adminAuthed', '1');
          window.location.href = 'admin_requests.html';
        } else {
          alert('Access denied.');
        }
      }
    })
    .catch(() => {
      if (allowOffline) {
        sessionStorage.setItem('adminAuthed', '1');
        window.location.href = 'admin_requests.html';
      } else {
        alert('Access denied or error connecting to server.');
      }
    });
  });
  closeAdminModal.addEventListener('click', function() {
    adminModal.style.display = 'none';
    adminContent.innerHTML = '';
  });
  window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      adminModal.style.display = 'none';
      adminContent.innerHTML = '';
    }
  });
  </script>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brute Haul Online Documentation System</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #e2e2e2 0%, #d0d0d0 100%);
      color: #230e09;
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
    }

    .main-container {
      max-width: 95%;
      width: 100%;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      padding: 0 20px;
    }

    .page-header {
      background: linear-gradient(135deg, #781d15 0%, #5a1510 100%);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      margin-bottom: 8px;
    }

    .page-header h1 {
      color: #e2e2e2;
      margin: 0;
      font-size: 2.5em;
      font-weight: 300;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      margin-bottom: 24px;
      width: 100%;
    }

    .card {
      background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(157, 117, 35, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 24px;
    }

    .card.form-step {
      margin-bottom: 24px;
    }
    
    #navigationCard {
      margin-bottom: 24px;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #9d7523;
    }

    .card-header h2 {
      color: #781d15;
      margin: 0;
      font-size: 1.4em;
      font-weight: 600;
    }

    .card-icon {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      background: #9d7523;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .icon {
      font-size: 24px;
      margin-right: 12px;
      display: inline-block;
      font-style: normal;
    }

    form {
      background: transparent;
      border-radius: 0;
      padding: 0;
    }
    textarea {
      width: 100%;
      height: 400px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    #notes {
      height: 80px;
      width: 100%;
      resize: vertical;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      color: #9d7523;
    }
    input, select, textarea {
      margin-bottom: 10px;
      width: 100%;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .section {
      margin-top: 0;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: 0;
    }

    .form-step {
      margin-bottom: 0;
    }

    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 200px;
      width: 100%;
      background: transparent;
      border-radius: 8px;
    }
    input[type="number"] {
      width: 120px;
      padding: 5px;
      font-size: 1.1em;
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    #crewAmount {
      width: 60px;
      font-size: 1em;
      padding: 3px;
      display: inline-block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .other-div {
      display: none;
      margin-left: 30px;
    }
    .other-div label {
      font-weight: bold;
      color: #9d7523;
      margin-top: 10px;
      display: block;
    }
    .other-div input {
      font-size: 0.95em;
      width: 60%;
      color: #230e09;
      background: #e2e2e2;
      border: 1px solid #781d15;
      margin-bottom: 10px;
    }
    .other-input {
      width: 85%;
      max-width: 360px;
      box-sizing: border-box;
      font-size: 0.95em;
      color: #230e09;
      background: #e2e2e2;
      border: 1px solid #781d15;
      margin-top: 8px;
      margin-left: 0px;
      padding: 8px 10px;
      border-radius: 6px;
      display: none;
    }
    .crew-label {
      display: block;
      margin-left: 30px;
      font-size: 0.95em;
      margin-top: 5px;
      color: #9d7523;
      font-weight: bold;
    }
    .crew-input {
      display: block;
      width: 60%;
      font-size: 0.95em;
      margin-left: 30px;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .deductible-input {
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .error {
      border: 2px solid #9d7523 !important;
      background: #b32428 !important;
    }
    select.error option[value=""] {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error:focus {
      background: #e2e2e2 !important;
      color: #230e09 !important;
    }
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .route-arrow {
      font-weight: bold;
      color: #230e09;
      font-size: 1.2em;
      padding: 0 8px;
    }
    button {
      background: #5865F2;
      color: #fff;
      border: none;
      padding: 10px 24px 10px 16px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      background: #404EED;
      color: #fff;
      border: 1px solid #9d7523;
    }
    .discord-btn-logo {
      height: 1.6em;
      width: auto;
      vertical-align: middle;
      filter: invert(1);
    }
    /* Global h1 reset removed to avoid interfering with page header; use .page-header h1 for header styling */
    .manifest-row label {
      margin: 0;
      font-weight: normal;
      color: #230e09;
      min-width: 60px;
    }
    .manifest-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .manifest-row input,
    .manifest-row select {
      width: auto;
      margin-bottom: 0;
    }
    .manifest-row .manifest-material {
      box-sizing: border-box;
    }
    .manifest-row .manifest-scu {
      width: 60px;
      min-width: 50px;
    }
    .manifest-row .manifest-uec {
      width: 70px;
      min-width: 60px;
    }
    .manifest-btn {
      font-size: 1em;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
      margin-right: 0;
      transition: background 0.2s;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 0;
    }
    .manifest-btn.add {
      background: #43b581;
      color: #fff;
    }
    .manifest-btn.add:hover {
      background: #2ea964;
    }
    .manifest-btn.remove {
      background: #ed4245;
      color: #fff;
    }
    .manifest-btn.remove:hover {
      background: #b32428;
    }
    .manifest-total-box {
      display: flex;
      gap: 24px;
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: bold;
      color: #230e09;
      background: #f8f6f2;
      border: 2px solid #9d7523;
      border-radius: 8px;
      padding: 12px;
      align-items: center;
      justify-content: flex-start;
    }
    .resource-preset-btn {
      background: #9d7523;
      color: #fff;
      border: none;
      padding: 6px 14px;
      font-size: 11px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
      white-space: nowrap;
      transition: background 0.2s;
      display: inline-block;
    }
    .resource-preset-btn.selected {
      background: #43b581 !important;
      color: #fff !important;
    }
    .resource-preset-btn:hover {
      background: #bfa14d;
      color: #fff;
    }
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4245;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
    }
    .tab-button-container {
      position: relative;
      display: contents;
    }

    .searchable-dropdown {
      position: relative;
      width: 100%;
    }
    .searchable-dropdown input {
      width: 100%;
      padding: 8px;
      border: 1px solid #781d15;
      background: #e2e2e2;
      color: #230e09;
      border-radius: 4px;
      box-sizing: border-box;
      min-height: 36px;
    }
    .searchable-dropdown .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #e2e2e2;
      border: 1px solid #781d15;
      border-top: none;
      max-height: 180px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .searchable-dropdown .dropdown-list.show {
      display: block;
    }
    .searchable-dropdown .dropdown-item {
      padding: 6px 8px;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
      background: #e2e2e2;
      color: #230e09;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .searchable-dropdown .dropdown-item:hover {
      background: #d0d0d0;
    }
    .searchable-dropdown .dropdown-item.selected {
      background: #781d15;
      color: #e2e2e2;
    }
    .searchable-dropdown .dropdown-item:last-child {
      border-bottom: none;
    }
    .searchable-dropdown .dropdown-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      transform: none;
      vertical-align: middle;
      pointer-events: auto;
      -webkit-appearance: checkbox;
      appearance: checkbox;
    }
    .checkbox-dropdown .dropdown-toggle:after {
      content: "▼";
      font-size: 12px;
    }
    .checkbox-dropdown .checkbox-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #e2e2e2;
      border: 1px solid #781d15;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .checkbox-dropdown .checkbox-list.show {
      display: block;
    }
    .checkbox-dropdown .checkbox-item {
      padding: 8px 12px;
      border-bottom: 1px solid #ccc;
      background: #e2e2e2;
      color: #230e09;
      font-size: 14px;
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .checkbox-dropdown .checkbox-item:hover {
      background: #d0d0d0;
    }
    .checkbox-dropdown .checkbox-item:last-child {
      border-bottom: none;
    }
    .checkbox-dropdown .checkbox-item input[type="checkbox"] {
      margin-right: 8px;
      width: auto;
      height: auto;
      pointer-events: none;
    }
    .checkbox-dropdown .checkbox-item label {
      cursor: pointer;
      margin: 0;
      flex: 1;
      pointer-events: none;
    }
    .checkbox-dropdown .dropdown-toggle.error {
      border-color: #ed4245;
      background: #fee;
    }
    
    .security-ship-captains {
      margin-top: 12px;
    }
    .security-captain-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 8px;
      background: #f8f6f2;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .security-captain-row label {
      font-weight: 600;
      min-width: 150px;
      margin: 0;
    }
    .security-captain-row .searchable-dropdown {
      flex: 1;
    }
    
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .route-row .searchable-dropdown {
      flex: 1;
    }

    #historyViewerTab {
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
      box-sizing: border-box;
    }
    
    .main-content-wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      align-items: start;
    }
    
    .form-column {
      min-width: 0;
      width: 100%;
    }
    
    .announcements-sidebar {
      position: static;
      height: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .announcements-sidebar .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .announcements-sidebar .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    @media (max-width: 1200px) {
      .main-content-wrapper {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(35, 14, 9, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }

    .loading-content {
      background: #781d15;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      color: #e2e2e2;
      border: 2px solid #9d7523;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: relative;
    }

    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: #e2e2e2;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
  width: 22px;
  height: 22px;
  margin-left: 4px;
  margin-right: 1px;
  font-size: 0.95em;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s, color 0.2s;
    }

    .close-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
      color: #ffffff;
    }

    .close-button:active {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .datetime-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    input[type="datetime-local"] {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      flex: 1;
      box-sizing: border-box;
      line-height: 1.2;
    }

    .time-now-btn {
      background: linear-gradient(135deg, #9d7523 0%, #8a6b1f 100%);
      color: #ffffff;
      border: 2px solid transparent;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      transition: all 0.2s ease;
      white-space: nowrap;
      box-sizing: border-box;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      line-height: 1.2;
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(16.8px + 20px + 4px);
      align-self: flex-start;
      margin-top: 3px;
    }

    .time-now-btn:hover {
      background: #b88629;
      color: #ffffff;
      transform: translateY(-1px);
    }

    .time-now-btn:active {
      background: #8a6b1f;
      transform: translateY(0);
    }

    @media (min-width: 481px) {
      #tr_cargoDetails {
        height: min(50vh, 420px);
        resize: vertical;
        overflow: auto;
        max-width: 100%;
        box-sizing: border-box;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        word-break: break-word;
      }
    }
    @media (max-width: 480px) {
      #tr_cargoDetails {
        height: 90px;
        resize: vertical;
      }
    }

    input, select, textarea {
      border: 2px solid #781d15;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.12s ease;
      background: #e2e2e2;
      color: #230e09;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    input:focus, select:focus, textarea:focus {
      border-color: #9d7523;
      outline: none;
      box-shadow: 0 0 0 3px rgba(157, 117, 35, 0.1);
      transform: translateY(-1px);
    }

    input:hover, select:hover, textarea:hover {
      border-color: #c4a140;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    label {
      font-weight: 600;
      color: #781d15;
      margin-bottom: 8px;
      font-size: 14px;
    }

    button {
      background: linear-gradient(135deg, #9d7523 0%, #8a6b1f 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(157, 117, 35, 0.3);
    }

    button:hover {
      background: linear-gradient(135deg, #b88629 0%, #9d7523 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(157, 117, 35, 0.4);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(157, 117, 35, 0.3);
    }

    .primary-btn {
      background: linear-gradient(135deg, #781d15 0%, #5a1510 100%);
      font-size: 16px;
      padding: 16px 32px;
      box-shadow: 0 6px 16px rgba(120, 29, 21, 0.3);
    }

    .primary-btn:hover {
      background: linear-gradient(135deg, #8a2419 0%, #6b1914 100%);
      box-shadow: 0 8px 20px rgba(120, 29, 21, 0.4);
    }

    .loading-spinner-large {
      width: 40px;
      height: 40px;
      border: 4px solid #9d7523;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto 16px auto;
    }

    .progress-bar-container {
      background: #e2e2e2;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #9d7523;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ccc;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #43b581, #9d7523);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      font-size: 14px;
      color: #230e09;
      font-weight: bold;
      text-align: center;
    }

    .button-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .success-feedback {
      background: #43b581;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    .error-feedback {
      background: #ed4245;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-step {
      transition: border-left 0.3s ease, padding-left 0.3s ease;
    }

    .form-step.active {
      border-left: 4px solid #9d7523;
      padding-left: 16px;
    }

    .form-step.completed {
      border-left: 4px solid #43b581;
      padding-left: 16px;
    }

    @media (max-width: 1200px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .main-container {
        max-width: 900px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .page-header {
        padding: 20px;
      }
      
      .page-header h1 {
        font-size: 2em;
      }
      
      .card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .card.form-step {
        margin-bottom: 20px;
      }
      
      .form-grid {
        gap: 20px;
        grid-template-columns: 1fr;
      }
      
      input, select, textarea {
        padding: 10px 12px;
      }
      
      button {
        padding: 10px 20px;
      }
      
      .primary-btn {
        padding: 14px 28px;
      }
    }

    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.6em;
      }
      
      .card {
        padding: 16px;
      }
      
      .card-header h2 {
        font-size: 1.2em;
      }
    }
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #formTab {
      display: block;
    }
    
    #historyViewerTab {
      display: none;
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      position: relative !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      z-index: 1000 !important;
      overflow: visible;
    }
    
    #historyViewerTab.active {
      display: block !important;
    }
    
    #historyList {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      overflow: visible;
    }
    
    #discordOutputContainer {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    #toggleOutputBtn {
      transition: all 0.2s ease;
    }
    
    #toggleOutputBtn:hover {
      background: #7d6a1e !important;
      transform: translateY(-1px);
    }
    
    #toggleOutputIcon {
      transition: transform 0.2s ease;
      font-size: 12px;
      display: inline-block;
    }
    .priority-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      color: #fff;
      font-weight: 700;
      font-size: 0.85em;
      line-height: 1;
      vertical-align: middle;
    }
    .prio-Emergency { background: #b32428; }
    .prio-High { background: #d96b2f; }
    .prio-Medium { background: #f0ad4e; color: #230e09; }
    .prio-Low { background: #28a745; }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      color: #fff;
      font-weight: 700;
      font-size: 0.85em;
      line-height: 1;
      vertical-align: middle;
      margin-left: 6px;
    }
    .status-New { background: #00bcd4; }
    .status-Assigned { background: #f0ad4e; }
    .status-Completed { background: #28a745; }
    .status-Declined { background: #8b0000; }
    /* Assignment modal styles */
    .assignment-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20000;
      padding: 12px;
      box-sizing: border-box;
    }
    .assignment-modal-panel {
      background: #fff;
      padding: 14px;
      border-radius: 10px;
      width: 520px;
      max-width: calc(100% - 40px);
      max-height: 80vh;
      overflow-y: auto;
      box-sizing: border-box;
    }
    @media (min-width: 1000px) {
      .assignment-modal-panel { width: 720px; }
    }
      /* Keep modal a reasonable fixed width (520px) to avoid overly wide popups */
    .assignment-modal-panel h3 { margin-top: 0; margin-bottom: 8px; }
    .assignment-modal-panel .searchable-dropdown { margin-top: 6px; }
    .assignment-modal-panel .dropdown-list {
      max-height: 40vh;
      overflow-y: auto;
      z-index: 21000;
    }
    /* Hide scrollbar for the modal panel itself, but allow visible scrollbars for dropdowns and crew lists */
    .assignment-modal-panel {
      -ms-overflow-style: none; /* IE 10+ */
      scrollbar-width: none; /* Firefox */
    }
    .assignment-modal-panel::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    /* Allow visible scrollbars for dropdown lists */
    .assignment-modal-panel .dropdown-list {
      -ms-overflow-style: auto;
      scrollbar-width: auto;
    }
    .assignment-modal-panel .dropdown-list::-webkit-scrollbar { width: 10px; height: 10px; }
    .assignment-modal-panel .dropdown-list::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.16); border-radius: 6px; }

    /* Crew names container: allow scrolling with visible scrollbar when long */
    .assignment-modal-panel [id^="assign_crew_names_"] {
      max-height: 40vh;
      overflow-y: auto;
      -ms-overflow-style: auto;
      scrollbar-width: auto;
    }
    .assignment-modal-panel [id^="assign_crew_names_"]::-webkit-scrollbar { width: 10px; }
    .assignment-modal-panel [id^="assign_crew_names_"]::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.16); border-radius: 6px; }
    .assignment-modal-panel input[type="text"], .assignment-modal-panel input[type="number"], .assignment-modal-panel .searchable-dropdown input {
      width: 100%;
      box-sizing: border-box;
      max-width: 100%;
    }
    .assignment-modal-panel .searchable-dropdown { position: relative; }
    .assignment-modal-panel .dropdown-list { left: 0; right: 0; }
  </style>
  <script>
  // Complete list of all Star Citizen universe locations (inlined from locations.js)
  const locations = [
    // === NUMERICAL & SPECIAL CHARACTERS ===
    "2930-CRU983",
  "78 Leonis (star)",
  // === MAJOR LANDING ZONES & TRADING HUBS ===
  "Aaron Halo",
  "Aberdeen",
  "Abyss",
  "Adir",
  "Adira Falls",
  "Administration Office",
  "Aemilia",
  "Aero",
  "Afterlife",
  "Ail'ka (star)",
  "Ail'ka - Kyuk'ya",
  "Ail'ka - T.āl",
  "Ail'ka - Yā'mon",
  "Ail'ka Belt Alpha",
  "Ail'ka Belt Beta",
  "Akiro Cluster",
  "Ako's Return",
  "Ambitious Dream Station",
  "Angeli",
  "Anóna",
  "ArcCorp Mining Area 022",
  "ArcCorp Mining Area 045",
  "ArcCorp Mining Area 048",
  "ArcCorp Mining Area 056",
  "ArcCorp Mining Area 061",
  "ArcCorp Mining Area 073",
  "ArcCorp Mining Area 141",
  "ArcCorp Mining Area 157",
  "ArcCorp Processing Center 115",
  "ArcCorp Processing Center 123",
  "Archangel Station",
  "Archibald Station",
  "Archon Base",
  "Area04",
  "Area06",
  "Area11",
  "Area17",
  "Area18",
  "Area20",
  "Aremis",
  "Arial",
  "Arid Reach",
  "Ariel",
  "Armitage (planet)",
  "Ashburn Channel Aid Shelter",
  "Ashana",
  "Ashland",
  "Aston Ridge Aid Shelter",
  "Aspire Grand",
  "Astor's Clearing",
  "Asura",
  "Attritus OLP",
  "Attritus PAF-I",
  "Attritus PAF-II",
  "Attritus PAF-III",
  "August Dunlow Spaceport",
  "Aydo",
  // === B LOCATIONS ===
  "Bacchus - Garron",
  "Bacchus - Geddon", 
  "Bacchus A",
  "Bacchus B",
  "Bacchus Belt Alpha",
  "Bacchus Flotilla",
  "Bacchus I",
  "Bacchus II",
  "Bacchus III",
  "Baijini Point",
  "Baker - Kiel",
  "Baker - Osiris",
  "Baker - Tayac",
  "Baker - Th.us'ūng",
  "Baker - Yā'mon",
  "Baker A",
  "Baker B",
  "Baker I",
  "Baker II",
  "Baker III",
  "Baker IV",
  "Balto's Blind",
  "Banshee (star)",
  "Banshee - Fora",
  "Banshee - Garron",
  "Banshee - Leir",
  "Banshee - Tamsa",
  "Banshee - Yulin",
  "Banshee I",
  "Banshee II",
  "Banshee IV",
  "Banu Station",
  "Bareton",
  "Barton Flats Aid Shelter",
  "Benny Henge",
  "Bennyhenge",
  "Benson Mining Outpost",
  "Bevic Convention Center",
  "Blackrock Exchange",
  "Blighter's Run",
  "Bloodshot Ridge",
  "Bloom",
  "Bombora",
  "Boondoggle",
  "Borea",
  "Bountiful Harvest Hydroponics",
  "Branaugh (star)",
  "Branaugh - Chronos",
  "Branaugh Belt Alpha",
  "Branaugh I",
  "Branaugh II", 
  "Branaugh III",
  "Bremen (star)",
  "Bremen - Kallis",
  "Bremen - Nyx",
  "Bremen - Tanga",
  "Bremen - Vega",
  "Bremen I",
  "Bremen III",
  "Bremen IV",
  "Brentworth Care Center",
  "Brio's Breaker Yard",
  "Broken Moon",
  "Broken Patch",
  "Bruder",
  "Buckets",
  "Bud's Growery",
  "Bueno Ravine",
  "Bullock's Reach",
  "Buloi Sataball Arena",
  "Burnout",
  // === C LOCATIONS ===
  "Café Musain",
  "Calhoun Pass Emergency Shelter",
  "Caliban (star)",
  "Caliban - Nul",
  "Caliban - Oberon",
  "Caliban - Orion", 
  "Caliban - Viking",
  "Caliban 2a",
  "Caliban 3a",
  "Caliban 3b",
  "Caliban 4a",
  "Caliban 4b",
  "Caliban 4c",
  "Caliban 4d",
  "Caliban 4e",
  "Caliban 4f",
  "Caliban Belt Alpha",
  "Caliban I",
  "Caliban III",
  "Caliban IV",
  "Caliban V",
  "Calliope",
  "Callisto",
  "Canard View",
  "Cano (star)",
  "Cano - Davien",
  "Cano - Pyro",
  "Cano Belt Alpha", 
  "Cano I",
  "Cano III",
  "Cano IV",
  "Caplan Circuit",
  "Carteyna",
  "Carteyna City",
  "Carver's Ridge",
  "Cascom",
  "Cassel",
  "Casselean",
  "Castor",
  "Castra (star)",
  "Castra - Hadrian",
  "Castra - Nyx",
  "Castra - Oso",
  "Castra - Oya",
  "Castra - Pyro",
  "Castra I",
  "Cathcart (star)",
  "Cathcart - Davien",
  "Cathcart - Hades",
  "Cathcart - Kilian",
  "Cathcart - Nexus",
  "Cathcart Belt Alpha",
  "Cellin",
  "Centauri (star)",
  "Centauri - Elysium",
  "Centauri - Nul",
  "Centauri Belt Alpha",
  "Centauri I",
  "Centauri IV",
  "Centauri V",
  "Central Business District (Lorville)",
  "Cestulus",
  "Char",
  "Charon (moon)",
  "Charon (star)",
  "Charon - Genesis",
  "Charon - Helios",
  "Charon - Kins",
  "Charon - Tyrol",
  "Chawla's Beach",
  "Checkmate Station",
  "Chronos (star)",
  "Chronos - Branaugh",
  "Chronos - Kellog",
  "Chronos - Kiel",
  "Chronos Belt Alpha",
  "Chronos I",
  "Chronos II",
  "Chronos III",
  "Clear View Emergency Shelter",
  "Cloudrest Retreat",
  "Cloudview Center",
  "Comm Array 042",
  "Comm Array 126",
  "Comm Array 275",
  "Comm Array 306",
  "Comm Array 472",
  "Comm Array 556",
  "Comm Array 625",
  "Comm Array 730",
  "Comm Array 849",
  "Comm Array ST1-02",
  "Comm Array ST1-13",
  "Comm Array ST1-48",
  "Comm Array ST1-61",
  "Comm Array ST1-92",
  "Comm Array ST2-28",
  "Comm Array ST2-47",
  "Comm Array ST2-55",
  "Comm Array ST2-76",
  "Comm Array ST3-18",
  "Comm Array ST3-35",
  "Comm Array ST3-90",
  "Comm Array ST4-22",
  "Comm Array ST4-31",
  "Comm Array ST4-59",
  "Comm Array ST4-64",
  "Commarray SCC",
  "Conscientious Objects",
  "Cordry's",
  "Corilla",
  "Connor's",
  "Consumption",
  "Covalex Distribution Centre S1DC06",
  "Covalex Distribution Centre S4DC05",
  "Covalex Hub Gallete",
  "Covalex Hub Gundo",
  "Covalex Hub Lagrange",
  "Covalex Hub Laskowski",
  "Covalex Hub O'Neill",
  "Covalex Hub Reilly",
  "Covalex Hub Sutter",
  "Covalex Hub Tompkins",
  "Covalex Hub Wightman",
  "Covalex Hub Xenia",
  "Covalex Hub Young",
  "Covalex Hub Ziegler",
  "Coven",
  "Cry-Astro Service 042",
  "Cry-Astro Service 151",
  "Cry-Astro Service 262",
  "Cry-Astro Plant CRY-B01",
  "Cry-Astro Plant CRY-B02",
  "Cry-Astro Plant CRY-B11",
  "Cry-Astro Plant CRY-B16",
  "Cubby Blast",
  "Cygnus",
  // === D LOCATIONS ===
  "Davien (star)",
  "Davien - Cano",
  "Davien - Cathcart",
  "Davien - Sol",
  "Davien - Croshaw",
  "Davien Belt Alpha",
  "Davien I",
  "Davien II",
  "Davien III",
  "Davien IV",
  "Daymar",
  "Deakins Research Outpost",
  "Deimos",
  "Delamar",
  "Dell Township",
  "Desmond Memorial Convention Center",
  "Devlin Scrap & Salvage",
  "Dinger's Depot",
  "Dobbs",
  "Downlow",
  "Drifters",
  "Dunboro",
  "Dunlow Ridge Emergency Shelter",
  "Dupree Storage Depot A",
  "Dupree Storage Depot B",
  "Dupree Storage Depot C",
  "Dupree Storage Depot D",
  "Dupree Storage Depot E",
  "Dupree Storage Depot F",
  "Dupree Storage Template",
  // === E LOCATIONS ===
  "Eager Flats Aid Shelter",
  "Eealus (star)",
  "Eealus - La'uo",
  "Eealus - Trise",
  "Ellis (star)",
  "Ellis - Goss",
  "Ellis - Nexus",
  "Ellis - Tayac",
  "Ellis Belt Alpha",
  "Ellis Belt Beta",
  "Ellis I",
  "Ellis II",
  "Ellis III",
  "Ellis IV",
  "Ellis V",
  "Ellis VI",
  "Ellis VII",
  "Ellis VIII",
  "Ellis IX",
  "Ellis X",
  "Ellis XI",
  "Ellis XII",
  "Elsewhere",
  "Earth",
  "Elysium (star)",
  "Elysium - Centauri",
  "Elysium - Ferron",
  "Elysium Belt Alpha",
  "Elysium I",
  "Elysium II",
  "Elysium III",
  "Elysium IV",
  "Empyrean Park",
  "Encole Station",
  "Empire Health Services",
  "Europa",
  "Everus Harbor",
  // === F LOCATIONS ===
  "Fallow Field",
  "Farro Data Center Alpha",
  "Farro Data Center I",
  "Farro Data Center II",
  "Farro Data Center III",
  "Farro Data Center IV",
  "Farro Data Center V",
  "Farro Data Center VI",
  "Farro Data Center VII",
  "Farro Data Center VIII",
  "Farro Data Center IX",
  "Farro Data Center X",
  "FEO Canyon Depot",
  "Ferron (star)",
  "Ferron - Elysium",
  "Ferron - Osiris",
  "Ferron Belt Alpha",
  "Ferron I",
  "Ferron II",
  "Ferron III",
  "Ferron IV",
  "Fetch",
  "Finn's Folly",
  "Fora (star)",
  "Fora - Banshee",
  "Fora - Garron",
  "Fora - Hades",
  "Fora - Leir",
  "Fora - Tamsa",
  "Fora Belt Alpha",
  "Fora I",
  "Fora II",
  "Fora III",
  "Frigid Knot",
  "Frostbite (settlement)",
  // === G LOCATIONS ===  
  "G-Loc Bar",
  "Gallete Family Farms",
  "Ganymede",
  "Garron (star)",
  "Garron - Bacchus",
  "Garron - Banshee",
  "Garron - Fora",
  "Garron - Hades",
  "Garron - Kins",
  "Garron - Tyrol",
  "Garron Belt Alpha",
  "Garron I",
  "Garron II",
  "Garron III",
  "Garron IV",
  "Geddon (star)",
  "Geddon - Bacchus",
  "Geddon - Hades",
  "Geddon Belt Alpha",
  "Geddon I",
  "Geddon II",
  "Genesis (star)",
  "Genesis - Charon",
  "Genesis - Hadrian",
  "Genesis Belt Alpha",
  "Genesis I",
  "Genesis II",
  "Ghost Hollow",
  "GIO",
  "Goner's Deal",
  "Gonzo",
  "Good Times Temple",
  "Goss (star)",
  "Goss - Ellis",
  "Goss - Tayac",
  "Goss - Tyrol",
  "Goss Belt Alpha",
  "Goss I",
  "Goss II",
  "Goss III",
  "Grand Barter Bazaar",
  "Gray Gardens",
  "Green Imperial Medical",
  "Greencircle Habitation",
  "Grim HEX",
  "Greycat Pomeroy",
  "Greycat Roc",
  "Greycat Stanton",
  // === H LOCATIONS ===
  "Hades (star)",
  "Hades - Cathcart",
  "Hades - Fora",
  "Hades - Garron",
  "Hades - Geddon",
  "Hades - Kins",
  "Hades - Oberon",
  "Hades - Orion",
  "Hades Belt Alpha",
  "Hades I",
  "Hades II",
  "Hades III",
  "HDMS Chameleon",
  "HDMS Edmond",
  "HDMS Hahn",
  "HDMS Norgay",
  "HDMS Oparei",
  "HDMS Ryder",
  "HDMS Stanhope",
  "HDPC Fissure Pack Station",
  "HDPC Racquel Research Outpost",
  "HDSF Ason",
  "HDSF Stanhope",
  "Hadrian (star)",
  "Hadrian - Castra",
  "Hadrian - Genesis",
  "Hadrian - Oberon",
  "Hadrian Belt Alpha",
  "Hadrian I",
  "Hadrian II",
  "Hadrian III",
  "Half Stack",
  "Hard Knocks",
  "Harper's Point",
  "Hasbin Hall",
  "Haven",
  "Haven Food Cluster",
  "Hela's Regret",
  "Helios (star)",
  "Helios - Charon",
  "Helios - Tyrol",
  "Helios - Vega",
  "Helios Belt Alpha",
  "Helios I",
  "Helios II",
  "Hickes Research Outpost",
  "HDMS-Anderson",
  "HDMS-Bezdek",
  "HDMS-Edmond",
  "HDMS-Hadley",
  "HDMS-Hahn",
  "HDMS-Lathan",
  "HDMS-Norgaard",
  "HDMS-Oparei",
  "HDMS-Perlman",
  "HDMS-Pinewood",
  "HDMS-Ryder",
  "HDMS-Stanhope",
  "HDMS-Thedus",
  "HDMS-Woodruff",
  "HDPC-Cassillo",
  "HDPC-Farnesway",
  "HDSF-Adlai",
  "HDSF-Barnabas",
  "HDSF-Breckinridge",
  "HDSF-Colfax",
  "HDSF-Damaris",
  "HDSF-Elbridge",
  "HDSF-Hendricks",
  "HDSF-Hiram",
  "HDSF-Hobart",
  "HDSF-Ishmael",
  "HDSF-Millerand",
  "HDSF-Palomar",
  "HDSF-Rufus",
  "HDSF-Sherman",
  "HDSF-Tamar",
  "HDSF-Tompkins",
  "HDSF-Zacharias",
  "Hospice",
  "Humboldt Mines",
  "Hurston",
  "Hurston Dynamics Showcase",
  "Hurston Security Station",
  // === I LOCATIONS ===
  "ICC ScanHub Stanton",
  "Independent Arbitrator Hub",
  "Inspiration Park",
  "Intercity Research Facility",
  "Invictus Base",
  "IO",
  "IO-North tower",
  // === J LOCATIONS ===
  "Jackson's Swap",
  "JRPC Alpha Outpost",
  "JRPC Beta Outpost",
  "JRPC Charlie Outpost",
  "JRPC Delta Outpost",
  "JRPC Echo Outpost",
  "JRPC Foxtrot Outpost",
  "JRPC Golf Outpost",
  "JRPC Hotel Outpost",
  "JRPC India Outpost",
  "JRPC Juliet Outpost",
  "JRPC Kilo Outpost",
  "JRPC Lima Outpost",
  "JRPC Mike Outpost",
  "JRPC November Outpost",
  "JRPC Oscar Outpost",
  "JRPC Papa Outpost",
  "JRPC Quebec Outpost",
  "JRPC Romeo Outpost",
  "JRPC Sierra Outpost",
  "JRPC Tango Outpost",
  "JRPC Uniform Outpost",
  "JRPC Victor Outpost",
  "JRPC Whiskey Outpost",
  "JRPC X-ray Outpost",
  "JRPC Yankee Outpost",
  "JRPC Zulu Outpost",
  "Jumptown",
  "Jupiter",
  "JusticeStar Satellite",
  // === K LOCATIONS ===
  "Kabir's Post",
  "Kallis (star)",
  "Kallis - Bremen",
  "Kallis - Nemo",
  "Kallis Belt Alpha",
  "Kallis I",
  "Kallis II",
  "Kant's Peak",
  "Kellog (star)",
  "Kellog - Chronos",
  "Kellog - Virgil",
  "Kellog Belt Alpha",
  "Kellog I",
  "Kellog II",
  "Kellog III",
  "Kelo Bottom",
  "Kiel (star)",
  "Kiel - Baker",
  "Kiel - Chronos",
  "Kiel Belt Alpha",
  "Kiel I",
  "Kiel II",
  "Kiel III",
  "Kiel IV",
  "Kiel V",
  "Kiel VI",
  "Kilian (star)",
  "Kilian - Cathcart",
  "Kilian - Nexus",
  "Kilian Belt Alpha",
  "Kilian I",
  "Kilian II",
  "Kilian VIII",
  "Kilian X",
  "Kilian XI",
  "Kilian XII",
  "Kilian XIII",
  "Kilian XIV",
  "Kinder Plots",
  "Kins (star)",
  "Kins - Charon",
  "Kins - Garron",
  "Kins - Hades",
  "Kins Belt Alpha",
  "Kins Belt Beta",
  "Kins I",
  "Kins II",
  "Kins III",
  "Kins IV",
  "Kins V",
  "Klescher Rehabilitation Facility (Aberdeen)",
  "Koli",
  "Kosso Basin Aid Shelter",
  "Kudre Ore",
  "Kudre Ore Mine",
  "Kuiper Belt",
  "Kuā'li",
  "Kyu'nao",
  "Kyu'ām",
  "Kyuk'ya (star)",
  "Kyuk'ya - Ail'ka",
  "Kyuk'ya A",
  "Kyuk'ya B",
  "Kyuk'ya Belt Alpha",
  "Kyuk'ya I",
  "Kyuk'ya II",
  "Kо̄ri'lya",
  // === L LOCATIONS ===
  "L19 Residences",
  "La'uo (star)",
  "La'uo - Eealus",
  "La'uo - Tohil",
  "La'uo - Trise",
  "La'uo Belt Alpha",
  "La'uo Belt Beta",
  "Lago",
  "Lamina OLP",
  "Lamina PAF-I",
  "Lamina PAF-II",
  "Lamina PAF-III",
  "Lanisto",
  "Last Day",
  "Last Ditch",
  "Last Landings",
  "Launch Pad",
  "Lazarus Phoenix Research Lab",
  "Lazarus Tithonus Research Lab",
  "Lazarus Transport Hub Phoenix-I",
  "Lazarus Transport Hub Phoenix-II",
  "Lazarus Transport Hub Phoenix-III",
  "Lazarus Transport Hub Tithonus-I",
  "Lazarus Transport Hub Tithonus-II",
  "Lazarus Transport Hub Tithonus-III",
  "Leavsden Square",
  "Leir (star)",
  "Leir I",
  "Leir III",
  "Levski",
  "List of Stanton locations",
  "Lixāuu",
  "Lo",
  "Locke",
  "Lorona",
  "Lorville",
  "Lorville Outskirts",
  "Lost and Found",
  "Loveridge Mineral Reserve",
  "LROP Rayari Anuk",
  "LROP Rayari Cantwell",
  "LROP Rayari Delta",
  "LROP Rayari Gaines",
  "LROP Rayari Kaltag",
  "LROP Rayari McGrath",
  "Lowdown",
  "Ludlow",
  "Luna",
  "Lyre",
  "Lyria",
  "Lyris Flotilla",
  "Lūng'xyi",
  // === M LOCATIONS ===
  "M.iiy'ong",
  "MacArthur",
  "MacIntyre & Victor's Bar",
  "Magda",
  "Magma",
  "Magnus (star)",
  "Magnus - Stanton",
  "Magnus Gateway",
  "Magnus I",
  "Magnus III",
  "Mainline",
  "Maker's Point",
  "Maria Pure of Heart",
  "Mariana",
  "Marisol Belt",
  "Markahil (star)",
  "Mars",
  "Megumi Refueling",
  "Mentor",
  "Mercury (planet)",
  "Mercy Hospital",
  "MIC-L1 Shallow Frontier Station",
  "MIC-L2 Long Forest Station",
  "MIC-L3 Endless Odyssey Station",
  "MIC-L4 Red Crossroads Station",
  "MIC-L5 Modern Icarus Station",
  "MicroTech (planet)",
  "MicroTech Logistics Depot S4LD01",
  "MicroTech Logistics Depot S4LD13",
  "Mya Aid Shelter",
  "Min 1a",
  "Min 1b",
  "Min 1c",
  "Min 1d",
  "Min I",
  "Miner's Lament",
  "Minlo Spire",
  "Miranda",
  "Mogote Aid Shelter",
  "Monox",
  "Moreland Hills",
  "Morgan's Gate",
  "Moscow",
  "MT DataCenter 2UB-RB9-5",
  "MT DataCenter 4HJ-LVE-A",
  "MT DataCenter 5WQ-R2V-C",
  "MT DataCenter 8FK-Q2X-K",
  "MT DataCenter D79-ECG-R",
  "MT DataCenter E2Q-NSG-Y",
  "MT DataCenter KH3-AAE-L",
  "MT DataCenter L8P-JUC-8",
  "MT DataCenter QVX-J88-J",
  "MT DataCenter TMG-XEV-2",
  "MT OpCenter TLI-4",
  "Mya",
  // === N LOCATIONS ===
  "Najita",
  "Nakamura Valley Aid Shelter",
  "Narena's Rest",
  "Nedila",
  "Nemo (star)",
  "Nemo I",
  "Nemo II",
  "Neo Taurii",
  "Neptune",
  "Nest Apartments",
  "Neutrality",
  "Nevermind",
  "New Austin",
  "New Babbage",
  "New Babbage Interstellar Spaceport",
  "New Corvo",
  "New Junction",
  "New York",
  "Newcastle",
  "Nexus (star)",
  "Nexus I",
  "Nexus II",
  "Nexus III",
  "Ne'er",
  "NKZ",
  "Noble",
  "Nogo",
  "Nova Kyiv",
  "NT-999-XV",
  "NT-999-XVI",
  "NT-999-XX",
  "NT-999-XXII",
  "Nuen Waste Management",
  "Nuiqsut Emergency Shelter",
  "Nul (star)",
  "Nul I",
  "Nul II",
  "Nul IV",
  "Nyx (star)",
  "Nyx I",
  "Nyx II",
  "Nyx III",
  // === O LOCATIONS ===
  "OB Heller",
  "OB Kobold",
  "OB Station Gryphon",
  "OB Station Pegasus",
  "Oberon (moon)",
  "Oberon (star)",
  "Oberon III",
  "Oberon IV",
  "Oberon V",
  "Oberon VI",
  "Oberon VII",
  "Odin (star)",
  "Odin II",
  "Odin III",
  "Odin IV",
  "Odyssa",
  "Old '38",
  "Oli'Sha",
  "Olympus",
  "Olympus Pool",
  "Onyx",
  "Onyx Facility S1A8",
  "OP Station Demien",
  "Operations Depot Lyria",
  "Orbituary",
  "Oretani (star)",
  "Oretani Belt Alpha",
  "Oretani I",
  "Oretani II",
  "Oretani III",
  "Oretani IV",
  "Oretani V",
  "Oretani VI",
  "Orion (star)",
  "Orion Belt Alpha",
  "Orion I",
  "Orion II",
  "Orison",
  "Orison General",
  "Osha",
  "Osiris (star)",
  "Osiris - Baker",
  "Osiris Belt Alpha",
  "Osiris II",
  "Oso (star)",
  "Oso I",
  "Oso II",
  "Oso III",
  "Oso IV",
  "Oso V",
  "Oso VI",
  "Ostler's Claim",
  "Outpost 54",
  "Oya (star)",
  "Oya I",
  "Oya II",
  "Oya III",
  "Oya IV",
  // === SPACE STATIONS & LAGRANGE POINTS ===
  "Port Olisar",
  "Port Renatus", 
  "Port Tressler",
  "P.uay'aha",
  "Paradise Cove",
  "Patch City",
  "Penselin",
  "Persei",
  "Petram",
  "Petrus",
  "Pharmacy",
  "Phobos",
  "Pi'tua",
  "Picker's Field",
  "Pike",
  "Pinecone",
  "Ping'leth",
  "Player hab",
  "Pluto",
  "Point Wain Emergency Shelter",
  "Prime",
  "PRIVATE PROPERTY",
  "Prophet's Peak",
  "Prospect Depot",
  "Prospect Point",
  "Providence industrial platform",
  "Pue'nu",
  "PYAM-SUPVISR-3-4",
  "Pyen'pui.a",
  "Pyro (star)",
  "Pyro - Stanton",
  "Pyro Gateway",
  "Pyro I",
  "Pyro IV",
  "Pyro V",
  "Seraphim Station",
  // Crusader Lagrange Points
  "CRU-L1",
  "CRU-L4", 
  "CRU-L5",
  "CRU-L1 Ambitious Dream Station",
  "CRU-L4 Shallow Fields Station",
  "CRU-L5 Beautiful Glen Station", 
  // MicroTech Lagrange Points
  "MIC-L1",
  "MIC-L2",
  "MIC-L3",
  "MIC-L4",
  "MIC-L5",  
  // ArcCorp Lagrange Points
  "ARC-L1 Wide Forest Station",
  "ARC-L2 Lively Pathway Station", 
  "ARC-L3 Modern Express Station",
  "ARC-L4 Faint Glen Station",
  "ARC-L5 Yellow Core Station",  
  // Hurston Lagrange Points
  "HUR-L1 Green Glade Station",
  "HUR-L2 Faithful Dream Station",
  "HUR-L3 Thundering Express Station",
  "HUR-L4 Melodic Fields Station",
  "HUR-L5 High Course Station",
  // === Q LOCATIONS ===
  "QuarterDeck",
  "Quasi",
  "Queeg",
  "Quinton",
  // === R LOCATIONS ===
  "R.il'a (star)",
  "R.il'a VI",
  "RAB-Alpha",
  "Rai.p'uāng",
  "Rappel",
  "Rat's Nest",
  "Raven's Roost",
  "Rayari Anvik Research Outpost",
  "Rayari Cantwell Research Outpost",
  "Rayari Deltana Research Outpost",
  "Rayari Kaltag Research Outpost",
  "Rayari Livengood Research Outpost",
  "Rayari McGrath Research Outpost",
  "Rayari, Inc. Outpost",
  "Razor's Edge",
  "Reclamation & Disposal",
  "Reclamation & Disposal Orinth",
  "Red God",
  "Refinery Deck",
  "Regiment Downs",
  "Reis",
  "Reisse",
  "Rollo's Junkyard",
  "Rest Stop",
  "Reza's Landing",
  "Rhea",
  "Rhetor (star)",
  "Rhetor I",
  "Rhetor V",
  "Rico's Remains",
  "Riker Memorial Spaceport",
  "Rings of Aremis",
  "Rings of Branaugh II",
  "Rings of Ellis VII",
  "Rings of Kiel V",
  "Rings of Kyuk'ya I",
  "Rings of Neptune",
  "Rings of Saturn",
  "Rings of Tayac II",
  "Rings of Uranus",
  "Rock Bottom",
  "Rod's Fuel 'N Supplies",
  "Rolo's Crater",
  "Rough Landing",
  "Ruin Station",
  "Ruptura OLP",
  "Ruptura PAF-I",
  "Ruptura PAF-II",
  "Ruptura PAF-III",
  "Rustville",
  "RyiXy'an",
  "Rytif",
  "Ryōl",
  // === S LOCATIONS ===
  "S.ap'uāng",
  "Sacren's Plot",
  "Saisei",
  "Sakura Sun Goldenrod Workcenter",
  "Sakura Sun Magnolia Workcenter",
  "Samson & Son's Salvage Center",
  "Saturn",
  "Scarper's Turn",
  "Schwester",
  "Scuttle",
  "Se'kith",
  "Second Sister",
  "Security Post Criska",
  "Security Post Dipur",
  "Security Post Kareah",
  "Security Post Lespin",
  "Security Post Moluto",
  "Security Post Opal",
  "Security Post Prashad",
  "Security Post Thaquray",
  "Security Post Wan",
  "Seer's Canyon",
  "Selene",
  "Serling",
  "Sesen",
  "Severus",
  "Shadowfall",
  "Shady Glen Farms",
  "Shanghai",
  "Shanks",
  "Shasta Hollow",
  "Shepherd",
  "Shepherd's Rest",
  "Sherman",
  "Shoel",
  "Shubin Mining Facility SAL-2",
  "Shubin Mining Facility SAL-5",
  "Shubin Mining Facility SCD-1",
  "Shubin Mining Facility SM0-10",
  "Shubin Mining Facility SM0-13",
  "Shubin Mining Facility SM0-18",
  "Shubin Mining Facility SM0-22",
  "Shubin Mining Facility SMCa-6",
  "Shubin Mining Facility SMCa-8",
  "Shubin Processing Facility SPAL-12",
  "Shubin Processing Facility SPAL-16",
  "Shubin Processing Facility SPAL-21",
  "Shubin Processing Facility SPAL-3",
  "Shubin Processing Facility SPAL-7",
  "Shubin Processing Facility SPAL-9",
  "Shubin Processing Facility SPMC-1",
  "Shubin Processing Facility SPMC-10",
  "Shubin Processing Facility SPMC-14",
  "Shubin Processing Facility SPMC-3",
  "Shubin Processing Facility SPMC-5",
  "Sightseeing and Travel Guide",
  "Sino",
  "Slowburn Depot",
  "Smokestack",
  "Sol (star)",
  "Sol - Croshaw",
  "Sol - Davien",
  "Space Clinics",
  "Space Whale",
  "Spider",
  "Stag's Rut",
  "Stalford",
  "Stanton (star)",
  "Stanton - Magnus",
  "Stanton - Pyro",
  "Stanton - Terra",
  "Stanton Gateway",
  "Starlight Service Station",
  "Stone's Throw",
  "Stonetree",
  "Stratus at Cloudview Center",
  "Sunset Mesa",
  "Supply Gap",
  "Synthworld",
  // === T LOCATIONS ===
  "T.āl (star)",
  "T.āl - Ail'ka",
  "Talarine Divide Aid Shelter",
  "Tamdon Plains Aid Shelter",
  "Tamsa (black hole)",
  "Tamsa I",
  "Tamsa II",
  "Tanga (star)",
  "Tanga Belt Alpha",
  "Tanga I",
  "Tanga II",
  "Tangaroa",
  "Tanys",
  "Taranis (star)",
  "Taranis 2a debris",
  "Taranis Belt Alpha",
  "Taranis Belt Beta",
  "Taranis I",
  "Taranis II",
  "Taranis III",
  "Taranis IV",
  "Tat'Ko",
  "Tayac (star)",
  "Tayac - Baker",
  "Tayac - Goss",
  "Tayac - Terra",
  "Tayac Belt Alpha",
  "Tayac I",
  "Tayac II",
  "TDD Kesner",
  "Teasa Spaceport",
  "Technotic",
  "Teddy's Playhouse",
  "Terminus",
  "Terra",
  "Terra - Stanton",
  "Terra Gateway",
  "Terra Mills HydroFarm",
  "Terra Mills Processing Center",
  "Terra Mills Storage Alpha",
  "Terra Mills Storage Beta",
  "Terra Nova",
  "Test Facility Octagon",
  "Tethle'a",
  "Tethys",
  "Th.us'ūng (star)",
  "Th.us'ūng - Baker",
  "Th.us'ūng Belt Alpha",
  "Th.us'ūng I",
  "The Ark (station)",
  "The Barrens",
  "The Coil",
  "The Dregs",
  "The Factory Line",
  "The Garden",
  "The Golden Riviera",
  "The Grove",
  "The Hollows",
  "The Icebreaker",
  "The Necropolis",
  "The Orphanage",
  "The Pit",
  "The Shades",
  "The Sky Scraper",
  "The Snake Pit",
  "The Yard",
  "Thimblerig",
  "Third Sister",
  "Tiber (star)",
  "Tiber Belt Alpha",
  "Tiber I", 
  "Titan",
  "Titania",
  "Titus",
  "Tobin Expo Center",
  "Tohil (star)",
  "Tohil - La'uo",
  "Tohil - Nyx",
  "Tohil - Oya",
  "Tohil Belt Alpha",
  "Tohil I",
  "Tohil II",
  "Tohil III",
  "Tohil IV",
  "Toja",
  "Tomb",
  "TPF",
  "Tram",
  "Tram & Myers Mining",
  "Tremonte",
  "Trilo",
  "Trise (star)",
  "Trise - Eealus",
  "Trise - La'uo",
  "Trise I",
  "Tyrol - Charon",
  "Tyrol - Goss",
  "Tyrol - Helios",
  "Tyrol A",
  "Tyrol B",
  "Tyrol Belt Alpha",
  "Tyrol I",
  "Tyrol II",
  "Tyrol III",
  "Tyrol IV",
  "Tyrol V",
  "Tyrol VI",
  "Tyrol VII",
  // === U LOCATIONS ===
  "Umbriel",
  "Unnamed abandoned outpost (Cellin)",
  "Unnamed abandoned outpost (Daymar)",
  "Unnamed abandoned outpost (Yela)",
  "Uranus",
  "Uriel",
  "Utopia",
  // === V LOCATIONS ===
  "Vagabond (star)",
  "Vanduul Attack",
  "Vanguard (star)",
  "Vann",
  "Vatra",
  "Vector (star)",
  "Vega (star)",
  "Vega 2A",
  "Vega 2B",
  "Vega Belt Alpha",
  "Vega I",
  "Vega IV",
  "Vendetta (star)",
  "Venus",
  "Veritas (star)",
  "Vermilion (star)",
  "Vesper (star)",
  "Viking (star)",
  "Viking - Caliban",
  "Viking - Orion",
  "Vili",
  "Virgil (star)",
  "Virgil - Kellog",
  "Virgil - Nyx",
  "Virgil - Oberon",
  "Virgil - Tiber",
  "Virgil - Vega",
  "Virgil III",
  "Virgo (star)",
  "Vision Center",
  "Vivere OLP",
  "Vivere PAF-I",
  "Vivere PAF-II",
  "Vivere PAF-III",
  "Volt (star)",
  "Voodoo (star)",
  "Vosca",
  "Voyager Bar",
  "Vulture (star)",
  "Vulture - Orion",
  "Vuur",
  // === W LOCATIONS ===
  "Wailing Rock",
  "Wala",
  "Walleye",
  "Wally's",
  "Washout",
  "Watcher's Depot",
  "Weeping Cove",
  "Wheeler's",
  "Whistlers Crypt",
  "Wikelo Emporium",
  "Wikelo Emporium Dasi Station",
  "Wikelo Emporium Kinga Station",
  "Wikelo Emporium Selo Station",
  "Wiley Flats",
  "Windfall",
  "Wolf Point Aid Shelter",
  "World's End",
  // === X LOCATIONS ===
  "Xenia",
  "Xi",
  "Xis",
  "Xyeping",
  "Xōl'uu",
  // === Y LOCATIONS ===
  "Y.ōm'e",
  "Yadar Valley",
  "Yang's Place",
  "Yar",
  "Ye'ten",
  "Ye'ton",
  "Yela",
  "Yengchuai",
  "Yethlūl S.yen'o",
  "Yethlūl Y.ath'o",
  "Yogi Station",
  "Yulin (star)",
  "Yulin - Banshee",
  "Yulin - Leir",
  "Yulin Cluster Alpha",
  "Yulin Flotilla",
  "Yulin I",
  "Yulin II",
  "Yulin III",
  "Yulin IV",
  "Yulin V",
  "Yulin VI",
  "Yā'mon (star)",
  "Yā'mon - Ail'ka",
  "Yā'mon - Baker",
  "Yā'ti",
  "Yām'ping",
  "Yā'mon Belt Alpha",
  // === Z LOCATIONS ===
  "Zephyr (settlement)",

  // === SPECIAL CHARACTER LOCATIONS ===
  "Ē'aluth (star)",
  "Ē'aluth Belt Alpha",
  "Ē'aluth I",
  "Ē'aluth II",
  "Ē'aluth IV",
  "Ē'aluth V"
  ];
  </script>
</head>
<body>
  <div class="main-container">
    <div class="page-header">
      <img class="logo" src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo">
      <h1>Brute Haul Online Documentation System</h1>
    </div>

    <div class="card" id="navigationCard">
        <div style="display: flex; gap: 12px; margin-bottom: 0;">
      <button type="button" onclick="showTab('formTab')" id="formTabBtn" style="border: 3px solid transparent;">Manifest Form</button>
      <button type="button" onclick="showTab('transportTab')" id="transportTabBtn" style="border: 3px solid transparent;">Transport Request</button>
  <button type="button" onclick="showTab('historyViewerTab')" id="historyTabBtn" style="border: 3px solid transparent;">History & Viewer</button>
        <a href="https://discord.gg/Ejpr5ZagvV" target="_blank" title="Join BRHS Discord" id="discordButton"
           style="margin-left:auto; display:inline-flex; align-items:center; justify-content:center; width:60px; height:60px; background:#5865F2; border-radius:8px; text-decoration:none; border:0px solid #9d7523; margin-right:12px;">
          <svg width="38" height="38" viewBox="0 0 71 55" fill="white">
            <g clip-path="url(#clip0)">
              <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
            </g>
            <defs>
              <clipPath id="clip0">
                <rect width="71" height="55"/>
              </clipPath>
            </defs>
          </svg>
        </a>
        <a href="https://robertsspaceindustries.com/en/orgs/BRHS" target="_blank" title="Join BRHS"
           style="display:inline-flex; align-items:center; justify-content:center; width:60px; height:60px; background:#222; border-radius:8px; text-decoration:none; border:0px solid #9d7523;">
          <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/starcitizenwhite.png" alt="Star Citizen" style="width:82px; height:82px; object-fit:contain; filter:invert(1);">
        </a>
      </div>
    </div>

    <div id="historyViewerTab" style="display: none; width: 100%; max-width: 95%; margin: 0 auto;">
      <div style="display: grid; grid-template-columns: 1fr; gap: 18px;">
        <div style="background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%); border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(157, 117, 35, 0.12);">
          <h2 style="color:#9d7523;margin-top:0;">Manifest History</h2>
          <div id="historyList" style="min-height: 200px; padding: 12px;"> 
            <div style="text-align: center; background: #fff; border: 3px solid #9d7523; border-radius: 12px; padding: 22px;">
              <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo" style="max-width: 160px; width: 100%; margin-bottom: 12px; border-radius: 8px;">
              <h3 style="color: #9d7523; margin: 12px 0; font-size: 20px;">Brute Haul Manifest Log</h3>
              <p style="font-size: 15px; color: #781d15; font-weight: bold; margin: 8px 0;">No posts generated this session.</p>
              <p style="color: #666; margin: 6px 0; font-size: 14px;">Complete and submit manifests to see them listed here.</p>
            </div>
          </div>
        </div>
        <div style="background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%); border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); border: 1px solid rgba(157, 117, 35, 0.12);">
          <h2 style="color:#9d7523;margin-top:0;">Transport Requests</h2>
          <div id="viewerControls" style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;align-items:center;">
              <label style="font-weight:600;color:#781d15;margin-right:6px;">Sort:</label>
              <select id="viewer_sort" style="min-width:200px;padding:8px;border:1px solid #781d15;border-radius:6px;height:40px;box-sizing:border-box;">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="priority">Priority</option>
                <option value="status">Status</option>
              </select>
            </div>
            <div style="display:flex;gap:8px;align-items:center;min-width:320px;">
              <input id="viewer_search" placeholder="Search Request ID, Org, Requester, Route" style="flex:1;min-width:220px;padding:8px;border:1px solid #781d15;border-radius:6px;height:40px;box-sizing:border-box;" />
              <button type="button" id="viewer_search_btn" style="height:40px;padding:0 12px;border-radius:6px;background:#9d7523;color:#fff;border:none;">Search</button>
              <button type="button" id="viewer_clear_btn" style="height:40px;padding:0 12px;border-radius:6px;background:#eee;color:#333;border:1px solid #ccc;">Clear</button>
            </div>
          </div>
          <div id="viewerStatus" style="margin-bottom:12px;color:#333;font-weight:bold;display:none;">Viewer status</div>
          <div id="viewerContent" style="min-height:120px; padding:8px;"></div>
        </div>
      </div>
    </div>

      <div id="transportTab" style="display: none; width: 100%; max-width: 95%; margin: 0 auto;">
        <div style="background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%); border-radius: 16px; padding: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(157, 117, 35, 0.12);">
          <h2 style="color:#9d7523;margin-top:0;">Transport Request</h2>
          <p style="color:#333;margin-bottom:18px;">Use this form to request a transport setup from another organisation. Fill in the details below and click Submit Request.</p>
          <form id="transportRequestForm" method="post" action="/cgi-bin/save_request.py">
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <div style="flex:1;min-width:220px;">
                <label>Organization:</label>
                <select id="tr_orgName" required style="width:100%;" onchange="toggleCustomOrg(this)">
                  <option value="" selected disabled>Select organization</option>
                  <option value="Brute Haul">Brute Haul</option>
                  <option value="Space Rats">Space Rats</option>
                  <option value="The Benjineering Project">The Benjineering Project</option>
                  <option value="__other__">Other</option>
                </select>
                <input type="text" id="tr_orgNameOther" class="other-input" placeholder="Enter organization name" style="display:none;" />
              </div>
              <div style="flex:1;min-width:220px;">
                <label>Requester Name:</label>
                <select id="tr_requester" required style="width:100%;" aria-required="true" onchange="toggleCustomRequester(this)">
                  <option value="" selected disabled>Select requester</option>
                  <option value="__other__">Other</option>
                </select>
                <input type="text" id="tr_requesterOther" class="other-input" placeholder="Enter requester name" style="display:none;" />
              </div>
              <div style="flex:1;min-width:220px;">
                <label>Security Ships needed?</label>
                <select id="tr_securityNeeded" required style="width:100%;" aria-required="true">
                  <option value="" selected disabled>Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div style="flex:1;min-width:220px;">
                <label>Start Destination:</label>
                <div class="searchable-dropdown">
                  <input type="text" id="tr_pickup" placeholder="Start location" autocomplete="off" required />
                  <div class="dropdown-list" id="tr_pickupList"></div>
                </div>
              </div>
              <div style="flex:1;min-width:220px;">
                <label>End Destination:</label>
                <div class="searchable-dropdown">
                  <input type="text" id="tr_destination" placeholder="End location" autocomplete="off" required />
                  <div class="dropdown-list" id="tr_destinationList"></div>
                </div>
              </div>
              <div style="flex:1 1 100%;min-width:220px;">
                <label>Cargo Details:</label>
                <textarea id="tr_cargoDetails" required placeholder="Enter cargo details here.
Example: What are you hauling? Any special requirements or requests? Any preferred ships or crew?" style="width:100%;max-width:100%;height:120px;resize:vertical;box-sizing:border-box;white-space:pre-wrap;overflow-wrap:break-word;" aria-required="true"></textarea>
              </div>
              <div style="flex:0 0 140px;">
                <label>SCU Total:</label>
                <input type="number" id="tr_requiredSCU" required min="0" step="1" style="width:100%;" aria-required="true" />
              </div>
              <div style="flex:1 1 100%;min-width:220px;margin-top:8px;">
                <label>Priority:</label>
                <select id="tr_priority" required style="width:100%;" aria-required="true">
                  <option value="" selected disabled>Select priority</option>
                  <option value="Emergency">Emergency</option>
                  <option value="High">High</option>
                  <option value="Medium">Medium</option>
                  <option value="Low">Low</option>
                </select>
              </div>
            </div>
            <div style="margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
              <button type="button" onclick="submitTransportRequest()" style="background:#9d7523;color:#fff;border:none;padding:10px 14px;border-radius:6px;">Submit Request</button>
              <button type="button" onclick="clearTransportRequestForm()" style="background:#eee;color:#333;border:1px solid #ccc;padding:8px 12px;border-radius:6px;">Clear</button>
              <div id="tr_status" style="margin-left:12px;color:#2a7a2a;font-weight:bold;display:none;">Request submitted</div>
            </div>
          </form>
        </div>
      </div>

        <div id="viewerTab" style="display:none; width:100%; max-width:95%; margin:0 auto;">
          <div style="background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%); border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); border: 1px solid rgba(157, 117, 35, 0.12);">
            <h2 style="color:#9d7523;margin-top:0;">Transport Viewer</h2>
            <div id="viewerStatus" style="margin-bottom:12px;color:#333;font-weight:bold;display:none;">Viewer status</div>
            <div id="viewerContent" style="min-height:200px; padding:8px;"></div>
          </div>
        </div>

        <div id="formTab">
      <div class="form-grid">
  
  <div class="success-feedback" id="successFeedback">
    <span>✓</span>
    <span id="successMessage">Success!</span>
  </div>
  <div class="error-feedback" id="errorFeedback">
    <span>⚠</span>
    <span id="errorMessage">Error occurred!</span>
  </div>

  <div class="main-content-wrapper">
    <div class="form-column">
      <form id="haulForm">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">1</div>
        <h2>Basic Information</h2>
      </div>
      <div class="section form-step" id="basicInfoStep">
      <label>Order Category:</label>
      <select id="orderCategory" required>
        <option value="" selected disabled>Select category</option>
        <option value="Transport">Transport</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderCategoryOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderCategoryOther" required />
      </div>

      <label>Company Name:</label>
      <select id="companyName" required>
        <option value="" selected disabled>Select company</option>
        <option value="Brute Haul">Brute Haul</option>
        <option value="Space Rats">Space Rats</option>
        <option value="The Benjineering Project">The Benjineering Project</option>
      </select>

      <label>Order Type:</label>
      <select id="orderType" required onchange="toggleOrderTypeOther()">
        <option value="" selected disabled>Select order type</option>
        <option value="Resource Drive">Resource Drive</option>
        <option value="Supplies">Supplies</option>
        <option value="Trade">Trade</option>
        <option value="Resources">Resources</option>
        <option value="Salvage">Salvage</option>
        <option value="Contract">Contract</option>
        <option value="Relocation">Relocation</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderTypeOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderTypeOther" required />
      </div>
      <div id="resourceDriveCompanyDiv" class="other-div" style="display:none;">
        <label>Resource Drive Company:</label>
        <select id="resourceDriveCompany">
          <option value="" selected disabled>Select company</option>
          <option value="Hurston Dynamics">Hurston Dynamics</option>
          <option value="Arccorp">Arccorp</option>
          <option value="🏆 Crusader Industries">🏆 Crusader Industries</option>
          <option value="Microtech">Microtech</option>
        </select>
      </div>

      <label>Ship Name:</label>
      <div class="searchable-dropdown" id="shipNameDropdown">
        <input type="text" id="shipName" placeholder="Search ship name..." autocomplete="off" required>
        <div class="dropdown-list" id="shipNameList"></div>
      </div>
      <div id="shipNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="shipNameOther" required />
      </div>

      <label>Captain Name:</label>
      <div class="searchable-dropdown" id="captainNameDropdown">
        <input type="text" id="captainName" placeholder="Search captain name..." autocomplete="off" required>
        <div class="dropdown-list" id="captainNameList"></div>
      </div>
      <div id="captainNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="captainNameOther" required />
      </div>

      <label>Crew Amount:</label>
      <input type="number" id="crewAmount" min="0" max="20" step="1" required oninput="generateCrewInputs()" />

      <div id="crewNamesDiv"></div>
    </div>
    </div>

    <div class="card form-step" id="securityShipsStep">
      <div class="card-header">
        <i class="icon">🛡️</i>
        <h2>Security Ships</h2>
      </div>
      <div class="card-content">
      <label>Security Ships:</label>
      <div class="searchable-dropdown" id="securityShipsDropdown">
        <input type="text" id="securityShips" placeholder="Search security ships..." autocomplete="off" required>
        <div class="dropdown-list" id="securityShipsList"></div>
      </div>
      <div id="securityShipsOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="securityShipsOther" required />
      </div>
      <div class="security-ship-captains" id="securityShipCaptains"></div>
    </div>
    </div>

    <div class="card form-step" id="locationTimeStep">
      <div class="card-header">
        <i class="icon">📍</i>
        <h2>Locations & Timeline</h2>
      </div>
      <div class="card-content">
      <label>Start Location:</label>
      <div class="searchable-dropdown" id="startLocationDropdown">
        <input type="text" id="startLocation" placeholder="Search start location..." autocomplete="off" required>
        <div class="dropdown-list" id="startLocationList"></div>
      </div>

      <label>Departure Timestamp:</label>
      <div class="datetime-container">
        <input type="datetime-local" id="departureTime" required>
        <button type="button" class="time-now-btn" onclick="setCurrentTime('departureTime')" title="Set to current time">Now</button>
      </div>

      <label>Route:</label>
      <div class="route-row">
        <div class="searchable-dropdown" id="routeStartDropdown">
          <input type="text" id="routeStart" placeholder="Search route start..." autocomplete="off" required>
          <div class="dropdown-list" id="routeStartList"></div>
        </div>
        <span class="route-arrow" style="font-size:1.5em;">➡️</span>
        <div class="searchable-dropdown" id="routeEndDropdown">
          <input type="text" id="routeEnd" placeholder="Search route end..." autocomplete="off" required>
          <div class="dropdown-list" id="routeEndList"></div>
        </div>
      </div>
    </div>
    </div>

    <div class="card form-step" id="manifestStep">
      <div class="card-header">
        <i class="icon">📦</i>
        <h2>Cargo Manifest</h2>
      </div>
      <div class="card-content">
      <label>Cargo Manifest (add/remove lines as needed):</label>
      <div id="resourceDrivePresets" style="display:none; margin-bottom:10px;">
        <span style="font-size:13px; font-weight:bold; vertical-align:middle; margin-right:8px;">Resource Drive Presets:</span>
        <span style="display:inline-flex; gap:10px; vertical-align:middle;">
          <button type="button" class="resource-preset-btn" id="presetLargeBtn" onclick="applyManifestPreset('large')">Heavy Haul</button>
          <button type="button" class="resource-preset-btn" id="presetMediumBtn" onclick="applyManifestPreset('medium')">Medium Haul</button>
          <button type="button" class="resource-preset-btn" id="presetSmallBtn" onclick="applyManifestPreset('small')">Small Haul</button>
        </span>
      </div>
      <div id="manifestLines"></div>
      <div class="manifest-total-box">
  <span id="totalSCUBox">Total SCU: 0</span>
  <span style="margin-right:6px;">Total UEC:</span>
<input type="number" id="totalUECBox" style="color:#230e09; font-weight:bold; vertical-align:middle; width:80px;" value="0" />
</div>
    </div>
    </div>

    <div class="card form-step" id="completionStep">
      <div class="card-header">
        <i class="icon">✅</i>
        <h2>Order Completion</h2>
      </div>
      <div class="card-content">
      <label>Order Completion Timestamp:</label>
      <div class="datetime-container">
        <input type="datetime-local" id="completionTime" required>
        <button type="button" class="time-now-btn" onclick="setCurrentTime('completionTime')" title="Set to current time">Now</button>
      </div>
      <div id="orderDuration" style="font-weight:bold; color:#9d7523; margin-top:8px;"></div>

      <label>Repairs (UEC):</label>
      <input type="number" id="repairs" min="0" step="1" class="deductible-input" required value="0">

      <label>Restock (UEC):</label>
      <input type="number" id="restock" min="0" step="1" class="deductible-input" required value="0">

      <label>Quantum Fuel (UEC):</label>
      <input type="number" id="quantumFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Hydrogen Fuel (UEC):</label>
      <input type="number" id="hydrogenFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Crew/Ship Costs (UEC):</label>
      <input type="number" id="crewCosts" min="0" step="1" class="deductible-input" required value="0">

      <label>Notes:</label>
      <textarea id="notes" style="width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
    </div>
    </div>

    <button type="button" onclick="generateOutput()" id="generateBtn">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" class="discord-btn-logo" style="filter: brightness(0) invert(1);" />
      Generate Discord Post
    </button>
    <button type="button" onclick="clearFormFields()" style="background:#b32428;color:#fff;border:none;padding:10px 16px;border-radius:5px;font-weight:bold;display:flex;align-items:center;gap:8px;margin-left:8px;margin-bottom:20px;">
  Clear Form
</button>
  </form>

  <div class="section" id="discordSection" style="display:none;">
    
    <div style="border-bottom: 1px solid #9d7523; margin-bottom: 16px;"></div>
    
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <button type="button" onclick="sendToDiscord()" style="background:#43b581;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:bold;font-size:16px;display:inline-flex;align-items:center;gap:10px;">
        <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.8em;width:auto;filter:brightness(0) invert(1);" />
        Send to Discord
      </button>
    </div>
    
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <button type="button" onclick="toggleDiscordOutput()" id="toggleOutputBtn" style="background:#9d7523;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;">
        <span id="toggleOutputIcon">▶</span>
        <span id="toggleOutputText">Show Generated Output</span>
      </button>
    </div>
    
    <div id="discordOutputContainer" style="display:none;">
      <textarea id="discordOutput" readonly></textarea>
      <button type="button" onclick="copyDiscordOutput()" id="copyDiscordBtn" style="background:#5865F2;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:none;align-items:center;gap:8px;">
        <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
        Copy to Clipboard
      </button>
    </div>
  </div>
    </div>

    <!-- THIS IS A JUMPPOINT FOR ANNOUCEMENTS BECAUSE I'M LAZY AND I DON'T WANT TO SCROLL TO FIND THIS SECTION-->
    <!-- I really should make annoucements a seperate file but that would be too smart of me-->
    <div class="announcements-sidebar">
      <div class="card" id="announcementsSection">
        <div class="card-header">
          <i class="icon">📢</i>
          <h2>Announcements</h2>
        </div>
        <div class="card-content">
          <div id="announcementsContent" style="height: auto; max-height: none;">
            <!-- Announcement Post 1 -->
            <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
                <h3 style="color:#781d15;margin:0;font-size:1.2em;">Brute Haul Manifest Error Reporting</h3>
                <div style="color:#666;font-size:0.8em;margin-top:5px;">
                  <strong>By:</strong> DyslexicNerd01<br><strong>Date:</strong> August 14, 2025
                </div>
              </div>
              <div class="announcement-body" style="color:#230e09;line-height:1.5;font-size:0.9em;">
                <p><strong>Brute Haul Manifest Logs now automatically get sent to discord after pressing the "Send to Discord" button!</strong></p>
                <p>If you do encounter any issues, you should see an error code and message explaining the problem. If this issue relates to the function of the bot, a GitHub issue will automatically open adressing the issue to have it solved as soon as possible.</p>
                <p>If you do see any of these messages, please do not panic as your current manifest will be printed in the bug report to be uploaded later! If you encounter an issue that does not generate an error message, please report it in <i>#space-truckers-diner</i> to be addressed later.</p>
                <p>Please do not report your ship not appearing in the list! The list is automatically generated from ships in <i>#ship-log</i>. Please DM Spartan to have your ship added! Until then please use the <i>"Other"</i> selection to manually enter your captain name/ship name.</p>
              </div>
            </div>
            
            <!-- Announcement Post 2 -->
            <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
                <h3 style="color:#781d15;margin:0;font-size:1.2em;">Known Issues Affecting Brute Haul Operations</h3>
                <div style="color:#666;font-size:0.8em;margin-top:5px;">
                  <strong>By:</strong> DyslexicNerd01<br><strong>Updated:</strong> August 25, 2025
                </div>
              </div>
              <div class="announcement-body" style="color:#230e09;line-height:1.5;font-size:0.9em;">
                <p><strong>✅</strong> <u>No Issues Currently Affecting Brute Haul Operations!</u><br>
                  There are currently no known issues majorly affecting Brute Haul Operations or Ad Astra Operations!</p>
                <p><strong>Follow this support ticket for more information on current bugs/issues or other issues within the game:<br> <a href="https://support.robertsspaceindustries.com/hc/en-us/articles/360056254754-Star-Citizen-Alpha-4-3-Known-Issues" target="_blank" style="color:#781d15;">Star Citizen Known Issues</a></strong></p>
              </div>
            </div>
            
            <!-- Announcement Post 3 -->
            <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
                <h3 style="color:#781d15;margin:0;font-size:1.2em;">📋 How to Use the Manifest Generator</h3>
                <div style="color:#666;font-size:0.8em;margin-top:5px;">
                  <strong>By:</strong> DyslexicNerd01<br><strong>Date:</strong> August 24, 2025
                </div>
              </div>
              <div class="announcement-body" style="color:#230e09;line-height:1.5;font-size:0.9em;">
                <p><strong>Complete guide to using the Brute Haul Cargo Manifest Generator:</strong></p>
                
                <p><strong>Step 1: Basic Information</strong><br>
                • Fill in Order Category, Company Name, Order Type<br>
                • Select your Transport Ship and Captain<br>
                • If you don't see your ship or name on the list, use the "Other" option<br>
                • Add crew members (if any)</p>
                
                <p><strong>Step 2: Security Ships</strong><br>
                • Select security escort ships from the dropdown (If any)<br>
                • Assign captains to each security ship<br>
                • Add crew members (if any)<br>
                • Use "Other" if your ship isn't listed</p>
                
                <p><strong>Step 3: Locations & Timeline</strong><br>
                • Set departure location and time<br>
                • Choose route start (Collection Point) and end points (Delivery Point)<br>
                • Set order completion time<br>
                • Duration is calculated automatically</p>
                
                <p><strong>Step 4: Manifest</strong><br>
                • Add cargo lines with SCU amounts and materials<br>
                • UEC values are optional but recommended<br>
                • Use presets for common cargo types in the Resource Drive<br>
                • Total SCU and UEC calculated automatically</p>
                
                <p><strong>Step 5: Completion & Costs</strong><br>
                • Enter repair costs, restocking, fuel costs<br>
                • Add crew/ship ie. Food/Drinks, Repairs, Fuel, etc.<br>
                • Add any notes from the mission. Not required<br>
                • Review your manifest before generating</p>
                
                <p><strong>Final Steps:</strong><br>
                • Click "Generate Discord Post" to create formatted output<br>
                • Click "Send to Discord" to post automatically<br>
                • Your manifest is logged to the Discord Channel!</p>
                
                <p><strong>Tips:</strong><br>
                • Green progress bars show completed sections<br>
                • Use "Clear Form" to start over while keeping basic information. This is automatically done when hitting "Send to Discord"<br>
                • Form validation prevents common errors<br>
                • History tab saves your previous manifests<br>
                • The announcement section displays important information regarding Brute Haul</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="progress-bar-container" style="width: 100%; margin: 24px 0; padding: 0 40px; box-sizing: border-box;">
    <div class="progress-bar">
      <div class="progress-fill" id="formProgressFill"></div>
    </div>
    <div class="progress-text" id="formProgressText">Form Completion: 0%</div>
  </div>
  </div>
  </div>
<script type="module">
   // Locations in locations.js

    // Ships
    const transportShips = [
      "SPRT Icarus", "BRHS Lednik", "BRHS Trireme", "WINC Caterpillar", "WINCO Rafto", "BRHS Ledokol",
    ];
    const securityShips = [
      "AACS Landsknecht", "AACS Feder", "BRHS Seastrom", "BRHS Sword of Twilight", "AACS Dendrobium", "AACS Judgements Bow", "BRHS Knight",
    ];
    const allShips = [
      ...transportShips,
      ...securityShips,
    ];

    // Captains
    const captainNames = [
      "DyslexicNerd", "Spartan", "Lightblade", "Roflnomish", 
      "BenjiNotorious", "zarainia", "Astol", "Venomnom", "BigDaddyTortuga", 
      "ItzProto", "Newt", "Xolion", "Bakes Kamuari", "LockEmUpJas", 
      "sadfish", "Efazer"
    ];

    // materials
    const materialList = [
      "Select Material", "Agricium", "Aluminium", "Aphorite", "Beryl", "Bexalite", "Borase", "Copper", "Corundum", "Diamond", "Dolivine", "Dyslexium", "Gold", "Hadanite", "Hephaestanite", "Inert materials", "Laranite", "Placeholder", "Spartanium", "Quantanium", "Quartz", "Taranite", "Tungsten", "Titanium"
    ];

    function clearFormFields() {

  document.getElementById("departureTime").value = "";
  document.getElementById("completionTime").value = "";
  document.getElementById("orderDuration").textContent = "";
  manifestLineCount = 1;
  renderManifestLines();
  const firstManifestRow = document.querySelector('.manifest-row');
  if (firstManifestRow) {
    firstManifestRow.querySelector('.manifest-scu').value = "";
    firstManifestRow.querySelector('.manifest-material').selectedIndex = 0;
    firstManifestRow.querySelector('.manifest-uec').value = "";
  }

  document.getElementById("totalSCUBox").textContent = "Total SCU: 0";

  document.getElementById("repairs").value = "0";
  document.getElementById("restock").value = "0";
  document.getElementById("quantumFuel").value = "0";
  document.getElementById("hydrogenFuel").value = "0";
  document.getElementById("crewCosts").value = "0";
  document.getElementById("totalUECBox").value = "0";

  document.getElementById("routeStart").value = "";
  document.getElementById("routeEnd").value = "";

  document.getElementById("startLocation").value = "";

  document.getElementById("notes").value = "";
  
  document.getElementById("discordSection").style.display = "none";
  hideCopyButton();
  
  const generateBtn = document.getElementById("generateBtn");
  if (generateBtn) {
    generateBtn.style.display = "inline-flex";
  }
  
  calculateFormProgress();
}

function showTab(tab) {
  const formTab = document.getElementById('formTab');
  const historyTab = document.getElementById('historyViewerTab');
  const transportTab = document.getElementById('transportTab');
  const viewerTab = document.getElementById('viewerTab');

    if (formTab && historyTab && transportTab && viewerTab) {
  formTab.style.display = 'none';
  historyTab.style.display = 'none';
  transportTab.style.display = 'none';
    if (tab === 'formTab') {
      formTab.style.display = 'block';
    } else if (tab === 'historyTab' || tab === 'historyViewerTab') {
      historyTab.style.display = 'block';
      if (typeof renderHistory === 'function') renderHistory();
      if (typeof renderViewer === 'function') renderViewer();
    } else if (tab === 'transportTab') {
      transportTab.style.display = 'block';
    } else if (tab === 'viewerTab') {
      if (typeof renderViewer === 'function') renderViewer();
    }
  }

  const formTabBtn = document.getElementById('formTabBtn');
  const historyTabBtn = document.getElementById('historyTabBtn');
  const transportTabBtn = document.getElementById('transportTabBtn');

  if (formTabBtn && historyTabBtn && transportTabBtn) {
    formTabBtn.style.background = tab === 'formTab' ? '#9d7523' : '#781d15';
    historyTabBtn.style.background = (tab === 'historyTab' || tab === 'historyViewerTab' || tab === 'viewerTab') ? '#9d7523' : '#781d15';
    transportTabBtn.style.background = tab === 'transportTab' ? '#9d7523' : '#781d15';

    formTabBtn.style.color = '#fff';
    historyTabBtn.style.color = '#fff';
    transportTabBtn.style.color = '#fff';

    formTabBtn.style.border = tab === 'formTab' ? '3px solid #000' : '3px solid transparent';
    historyTabBtn.style.border = (tab === 'historyTab' || tab === 'historyViewerTab' || tab === 'viewerTab') ? '3px solid #000' : '3px solid transparent';
    transportTabBtn.style.border = tab === 'transportTab' ? '3px solid #000' : '3px solid transparent';
  }
}
window.showTab = showTab;

window.addEventListener("DOMContentLoaded", function() {
  showTab('formTab');
  const totalUECInput = document.getElementById("totalUECBox");
  if (totalUECInput) totalUECInput.value = "0";
  resizeAnnouncementsContent();
});
function resizeAnnouncementsContent() {
  const announcementsContent = document.getElementById('announcementsContent');
  const formCompletionCard = document.getElementById('completionStep');
  
  if (announcementsContent && formCompletionCard) {
    announcementsContent.style.height = 'auto';
    announcementsContent.style.maxHeight = 'none';
    announcementsContent.style.overflow = 'visible';
    
    const contentRect = announcementsContent.getBoundingClientRect();
    const completionRect = formCompletionCard.getBoundingClientRect();
    
    if (contentRect.bottom > completionRect.bottom) {
      const maxHeight = completionRect.bottom - contentRect.top - 20;
      announcementsContent.style.height = maxHeight + 'px';
      announcementsContent.style.maxHeight = maxHeight + 'px';
      announcementsContent.style.overflow = 'auto';
    }
  }
}

window.addEventListener('resize', resizeAnnouncementsContent);

    function submitTransportRequest() {
      const statusDiv = document.getElementById('tr_status');
      if (!validateTransportRequest()) {
        return;
      }
      // Gather form data
      const form = document.getElementById('transportRequestForm');
      const formData = new FormData(form);
      // Add custom fields if needed
      if (document.getElementById('tr_orgNameOther')?.value) {
        formData.set('tr_orgName', document.getElementById('tr_orgNameOther').value);
      }
      if (document.getElementById('tr_requesterOther')?.value) {
        formData.set('tr_requester', document.getElementById('tr_requesterOther').value);
      }
      // Send to CGI endpoint
      fetch('/cgi-bin/save_request.py', {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(data => {
        if (statusDiv) {
          statusDiv.style.display = 'inline-block';
          statusDiv.style.color = '#2a7a2a';
          statusDiv.textContent = 'Request submitted ✓';
        }
        setTimeout(() => {
          clearTransportRequestForm();
        }, 900);
        setTimeout(() => {
          if (statusDiv) statusDiv.style.display = 'none';
        }, 3000);
      })
      .catch(e => {
        if (statusDiv) {
          statusDiv.style.display = 'inline-block';
          statusDiv.style.color = '#a33';
          statusDiv.textContent = 'Error saving request';
        }
        console.error('Failed to save transport request', e);
      });
    }

    function clearTransportRequestForm() {
      ['tr_orgName','tr_requester','tr_securityNeeded','tr_pickup','tr_destination','tr_cargoDetails','tr_requiredSCU','tr_priority'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
        if (el) el.classList.remove('error');
      });
      const statusDiv = document.getElementById('tr_status');
      if (statusDiv) { statusDiv.style.display = 'none'; }
      const notif = document.getElementById('notificationOverlay');
      if (notif) notif.remove();
    }

  window.toggleCustomOrg = function(selectEl) {
      const other = document.getElementById('tr_orgNameOther');
      if (!other) return;
      if (selectEl && selectEl.value === '__other__') {
        other.style.display = 'block';
        other.focus();
      } else {
        other.style.display = 'none';
        other.value = '';
      }
    }

  window.toggleCustomRequester = function(selectEl) {
      const other = document.getElementById('tr_requesterOther');
      if (!other) return;
      if (selectEl && selectEl.value === '__other__') {
        other.style.display = 'block';
        other.focus();
      } else {
        other.style.display = 'none';
        other.value = '';
      }
    }

    function validateTransportRequest() {
      ['tr_orgName','tr_requester','tr_securityNeeded','tr_pickup','tr_destination','tr_cargoDetails','tr_requiredSCU','tr_priority'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('error');
      });

      const errors = [];
      let firstEl = null;

      const requiredIds = [
        {id: 'tr_orgName', label: 'Organization'},
        {id: 'tr_requester', label: 'Requester Name'},
        {id: 'tr_securityNeeded', label: 'Security Ships needed?'},
        {id: 'tr_pickup', label: 'Start Destination'},
        {id: 'tr_destination', label: 'End Destination'},
        {id: 'tr_cargoDetails', label: 'Cargo Details'},
        {id: 'tr_requiredSCU', label: 'SCU Total'},
        {id: 'tr_priority', label: 'Priority'}
      ];

      requiredIds.forEach(item => {
        const el = document.getElementById(item.id);
        const val = el ? (el.value || '').toString().trim() : '';
        let invalid = false;
        if (!val) invalid = true;
        if (invalid) {
          if (el) el.classList.add('error');
          errors.push(item.label + ' is required');
          if (!firstEl && el) firstEl = el;
        }
      });

      const pickupEl = document.getElementById('tr_pickup');
      const destEl = document.getElementById('tr_destination');
      if (typeof locations !== 'undefined') {
        if (pickupEl && pickupEl.value && !locations.includes(pickupEl.value)) {
          pickupEl.classList.add('error');
          errors.push('Start Destination must be selected from the locations list');
          if (!firstEl) firstEl = pickupEl;
        }
        if (destEl && destEl.value && !locations.includes(destEl.value)) {
          destEl.classList.add('error');
          errors.push('End Destination must be selected from the locations list');
          if (!firstEl) firstEl = destEl;
        }
      }

      const scuEl = document.getElementById('tr_requiredSCU');
      if (scuEl) {
        const n = Number(scuEl.value);
        if (!Number.isFinite(n) || n < 0) {
          scuEl.classList.add('error');
          errors.push('SCU Total must be a number >= 0');
          if (!firstEl) firstEl = scuEl;
        }
      }

      if (errors.length > 0) {
  const msgHtml = '<strong>Please fix the following issues:</strong><br/><br/>' + errors.map(e => '• ' + e).join('<br/>');
  showNotificationOverlay(msgHtml, 'warning');
        if (firstEl) {
          try { firstEl.focus(); firstEl.scrollIntoView({behavior: 'smooth', block: 'center'}); } catch (e) {}
        }
        return false;
      }

      return true;
    }

    function sendTransportRequestToDiscord() {
      const allRequests = JSON.parse(localStorage.getItem('transportRequests') || '[]');
      if (!allRequests || allRequests.length === 0) {
        showNotificationOverlay('<strong>No transport request found!</strong><br/><br/>Please submit a request first before sending to Discord.', 'warning');
        return;
      }

      const transportData = allRequests[0];
      
      const statusDiv = document.getElementById('tr_status');
      if (statusDiv) {
        statusDiv.style.display = 'inline-block';
        statusDiv.style.color = '#555';
        statusDiv.textContent = 'Sending to Discord...';
      }

      const payload = {
        transportData: transportData,
        channelId: 1391877534215438398
      };

      fetch('/send-transport-request', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(errorData => {
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
          });
        }
        return response.json();
      })
      .then(data => {
        if (statusDiv) {
          statusDiv.style.display = 'inline-block';
          statusDiv.style.color = '#2a7a2a';
          statusDiv.textContent = 'Sent to Discord ✓';
        }
        console.log('✅ Transport request sent to Discord:', data);
        setTimeout(() => {
          if (statusDiv) statusDiv.style.display = 'none';
        }, 3000);
      })
      .catch(error => {
        if (statusDiv) {
          statusDiv.style.display = 'inline-block';
          statusDiv.style.color = '#d9534f';
          statusDiv.textContent = 'Error sending to Discord: ' + error.message;
        }
        console.error('❌ Error sending to Discord:', error);
        showNotificationOverlay('<strong>Error sending to Discord:</strong><br/><br/>' + error.message, 'error');
      });
    }

    window.submitTransportRequest = submitTransportRequest;
    window.clearTransportRequestForm = clearTransportRequestForm;
    window.sendTransportRequestToDiscord = sendTransportRequestToDiscord;

    function renderViewer() {
      const container = document.getElementById('viewerContent');
      const status = document.getElementById('viewerStatus');
      if (status) { status.style.display = 'none'; }
      if (!container) return;

      const transport = JSON.parse(localStorage.getItem('transportRequests') || '[]');
      const history = JSON.parse(localStorage.getItem('discordHistory') || '[]');

      const sortBy = (document.getElementById('viewer_sort')?.value) || 'date_desc';
      const searchTerm = (document.getElementById('viewer_search')?.value || '').toString().trim().toLowerCase();

      let filtered = (transport || []).slice();
      if (searchTerm) {
        filtered = filtered.filter(r => {
          const route = ((r.start || '') + ' ' + (r.end || '')).toLowerCase();
          return (r.requestNumber || '').toLowerCase().includes(searchTerm) ||
                 (r.orgName || '').toLowerCase().includes(searchTerm) ||
                 (r.requester || '').toLowerCase().includes(searchTerm) ||
                 route.includes(searchTerm);
        });
      }

      const priorityOrder = { 'Emergency': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
      const statusOrder = { 'New': 4, 'Assigned': 3, 'Completed': 2, 'Declined': 1 };
      if (sortBy === 'date_desc') {
        filtered.sort((a,b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
      } else if (sortBy === 'date_asc') {
        filtered.sort((a,b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
      } else if (sortBy === 'priority') {
        filtered.sort((a,b) => (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0));
      } else if (sortBy === 'status') {
        filtered.sort((a,b) => (statusOrder[b.status] || 0) - (statusOrder[a.status] || 0));
      }

      container.innerHTML = '<div style="margin-bottom:12px;color:#333;font-weight:bold;">Transport Requests: ' + filtered.length + '</div>';

      const listDiv = document.createElement('div');
      listDiv.style.display = 'grid';
      listDiv.style.gridTemplateColumns = '1fr';
      listDiv.style.gap = '10px';

      if (!filtered || filtered.length === 0) {
        listDiv.innerHTML = '<div style="padding:12px;background:#fff;border:1px solid #ccc;border-radius:6px;">No transport requests found.</div>';
      } else {
        filtered.forEach(req => {
          const card = document.createElement('div');
          card.style.padding = '12px';
          card.style.position = 'relative';
          card.style.border = '1px solid #9d7523';
          card.style.borderRadius = '8px';
          card.style.background = '#fff';
          card.style.display = 'flex';
          card.style.justifyContent = 'space-between';
          card.style.alignItems = 'center';

          const left = document.createElement('div');
          left.style.flex = '1';
          const displayOrg = req.orgName || 'Unknown Org';
          const displayPriority = req.priority || 'Medium';
          let priorityClass = 'prio-Medium';
          if (displayPriority === 'Emergency') priorityClass = 'prio-Emergency';
          else if (displayPriority === 'High') priorityClass = 'prio-High';
          else if (displayPriority === 'Low') priorityClass = 'prio-Low';

          const displayStatus = (req.status || 'New');
          let statusClass = 'status-New';
          if (displayStatus === 'Assigned') statusClass = 'status-Assigned';
          else if (displayStatus === 'Completed') statusClass = 'status-Completed';
          else if (displayStatus === 'Declined') statusClass = 'status-Declined';

          const requestIdAndPriority = req.requestNumber ? '<div style="font-size:0.95em;color:#0b5; font-weight:700; margin-bottom:6px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">' +
            '<span>Request ID: ' + req.requestNumber + '</span>' +
            '<span class="priority-badge ' + priorityClass + '">' + displayPriority + '</span>' +
            '<span class="status-badge ' + statusClass + '">' + displayStatus + '</span>' +
            '</div>' : '';

          const orgLine = '<div style="font-weight:700;color:#781d15;font-size:1.05em;margin-bottom:6px;">' + displayOrg + ' Transport Request</div>';

          left.innerHTML = requestIdAndPriority + orgLine +
            '<div style="font-size:1.2em;color:#333;margin:8px 0;">→</div>' +
            '<div style="font-size:0.95em;color:#333;"><strong>Details:</strong> ' + (req.cargoDetails ? req.cargoDetails : '<em>No details</em>') + '</div>';

          if (req.assigned) {
            if (req.assigned.shipAssignments && req.assigned.shipAssignments.length) {
              let html = '<div id="assigned_block_' + req.id + '" style="margin-top:8px;font-size:0.9em;color:#155724;background:#e6f4ea;padding:8px;border-radius:6px;">';
              req.assigned.shipAssignments.forEach(sa => {
                html += '<div style="margin-bottom:6px;"><strong>' + (sa.ship || 'Ship') + ':</strong> ' + (sa.captain ? ('Captain: ' + sa.captain) : 'No captain');
                if (sa.crew && sa.crew.length) html += '<br/><em>Crew:</em> ' + sa.crew.join(', ');
                html += '</div>';
              });
              if (req.assigned.securityShips && req.assigned.securityShips.length) {
                html += '<div style="margin-top:6px;"><strong>Security Ships:</strong> ' + req.assigned.securityShips.join(', ') + '</div>';
              }
              html += '</div>';
              left.innerHTML += html;
            } else {
              const assignedCargo = req.assigned.ships && req.assigned.ships.length ? req.assigned.ships.join(', ') : '';
              const assignedSecurity = req.assigned.securityShips && req.assigned.securityShips.length ? req.assigned.securityShips.join(', ') : '';
              const assignedCaps = req.assigned.captains && req.assigned.captains.length ? req.assigned.captains.join(', ') : '';
              left.innerHTML += '<div style="margin-top:8px;font-size:0.85em;color:#155724;background:#e6f4ea;padding:8px;border-radius:6px;">' +
                (assignedCargo ? ('<strong>Cargo Ships:</strong> ' + assignedCargo + '<br/>') : '') +
                (assignedSecurity ? ('<strong>Security Ships:</strong> ' + assignedSecurity + '<br/>') : '') +
                (assignedCaps ? ('<strong>Crew:</strong> ' + assignedCaps) : '') +
              '</div>';
            }
          }

          left.innerHTML += '<div style="margin-top:8px;font-size:0.9em;color:#333;">' +
            '<strong>Org:</strong> ' + (req.orgName || '-') + '  |  ' +
            '<strong>Requester:</strong> ' + (req.requester || '-') + '  |  ' +
            '<strong>Security:</strong> ' + (req.securityNeeded || 'No') +
          '</div>' +
          '<div style="font-size:0.9em;color:#333;"><strong>Route:</strong> ' + (req.start || '') + ' → ' + (req.end || '') + '</div>' +
          '<div style="font-size:0.9em;color:#333;margin-top:6px;"><strong>SCU:</strong> ' + (req.requiredSCU ? req.requiredSCU.toLocaleString() : '0') + '</div>';

          if ((req.status || '') === 'Declined' && req.declineReason) {
            left.innerHTML += '<div style="margin-top:8px;color:#721c24;background:#f8d7da;padding:8px;border-radius:6px;"><strong>Decline Reason:</strong> ' + (req.declineReason || '') + '</div>';
          }

          const right = document.createElement('div');
          right.style.display = 'flex';
          right.style.gap = '8px';
          right.style.alignItems = 'center';

          const ts = document.createElement('div');
          ts.style.position = 'absolute';
          ts.style.right = '8px';
          ts.style.top = '8px';
          ts.style.fontSize = '0.75em';
          ts.style.color = '#666';
          ts.style.textAlign = 'right';
          ts.style.zIndex = '1100';
          ts.textContent = new Date(req.timestamp).toLocaleString();

          const statusBadge = document.createElement('div');
          statusBadge.style.fontSize = '0.85em';
          statusBadge.style.padding = '6px 8px';
          statusBadge.style.borderRadius = '6px';
          statusBadge.style.background = req.status === 'Assigned' ? '#fff3cd' : (req.status === 'Completed' ? '#d4edda' : (req.status === 'Declined' ? '#f8d7da' : '#e9ecef'));
          statusBadge.style.color = '#333';
          statusBadge.textContent = req.status || 'New';

          const declinedBtn = document.createElement('button');
          declinedBtn.textContent = 'Declined';
          declinedBtn.style.background = '#f0ad4e';
          declinedBtn.style.color = '#fff';
          declinedBtn.style.border = 'none';
          declinedBtn.style.padding = '6px 10px';
          declinedBtn.style.borderRadius = '6px';
          declinedBtn.style.cursor = 'pointer';
          declinedBtn.onclick = function() {
            const reason = prompt('Please enter a reason for declining this request:');
            if (reason === null) return; // user cancelled
            updateTransportStatus(req.id, 'Declined', { declineReason: reason });
          };

          const assignedBtn = document.createElement('button');
          assignedBtn.textContent = 'Assign';
          assignedBtn.style.background = '#17a2b8';
          assignedBtn.style.color = '#fff';
          assignedBtn.style.border = 'none';
          assignedBtn.style.padding = '6px 10px';
          assignedBtn.style.borderRadius = '6px';
          assignedBtn.style.cursor = 'pointer';
          assignedBtn.onclick = function() { showAssignUI(req, card); };

          const completedBtn = document.createElement('button');
          completedBtn.textContent = 'Completed';
          completedBtn.style.background = '#28a745';
          completedBtn.style.color = '#fff';
          completedBtn.style.border = 'none';
          completedBtn.style.padding = '6px 10px';
          completedBtn.style.borderRadius = '6px';
          completedBtn.style.cursor = 'pointer';
          completedBtn.onclick = function() { updateTransportStatus(req.id, 'Completed'); };

          const archiveBtn = document.createElement('button');
          archiveBtn.textContent = 'Archive';
          archiveBtn.style.background = '#6c757d';
          archiveBtn.style.color = '#fff';
          archiveBtn.style.border = 'none';
          archiveBtn.style.padding = '6px 10px';
          archiveBtn.style.borderRadius = '6px';
          archiveBtn.style.cursor = 'pointer';
          archiveBtn.title = 'Move this request to the archive';
          archiveBtn.onclick = function() { archiveTransportRequest(req.id); };
          card.appendChild(ts);
          right.appendChild(statusBadge);
          right.appendChild(declinedBtn);
          right.appendChild(assignedBtn);
          right.appendChild(completedBtn);
          if ((req.status || '') === 'Completed' || (req.status || '') === 'Declined') {
            right.appendChild(archiveBtn);
          }

          card.appendChild(left);
          card.appendChild(right);

          listDiv.appendChild(card);
        });
      }

      container.appendChild(listDiv);
    }

    window.renderViewer = renderViewer;

    function updateTransportStatus(id, status, assignedData) {
      try {
        let transport = JSON.parse(localStorage.getItem('transportRequests') || '[]');
        transport = transport.map(t => {
          if (t.id === id) {
            t.status = status;
            if (assignedData) {
              if (assignedData.shipAssignments || assignedData.ships || assignedData.securityShips || assignedData.assignedAt) {
                t.assigned = assignedData;
              }
              if (assignedData.declineReason !== undefined) {
                t.declineReason = assignedData.declineReason;
              }
            }
          }
          return t;
        });
        localStorage.setItem('transportRequests', JSON.stringify(transport));
        renderViewer();
      } catch (e) {
        console.error('Failed to update transport status', e);
      }
    }

    function archiveTransportRequest(id) {
      try {
        const all = JSON.parse(localStorage.getItem('transportRequests') || '[]');
        const idx = all.findIndex(t => t.id === id);
        if (idx === -1) {
          showNotificationOverlay('<strong>Request not found</strong>', 'warning');
          return;
        }
        const [item] = all.splice(idx, 1);
        item.archivedAt = new Date().toISOString();
        const archived = JSON.parse(localStorage.getItem('archivedTransportRequests') || '[]');
        archived.unshift(item);
        localStorage.setItem('archivedTransportRequests', JSON.stringify(archived));
        localStorage.setItem('transportRequests', JSON.stringify(all));
        renderViewer();
        showNotificationOverlay('<strong>Archived</strong><br/>Request moved to archive.', 'success');
      } catch (e) {
        console.error('Failed to archive transport request', e);
        showNotificationOverlay('<strong>Archive failed</strong><br/>' + (e && e.message ? e.message : ''), 'error');
      }
    }

    function showAssignUI(req, card) {
      if (card._assigning) return;
      card._assigning = true;

      const assignDiv = document.createElement('div');
      assignDiv.style.marginTop = '8px';
      assignDiv.style.padding = '8px';
      assignDiv.style.borderTop = '1px dashed #ccc';

      const shipLabel = document.createElement('label');
      shipLabel.textContent = 'Assign Ships (type to filter, click to add):';
      shipLabel.style.display = 'block';
      shipLabel.style.fontSize = '0.9em';
      shipLabel.style.marginBottom = '4px';

      const shipInputId = 'assign_ship_input_' + req.id;
      const shipListId = shipInputId + 'List';
      const shipWrapper = document.createElement('div');
      shipWrapper.className = 'searchable-dropdown';
      const shipInput = document.createElement('input');
      shipInput.type = 'text';
      shipInput.id = shipInputId;
      shipInput.placeholder = 'Type or click to add ships';
      shipInput.autocomplete = 'off';
      shipWrapper.appendChild(shipInput);
      const shipList = document.createElement('div');
      shipList.className = 'dropdown-list';
      shipList.id = shipListId;
      shipWrapper.appendChild(shipList);



      const actionRow = document.createElement('div');
      actionRow.style.marginTop = '8px';
      actionRow.style.display = 'flex';
      actionRow.style.gap = '8px';

      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = 'Confirm Assign';
      confirmBtn.style.background = '#17a2b8'; confirmBtn.style.color = '#fff'; confirmBtn.style.border='none'; confirmBtn.style.padding='6px 10px'; confirmBtn.style.borderRadius='6px';

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.style.background = '#eee'; cancelBtn.style.color = '#333'; cancelBtn.style.border='1px solid #ccc'; cancelBtn.style.padding='6px 10px'; cancelBtn.style.borderRadius='6px';
      confirmBtn.onclick = function() {
        const selectedShips = shipInput.selectedItems ? Array.from(shipInput.selectedItems) : [];
        const secEl = document.getElementById('assign_sec_ship_input_' + req.id);
        const selectedSecurity = secEl && secEl.selectedItems ? Array.from(secEl.selectedItems) : [];

        const errors = [];
        if ((!selectedShips || selectedShips.length === 0) && (!selectedSecurity || selectedSecurity.length === 0)) {
          errors.push('No ships selected. Please select at least one cargo or security ship.');
        }

        selectedShips.forEach(ship => {
          const shipId = ship.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'');
          const capInputIdLocal = 'assign_captain_' + req.id + '_' + shipId;
          const capEl = document.getElementById(capInputIdLocal);
          const captain = capEl ? (capEl.value || '').trim() : '';
          const crewAmountEl = document.getElementById('assign_crew_amount_' + req.id + '_' + shipId);
          const crewCount = crewAmountEl ? (parseInt(crewAmountEl.value,10) || 0) : 0;
          if (crewCount > 0 && !captain) {
            errors.push('Captain is required for ' + ship + ' when crew > 0.');
            if (capEl) capEl.classList.add('error');
          }
        });

        selectedSecurity.forEach(ship => {
          const shipId = 'SEC_' + ship.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'');
          const capInputIdLocal = 'assign_captain_' + req.id + '_' + shipId;
          const capEl = document.getElementById(capInputIdLocal);
          const captain = capEl ? (capEl.value || '').trim() : '';
          if (!captain) {
            errors.push('Security ship "' + ship + '" requires a captain.');
            if (capEl) capEl.classList.add('error');
          }
        });

        if (errors.length > 0) {
          const msg = '<strong>Please fix the following assignment issues:</strong><br/><br/>' + errors.map(e => '• ' + e).join('<br/>');
          showNotificationOverlay(msg, 'warning');
          return;
        }

        const shipAssignments = [];
        selectedShips.forEach(ship => {
          const shipId = ship.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'');
          const capInputIdLocal = 'assign_captain_' + req.id + '_' + shipId;
          const capEl = document.getElementById(capInputIdLocal);
          const captain = capEl ? (capEl.value || '').trim() : '';
          const crewAmountEl = document.getElementById('assign_crew_amount_' + req.id + '_' + shipId);
          const crewCount = crewAmountEl ? (parseInt(crewAmountEl.value,10) || 0) : 0;
          const crewNames = [];
          for (let i=1;i<=crewCount;i++){
            const ci = document.getElementById('assign_crew_' + req.id + '_' + shipId + '_' + i);
            if (ci && ci.value && ci.value.trim()) crewNames.push(ci.value.trim());
          }
          shipAssignments.push({ ship: ship, captain: captain, crew: crewNames });
        });


        if (selectedSecurity && selectedSecurity.length) {
          selectedSecurity.forEach(ship => {
            const shipId = 'SEC_' + ship.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'');
            const capInputIdLocal = 'assign_captain_' + req.id + '_' + shipId;
            const capEl = document.getElementById(capInputIdLocal);
            const captain = capEl ? (capEl.value || '').trim() : '';
            const crewAmountEl = document.getElementById('assign_crew_amount_' + req.id + '_' + shipId);
            const crewCount = crewAmountEl ? (parseInt(crewAmountEl.value,10) || 0) : 0;
            const crewNames = [];
            for (let i=1;i<=crewCount;i++){
              const ci = document.getElementById('assign_crew_' + req.id + '_' + shipId + '_' + i);
              if (ci && ci.value && ci.value.trim()) crewNames.push(ci.value.trim());
            }
            shipAssignments.push({ ship: ship, captain: captain, crew: crewNames, security: true });
          });
        }

        updateTransportStatus(req.id, 'Assigned', { ships: selectedShips, shipAssignments: shipAssignments, securityShips: selectedSecurity, assignedAt: new Date().toISOString() });
        assignDiv.remove();
        card._assigning = false;
      };
      cancelBtn.onclick = function() { assignDiv.remove(); card._assigning = false; };

  actionRow.appendChild(confirmBtn);
  actionRow.appendChild(cancelBtn);

  assignDiv.appendChild(shipLabel);
  assignDiv.appendChild(shipWrapper);
  if ((req.securityNeeded || '').toString().toLowerCase() === 'yes') {
    const secLabel = document.createElement('label');
    secLabel.textContent = 'Assign Security Ships (type to filter, click to add):';
    secLabel.style.display = 'block';
    secLabel.style.fontSize = '0.9em';
    secLabel.style.margin = '8px 0 4px 0';

    const secInputId = 'assign_sec_ship_input_' + req.id;
    const secListId = secInputId + 'List';
    const secWrapper = document.createElement('div');
    secWrapper.className = 'searchable-dropdown';
    const secInput = document.createElement('input');
    secInput.type = 'text';
    secInput.id = secInputId;
    secInput.placeholder = 'Type or click to add security ships';
    secInput.autocomplete = 'off';
    secWrapper.appendChild(secInput);
    const secList = document.createElement('div');
    secList.className = 'dropdown-list';
    secList.id = secListId;
    secWrapper.appendChild(secList);

    assignDiv.appendChild(secLabel);
    assignDiv.appendChild(secWrapper);
  }

  assignDiv.appendChild(actionRow);

  card.appendChild(assignDiv);
  try {
    createMultiSearchableDropdown(shipInputId, shipListId, transportShips);
    shipInput.addEventListener('click', () => { if (shipInput.showDropdown) shipInput.showDropdown(); });
  } catch (e) { console.warn('Failed to init ship multi-dropdown', e); }
  try {
    const secInputEl = document.getElementById('assign_sec_ship_input_' + req.id);
    if (secInputEl) {
      createMultiSearchableDropdown('assign_sec_ship_input_' + req.id, 'assign_sec_ship_input_' + req.id + 'List', securityShips);
      secInputEl.addEventListener('click', () => { if (secInputEl.showDropdown) secInputEl.showDropdown(); });
    }
  } catch (e) { console.warn('Failed to init security multi-dropdown', e); }
  const perShipContainerId = 'assign_ships_container_' + req.id;
  let perShipContainer = document.getElementById(perShipContainerId);
  if (!perShipContainer) {
    perShipContainer = document.createElement('div');
    perShipContainer.id = perShipContainerId;
    perShipContainer.style.marginTop = '8px';
    perShipContainer.style.display = 'block';
    perShipContainer.style.width = '100%';
    assignDiv.insertBefore(perShipContainer, actionRow);
  }

  function sanitizeId(name) { return name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, ''); }

  function openModalForShip(ship, isSecurity) {
    const shipKey = (isSecurity ? 'SEC_' : '') + sanitizeId(ship);
    const holderId = 'assign_inputs_holder_' + req.id + '_' + shipKey;
    if (document.getElementById(holderId)) return;

    const modalId = 'assign_ship_modal_' + req.id + '_' + shipKey;
    if (document.getElementById(modalId)) {
      document.getElementById(modalId).style.display = 'flex';
      return;
    }

    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'assignment-modal-backdrop';

    const panel = document.createElement('div');
    panel.className = 'assignment-modal-panel';

    const title = document.createElement('h3');
    title.textContent = (isSecurity ? 'Security Ship' : 'Cargo Ship') + ' Assignment — ' + ship;
    title.style.marginTop = '0';
    panel.appendChild(title);

    const capInputIdLocal = 'assign_captain_' + req.id + '_' + shipKey;
    const capListIdLocal = capInputIdLocal + '_List';
    let capInputLocal = document.getElementById(capInputIdLocal);
    let capListLocal = document.getElementById(capListIdLocal);
    if (!capInputLocal) {
      capInputLocal = document.createElement('input');
      capInputLocal.type = 'text'; capInputLocal.id = capInputIdLocal; capInputLocal.placeholder = 'Click to select captain...'; capInputLocal.autocomplete='off';
      capListLocal = document.createElement('div'); capListLocal.className = 'dropdown-list'; capListLocal.id = capListIdLocal;
      
      // Restore captain value from saved summary if it exists
      const summaryId = 'assigned_summary_' + req.id + '_' + shipKey;
      const summary = document.getElementById(summaryId);
      if (summary && summary.dataset.captainValue) {
        capInputLocal.value = summary.dataset.captainValue;
      }
    }
    const capLabelEl = document.createElement('div'); capLabelEl.textContent = 'Captain:'; capLabelEl.style.fontWeight = '700'; capLabelEl.style.marginTop = '8px';
    panel.appendChild(capLabelEl);
    const capWrap = document.createElement('div'); capWrap.className = 'searchable-dropdown'; capWrap.appendChild(capInputLocal); capWrap.appendChild(capListLocal);
    panel.appendChild(capWrap);

    const crewLabelEl = document.createElement('div'); crewLabelEl.textContent = 'Crew Amount:'; crewLabelEl.style.fontWeight = '700'; crewLabelEl.style.marginTop = '12px';
    panel.appendChild(crewLabelEl);
    let crewInput = document.getElementById('assign_crew_amount_' + req.id + '_' + shipKey);
    if (!crewInput) {
      crewInput = document.createElement('input');
      crewInput.type = 'number'; crewInput.min='0'; crewInput.max='20'; crewInput.step='1'; crewInput.value='0'; crewInput.id = 'assign_crew_amount_' + req.id + '_' + shipKey;
      
      // Restore crew count from saved summary if it exists
      const summaryId = 'assigned_summary_' + req.id + '_' + shipKey;
      const summary = document.getElementById(summaryId);
      if (summary && summary.dataset.crewCount) {
        crewInput.value = summary.dataset.crewCount;
      }
    }
    crewInput.style.width = '120px'; crewInput.style.marginTop = '6px';
    panel.appendChild(crewInput);

    const crewNamesContainer = document.getElementById('assign_crew_names_' + req.id + '_' + shipKey) || document.createElement('div');
    crewNamesContainer.id = 'assign_crew_names_' + req.id + '_' + shipKey;
    crewNamesContainer.style.marginTop = '10px';
    panel.appendChild(crewNamesContainer);

    function renderCrewNames() {
      const n = parseInt(crewInput.value,10) || 0;
      crewNamesContainer.innerHTML = '';
      for (let i=1;i<=n;i++){
        let ci = document.getElementById('assign_crew_' + req.id + '_' + shipKey + '_' + i);
        if (!ci) {
          ci = document.createElement('input'); ci.type='text'; ci.placeholder = 'Crew name ' + i; ci.id = 'assign_crew_' + req.id + '_' + shipKey + '_' + i; ci.style.display='block'; ci.style.marginTop='6px'; ci.style.width='100%';
        }
        crewNamesContainer.appendChild(ci);
      }
    }
    renderCrewNames();
    crewInput.addEventListener('input', renderCrewNames);

    const footer = document.createElement('div'); footer.style.display='flex'; footer.style.justifyContent='flex-end'; footer.style.gap='8px'; footer.style.marginTop='14px';
    const saveBtn = document.createElement('button'); saveBtn.textContent = 'Save'; saveBtn.style.background = '#17a2b8'; saveBtn.style.color='#fff'; saveBtn.style.padding='8px 12px'; saveBtn.style.border='none'; saveBtn.style.borderRadius='6px';
    const cancelBtnModal = document.createElement('button'); cancelBtnModal.textContent = 'Cancel'; cancelBtnModal.style.padding='8px 12px'; cancelBtnModal.style.border='1px solid #ccc'; cancelBtnModal.style.borderRadius='6px';
    footer.appendChild(cancelBtnModal); footer.appendChild(saveBtn); panel.appendChild(footer);

    modal.appendChild(panel);
    document.body.appendChild(modal);

    try { initializeCaptainDropdown(capInputLocal, capListLocal, ship); } catch (e) { console.warn('Failed to init captain dropdown in modal', e); }

    cancelBtnModal.onclick = function() { modal.remove(); };
    saveBtn.onclick = function() {
      // Capture captain and crew values BEFORE moving DOM elements
      const capNow = (capInputLocal && capInputLocal.value) ? capInputLocal.value.trim() : '';
      const crewNow = (crewInput && crewInput.value) ? parseInt(crewInput.value, 10) : 0;
      
      const holder = document.createElement('div');
      holder.id = holderId;
      holder.style.display = 'none';

      try {
        if (capInputLocal.parentNode && capInputLocal.parentNode !== holder) holder.appendChild(capInputLocal);
        if (capListLocal && capListLocal.parentNode && capListLocal.parentNode !== holder) holder.appendChild(capListLocal);
        if (crewInput.parentNode && crewInput.parentNode !== holder) holder.appendChild(crewInput);
        if (crewNamesContainer.parentNode && crewNamesContainer.parentNode !== holder) holder.appendChild(crewNamesContainer);
      } catch (e) { /* ignore */ }

      const summaryId = 'assigned_summary_' + req.id + '_' + shipKey;
      let summary = document.getElementById(summaryId);
      if (!summary) {
        summary = document.createElement('div');
        summary.id = summaryId;
        summary.style.border = '1px solid #ddd';
        summary.style.padding = '8px';
        summary.style.borderRadius = '6px';
        summary.style.marginBottom = '6px';
        summary.style.background = '#f8f9f9';
        summary.style.display = 'flex';
        summary.style.justifyContent = 'space-between';
        summary.style.alignItems = 'center';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.flexDirection = 'column';
        left.style.flex = '1';
        const nameLine = document.createElement('div'); nameLine.style.fontWeight = '700'; nameLine.textContent = ship; left.appendChild(nameLine);
        const metaLine = document.createElement('div'); metaLine.style.fontSize='0.9em'; metaLine.style.color='#333'; metaLine.id = summaryId + '_meta'; left.appendChild(metaLine);
        summary.appendChild(left);

        const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
        const removeBtn = document.createElement('button'); removeBtn.textContent = 'Remove'; removeBtn.style.background='#ed4245'; removeBtn.style.color='#fff'; removeBtn.style.border='none'; removeBtn.style.padding='6px 8px'; removeBtn.style.borderRadius='6px';
        removeBtn.onclick = function() {
          if (shipInput.selectedItems) shipInput.selectedItems = shipInput.selectedItems.filter(x=>x!==ship);
          const chipContainer = document.getElementById(shipInputId + '_chips'); if (chipContainer) chipContainer.querySelectorAll('.chip').forEach(ch => { if (ch.textContent === ship) ch.remove(); });
        
          const h = document.getElementById(holderId); if (h) h.remove();
          const s = document.getElementById(summaryId); if (s) s.remove();
        };
        right.appendChild(removeBtn);
        summary.appendChild(right);
      }

      const metaEl = document.getElementById(summaryId + '_meta');
      
      // Store captain value in data attribute for persistence
      summary.dataset.captainValue = capNow;
      summary.dataset.crewCount = crewNow;
      
      if (metaEl) metaEl.textContent = (capNow ? ('Captain: ' + capNow) : 'No captain') + (crewNow ? ('  •  Crew: ' + crewNow) : '');

      perShipContainer.appendChild(summary);
      perShipContainer.appendChild(holder);

      modal.remove();
    };
  }

  function renderPerShipAssignments() {
    // Query for all existing summaries and holders BEFORE clearing
    const summaries = Array.from(document.querySelectorAll('[id^="assigned_summary_' + req.id + '_"]'));
    const holders = Array.from(document.querySelectorAll('[id^="assign_inputs_holder_' + req.id + '_"]'));
    
    if (holders.length === 0) {
      perShipContainer.innerHTML = '<div style="font-size:0.9em;color:#666;margin-top:6px;">No ships assigned yet — select a ship to open the assignment popup.</div>';
      return;
    }
    
    // Clear only the children, don't use innerHTML to preserve DOM references
    while (perShipContainer.firstChild) {
      perShipContainer.removeChild(perShipContainer.firstChild);
    }
    
    // Re-add summaries with their data
    summaries.forEach(summary => {
      const metaEl = summary.querySelector('[id$="_meta"]');
      if (metaEl && summary.dataset.captainValue !== undefined) {
        const capNow = summary.dataset.captainValue || '';
        const crewNow = summary.dataset.crewCount || 0;
        metaEl.textContent = (capNow ? ('Captain: ' + capNow) : 'No captain') + (crewNow ? ('  •  Crew: ' + crewNow) : '');
      }
      perShipContainer.appendChild(summary);
    });
    
    // Re-add holders
    holders.forEach(holder => {
      perShipContainer.appendChild(holder);
    });
  }

  renderPerShipAssignments();

  let lastSelectedObj = { cargo: shipInput.selectedItems ? Array.from(shipInput.selectedItems) : [], sec: (document.getElementById('assign_sec_ship_input_' + req.id) ? (document.getElementById('assign_sec_ship_input_' + req.id).selectedItems || []) : []) };
  let lastSelected = JSON.stringify(lastSelectedObj);
  const pollInterval = setInterval(() => {
    if (!document.body.contains(assignDiv)) { clearInterval(pollInterval); return; }
    const curCargo = shipInput.selectedItems ? Array.from(shipInput.selectedItems) : [];
    const secElNow = document.getElementById('assign_sec_ship_input_' + req.id);
    const curSec = secElNow && secElNow.selectedItems ? Array.from(secElNow.selectedItems) : [];
    const curObj = { cargo: curCargo, sec: curSec };
    const cur = JSON.stringify(curObj);
    if (cur !== lastSelected) {
      try {
        const prev = JSON.parse(lastSelected);
        const addedCargo = curCargo.filter(s => !(prev.cargo || []).includes(s));
        const removedCargo = (prev.cargo || []).filter(s => !curCargo.includes(s));
        const addedSec = curSec.filter(s => !(prev.sec || []).includes(s));
        const removedSec = (prev.sec || []).filter(s => !curSec.includes(s));

        addedCargo.forEach(s => { openModalForShip(s, false); });
        addedSec.forEach(s => { openModalForShip(s, true); });

        removedCargo.forEach(s => {
          const key = sanitizeId(s);
          const holder = document.getElementById('assign_inputs_holder_' + req.id + '_'+ key);
          if (holder) holder.remove();
          const summary = document.getElementById('assigned_summary_' + req.id + '_' + key);
          if (summary) summary.remove();
        });
        removedSec.forEach(s => {
          const key = 'SEC_' + sanitizeId(s);
          const holder = document.getElementById('assign_inputs_holder_' + req.id + '_'+ key);
          if (holder) holder.remove();
          const summary = document.getElementById('assigned_summary_' + req.id + '_' + key);
          if (summary) summary.remove();
        });
      } catch (e) { /* fallback */ }

      lastSelected = cur;
      renderPerShipAssignments();
    }
  }, 300);
    }

    function createMultiSearchableDropdown(inputId, listId, items) {
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      if (!input || !list) return;

      let chips = document.getElementById(inputId + '_chips');
      if (!chips) {
        chips = document.createElement('div');
        chips.id = inputId + '_chips';
        chips.className = 'chips-container';
        chips.style.display = 'flex';
        chips.style.flexWrap = 'wrap';
        chips.style.gap = '6px';
        chips.style.marginBottom = '6px';
        input.parentNode.insertBefore(chips, input);
      }

      let filtered = items.slice();
      input.selectedItems = input.selectedItems || [];

      function show() { list.classList.add('show'); }
      function hide() { setTimeout(()=>list.classList.remove('show'), 150); }

      function renderList() {
        list.innerHTML = '';
        filtered.forEach(it => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          const selected = input.selectedItems.includes(it);
          item.innerHTML = '<span style="flex:1;">' + it + '</span>' + (selected ? ' <strong style="color:#155724">✓</strong>' : '');
          item.addEventListener('click', () => {
            if (!input.selectedItems.includes(it)) {
              input.selectedItems.push(it);
            } else {
              input.selectedItems = input.selectedItems.filter(x=>x!==it);
            }
            updateChips();
            renderList();
            input.value = '';
            input.focus();
            show();
          });
          list.appendChild(item);
        });
      }

      function updateChips() {
        chips.innerHTML = '';
        input.selectedItems.forEach(val => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = val;
          chip.style.background = '#e6f4ea';
          chip.style.border = '1px solid #9d7523';
          chip.style.padding = '4px 8px';
          chip.style.borderRadius = '999px';
          chip.style.fontSize = '0.85em';
          chip.style.cursor = 'pointer';
          chip.addEventListener('click', () => {
            input.selectedItems = input.selectedItems.filter(x=>x!==val);
            updateChips();
            renderList();
          });
          chips.appendChild(chip);
        });
        if (input.selectedItems.length === 0) {
          input.placeholder = input.getAttribute('data-default-placeholder') || '';
        } else {
          input.placeholder = '';
        }
      }

      input.setAttribute('data-default-placeholder', input.placeholder || '');

      input.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        if (!term) filtered = items.filter(i=>!input.selectedItems.includes(i));
        else filtered = items.filter(i=>i.toLowerCase().includes(term) && !input.selectedItems.includes(i));
        renderList();
        show();
      });

      input.addEventListener('focus', () => { filtered = items.filter(i=>!input.selectedItems.includes(i)); renderList(); show(); });
  input.addEventListener('click', (e) => { e.stopPropagation(); filtered = items.filter(i=>!input.selectedItems.includes(i)); renderList(); show(); input.focus(); });
      input.addEventListener('blur', () => { hide(); });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && input.value === '') {
          input.selectedItems.pop();
          updateChips();
          renderList();
        }
      });

      renderList();
      updateChips();
      input.showDropdown = function() { filtered = items.filter(i=>!input.selectedItems.includes(i)); renderList(); show(); };
    }

    function populateLocationDropdown(id) {
      const inputId = id;
      const listId = id + 'List';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let selectedValue = '';
      let filteredLocations = locations;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterLocations(searchTerm) {
        const term = searchTerm.toLowerCase();
        return locations.filter(location => 
          location.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(locationsToShow) {
        list.innerHTML = '';
        locationsToShow.forEach(location => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = location;
          item.addEventListener('click', () => {
            input.value = location;
            selectedValue = location;
            hideDropdown();
            input.classList.remove('error');
            showGenerateButtonOnChange();
          });
          list.appendChild(item);
        });
      }

      renderDropdownItems(locations);
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredLocations = locations;
        } else {
          filteredLocations = filterLocations(searchTerm);
        }
        renderDropdownItems(filteredLocations);
        showDropdown();
        selectedValue = '';
        showGenerateButtonOnChange();
      });

      input.addEventListener('focus', () => {
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            showGenerateButtonOnChange();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      input.validateValue = function() {
        return locations.includes(input.value);
      };
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.searchable-dropdown')) {
        document.querySelectorAll('.dropdown-list').forEach(list => {
          list.classList.remove('show');
        });
      }
    });

    window.addEventListener('DOMContentLoaded', function() {
      const trRequester = document.getElementById('tr_requester');
      if (trRequester && typeof captainNames !== 'undefined') {
        captainNames.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          trRequester.appendChild(opt);
        });
  const otherOpt = document.createElement('option');
  otherOpt.value = '__other__';
  otherOpt.textContent = 'Other';
  trRequester.appendChild(otherOpt);
      }
    });

    function populateShipDropdown(category) {
      const inputId = 'shipName';
      const listId = 'shipNameList';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let ships = [];
      if (category === "Transport") {
        ships = transportShips;
      } else {
        ships = transportShips;
      }

      const shipsWithOther = [...ships, "Other"];

      let selectedValue = '';
      let filteredShips = shipsWithOther;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterShips(searchTerm) {
        const term = searchTerm.toLowerCase();
        return shipsWithOther.filter(ship => 
          ship.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(shipsToShow) {
        list.innerHTML = '';
        shipsToShow.forEach(ship => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = ship;
          item.addEventListener('click', () => {
            input.value = ship;
            selectedValue = ship;
            hideDropdown();
            input.classList.remove('error');
            toggleShipNameOther();
          });
          list.appendChild(item);
        });
      }

      renderDropdownItems(shipsWithOther);

      input.removeEventListener('input', input._shipInputHandler);
      input.removeEventListener('focus', input._shipFocusHandler);
      input.removeEventListener('blur', input._shipBlurHandler);
      input.removeEventListener('keydown', input._shipKeydownHandler);

      input._shipInputHandler = (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredShips = shipsWithOther;
        } else {
          filteredShips = filterShips(searchTerm);
        }
        renderDropdownItems(filteredShips);
        showDropdown();
        selectedValue = '';
      };
      input.addEventListener('input', input._shipInputHandler);

      input._shipFocusHandler = () => {
        showDropdown();
      };
      input.addEventListener('focus', input._shipFocusHandler);

      input._shipBlurHandler = () => {
        hideDropdown();
      };
      input.addEventListener('blur', input._shipBlurHandler);

      input._shipKeydownHandler = (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            toggleShipNameOther();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      };
      input.addEventListener('keydown', input._shipKeydownHandler);

      input.validateValue = function() {
        return shipsWithOther.includes(input.value);
      };
    }

    function populateCaptainDropdown(inputId = 'captainName') {
      const listId = inputId + 'List';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      const captainsWithOther = [...captainNames, "Other"];

      let selectedValue = '';
      let filteredCaptains = captainsWithOther;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterCaptains(searchTerm) {
        const term = searchTerm.toLowerCase();
        return captainsWithOther.filter(captain => 
          captain.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(captainsToShow) {
        list.innerHTML = '';
        captainsToShow.forEach(captain => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = captain;
          item.addEventListener('click', () => {
            input.value = captain;
            selectedValue = captain;
            hideDropdown();
            input.classList.remove('error');
            if (inputId === 'captainName') {
              toggleCaptainNameOther();
            }
            calculateFormProgress();
          });
          list.appendChild(item);
        });
      }

      renderDropdownItems(captainsWithOther);

      if (input.dataset.initialized === 'true') {
        return;
      }
      input.dataset.initialized = 'true';

      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredCaptains = captainsWithOther;
        } else {
          filteredCaptains = filterCaptains(searchTerm);
        }
        renderDropdownItems(filteredCaptains);
        showDropdown();
        selectedValue = '';
      });

      input.addEventListener('focus', () => {
        renderDropdownItems(filteredCaptains);
        showDropdown();
      });

      input.addEventListener('click', () => {
        renderDropdownItems(filteredCaptains);
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            if (inputId === 'captainName') {
              toggleCaptainNameOther();
            }
            calculateFormProgress();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      input.validateValue = function() {
        return captainsWithOther.includes(input.value);
      };
    }

    function populateSecurityShipsDropdown() {
      const inputId = 'securityShips';
      const listId = 'securityShipsList';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      const securityShipsWithOther = ["None", ...securityShips, "Other"];
      let selectedShips = ['None'];

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function updateInputDisplay() {
        if (selectedShips.length === 0) {
          input.value = '';
          input.placeholder = 'Select security ships...';
        } else if (selectedShips.length === 1) {
          input.value = selectedShips[0];
        } else {
          input.value = selectedShips.length + ' ships selected';
        }
      }

      function renderDropdownItems(shipsToShow) {
        list.innerHTML = '';
        renderShipItems(shipsToShow);
      }

      function renderShipItems(shipsToShow) {
        list.innerHTML = '';

        shipsToShow.forEach(ship => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = selectedShips.includes(ship);
          checkbox.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (ship === 'None') {
              if (selectedShips.includes('None')) {
                selectedShips = [];
              } else {
                selectedShips = ['None'];
              }
            } else {
              if (selectedShips.includes('None')) {
                selectedShips = selectedShips.filter(s => s !== 'None');
              }
              if (selectedShips.includes(ship)) {
                selectedShips = selectedShips.filter(s => s !== ship);
              } else {
                selectedShips.push(ship);
              }
            }
            updateInputDisplay();
            renderShipItems(shipsToShow);
            input.classList.remove('error');
            toggleSecurityShipsOther();
            const validShips = selectedShips.filter(s => s !== 'None' && s !== 'Other');
            updateSecurityCaptainDropdowns(validShips);
            calculateFormProgress();
          });
          
          const label = document.createElement('span');
          label.textContent = ship;
          
          item.appendChild(checkbox);
          item.appendChild(label);
          
          item.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (ship === 'None') {
              if (selectedShips.includes('None')) {
                selectedShips = [];
              } else {
                selectedShips = ['None'];
              }
            } else {
              if (selectedShips.includes('None')) {
                selectedShips = selectedShips.filter(s => s !== 'None');
              }
              
              if (selectedShips.includes(ship)) {
                selectedShips = selectedShips.filter(s => s !== ship);
              } else {
                selectedShips.push(ship);
              }
            }
            
            updateInputDisplay();
            renderShipItems(shipsToShow);
            input.classList.remove('error');
            toggleSecurityShipsOther();
            
            const validShips = selectedShips.filter(s => s !== 'None' && s !== 'Other');
            updateSecurityCaptainDropdowns(validShips);
            calculateFormProgress();
          });
          
          item.addEventListener('mouseenter', () => {
            if (!item.style.backgroundColor || item.style.backgroundColor === '') {
              item.style.backgroundColor = '#d0d0d0';
            }
          });
          
          item.addEventListener('mouseleave', () => {
            if (item.style.backgroundColor === 'rgb(208, 208, 208)') {
              item.style.backgroundColor = '';
            }
          });
          
          list.appendChild(item);
        });
      }

      renderDropdownItems(securityShipsWithOther);
      updateInputDisplay();

      if (input.dataset.initialized === 'true') {
        return;
      }
      input.dataset.initialized = 'true';

      input.addEventListener('focus', () => {
        renderDropdownItems(securityShipsWithOther);
        showDropdown();
      });

      input.addEventListener('click', (e) => {
        e.stopPropagation();
        renderDropdownItems(securityShipsWithOther);
        showDropdown();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideDropdown();
        } else if (e.key === 'Backspace' || e.key === 'Delete') {
          if (selectedShips.length > 0) {
            selectedShips = [];
            updateInputDisplay();
            updateSecurityCaptainDropdowns([]);
            calculateFormProgress();
          }
        } else {
          e.preventDefault();
        }
      });

      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          hideDropdown();
        }
      });

      input.validateValue = function() {
        return selectedShips.length > 0;
      };

      input.getSelectedShips = function() {
        return [...selectedShips];
      };
    }

    function toggleSecurityShipsOther() {
      const securityShipsInput = document.getElementById("securityShips");
      const otherDiv = document.getElementById("securityShipsOtherDiv");
      
      if (!securityShipsInput || !otherDiv) return;
      
      const selectedShips = securityShipsInput.getSelectedShips ? securityShipsInput.getSelectedShips() : [];
      const hasOther = selectedShips.includes("Other");
      
      if (hasOther) {
        otherDiv.style.display = "block";
      } else {
        otherDiv.style.display = "none";
      }
    }

    let manifestLineCount = 1;

    function createManifestLine(index) {
      const isLast = index === manifestLineCount;
      return '<div class="manifest-row" id="manifestRow' + index + '">' +
        '<label>SCU:</label>' +
        '<input type="number" min="0" step="1" class="manifest-scu" id="manifestSCU' + index + '">' +
        '<label>UEC:</label>' +
        '<input type="number" min="0" step="1" class="manifest-uec" id="manifestUEC' + index + '">' +
        '<label style="margin-left:6px;">Material:</label>' +
        '<select class="manifest-material" id="manifestMaterial' + index + '" style="width:auto;min-width:140px;max-width:220px;">' +
          materialList.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join("") +
        '</select>' +
        '<button type="button" onclick="removeManifestLine(' + index + ')" class="manifest-btn remove" title="Remove line">－</button>' +
        (isLast ? '<button type="button" onclick="addManifestLine()" class="manifest-btn add" title="Add line">＋</button>' : "") +
        '</div>';
    }

    function renderManifestLines() {
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }

      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      document.querySelectorAll('.manifest-scu, .manifest-uec').forEach(input => {
        input.addEventListener('input', updateManifestTotals);
      });
      updateManifestTotals();
    }
    function applyManifestPreset(type) {
      var preset = [];
      var totalUEC = 0;
      if (type === 'large') {
        preset = [
          { scu: 72, material: 'Corundum' },
          { scu: 36, material: 'Tungsten' },
          { scu: 72, material: 'Copper' }
        ];
        totalUEC = 101750;
      } else if (type === 'medium') {
        preset = [
          { scu: 19, material: 'Corundum' },
          { scu: 10, material: 'Tungsten' },
          { scu: 19, material: 'Copper' }
        ];
        totalUEC = 58400;
      } else if (type === 'small') {
        preset = [
          { scu: 2, material: 'Corundum' },
          { scu: 4, material: 'Tungsten' },
          { scu: 2, material: 'Copper' }
        ];
        totalUEC = 53250;
      }
      manifestLineCount = preset.length;
      renderManifestLines();
      var totalSCU = preset.reduce(function(sum, item) { return sum + item.scu; }, 0);
      var rows = document.querySelectorAll('.manifest-row');
      var uecAssigned = 0;
      for (var idx = 0; idx < preset.length; idx++) {
        var row = rows[idx];
        if (row) {
          row.querySelector('.manifest-scu').value = preset[idx].scu;
          row.querySelector('.manifest-material').value = preset[idx].material;
          var uec = Math.floor((preset[idx].scu / totalSCU) * totalUEC);
          if (idx === preset.length - 1) {
            uec = totalUEC - uecAssigned;
          }
          row.querySelector('.manifest-uec').value = uec;
          uecAssigned += uec;
        }
      }
      var totalUECInput = document.getElementById('totalUECBox');
      if (totalUECInput) totalUECInput.value = totalUEC;
      updateManifestTotals();
      var largeBtn = document.getElementById('presetLargeBtn');
      var mediumBtn = document.getElementById('presetMediumBtn');
      var smallBtn = document.getElementById('presetSmallBtn');
      if (largeBtn) largeBtn.classList.remove('selected');
      if (mediumBtn) mediumBtn.classList.remove('selected');
      if (smallBtn) smallBtn.classList.remove('selected');
      if (type === 'large' && largeBtn) largeBtn.classList.add('selected');
      if (type === 'medium' && mediumBtn) mediumBtn.classList.add('selected');
      if (type === 'small' && smallBtn) smallBtn.classList.add('selected');
    }

    function addManifestLine() {
      manifestLineCount++;
      renderManifestLines();
      calculateFormProgress();
    }

    function removeManifestLine(index) {
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });
      manifestData.splice(index - 1, 1);

      manifestLineCount--;
      if (manifestLineCount < 1) manifestLineCount = 1;

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
      calculateFormProgress();
    }

    function updateManifestTotals() {
  let totalSCU = 0;
  let totalUEC = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scu = parseInt(row.querySelector('.manifest-scu').value, 10);
    const uec = parseInt(row.querySelector('.manifest-uec').value, 10);
    if (!isNaN(scu)) totalSCU += scu;
    if (!isNaN(uec)) totalUEC += uec;
  });

  document.getElementById("totalSCUBox").textContent = "Total SCU: " + totalSCU.toLocaleString();

  const totalUECInput = document.getElementById("totalUECBox");
  if (document.activeElement !== totalUECInput) {
    totalUECInput.value = totalUEC;
  }
  
  showGenerateButtonOnChange();
}

    function updateSecurityCaptainDropdowns(selectedShips) {
      const container = document.getElementById('securityShipCaptains');
      if (!container) return;
      
      container.innerHTML = '';
      
      const shipsArray = Array.isArray(selectedShips) ? selectedShips : [selectedShips];
      const validShips = shipsArray.filter(ship => ship && ship !== 'None' && ship.trim() !== '');
      
      validShips.forEach(ship => {
        let displayShipName = ship;
        let shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        
        if (ship === 'Other') {
          const otherInput = document.getElementById('securityShipsOther');
          const otherValue = otherInput ? otherInput.value.trim() : '';
          if (otherValue === '') {
            return;
          }
          displayShipName = otherValue;
          shipId = 'Other_' + otherValue.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        }
        
        const row = document.createElement('div');
        row.className = 'security-captain-row';
        row.style.border = '2px solid #781d15';
        row.style.background = '#f9f9f9';
        row.style.padding = '15px';
        row.style.borderRadius = '8px';
        row.style.marginBottom = '15px';
        row.style.display = 'block';
        row.style.width = '100%';
        row.style.boxSizing = 'border-box';
        
        const shipHeader = document.createElement('h3');
        shipHeader.textContent = displayShipName;
        shipHeader.style.margin = '0 0 15px 0';
        shipHeader.style.padding = '0 0 5px 0';
        shipHeader.style.fontSize = '16px';
        shipHeader.style.fontWeight = 'bold';
        shipHeader.style.color = '#781d15';
        shipHeader.style.borderBottom = '1px solid #781d15';
        shipHeader.style.display = 'block';
        shipHeader.style.width = '100%';
        
        const captainSection = document.createElement('div');
        captainSection.style.marginLeft = '20px';
        captainSection.style.marginBottom = '15px';
        captainSection.style.display = 'block';
        captainSection.style.width = '100%';
        
        const label = document.createElement('label');
        label.textContent = 'Captain:';
        label.style.display = 'block';
        label.style.marginBottom = '5px';
        label.style.fontWeight = 'bold';
        label.style.fontSize = '14px';
        label.style.width = '100%';
        
        const dropdownDiv = document.createElement('div');
        dropdownDiv.className = 'searchable-dropdown';
        dropdownDiv.style.position = 'relative';
        dropdownDiv.style.width = '100%';
        dropdownDiv.style.marginBottom = '10px';
        dropdownDiv.style.display = 'block';
        
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'securityCaptain_' + shipId;
        input.placeholder = 'Click to select captain...';
        input.autocomplete = 'off';
        input.required = true;
        input.style.width = 'calc(100% - 10px)';
        input.style.padding = '8px';
        input.style.border = '1px solid #781d15';
        input.style.background = '#e2e2e2';
        input.style.color = '#230e09';
        input.style.borderRadius = '4px';
        input.style.boxSizing = 'border-box';
        
        const list = document.createElement('div');
        list.className = 'dropdown-list';
        list.id = 'securityCaptain_' + shipId + '_List';
        list.style.position = 'absolute';
        list.style.top = '100%';
        list.style.left = '0';
        list.style.right = '0';
        list.style.background = '#e2e2e2';
        list.style.border = '1px solid #781d15';
        list.style.borderTop = 'none';
        list.style.maxHeight = '150px';
        list.style.overflowY = 'auto';
        list.style.zIndex = '1000';
        list.style.display = 'none';
        list.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
        
        dropdownDiv.appendChild(input);
        dropdownDiv.appendChild(list);
        captainSection.appendChild(label);
        captainSection.appendChild(dropdownDiv);
        
        const crewSection = document.createElement('div');
        crewSection.style.marginLeft = '20px';
        crewSection.style.marginBottom = '15px';
        crewSection.style.display = 'block';
        crewSection.style.width = '100%';
        crewSection.style.clear = 'both';
        
        const crewLabel = document.createElement('label');
        crewLabel.textContent = 'Crew Amount:';
        crewLabel.style.display = 'block';
        crewLabel.style.marginBottom = '5px';
        crewLabel.style.fontWeight = 'bold';
        crewLabel.style.fontSize = '14px';
        crewLabel.style.width = '100%';
        
        const crewInput = document.createElement('input');
        crewInput.type = 'number';
        crewInput.id = 'securityCrew_' + shipId;
        crewInput.min = '0';
        crewInput.max = '20';
        crewInput.step = '1';
        crewInput.value = '0';
        crewInput.style.width = '100px';
        crewInput.style.padding = '8px';
        crewInput.style.border = '1px solid #781d15';
        crewInput.style.background = '#e2e2e2';
        crewInput.style.color = '#230e09';
        crewInput.style.borderRadius = '4px';
        crewInput.style.boxSizing = 'border-box';
        crewInput.style.fontSize = '14px';
        
        crewInput.addEventListener('input', function() {
          generateSecurityCrewInputs(shipId, displayShipName, parseInt(this.value, 10) || 0);
          calculateFormProgress();
          showGenerateButtonOnChange();
          updateSecurityShipSectionStyling(shipId);
        });
        
        crewSection.appendChild(crewLabel);
        crewSection.appendChild(crewInput);
        
        const crewNamesContainer = document.createElement('div');
        crewNamesContainer.className = 'security-crew-names';
        crewNamesContainer.id = 'securityCrewNames_' + shipId;
        crewNamesContainer.style.marginLeft = '20px';
        crewNamesContainer.style.display = 'block';
        crewNamesContainer.style.width = '100%';
        crewNamesContainer.style.clear = 'both';
        
        row.appendChild(shipHeader);
        row.appendChild(captainSection);
        row.appendChild(crewSection);
        row.appendChild(crewNamesContainer);
        container.appendChild(row);
        
        input.addEventListener('input', () => {
          updateSecurityShipSectionStyling(shipId);
        });
        input.addEventListener('change', () => {
          updateSecurityShipSectionStyling(shipId);
        });
        
        initializeCaptainDropdown(input, list, ship);
      });
      
      setTimeout(() => {
        updateAllSecurityShipStylings();
      }, 100);
    }
    
    function createSecurityShipElement(ship, shipId, container) {
      let displayShipName = ship;
      
      if (ship === 'Other') {
        const otherInput = document.getElementById('securityShipsOther');
        const otherValue = otherInput ? otherInput.value.trim() : '';
        if (otherValue === '') {
          return;
        }
        displayShipName = otherValue;
      }
    }
    
    function initializeCaptainDropdown(input, list, shipName) {
      const captainsArray = typeof captainNames !== 'undefined' ? captainNames : [
        "DyslexicNerd", "Spartan", "Lightblade", "Roflnomish", 
        "BenjiNotorious", "zarainia", "Astol", "Venomnom", "BigDaddyTortuga", 
        "ItzProto", "Newt", "Xolion", "Bakes Kamuari", "LockEmUpJas", 
        "sadfish", "Efazer"
      ];
      const captainsWithOther = [...captainsArray, "Other"];
      let floatList = document.createElement('div');
      floatList.className = 'dropdown-list floating-captain-list';
      floatList.style.position = 'absolute';
      floatList.style.zIndex = '24000';
      floatList.style.display = 'none';
      floatList.style.background = '#e2e2e2';
      floatList.style.border = '1px solid #781d15';
      floatList.style.boxSizing = 'border-box';
      floatList.style.maxHeight = '40vh';
      floatList.style.overflowY = 'auto';
      document.body.appendChild(floatList);

      function renderItems(captains) {
        floatList.innerHTML = '';
        captains.forEach(captain => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.style.padding = '6px 12px';
          item.style.cursor = 'pointer';
          item.style.borderBottom = '1px solid #ccc';
          item.style.background = '#e2e2e2';
          item.style.color = '#230e09';
          item.style.fontSize = '14px';
          item.textContent = captain;

          item.addEventListener('mouseenter', () => { item.style.background = '#d0d0d0'; });
          item.addEventListener('mouseleave', () => { item.style.background = '#e2e2e2'; });

          item.addEventListener('click', () => {
            if (captain === 'Other') {
              const customName = prompt('Enter captain name for ' + shipName + ':');
              if (customName && customName.trim()) input.value = customName.trim(); else input.value = '';
            } else {
              input.value = captain;
            }
            hideDropdown();
            input.classList.remove('error');
            calculateFormProgress();
            showGenerateButtonOnChange();
            const shipId = input.id.replace('securityCaptain_', '');
            updateSecurityShipSectionStyling(shipId);
          });

          floatList.appendChild(item);
        });
      }

      function positionFloat() {
        const rect = input.getBoundingClientRect();
        const scrollY = window.scrollY || window.pageYOffset;
        const scrollX = window.scrollX || window.pageXOffset;
        const left = rect.left + scrollX;
        const belowTop = rect.bottom + scrollY;
        floatList.style.minWidth = (rect.width) + 'px';
        floatList.style.left = left + 'px';
        floatList.style.top = belowTop + 'px';
        const overflowRight = (left + floatList.offsetWidth) - window.innerWidth;
        if (overflowRight > 0) {
          floatList.style.left = Math.max(8, left - overflowRight - 8) + 'px';
        }
      }

      function showDropdown() {
        renderItems(captainsWithOther);
        floatList.style.display = 'block';
        requestAnimationFrame(positionFloat);
      }

      function hideDropdown() {
        setTimeout(() => { if (floatList) floatList.style.display = 'none'; }, 100);
      }

      function filterCaptains(searchTerm) {
        const term = searchTerm.toLowerCase();
        return captainsWithOther.filter(captain => captain.toLowerCase().includes(term));
      }

      input.addEventListener('click', (e) => { e.stopPropagation(); showDropdown(); });
      input.addEventListener('focus', () => { showDropdown(); });
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        const filtered = searchTerm.length === 0 ? captainsWithOther : filterCaptains(searchTerm);
        renderItems(filtered);
        floatList.style.display = 'block';
        requestAnimationFrame(positionFloat);
        calculateFormProgress();
        showGenerateButtonOnChange();
      });

      input.addEventListener('blur', () => { hideDropdown(); });

      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !floatList.contains(e.target)) {
          hideDropdown();
        }
      });

      renderItems(captainsWithOther);
    }
    
    function getSelectedSecurityShips() {
      const securityShipsInput = document.getElementById('securityShips');
      if (!securityShipsInput) return [];
      
      if (securityShipsInput.getSelectedShips) {
        return securityShipsInput.getSelectedShips();
      }
      
      const value = securityShipsInput.value.trim();
      if (value === '') return [];
      
      return [value];
    }
    
    function validateSecurityShips() {
      const securityShipsInput = document.getElementById('securityShips');
      if (!securityShipsInput) return false;
      
      if (securityShipsInput.getSelectedShips) {
        const selectedShips = securityShipsInput.getSelectedShips();
        return selectedShips.length > 0;
      }
      
      const value = securityShipsInput.value.trim();
      return value !== '';
    }

    window.addEventListener("DOMContentLoaded", function() {
  populateLocationDropdown("startLocation");
  populateLocationDropdown("routeStart");
  populateLocationDropdown("routeEnd");
  populateLocationDropdown("tr_pickup");
  populateLocationDropdown("tr_destination");
      populateShipDropdown("");
      populateCaptainDropdown();
      populateSecurityShipsDropdown();
      
      const securityShipsOtherInput = document.getElementById('securityShipsOther');
      if (securityShipsOtherInput) {
        securityShipsOtherInput.addEventListener('input', function() {
          const securityShipsInput = document.getElementById('securityShips');
          if (securityShipsInput && securityShipsInput.getSelectedShips) {
            const selectedShips = securityShipsInput.getSelectedShips();
            if (selectedShips.includes('Other')) {
              updateSecurityCaptainDropdowns(selectedShips);
            }
          }
        });
      }
      
      document.getElementById("discordSection").style.display = "none";
      manifestLineCount = 1;
      renderManifestLines();
      renderHistory();
      calculateFormProgress();

      (function initViewerControls(){
        const viewerSort = document.getElementById('viewer_sort');
        const viewerSearch = document.getElementById('viewer_search');
        const viewerSearchBtn = document.getElementById('viewer_search_btn');
        const viewerClearBtn = document.getElementById('viewer_clear_btn');

        if (viewerSort) viewerSort.addEventListener('change', renderViewer);
        if (viewerSearch) viewerSearch.addEventListener('input', function(e){ if (this.value.length === 0) renderViewer(); });
        if (viewerSearch) viewerSearch.addEventListener('keyup', function(e){ if (e.key === 'Enter') renderViewer(); });
        if (viewerSearchBtn) viewerSearchBtn.addEventListener('click', renderViewer);
        if (viewerClearBtn) viewerClearBtn.addEventListener('click', function(){
          if (viewerSearch) viewerSearch.value = '';
          if (viewerSort) viewerSort.value = 'date_desc';
          renderViewer();
        });

      })();
      
      const formElements = document.querySelectorAll('input, select, textarea');
      formElements.forEach(element => {
        element.addEventListener('input', calculateFormProgress);
        element.addEventListener('change', calculateFormProgress);
        element.addEventListener('input', showGenerateButtonOnChange);
        element.addEventListener('change', showGenerateButtonOnChange);
      });
      
      const manifestContainer = document.getElementById('manifestLines');
      if (manifestContainer) {
        const observer = new MutationObserver(calculateFormProgress);
        observer.observe(manifestContainer, { childList: true, subtree: true });
      }
    });

    document.getElementById("orderCategory").addEventListener("change", function() {
      toggleOrderCategoryOther();
      populateShipDropdown(this.value);
    });
    document.getElementById("orderType").addEventListener("change", function() {
      toggleOrderTypeOther();

      const val = this.value;
      const presetsDiv = document.getElementById("resourceDrivePresets");
      if (val === "Resource Drive") {
        presetsDiv.style.display = "block";
      } else {
        presetsDiv.style.display = "none";
      }
    });

    document.getElementById("departureTime").addEventListener("change", function() {
      this.classList.remove('error');
      updateOrderDuration();
      showGenerateButtonOnChange();
    });
    
    document.getElementById("completionTime").addEventListener("change", function() {
      this.classList.remove('error');
      updateOrderDuration();
      showGenerateButtonOnChange();
    });

    function toDiscordTimestamp(dtString) {
      if (!dtString) return "";
      const date = new Date(dtString);
      if (isNaN(date.getTime())) return "";
      const yearsToAdd = 930;
      date.setFullYear(date.getFullYear() + yearsToAdd);
      const unix = Math.floor(date.getTime() / 1000);
      return '<t:' + unix + ':f>';
    }
    // Ship Message Links no longer using threads cause spartan is lazy - !!DEPRECIATED FEATURE!!
    const shipLinks = {
      "BRHS Seastrom": "https://discord.com/channels/900478857436606535/1391878505905524817/1404322180329898046",
      "AACS Judgements Bow": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319407106293843",
      "BRHS Sword of Twilight": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319218261954661",
      "BRHS Trireme": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319148888031312",
      "AACS Dendrobium": "https://discord.com/channels/900478857436606535/1391878505905524817/1403127587567439872",
      "WINCO Rafto": "https://discord.com/channels/900478857436606535/1391878505905524817/1398047073097482262",
      "BRHS Lednik": "https://discord.com/channels/900478857436606535/1391878505905524817/1398045703367823461",
      "SPRT Icarus": "https://discord.com/channels/900478857436606535/1391878505905524817/1396265862268190830",
      "AACS Feder": "https://discord.com/channels/900478857436606535/1391878505905524817/1393365523407835196",
      "AACS Landsknecht": "https://discord.com/channels/900478857436606535/1391878505905524817/1392713534005186730",
      "WINC Caterpillar": "https://discord.com/channels/900478857436606535/1391878505905524817/1391904347117322322",
      "BRHS Knight": "https://discord.com/channels/900478857436606535/1391878505905524817/1408243741508108501",
      "BRHS Ledokol": "https://discord.com/channels/900478857436606535/1391878505905524817/1409173959382925514",
    };

    function showLoadingOverlay(message = "Processing...") {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingOverlay';
      overlay.innerHTML = 
        '<div class="loading-content">' +
          '<div class="loading-spinner-large"></div>' +
          '<div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">' + message + '</div>' +
          '<div style="font-size: 14px; opacity: 0.8;">Please wait...</div>' +
        '</div>';
      document.body.appendChild(overlay);
    }

    function showNotificationOverlay(message, type = 'info', duration = 0) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'notificationOverlay';
      
      let icon = '';
      let bgColor = '#781d15';
      let borderColor = '#9d7523';
      
      switch(type) {
        case 'success':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">✓</div>';
          bgColor = '#43b581';
          borderColor = '#2ea964';
          break;
        case 'error':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">⚠</div>';
          bgColor = '#ed4245';
          borderColor = '#b32428';
          break;
        case 'warning':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">⚠</div>';
          bgColor = '#faa61a';
          borderColor = '#e18d00';
          break;
        default:
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">ℹ</div>';
      }
      
      overlay.innerHTML = 
        '<div class="loading-content" style="background: ' + bgColor + '; border-color: ' + borderColor + ';">' +
          '<button class="close-button" onclick="document.getElementById(\'notificationOverlay\').remove()">×</button>' +
          icon +
          '<div style="font-size: 16px; font-weight: bold; text-align: center; line-height: 1.4;">' + message + '</div>' +
        '</div>';
      document.body.appendChild(overlay);
      
    }

    function showConfirmationOverlay(message, onConfirm, onCancel = null) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'confirmationOverlay';
      
      overlay.innerHTML = 
        '<div class="loading-content" style="background: #faa61a; border-color: #e18d00;">' +
          '<div style="font-size: 32px; margin-bottom: 16px;">⚠</div>' +
          '<div style="font-size: 16px; font-weight: bold; text-align: center; line-height: 1.4; margin-bottom: 20px;">' + message + '</div>' +
          '<div style="display: flex; gap: 12px; justify-content: center;">' +
            '<button id="confirmBtn" style="background: #ed4245; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;">Delete</button>' +
            '<button id="cancelBtn" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;">Cancel</button>' +
          '</div>' +
        '</div>';
      
      document.body.appendChild(overlay);
      
      document.getElementById('confirmBtn').addEventListener('click', () => {
        overlay.remove();
        if (onConfirm) onConfirm();
      });
      
      document.getElementById('cancelBtn').addEventListener('click', () => {
        overlay.remove();
        if (onCancel) onCancel();
      });
    }

    function showLoadingMessage(message, autoCloseAfterMs = 0) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingMessageOverlay';
      
      overlay.innerHTML = 
        '<div class="loading-content">' +
          '<div class="loading-spinner-large"></div>' +
          '<div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">' + message + '</div>' +
          '<div style="font-size: 14px; opacity: 0.8;">Please wait...</div>' +
        '</div>';
      document.body.appendChild(overlay);
      
      if (autoCloseAfterMs > 0) {
        setTimeout(() => {
          const loadingOverlay = document.getElementById('loadingMessageOverlay');
          if (loadingOverlay) {
            loadingOverlay.remove();
          }
        }, autoCloseAfterMs);
      }
      
      return overlay;
    }

    function hideLoadingMessage() {
      const overlay = document.getElementById('loadingMessageOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function showButtonLoading(buttonId, loadingText = null) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.add('button-loading');
        button.disabled = true;
        const originalHTML = button.innerHTML;
        button.setAttribute('data-original-html', originalHTML);
        
        if (loadingText) {
          button.innerHTML = '<div class="loading-spinner"></div>' + loadingText;
        } else {
          button.innerHTML = '<div class="loading-spinner"></div>Processing...';
        }
      }
    }

    function hideButtonLoading(buttonId) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.remove('button-loading');
        button.disabled = false;
        const originalHTML = button.getAttribute('data-original-html');
        if (originalHTML) {
          button.innerHTML = originalHTML;
          button.removeAttribute('data-original-html');
        }
      }
    }

    function showFeedback(type, message, duration = 5000) {
      const feedbackElement = type === 'success' ? 
        document.getElementById('successFeedback') : 
        document.getElementById('errorFeedback');
      const messageElement = type === 'success' ? 
        document.getElementById('successMessage') : 
        document.getElementById('errorMessage');
      
      if (feedbackElement && messageElement) {
        messageElement.textContent = message;
        feedbackElement.style.display = 'flex';
        
        setTimeout(() => {
          feedbackElement.style.display = 'none';
        }, duration);
      }
    }

    function calculateFormProgress() {
      const requiredFields = [
        'orderCategory', 'companyName', 'orderType', 'shipName', 'captainName',
        'crewAmount', 'startLocation', 'departureTime', 'routeStart', 'routeEnd',
        'completionTime'
      ];
      
      let filledFields = 0;
      let totalFields = requiredFields.length;
      
      for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        let isFieldValid = false;
        
        if (field) {
          if (fieldId === 'startLocation' || fieldId === 'routeStart' || fieldId === 'routeEnd') {
            isFieldValid = field.value && field.value.trim() !== '' && locations.includes(field.value);
          } 
          else if (fieldId === 'shipName') {
            isFieldValid = field.value && field.value.trim() !== '' && (allShips.includes(field.value) || field.value === 'Other');
          }
          else if (fieldId === 'captainName') {
            isFieldValid = field.value && field.value.trim() !== '' && (captainNames.includes(field.value) || field.value === 'Other');
          }
          else {
            isFieldValid = field.value && field.value.trim() !== '';
          }
          
          if (isFieldValid) {
            filledFields++;
          }
        }
      }
      
      const otherFieldChecks = [
        { select: 'orderCategory', other: 'orderCategoryOther' },
        { select: 'orderType', other: 'orderTypeOther' },
        { select: 'shipName', other: 'shipNameOther' },
        { select: 'captainName', other: 'captainNameOther' }
      ];
      
      for (const check of otherFieldChecks) {
        const selectField = document.getElementById(check.select);
        const otherField = document.getElementById(check.other);
        const otherDiv = document.getElementById(check.other + 'Div');
        
        if (selectField && selectField.value === 'Other' && otherDiv && otherDiv.style.display !== 'none') {
          totalFields++;
          if (otherField && otherField.value && otherField.value.trim() !== '') {
            filledFields++;
          }
        }
      }
      
      const crewAmount = parseInt(document.getElementById('crewAmount')?.value || '0', 10);
      if (crewAmount > 0) {
        totalFields += crewAmount;
        for (let i = 1; i <= crewAmount; i++) {
          const crewField = document.getElementById('crewName' + i);
          if (crewField && crewField.value && crewField.value.trim() !== '') {
            filledFields++;
          }
        }
      }
      
      const selectedSecurityShips = getSelectedSecurityShips();
      const hasNonNoneSecurityShips = selectedSecurityShips.some(ship => ship && ship !== 'None');
      
      if (hasNonNoneSecurityShips) {
        totalFields++;
        if (validateSecurityShips()) {
          filledFields++;
        }
      }
      
      const validSecurityShips = selectedSecurityShips.filter(ship => ship && ship !== 'None' && ship !== 'Other' && ship.trim() !== '');
      totalFields += validSecurityShips.length;
      validSecurityShips.forEach(ship => {
        const shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        const captainInput = document.getElementById('securityCaptain_' + shipId);
        if (captainInput && captainInput.value && captainInput.value.trim() !== '') {
          filledFields++;
        }
      });

      const securityShipsInput = document.getElementById('securityShips');
      const securityShipsOtherDiv = document.getElementById('securityShipsOtherDiv');
      const securityShipsOtherInput = document.getElementById('securityShipsOther');
      if (securityShipsInput && securityShipsInput.value === "Other" && securityShipsOtherDiv && securityShipsOtherDiv.style.display !== 'none') {
        totalFields++;
        if (securityShipsOtherInput && securityShipsOtherInput.value && securityShipsOtherInput.value.trim() !== '') {
          filledFields++;
        }
      }
      
      const manifestRows = document.querySelectorAll('.manifest-row');
      let hasValidManifest = false;
      manifestRows.forEach(row => {
        const material = row.querySelector('.manifest-material');
        if (material && material.value && material.value.trim() !== '' && material.value !== 'Select Material') {
          hasValidManifest = true;
        }
      });
      
      if (hasValidManifest) {
        filledFields++;
      }
      totalFields++; 
      const percentage = Math.round((filledFields / totalFields) * 100);
      

      const progressFill = document.getElementById('formProgressFill');
      const progressText = document.getElementById('formProgressText');
      
      if (progressFill) {
        progressFill.style.width = percentage + '%';
      }
      
      if (progressText) {
        progressText.textContent = 'Form Completion: ' + percentage + '%';
      }
      

      updateFormStepStates();
      
      return percentage;
    }

    function updateFormStepStates() {
      const steps = [
        {
          id: 'basicInfoStep',
          fields: ['orderCategory', 'companyName', 'orderType', 'shipName', 'captainName', 'crewAmount']
        },
        {
          id: 'securityShipsStep',
          fields: []
        },
        {
          id: 'locationTimeStep',
          fields: ['startLocation', 'departureTime', 'routeStart', 'routeEnd']
        },
        {
          id: 'manifestStep',
          fields: []
        },
        {
          id: 'completionStep',
          fields: ['completionTime']
        }
      ];
      
      steps.forEach(step => {
        const stepElement = document.getElementById(step.id);
        if (!stepElement) return;
        
        let completedFields = 0;
        let totalStepFields = step.fields.length;
        
        if (step.id === 'manifestStep') {
          const manifestRows = document.querySelectorAll('.manifest-row');
          let hasValidManifest = false;
          manifestRows.forEach(row => {
            const material = row.querySelector('.manifest-material');
            if (material && material.value && material.value.trim() !== '' && material.value !== 'Select Material') {
              hasValidManifest = true;
            }
          });
          completedFields = hasValidManifest ? 1 : 0;
          totalStepFields = 1;
        } else if (step.id === 'securityShipsStep') {
          if (validateSecurityShips()) {
            completedFields = 1;
            
            const selectedSecurityShips = getSelectedSecurityShips();
            const validSecurityShips = selectedSecurityShips.filter(ship => ship && ship !== 'None' && ship.trim() !== '');
            
            let securityShipFieldsCompleted = 0;
            let totalSecurityFields = 0;
            
            validSecurityShips.forEach(ship => {
              let shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
              
              if (ship === 'Other') {
                const otherInput = document.getElementById('securityShipsOther');
                const otherValue = otherInput ? otherInput.value.trim() : '';
                if (otherValue === '') return;
                shipId = 'Other_' + otherValue.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
              }
              
              totalSecurityFields++;
              const captainInput = document.getElementById('securityCaptain_' + shipId);
              if (captainInput && captainInput.value.trim()) {
                securityShipFieldsCompleted++;
              }
              
              const crewAmountInput = document.getElementById('securityCrew_' + shipId);
              if (crewAmountInput) {
                const securityCrewAmount = parseInt(crewAmountInput.value, 10);
                if (!isNaN(securityCrewAmount) && securityCrewAmount > 0) {
                  totalSecurityFields += securityCrewAmount;
                  for (let i = 1; i <= securityCrewAmount; i++) {
                    const crewInput = document.getElementById('securityCrew_' + shipId + '_' + i);
                    if (crewInput && crewInput.value.trim()) {
                      securityShipFieldsCompleted++;
                    }
                  }
                }
              }
            });
            
            completedFields = securityShipFieldsCompleted;
            totalStepFields = Math.max(totalSecurityFields, 1);
          } else {
            completedFields = 0;
            totalStepFields = 1;
          }
        } else {
          
          for (const fieldId of step.fields) {
            const field = document.getElementById(fieldId);
            let isFieldValid = false;
            
            if (field) {

              if (fieldId === 'startLocation' || fieldId === 'routeStart' || fieldId === 'routeEnd') {
                isFieldValid = field.value && field.value.trim() !== '';
              } else {
                isFieldValid = field.value && field.value.trim() !== '';
              }
              
              if (isFieldValid) {
                completedFields++;
              }
            }
          }
          
          if (step.id === 'basicInfoStep') {
            const crewAmount = parseInt(document.getElementById('crewAmount')?.value || '0', 10);
            if (crewAmount > 0) {
              totalStepFields += crewAmount;
              for (let i = 1; i <= crewAmount; i++) {
                const crewField = document.getElementById('crewName' + i);
                if (crewField && crewField.value && crewField.value.trim() !== '') {
                  completedFields++;
                }
              }
            }
            
            const otherFieldChecks = [
              { select: 'orderCategory', other: 'orderCategoryOther' },
              { select: 'orderType', other: 'orderTypeOther' },
              { select: 'shipName', other: 'shipNameOther' },
              { select: 'captainName', other: 'captainNameOther' }
            ];
            
            for (const check of otherFieldChecks) {
              const selectField = document.getElementById(check.select);
              const otherField = document.getElementById(check.other);
              const otherDiv = document.getElementById(check.other + 'Div');
              
              if (selectField && selectField.value === 'Other' && otherDiv && otherDiv.style.display !== 'none') {
                totalStepFields++;
                if (otherField && otherField.value && otherField.value.trim() !== '') {
                  completedFields++;
                }
              }
            }
          }
        }
        
        stepElement.classList.remove('active', 'completed');
        if (completedFields === totalStepFields && completedFields > 0) {
          stepElement.classList.add('completed');
        } else if (completedFields > 0) {
          stepElement.classList.add('active');
        }
      });
    }

    function toggleOrderCategoryOther() {
      const val = document.getElementById("orderCategory").value;
      const otherDiv = document.getElementById("orderCategoryOtherDiv");
      if (val === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderCategoryOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("orderCategoryOther").required = false;
      }
    }

    function toggleOrderTypeOther() {
      const orderType = document.getElementById("orderType").value;
      const otherDiv = document.getElementById("orderTypeOtherDiv");
      const resourceDriveDiv = document.getElementById("resourceDriveCompanyDiv");
      if (orderType === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderTypeOther").required = true;
        resourceDriveDiv.style.display = "none";
        document.getElementById("resourceDriveCompany").required = false;
      } else if (orderType === "Resource Drive") {
        resourceDriveDiv.style.display = "block";
        document.getElementById("resourceDriveCompany").required = true;
        otherDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
      } else {
        otherDiv.style.display = "none";
        resourceDriveDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
        document.getElementById("resourceDriveCompany").required = false;
      }
    }

    function toggleShipNameOther() {
      const shipName = document.getElementById("shipName").value;
      const otherDiv = document.getElementById("shipNameOtherDiv");
      if (shipName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("shipNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("shipNameOther").required = false;
      }
    }

    function toggleCaptainNameOther() {
      const captainName = document.getElementById("captainName").value;
      const otherDiv = document.getElementById("captainNameOtherDiv");
      if (captainName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("captainNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("captainNameOther").required = false;
      }
    }

    function generateCrewInputs() {
      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      const crewNamesDiv = document.getElementById("crewNamesDiv");
      crewNamesDiv.innerHTML = "";
      if (!isNaN(crewAmount) && crewAmount > 0) {
        for (let i = 1; i <= crewAmount; i++) {
          const label = document.createElement("label");
          label.textContent = 'Crew ' + i + ' Name:';
          label.htmlFor = 'crewName' + i;
          label.className = "crew-label";
          const input = document.createElement("input");
          input.type = "text";
          input.id = 'crewName' + i;
          input.name = 'crewName' + i;
          input.required = true;
          input.className = "crew-input";
          input.addEventListener('input', calculateFormProgress);
          input.addEventListener('change', calculateFormProgress);
          crewNamesDiv.appendChild(label);
          crewNamesDiv.appendChild(input);
        }
      }
      calculateFormProgress();
    }

    function generateSecurityCrewInputs(shipId, shipName, crewAmount) {
      const crewNamesContainer = document.getElementById('securityCrewNames_' + shipId);
      if (!crewNamesContainer) return;
      
      crewNamesContainer.innerHTML = "";
      
      if (!isNaN(crewAmount) && crewAmount > 0) {
        const crewNamesHeader = document.createElement("label");
        crewNamesHeader.textContent = "Crew Names:";
        crewNamesHeader.style.display = 'block';
        crewNamesHeader.style.marginBottom = '10px';
        crewNamesHeader.style.fontWeight = 'bold';
        crewNamesHeader.style.fontSize = '14px';
        crewNamesContainer.appendChild(crewNamesHeader);
        
        for (let i = 1; i <= crewAmount; i++) {
          const label = document.createElement("label");
          label.textContent = 'Crew ' + i + ' Name:';
          label.htmlFor = 'securityCrew_' + shipId + '_' + i;
          label.className = "crew-label";
          label.style.fontSize = '14px';
          label.style.marginTop = '8px';
          label.style.display = 'block';
          label.style.marginLeft = '20px';
          
          const input = document.createElement("input");
          input.type = "text";
          input.id = 'securityCrew_' + shipId + '_' + i;
          input.name = 'securityCrew_' + shipId + '_' + i;
          input.required = true;
          input.className = "crew-input";
          input.style.width = 'calc(100% - 40px)';
          input.style.marginLeft = '20px';
          input.style.padding = '8px';
          input.style.border = '1px solid #781d15';
          input.style.background = '#e2e2e2';
          input.style.color = '#230e09';
          input.style.borderRadius = '4px';
          input.style.boxSizing = 'border-box';
          input.style.marginBottom = '5px';
          input.style.fontSize = '14px';
          
          input.addEventListener('input', calculateFormProgress);
          input.addEventListener('change', calculateFormProgress);
          input.addEventListener('input', showGenerateButtonOnChange);
          input.addEventListener('change', showGenerateButtonOnChange);
          input.addEventListener('input', () => {
            const shipIdFromInput = input.id.split('_').slice(1, -1).join('_');
            updateSecurityShipSectionStyling(shipIdFromInput);
          });
          input.addEventListener('change', () => {
            const shipIdFromInput = input.id.split('_').slice(1, -1).join('_');
            updateSecurityShipSectionStyling(shipIdFromInput);
          });
          
          crewNamesContainer.appendChild(label);
          crewNamesContainer.appendChild(input);
        }
      }
      calculateFormProgress();
      updateSecurityShipSectionStyling(shipId);
    }

    function checkSecurityShipCompletion(shipId) {
      const captainInput = document.getElementById('securityCaptain_' + shipId);
      const crewAmountInput = document.getElementById('securityCrew_' + shipId);
      
      if (!captainInput || !crewAmountInput) return false;
      
      const hasCaptain = captainInput.value.trim() !== '';
      
      const crewAmount = parseInt(crewAmountInput.value, 10) || 0;
      const hasCrewAmount = crewAmount >= 0;
      
      let allCrewNamesFilled = true;
      if (crewAmount > 0) {
        for (let i = 1; i <= crewAmount; i++) {
          const crewInput = document.getElementById('securityCrew_' + shipId + '_' + i);
          if (!crewInput || crewInput.value.trim() === '') {
            allCrewNamesFilled = false;
            break;
          }
        }
      }
      
      return hasCaptain && hasCrewAmount && allCrewNamesFilled;
    }
    
    function updateSecurityShipSectionStyling(shipId) {
      const allRows = document.querySelectorAll('#securityShipCaptains .security-captain-row');
      for (let row of allRows) {
        if (row.querySelector('#securityCaptain_' + shipId)) {
          const isComplete = checkSecurityShipCompletion(shipId);
          if (isComplete) {
            row.style.border = '2px solid #22c55e';
          } else {
            row.style.border = '2px solid #781d15';
          }
          return;
        }
      }
    }
    
    function updateAllSecurityShipStylings() {
      const allCaptainInputs = document.querySelectorAll('[id^="securityCaptain_"]');
      allCaptainInputs.forEach(input => {
        const shipId = input.id.replace('securityCaptain_', '');
        updateSecurityShipSectionStyling(shipId);
      });
    }

    window.toggleOrderTypeOther = toggleOrderTypeOther;
    window.toggleOrderCategoryOther = toggleOrderCategoryOther;
    window.toggleShipNameOther = toggleShipNameOther;
    window.toggleCaptainNameOther = toggleCaptainNameOther;
    window.generateCrewInputs = generateCrewInputs;
    window.generateSecurityCrewInputs = generateSecurityCrewInputs;
    window.checkSecurityShipCompletion = checkSecurityShipCompletion;
    window.updateSecurityShipSectionStyling = updateSecurityShipSectionStyling;
    window.updateAllSecurityShipStylings = updateAllSecurityShipStylings;
    window.updateSecurityCaptainDropdowns = updateSecurityCaptainDropdowns;
    window.initializeCaptainDropdown = initializeCaptainDropdown;
    window.addManifestLine = addManifestLine;
    window.removeManifestLine = removeManifestLine;
    window.updateManifestTotals = updateManifestTotals;
    window.generateOutput = generateOutput;
    window.copyDiscordOutput = copyDiscordOutput;
    window.toggleDiscordOutput = toggleDiscordOutput;
    window.showCopyButton = showCopyButton;
    window.hideCopyButton = hideCopyButton;
    window.showGenerateButtonOnChange = showGenerateButtonOnChange;
    window.clearFormFields = clearFormFields;
    window.applyManifestPreset = applyManifestPreset;
    window.showConfirmationOverlay = showConfirmationOverlay;

    function validateRequiredFields() {
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      const requiredFields = [
        "orderCategory",
        "companyName",
        "orderType",
        "shipName",
        "captainName",
        "crewAmount",
        "startLocation",
        "departureTime",
        "routeStart",
        "routeEnd",
        "completionTime",
        "repairs",
        "restock",
        "quantumFuel",
        "hydrogenFuel",
        "crewCosts",
        "totalUECBox"
      ];
      requiredFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => el.classList.remove('error'));
      el.addEventListener('change', () => el.classList.remove('error'));
    }
  });

  document.querySelectorAll('.manifest-scu, .manifest-material, .crew-input').forEach(el => {
    el.addEventListener('input', () => el.classList.remove('error'));
    el.addEventListener('change', () => el.classList.remove('error'));
  });

  let allErrors = [];
  let firstErrorElement = null;

  function addError(element, message, fieldName) {
    if (element) {
      element.classList.add('error');
      if (!firstErrorElement) firstErrorElement = element;
    }
    allErrors.push({ element, message, fieldName });
  }

  for (const id of requiredFields) {
    const el = document.getElementById(id);
    let isValid = false;
    let fieldLabel = id.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
    
    if (id === 'totalUECBox') {
      fieldLabel = 'Total UEC Box';
    }
    
    if (!el) continue;
    
    if (id === 'startLocation' || id === 'routeStart' || id === 'routeEnd') {
      if (el.value.trim() === "") {
        addError(el, fieldLabel + ' is required', fieldLabel);
      } else if (!locations.includes(el.value)) {
        addError(el, fieldLabel + ' must be a valid location from the dropdown', fieldLabel);
      }
    } else {
      if (el.value === "" || el.value === null) {
        addError(el, fieldLabel + ' is required', fieldLabel);
      }
    }
  }

  const routeStartEl = document.getElementById('routeStart');
  const routeEndEl = document.getElementById('routeEnd');
  if (routeStartEl && routeEndEl && routeStartEl.value && routeEndEl.value) {
    if (routeStartEl.value === routeEndEl.value) {
      routeStartEl.classList.add('error');
      routeEndEl.classList.add('error');
      addError(routeStartEl, 'Route Start and Route End cannot be the same location', 'Route Validation');
    }
  }

  const otherFields = [
    {select: "orderCategory", other: "orderCategoryOtherDiv", input: "orderCategoryOther", label: "Order Category (Other)"},
    {select: "orderType", other: "orderTypeOtherDiv", input: "orderTypeOther", label: "Order Type (Other)"},
    {select: "shipName", other: "shipNameOtherDiv", input: "shipNameOther", label: "Ship Name (Other)"},
    {select: "captainName", other: "captainNameOtherDiv", input: "captainNameOther", label: "Captain Name (Other)"}
  ];
  
  for (const field of otherFields) {
    const selectEl = document.getElementById(field.select);
    const otherDiv = document.getElementById(field.other);
    const otherInput = document.getElementById(field.input);
    if (selectEl && selectEl.value === "Other" && otherDiv && otherDiv.style.display === "block") {
      if (!otherInput || !otherInput.value.trim()) {
        addError(otherInput, field.label + ' is required when "Other" is selected', field.label);
      }
    }
  }

  const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
  if (!isNaN(crewAmount) && crewAmount > 0) {
    for (let i = 1; i <= crewAmount; i++) {
      const crewInput = document.getElementById('crewName' + i);
      if (!crewInput || !crewInput.value.trim()) {
        addError(crewInput, 'Crew ' + i + ' Name is required', 'Crew ' + i + ' Name');
      }
    }
  }

  const selectedSecurityShips = getSelectedSecurityShips();
  const validSecurityShips = selectedSecurityShips.filter(ship => ship && ship !== 'None' && ship.trim() !== '');
  
  validSecurityShips.forEach(ship => {
    let shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
    let displayShipName = ship;
    
    if (ship === 'Other') {
      const otherInput = document.getElementById('securityShipsOther');
      const otherValue = otherInput ? otherInput.value.trim() : '';
      if (otherValue === '') {
        return;
      }
      displayShipName = otherValue;
      shipId = 'Other_' + otherValue.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
    }
    
    const captainInput = document.getElementById('securityCaptain_' + shipId);
    if (!captainInput || !captainInput.value.trim()) {
      addError(captainInput, 'Captain name is required for ' + displayShipName, displayShipName + ' Captain');
    }
    
    const crewAmountInput = document.getElementById('securityCrew_' + shipId);
    if (crewAmountInput) {
      const securityCrewAmount = parseInt(crewAmountInput.value, 10);
      if (!isNaN(securityCrewAmount) && securityCrewAmount > 0) {
        for (let i = 1; i <= securityCrewAmount; i++) {
          const crewInput = document.getElementById('securityCrew_' + shipId + '_' + i);
          if (!crewInput || !crewInput.value.trim()) {
            addError(crewInput, displayShipName + ' Crew ' + i + ' Name is required', displayShipName + ' Crew ' + i + ' Name');
          }
        }
      }
    }
  });

  if (!validateSecurityShips()) {
    const securityShipsInput = document.getElementById('securityShips');
    addError(securityShipsInput, "Security ships selection is required", "Security Ships");
  }

  const securityShipsOtherDiv = document.getElementById('securityShipsOtherDiv');
  const securityShipsOtherInput = document.getElementById('securityShipsOther');
  
  if (selectedSecurityShips.includes("Other") && securityShipsOtherDiv && securityShipsOtherDiv.style.display === "block") {
    if (!securityShipsOtherInput || !securityShipsOtherInput.value.trim()) {
      addError(securityShipsOtherInput, "Security Ships (Other) is required when 'Other' is selected", "Security Ships (Other)");
    }
  }

  const manifestRows = document.querySelectorAll('.manifest-row');
  if (manifestRows.length === 0) {
    allErrors.push({ 
      element: null, 
      message: "At least one manifest line is required", 
      fieldName: "Manifest" 
    });
  } else {
    let manifestIndex = 1;
    for (const row of manifestRows) {
      const scu = row.querySelector('.manifest-scu');
      const mat = row.querySelector('.manifest-material');
      
      if (!scu || !scu.value.trim()) {
        addError(scu, 'Manifest Line ' + manifestIndex + ': SCU is required', 'Manifest Line ' + manifestIndex + ' SCU');
      }
      if (!mat || !mat.value.trim() || mat.value === 'Select Material') {
        addError(mat, 'Manifest Line ' + manifestIndex + ': Material is required', 'Manifest Line ' + manifestIndex + ' Material');
      }
      manifestIndex++;
    }
  }

  const timestampErrors = validateTimestampsDetailed();
  if (timestampErrors.length > 0) {
    allErrors.push(...timestampErrors);
  }

  if (allErrors.length > 0) {
    if (firstErrorElement) {
      firstErrorElement.scrollIntoView({behavior: "smooth", block: "center"});
    }
    
    const errorsByCategory = {
      'Basic Information': [],
      'Security Ships': [],
      'Route & Timing': [],
      'Crew Information': [],
      'Manifest': [],
      'Financial Information': [],
      'Other': []
    };
    
    allErrors.forEach(error => {
      const fieldName = error.fieldName.toLowerCase();
      if (fieldName.includes('category') || fieldName.includes('company') || fieldName.includes('type') || fieldName.includes('ship name') || fieldName.includes('captain name')) {
        errorsByCategory['Basic Information'].push(error.message);
      } else if (fieldName.includes('security')) {
        errorsByCategory['Security Ships'].push(error.message);
      } else if (fieldName.includes('location') || fieldName.includes('route') || fieldName.includes('time') || fieldName.includes('timestamp')) {
        errorsByCategory['Route & Timing'].push(error.message);
      } else if (fieldName.includes('crew')) {
        errorsByCategory['Crew Information'].push(error.message);
      } else if (fieldName.includes('manifest')) {
        errorsByCategory['Manifest'].push(error.message);
      } else if (fieldName.includes('repair') || fieldName.includes('restock') || fieldName.includes('fuel') || fieldName.includes('cost') || fieldName.includes('uec')) {
        errorsByCategory['Financial Information'].push(error.message);
      } else {
        errorsByCategory['Other'].push(error.message);
      }
    });
    
    let validationMessage = 'Form Validation Issues<br><br><strong>Please fix the following ' + allErrors.length + ' issue' + (allErrors.length === 1 ? '' : 's') + ':</strong><br><br>';
    
    Object.keys(errorsByCategory).forEach(category => {
      if (errorsByCategory[category].length > 0) {
        validationMessage += '<strong>' + category + ':</strong><br>';
        errorsByCategory[category].forEach(error => {
          validationMessage += '• ' + error + '<br>';
        });
        validationMessage += '<br>';
      }
    });
    
    validationMessage += '<small style="opacity: 0.8;">Fields with issues are highlighted in red.</small>';
    
    showNotificationOverlay(validationMessage, 'warning');
    return false;
  }
  
  return true;
}

    function copyDiscordOutput() {
      const discordOutput = document.getElementById("discordOutput");
      discordOutput.select();
      discordOutput.setSelectionRange(0, 99999);
      document.execCommand("copy");
      showNotificationOverlay("Discord post copied to clipboard!", 'success');
    }

    function toggleDiscordOutput() {
      const container = document.getElementById("discordOutputContainer");
      const icon = document.getElementById("toggleOutputIcon");
      const text = document.getElementById("toggleOutputText");
      
      if (container.style.display === "none") {
        container.style.display = "block";
        icon.textContent = "▼";
        text.textContent = "Hide Generated Output";
      } else {
        container.style.display = "none";
        icon.textContent = "▶";
        text.textContent = "Show Generated Output";
      }
    }

    function showCopyButton() {
      const copyBtn = document.getElementById("copyDiscordBtn");
      if (copyBtn) {
        copyBtn.style.display = "inline-flex";
      }
    }

    function hideCopyButton() {
      const copyBtn = document.getElementById("copyDiscordBtn");
      if (copyBtn) {
        copyBtn.style.display = "none";
      }
    }

    function showGenerateButtonOnChange() {
      const generateBtn = document.getElementById("generateBtn");
      if (generateBtn && generateBtn.style.display === "none") {
        generateBtn.style.display = "inline-flex";
      }
    }

    function updateOrderDuration() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      const durationDiv = document.getElementById("orderDuration");
      if (!dep || !comp) {
        durationDiv.textContent = "";
        return;
      }
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) {
        durationDiv.textContent = "";
        return;
      }
      let diffMs = compDate - depDate;
      if (diffMs < 0) {
        durationDiv.textContent = "Completion time is before departure!";
        durationDiv.style.color = "#ed4245";
        return;
      }
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      durationDiv.textContent = 'Order Duration: ' + hours + 'h ' + mins + 'm';
      durationDiv.style.color = "#9d7523";
    }

    function setCurrentTime(fieldId) {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        const timeString = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
        
        const field = document.getElementById(fieldId);
        if (field) {
          field.value = timeString;
          field.classList.remove('error');
          updateOrderDuration();
          
          console.log('✓ Time set for ' + fieldId + ': ' + timeString);
        } else {
          throw new Error('Field with ID \'' + fieldId + '\' not found');
        }
      } catch (error) {
        console.error('Error setting current time:', error);
        handleError('Failed to set current time', error, { fieldId });
      }
    }

    window.setCurrentTime = setCurrentTime;

    function handleError(message, error = null, context = {}) {
      const errorInfo = {
        message,
        error: error ? {
          name: error.name,
          message: error.message,
          stack: error.stack
        } : null,
        context,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href
      };
      
      console.error('Enhanced Error Log:', errorInfo);
      
      let userMessage = message;
      let suggestions = [];
      
      if (error) {
        switch (error.name) {
          case 'TypeError':
            if (error.message.includes('null') || error.message.includes('undefined')) {
              userMessage = 'A required field or element was not found.';
              suggestions.push('Please refresh the page and try again.');
              suggestions.push('Ensure all required fields are properly filled.');
            }
            break;
          case 'ReferenceError':
            userMessage = 'A programming error occurred.';
            suggestions.push('Please refresh the page.');
            suggestions.push('If the problem persists, contact support.');
            break;
          case 'NetworkError':
          case 'Failed to fetch':
            userMessage = 'Network connection error.';
            suggestions.push('Check your internet connection.');
            suggestions.push('Try again in a few moments.');
            break;
        }
      }
      
      if (message.includes('timestamp') || message.includes('time')) {
        suggestions.push('Ensure your system clock is set correctly.');
        suggestions.push('Try clicking the "Now" button instead of manual entry.');
      }
      
      if (message.includes('validation') || message.includes('required')) {
        suggestions.push('Check that all required fields are filled.');
        suggestions.push('Look for fields highlighted in red.');
      }
      
      const fullMessage = suggestions.length > 0 
        ? userMessage + '<br><br><strong>Suggestions:</strong><br>• ' + suggestions.join('<br>• ')
        : userMessage;
      
      showNotificationOverlay(fullMessage, 'error');
      
      const recentErrors = JSON.parse(localStorage.getItem('bruteHaulErrors') || '[]');
      recentErrors.push(errorInfo);
      
      if (recentErrors.length > 20) {
        recentErrors.splice(0, recentErrors.length - 20);
      }
      
      localStorage.setItem('bruteHaulErrors', JSON.stringify(recentErrors));
    }


    function validateTimestamps() {
      const departureField = document.getElementById('departureTime');
      const completionField = document.getElementById('completionTime');
      
      if (!departureField.value || !completionField.value) {
        return false;
      }
      
      try {
        const depDate = new Date(departureField.value);
        const compDate = new Date(completionField.value);
        
        if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) {
          handleError('Invalid timestamp format detected', null, { 
            departure: departureField.value, 
            completion: completionField.value 
          });
          return false;
        }
        
        if (compDate <= depDate) {
          const timeDiff = Math.abs(compDate - depDate) / (1000 * 60); // minutes
          handleError(
            'Completion time must be after departure time.<br><br>Current difference: ' + Math.round(timeDiff) + ' minutes backwards.', 
            null, 
            { departure: departureField.value, completion: completionField.value }
          );
          completionField.classList.add('error');
          return false;
        }
        
        const now = new Date();
        const oneYearFromNow = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000));
        
        if (depDate > oneYearFromNow || compDate > oneYearFromNow) {
          handleError('Timestamps appear to be set too far in the future. Please verify the dates.', null, {
            departure: departureField.value,
            completion: completionField.value
          });
          return false;
        }
        
        return true;
      } catch (error) {
        handleError('Error validating timestamps', error, {
          departure: departureField.value,
          completion: completionField.value
        });
        return false;
      }
    }

    function validateTimestampsDetailed() {
      const errors = [];
      const departureField = document.getElementById('departureTime');
      const completionField = document.getElementById('completionTime');
      
      if (!departureField.value || !completionField.value) {
        return errors;
      }
      
      try {
        const depDate = new Date(departureField.value);
        const compDate = new Date(completionField.value);
        
        if (isNaN(depDate.getTime())) {
          departureField.classList.add('error');
          errors.push({
            element: departureField,
            message: 'Departure timestamp has invalid format',
            fieldName: 'Departure Time'
          });
        }
        
        if (isNaN(compDate.getTime())) {
          completionField.classList.add('error');
          errors.push({
            element: completionField,
            message: 'Completion timestamp has invalid format',
            fieldName: 'Completion Time'
          });
        }
        
        if (!isNaN(depDate.getTime()) && !isNaN(compDate.getTime())) {
          if (compDate <= depDate) {
            const timeDiff = Math.abs(compDate - depDate) / (1000 * 60); // minutes
            completionField.classList.add('error');
            errors.push({
              element: completionField,
              message: 'Completion time must be after departure time (currently ' + Math.round(timeDiff) + ' minutes before departure)',
              fieldName: 'Completion Time'
            });
          }
          
          const now = new Date();
          const oneYearFromNow = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000));
          
          if (depDate > oneYearFromNow) {
            departureField.classList.add('error');
            errors.push({
              element: departureField,
              message: 'Departure time appears to be set too far in the future',
              fieldName: 'Departure Time'
            });
          }
          
          if (compDate > oneYearFromNow) {
            completionField.classList.add('error');
            errors.push({
              element: completionField,
              message: 'Completion time appears to be set too far in the future',
              fieldName: 'Completion Time'
            });
          }
        }
        
        return errors;
      } catch (error) {
        console.error('Error validating timestamps:', error);
        errors.push({
          element: null,
          message: 'Error occurred while validating timestamps',
          fieldName: 'Timestamps'
        });
        return errors;
      }
    }

    function getOrderDurationText() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      if (!dep || !comp) return "";
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) return "";
      let diffMs = compDate - depDate;
      if (diffMs < 0) return "";
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      return 'Order Duration: ' + hours + 'h ' + mins + 'm';
    }

    function generateOutput() {
  if (!validateRequiredFields()) return;

  showButtonLoading('generateBtn', 'Generating...');
  showLoadingOverlay('Generating Discord post...');

  setTimeout(() => {
    try {
      const get = id => document.getElementById(id)?.value?.trim() || "";
      const departureDiscord = toDiscordTimestamp(get("departureTime"));
      const completionDiscord = toDiscordTimestamp(get("completionTime"));

  let orderCategoryText = get("orderCategory");
  if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");

  let companyNameText = get("companyName");

  let orderTypeText = get("orderType");
  if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");

  let resourceDriveCompanyText = "";
  if (orderTypeText === "Resource Drive") {
    resourceDriveCompanyText = document.getElementById("resourceDriveCompany").value || "";
  }

  let shipNameText = get("shipName");
  if (shipNameText === "Other") shipNameText = get("shipNameOther");

  let captainNameText = get("captainName");
  if (captainNameText === "Other") captainNameText = get("captainNameOther");

  const shipLink = shipLinks[shipNameText];

  const crewAmount = parseInt(get("crewAmount"), 10);
  let crewNamesList = [];
  for (let i = 1; i <= crewAmount; i++) {
    const crewInput = document.getElementById('crewName' + i);
    if (crewInput && crewInput.value.trim()) {
      crewNamesList.push(crewInput.value.trim());
    }
  }
  let postCounter = parseInt(localStorage.getItem('discordHistoryCounter') || '1', 10);
  const crewNamesText = crewNamesList.length > 0 ? crewNamesList.join(", ") : "0";

  const selectedSecurityShips = getSelectedSecurityShips();
  let securityShipsText = "";
  let securityShipsHeader = "Security Ships";
  
  if (selectedSecurityShips.length === 0 || (selectedSecurityShips.length === 1 && selectedSecurityShips[0] === '')) {
    securityShipsText = "None";
  } else if (selectedSecurityShips.includes('None')) {
    securityShipsText = "None";
  } else {
    const securityShipDetails = [];
    let shipCounter = 1;
    
    selectedSecurityShips.forEach(ship => {
      if (ship === 'Other') {
        const otherInput = document.getElementById('securityShipsOther');
        const otherValue = otherInput ? otherInput.value.trim() : '';
        if (otherValue) {
          const shipId = 'Other_' + otherValue.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
          const captainInput = document.getElementById('securityCaptain_' + shipId);
          const captainName = captainInput ? captainInput.value.trim() : '';
          
          const crewAmountInput = document.getElementById('securityCrew_' + shipId);
          const crewAmount = crewAmountInput ? parseInt(crewAmountInput.value, 10) || 0 : 0;
          let crewNames = [];
          if (crewAmount > 0) {
            for (let i = 1; i <= crewAmount; i++) {
              const crewInput = document.getElementById('securityCrew_' + shipId + '_' + i);
              if (crewInput && crewInput.value.trim()) {
                crewNames.push(crewInput.value.trim());
              }
            }
          }
          
          let shipText = otherValue;
          if (captainName) shipText += '\n**Captain:** ' + captainName;
          if (crewNames.length > 0) shipText += '\n**Crew:** ' + crewNames.join(", ");
          
          securityShipDetails.push(shipText);
          shipCounter++;
        }
      } else if (ship && ship.trim() !== '' && ship !== 'None') {
        const shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        const captainInput = document.getElementById('securityCaptain_' + shipId);
        const captainName = captainInput ? captainInput.value.trim() : '';
        
        const crewAmountInput = document.getElementById('securityCrew_' + shipId);
        const crewAmount = crewAmountInput ? parseInt(crewAmountInput.value, 10) || 0 : 0;
        let crewNames = [];
        if (crewAmount > 0) {
          for (let i = 1; i <= crewAmount; i++) {
            const crewInput = document.getElementById('securityCrew_' + shipId + '_' + i);
            if (crewInput && crewInput.value.trim()) {
              crewNames.push(crewInput.value.trim());
            }
          }
        }
        
        const shipLink = shipLinks[ship];
        const shipDisplayText = shipLink ? '[' + ship + '](' + shipLink + ')' : ship;
        
        let shipText = shipDisplayText;
        if (captainName) shipText += '\n**Captain:** ' + captainName;
        if (crewNames.length > 0) shipText += '\n**Crew:** ' + crewNames.join(", ");
        
        securityShipDetails.push(shipText);
        shipCounter++;
      }
    });
    
    securityShipsText = securityShipDetails.length > 0 ? "\n" + securityShipDetails.join("\n—\n") : "None";
    securityShipsHeader = securityShipDetails.length === 1 ? "Security Ship" : "Security Ships";
  }

  const routeStart = get("routeStart");
  const routeEnd = get("routeEnd");
  const routeText = routeStart && routeEnd ? routeStart + ' :arrow_right: ' + routeEnd : "";

  let manifestLines = [];
  let totalSCU = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scuValue = row.querySelector('.manifest-scu').value;
    const scu = parseInt(scuValue, 10);
    const mat = row.querySelector('.manifest-material').value;
    const uecValue = row.querySelector('.manifest-uec').value;
    if (!isNaN(scu)) totalSCU += scu;
    manifestLines.push({
      scu: scuValue,
      mat: mat,
      uec: uecValue
    });
  });

  if (totalSCU <= 0) {
    hideLoadingOverlay();
    hideButtonLoading('generateBtn');
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
      generateBtn.innerHTML = 'Generate Post';
    }
    showNotificationOverlay('Manifest Validation Issue<br><br><strong>Total SCU is 0</strong><br><br>Please add cargo to your manifest before generating the Discord post.', 'warning');
    showFeedback('warning', 'Cannot generate post: Total SCU is 0. Please add cargo to your manifest.');
    return;
  }

  let manifestTable = "SCU   Material         UEC\n";
  manifestLines.forEach(line => {
    manifestTable += line.scu.padEnd(5) + ' ' + line.mat.padEnd(15) + ' ' + (line.uec ? line.uec : "") + '\n';
  });

  const totalUECInput = document.getElementById("totalUECBox");
  let totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) : 0;

  let totalLine = '**Total: ' + totalSCU.toLocaleString() + ' SCU';
  if (totalUEC && !isNaN(totalUEC)) {
    totalLine += ' / ' + totalUEC.toLocaleString() + ' UEC';
  }
  totalLine += "**";
  const totalSCUText = '**Total: ' + totalSCU.toLocaleString() + ' SCU**';

  const repairs = parseInt(get("repairs") || "0", 10);
  const restock = parseInt(get("restock") || "0", 10);
  const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
  const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
  const crewCosts = parseInt(get("crewCosts") || "0", 10);
  const totalDeductibles = repairs + restock + quantumFuel + hydrogenFuel + crewCosts;

  const notesText = get("notes") || "None";

  const shipDisplayText = shipLink ? '[' + shipNameText + '](' + shipLink + ')' : shipNameText;

    let output = '**' + orderCategoryText + ' Order**\n' +
companyNameText + ' : ' + (orderTypeText === "Resource Drive" ? "Resource Drive" : orderTypeText) + '\n' +
(resourceDriveCompanyText ? 'Resource Drive Company: ' + resourceDriveCompanyText : "") + '\n\n' +

'———\n\n' +

'**Transport Ship:** ' + shipDisplayText + '\n' +
'**Captain:** ' + captainNameText + '\n' +
'**Crew:** ' + crewNamesText + '\n\n' +

'———\n\n' +

'**' + securityShipsHeader + ':**\n' +
securityShipsText + '\n\n' +

'———\n\n' +

' **Departure:** ' + get("startLocation") + '\n' +
' **Departure Time:** ' + departureDiscord + '\n' +
' **Route:** ' + routeText + '\n\n' +

'———\n\n' +

'**Manifest**\n' +
String.fromCharCode(96) + String.fromCharCode(96) + String.fromCharCode(96) + '\n' +
manifestTable.trim() + '\n' +
String.fromCharCode(96) + String.fromCharCode(96) + String.fromCharCode(96) + '\n' +
totalLine + '\n\n' +

'———\n\n' +

'**Sign Off**\n' +
'Order completion time: ' + completionDiscord + '\n' +
getOrderDurationText() + '\n\n' +

'**Deductibles**\n' +
'- **Repairs:** ' + repairs.toLocaleString() + ' UEC\n' +
'- **Restock:** ' + restock.toLocaleString() + ' UEC\n' +
'- **Quantum fuel:** ' + quantumFuel.toLocaleString() + ' UEC\n' +
'- **Hydrogen fuel:** ' + hydrogenFuel.toLocaleString() + ' UEC\n' +
'- **Crew/ship costs:** ' + crewCosts.toLocaleString() + ' UEC\n' +
'**Total Deductibles: ' + totalDeductibles.toLocaleString() + ' UEC**\n\n' +

'———\n\n' +

'**Notes**\n' +
String.fromCharCode(96) + String.fromCharCode(96) + String.fromCharCode(96) + '\n' +
notesText + '\n' +
String.fromCharCode(96) + String.fromCharCode(96) + String.fromCharCode(96) + '\n';

  let history = getManifestHistory();
  
  const orderCategory = get("orderCategory") === "Other" ? get("orderCategoryOther") : get("orderCategory");
  const companyName = get("companyName");
  const shipName = get("shipName") === "Other" ? get("shipNameOther") : get("shipName");
  const captainName = get("captainName") === "Other" ? get("captainNameOther") : get("captainName");
  const summary = orderCategory + ' Order - ' + companyName + ' - ' + shipName + ' (Capt. ' + captainName + ')';
  
  const formDataForHistory = {
    orderCategory: get("orderCategory"),
    orderCategoryOther: get("orderCategoryOther"),
    companyName: get("companyName"),
    orderType: get("orderType"),
    orderTypeOther: get("orderTypeOther"),
    resourceDriveCompany: get("resourceDriveCompany"),
    shipName: get("shipName"),
    shipNameOther: get("shipNameOther"),
    captainName: get("captainName"),
    captainNameOther: get("captainNameOther"),
    crewAmount: get("crewAmount"),
    startLocation: get("startLocation"),
    departureTime: get("departureTime"),
    routeStart: get("routeStart"),
    routeEnd: get("routeEnd"),
    completionTime: get("completionTime"),
    repairs: get("repairs"),
    restock: get("restock"),
    quantumFuel: get("quantumFuel"),
    hydrogenFuel: get("hydrogenFuel"),
    crewCosts: get("crewCosts"),
    notes: get("notes")
  };
  
  const crewNames = [];
  for (let i = 1; i <= crewAmount; i++) {
    const crewInput = document.getElementById('crewName' + i);
    if (crewInput && crewInput.value.trim()) {
      crewNames.push(crewInput.value.trim());
    }
  }
  
  const manifestHistory = [];
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scu = row.querySelector('.manifest-scu').value;
    const material = row.querySelector('.manifest-material').value;
    const uec = row.querySelector('.manifest-uec').value;
    if (scu && material) {
      manifestHistory.push({ scu: scu, material: material, uec: uec });
    }
  });
  
  
  document.getElementById("discordOutput").value = output;
  document.getElementById("discordSection").style.display = "block";
  
  const generateBtn = document.getElementById("generateBtn");
  if (generateBtn) {
    generateBtn.style.display = "none";
  }
  
  hideCopyButton();
  
  hideLoadingOverlay();
  hideButtonLoading('generateBtn');
  showFeedback('success', 'Discord post generated successfully!');
  
  showNotificationOverlay('✅ Discord Post Generated Successfully!<br><br><strong>Your manifest has been prepared</strong><br><br>Review the Discord post below and click "Send to Discord" when ready.', 'success');
  
    } catch (error) {
      console.error('Error generating output:', error);
      hideLoadingOverlay();
      hideButtonLoading('generateBtn');
      
      logErrorToGitHub('G100', 'Discord generation failed', error.message, error.stack, {
        errorType: error.name || 'Unknown',
        generationError: true,
        formData: {
          hasManifest: document.querySelectorAll('.manifest-row').length > 0,
          hasSecurityShips: getSelectedSecurityShips().length > 0,
          totalSCU: parseInt(document.getElementById("totalSCUBox")?.textContent?.replace(/\D/g, "") || "0"),
          orderType: document.getElementById("orderType")?.value || "Unknown"
        }
      });
      
      showNotificationOverlay('❌ Generation Failed<br><br><strong>Error G100:</strong> Failed to generate Discord post<br><br>A technical error occurred during generation. Please try again or refresh the page if the problem persists.', 'error');
      showFeedback('error', 'Failed to generate Discord post (G100). Please try again.');
    }
  }, 500);
}

function saveSuccessfulManifestToHistory() {
  
  const get = (id) => {
    const element = document.getElementById(id);
    return element ? element.value : '';
  };
  
  const discordMessage = document.getElementById("discordOutput").value;
  
  const orderCategory = get("orderCategory") === "Other" ? get("orderCategoryOther") : get("orderCategory");
  const companyName = get("companyName");
  const shipName = get("shipName") === "Other" ? get("shipNameOther") : get("shipName");
  const captainName = get("captainName") === "Other" ? get("captainNameOther") : get("captainName");
  const summary = orderCategory + ' Order - ' + companyName + ' - ' + shipName + ' (Capt. ' + captainName + ')';
  
  const totalSCUText = document.getElementById("totalSCUBox").textContent;
  const totalSCU = parseInt(totalSCUText.replace(/\D/g, "")) || 0;
  const totalUEC = parseInt(get("totalUECBox")) || 0;
  
  const formDataForHistory = {
    orderCategory: get("orderCategory"),
    orderCategoryOther: get("orderCategoryOther"),
    companyName: get("companyName"),
    orderType: get("orderType"),
    orderTypeOther: get("orderTypeOther"),
    resourceDriveCompany: get("resourceDriveCompany"),
    shipName: get("shipName"),
    shipNameOther: get("shipNameOther"),
    captainName: get("captainName"),
    captainNameOther: get("captainNameOther"),
    crewAmount: get("crewAmount"),
    startLocation: get("startLocation"),
    departureTime: get("departureTime"),
    routeStart: get("routeStart"),
    routeEnd: get("routeEnd"),
    completionTime: get("completionTime"),
    repairs: get("repairs"),
    restock: get("restock"),
    quantumFuel: get("quantumFuel"),
    hydrogenFuel: get("hydrogenFuel"),
    crewCosts: get("crewCosts"),
    notes: get("notes")
  };
  
  const crewAmount = parseInt(get("crewAmount")) || 0;
  const crewNames = [];
  for (let i = 1; i <= crewAmount; i++) {
    const crewInput = document.getElementById('crewName' + i);
    if (crewInput && crewInput.value.trim()) {
      crewNames.push(crewInput.value.trim());
    }
  }
  
  const manifestHistory = [];
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scu = row.querySelector('.manifest-scu').value;
    const material = row.querySelector('.manifest-material').value;
    const uec = row.querySelector('.manifest-uec').value;
    if (scu && material) {
      manifestHistory.push({ scu: scu, material: material, uec: uec });
    }
  });
  
  let postCounter = parseInt(localStorage.getItem('discordHistoryCounter') || '1', 10);
  
  const history = getManifestHistory();
  history.push({ 
    id: postCounter, 
    content: discordMessage,
    timestamp: new Date().toISOString(),
    summary: summary,
    totalSCU: totalSCU,
    totalUEC: totalUEC,
    crewNames: crewNames,
    manifestLines: manifestHistory,
    ...formDataForHistory
  });
  
  setManifestHistory(history);
  localStorage.setItem('discordHistoryCounter', (postCounter + 1).toString());
  renderHistory();
}

function formatSCDate(timestamp) {
  if (!timestamp) return 'Unknown Date';
  try {
    const date = new Date(timestamp);
    if (isNaN(date.getTime())) return 'Invalid Date';
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
  } catch (e) {
    return 'Invalid Date';
  }
}

function renderHistory() {
  const historyList = document.getElementById('historyList');
  if (!historyList) return;

  let history = getManifestHistory();
  let filter = '';
  let sortOrder = localStorage.getItem('historySortOrder') || 'desc';

  historyList.innerHTML = 
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">' +
      '<input id="historySearchInput" type="text" placeholder="Search history..." style="flex:1;max-width:300px;padding:8px;border-radius:6px;border:1px solid #ccc;">' +
      '<div style="display:flex;gap:12px;align-items:center;">' +
        '<select id="historySortSelect" style="padding:8px;border-radius:6px;">' +
          '<option value="desc">Newest First</option>' +
          '<option value="asc">Oldest First</option>' +
        '</select>' +
        '<button id="deleteAllHistoryBtn" style="background:#ed4245;color:#fff;border:1px solid #781d15;border-radius:6px;padding:8px 12px;cursor:pointer;font-weight:bold;" title="Delete all manifests from history">Delete All</button>' +
      '</div>' +
    '</div>' +
    '<div id="historyPostsContainer"></div>';

  function renderPosts(posts, isSearchResult = false, searchTerm = '') {
    const container = document.getElementById('historyPostsContainer');
    if (!container) return;
    
    container.innerHTML = "";
    
    if (!posts || posts.length === 0) {
      if (isSearchResult && searchTerm) {
        container.innerHTML = `
          <div style="text-align: center; background: #fff; border: 3px solid #9d7523; border-radius: 12px; padding: 30px; margin-top: 20px;">
            <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" 
                 alt="BruteHaul Logo" 
                 style="max-width: 200px; width: 100%; margin-bottom: 20px; border-radius: 8px;">
            <h2 style="color: #9d7523; margin: 20px 0; font-size: 24px;">No Results Found</h2>
            <p style="font-size: 18px; color: #781d15; font-weight: bold; margin: 15px 0;">
              No manifests found matching "${searchTerm}"
            </p>
            <p style="color: #666; margin: 10px 0; font-size: 16px;">
              Try different search terms or clear the search to view all manifests.
            </p>
          </div>
        `;
      } else {
        container.innerHTML = `
          <div style="text-align: center; background: #fff; border: 3px solid #9d7523; border-radius: 12px; padding: 30px; margin-top: 20px;">
            <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" 
                 alt="BruteHaul Logo" 
                 style="max-width: 200px; width: 100%; margin-bottom: 20px; border-radius: 8px;">
            <h2 style="color: #9d7523; margin: 20px 0; font-size: 24px;">Brute Haul Manifest Log</h2>
            <p style="font-size: 18px; color: #781d15; font-weight: bold; margin: 15px 0;">
              No manifest generated on this browser.
            </p>
            <p style="color: #666; margin: 10px 0; font-size: 16px;">
              Complete and submit manifests to see them listed here.
            </p>
          </div>
        `;
      }
      return;
    }
    
    posts.forEach((post, idx) => {
          const postDiv = document.createElement("div");
          postDiv.className = "history-post";
          postDiv.style.marginBottom = "18px";
          postDiv.style.border = "2px solid #781d15";
          postDiv.style.borderRadius = "8px";
          postDiv.style.background = "#f9f9f9";
          postDiv.style.padding = "16px";
          postDiv.style.position = "relative";
          postDiv.style.boxShadow = "0 2px 8px rgba(0,0,0,0.07)";
          postDiv.style.transition = "box-shadow 0.2s";
          postDiv.addEventListener('mouseenter', () => {
            postDiv.style.boxShadow = "0 4px 16px rgba(120,29,21,0.13)";
          });
          postDiv.addEventListener('mouseleave', () => {
            postDiv.style.boxShadow = "0 2px 8px rgba(0,0,0,0.07)";
          });

          const titleDiv = document.createElement("div");
          titleDiv.className = "history-post-title";
          titleDiv.style.fontWeight = "bold";
          titleDiv.style.fontSize = "16px";
          titleDiv.style.marginBottom = "8px";
          titleDiv.style.color = "#781d15";
  titleDiv.textContent = 'Post ' + (idx + 1) + ' - ' + formatSCDate(post.timestamp);
          postDiv.appendChild(titleDiv);

          const contentDiv = document.createElement("div");
          contentDiv.className = "history-post-content";
          contentDiv.style.marginBottom = "10px";
          contentDiv.style.whiteSpace = "pre-wrap";
          contentDiv.style.fontFamily = "monospace";
          contentDiv.style.fontSize = "13px";
          contentDiv.style.backgroundColor = "#f8f8f8";
          contentDiv.style.border = "1px solid #ddd";
          contentDiv.style.padding = "12px";
          contentDiv.style.borderRadius = "6px";
          contentDiv.style.maxHeight = "300px";
          contentDiv.style.overflowY = "auto";
          contentDiv.style.lineHeight = "1.4";
          contentDiv.textContent = post.content || post.summary || "(No content)";
          postDiv.appendChild(contentDiv);

          const btnRow = document.createElement("div");
          btnRow.style.display = "flex";
          btnRow.style.gap = "8px";
          btnRow.style.marginTop = "6px";

          const copyBtn = document.createElement("button");
          copyBtn.className = "history-copy-btn";
          copyBtn.textContent = "Copy";
          copyBtn.title = "Copy manifest to clipboard";
          copyBtn.style.background = "#e2e2e2";
          copyBtn.style.color = "#230e09";
          copyBtn.style.border = "1px solid #781d15";
          copyBtn.style.borderRadius = "4px";
          copyBtn.style.padding = "4px 10px";
          copyBtn.style.cursor = "pointer";
          copyBtn.addEventListener("click", () => {
            copyHistoryPost(idx);
          });
          btnRow.appendChild(copyBtn);

          const autofillBtn = document.createElement("button");
          autofillBtn.className = "history-autofill-btn";
          autofillBtn.textContent = "Autofill";
          autofillBtn.title = "Autofill manifest form with this post's data";
          autofillBtn.style.background = "#43b581";
          autofillBtn.style.color = "#fff";
          autofillBtn.style.border = "1px solid #781d15";
          autofillBtn.style.borderRadius = "4px";
          autofillBtn.style.padding = "4px 10px";
          autofillBtn.style.cursor = "pointer";
          autofillBtn.addEventListener("click", () => {
            autofillManifestFormFromHistory(post);
          });
          btnRow.appendChild(autofillBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "history-delete-btn";
          deleteBtn.textContent = "Delete";
          deleteBtn.title = "Delete this manifest from history";
          deleteBtn.style.background = "#ed4245";
          deleteBtn.style.color = "#fff";
          deleteBtn.style.border = "1px solid #781d15";
          deleteBtn.style.borderRadius = "4px";
          deleteBtn.style.padding = "4px 10px";
          deleteBtn.style.cursor = "pointer";
          deleteBtn.addEventListener("click", () => {
            showConfirmationOverlay(
              'Are you sure you want to delete this manifest from history?<br><br><strong>This action cannot be undone.</strong>',
              () => {
                posts.splice(idx, 1);
                setManifestHistory(posts);
                renderPosts(posts);
                showNotificationOverlay('✅ Manifest Deleted<br><br><strong>The manifest has been removed from your history.</strong>', 'success');
              }
            );
          });
          btnRow.appendChild(deleteBtn);

          postDiv.appendChild(btnRow);
          container.appendChild(postDiv);
        });
  }
  
  const searchInput = document.getElementById('historySearchInput');
  const sortSelect = document.getElementById('historySortSelect');
  
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      filter = e.target.value.toLowerCase();
      const filteredPosts = history.filter(post => 
        (post.content && post.content.toLowerCase().includes(filter)) ||
        (post.summary && post.summary.toLowerCase().includes(filter))
      );
      renderPosts(filteredPosts, filter.length > 0, filter);
    });
  }
  
  if (sortSelect) {
    sortSelect.value = sortOrder;
    sortSelect.addEventListener('change', (e) => {
      sortOrder = e.target.value;
      localStorage.setItem('historySortOrder', sortOrder);
      
      let postsToSort = history;
      if (filter) {
        postsToSort = history.filter(post => 
          (post.content && post.content.toLowerCase().includes(filter)) ||
          (post.summary && post.summary.toLowerCase().includes(filter))
        );
      }
      
      const sortedPosts = [...postsToSort].sort((a, b) => {
        const aTime = new Date(a.timestamp || 0).getTime();
        const bTime = new Date(b.timestamp || 0).getTime();
        return sortOrder === 'desc' ? bTime - aTime : aTime - bTime;
      });
      renderPosts(sortedPosts, filter.length > 0, filter);
    });
  }
  
  const deleteAllBtn = document.getElementById('deleteAllHistoryBtn');
  if (deleteAllBtn) {
    deleteAllBtn.addEventListener('click', () => {
      if (history.length === 0) {
        showNotificationOverlay('ℹ️ No History to Delete<br><br><strong>There are no manifests in your history.</strong>', 'info');
        return;
      }
      
      showConfirmationOverlay(
        '⚠️ Delete All Manifests?<br><br><strong>This will permanently delete all ' + history.length + ' manifest(s) from your browser history.</strong><br><br>This action cannot be undone.',
        () => {
          setManifestHistory([]);
          history = [];
          renderPosts([], false, '');
          showNotificationOverlay('✅ All Manifests Deleted<br><br><strong>Your manifest history has been cleared.</strong>', 'success');
        }
      );
    });
  }
  
  const sortedPosts = [...history].sort((a, b) => {
    const aTime = new Date(a.timestamp || 0).getTime();
    const bTime = new Date(b.timestamp || 0).getTime();
    return sortOrder === 'desc' ? bTime - aTime : aTime - bTime;
  });
  renderPosts(sortedPosts, false, '');
}

function autofillManifestFormFromHistory(post) {
  if (!post) return;
  const fieldMap = {
    orderCategory: 'orderCategory',
    orderCategoryOther: 'orderCategoryOther',
    companyName: 'companyName',
    orderType: 'orderType',
    orderTypeOther: 'orderTypeOther',
    resourceDriveCompany: 'resourceDriveCompany',
    shipName: 'shipName',
    shipNameOther: 'shipNameOther',
    captainName: 'captainName',
    captainNameOther: 'captainNameOther',
    crewAmount: 'crewAmount',
    startLocation: 'startLocation',
    departureTime: 'departureTime',
    routeStart: 'routeStart',
    routeEnd: 'routeEnd',
    completionTime: 'completionTime',
    repairs: 'repairs',
    restock: 'restock',
    quantumFuel: 'quantumFuel',
    hydrogenFuel: 'hydrogenFuel',
    crewCosts: 'crewCosts',
    notes: 'notes',
    totalUECBox: 'totalUECBox'
  };
  for (const key in fieldMap) {
    if (post[key] !== undefined && document.getElementById(fieldMap[key])) {
      document.getElementById(fieldMap[key]).value = post[key];
    }
  }

  if (post.crewNames && Array.isArray(post.crewNames)) {
    document.getElementById('crewAmount').value = post.crewNames.length;
    generateCrewInputs();
    post.crewNames.forEach((name, i) => {
  var crewInput = document.getElementById('crewName' + (i+1));
  if (crewInput) crewInput.value = name;
    });
  } else {
    generateCrewInputs();
  }

  if (post.manifestLines && Array.isArray(post.manifestLines)) {
    window.manifestLineCount = post.manifestLines.length;
    renderManifestLines();
    post.manifestLines.forEach((line, i) => {
      const row = document.querySelectorAll('.manifest-row')[i];
      if (row) {
        if (row.querySelector('.manifest-scu') && line.scu !== undefined) row.querySelector('.manifest-scu').value = line.scu;
        if (row.querySelector('.manifest-material') && line.material !== undefined) row.querySelector('.manifest-material').value = line.material;
        if (row.querySelector('.manifest-uec') && line.uec !== undefined) row.querySelector('.manifest-uec').value = line.uec;
      }
    });
    updateManifestTotals();
  }

  if (post.securityShips && Array.isArray(post.securityShips)) {
    const securityShipsInput = document.getElementById('securityShips');
    if (securityShipsInput && securityShipsInput.setSelectedShips) {
      securityShipsInput.setSelectedShips(post.securityShips);
    } else if (securityShipsInput) {
      securityShipsInput.value = post.securityShips.join(', ');
    }
    populateSecurityShipsDropdown();
    updateSecurityCaptainDropdowns(post.securityShips);
  }

  if (post.securityShipData && typeof post.securityShipData === 'object') {
    Object.entries(post.securityShipData).forEach(([shipId, data]) => {
      var captainInput = document.getElementById('securityCaptain_' + shipId);
      if (captainInput && data.captain !== undefined) captainInput.value = data.captain;
      var crewInput = document.getElementById('securityCrew_' + shipId);
      if (crewInput && data.crewAmount !== undefined) crewInput.value = data.crewAmount;
      generateSecurityCrewInputs(shipId, shipId, data.crewAmount || 0);
      if (Array.isArray(data.crewNames)) {
        for (var i = 0; i < data.crewNames.length; i++) {
          var crewNameInput = document.getElementById('securityCrew_' + shipId + '_' + (i+1));
          if (crewNameInput) crewNameInput.value = data.crewNames[i];
        }
      }
    });
  }

  calculateFormProgress();
  showTab('formTab');
  showNotificationOverlay('Manifest autofilled from history.', 'success', 2000);
}

function deleteHistoryPost(idx) {
  let history = getManifestHistory();
  history.splice(idx, 1);
  setManifestHistory(history);
  renderHistory();
}

function copyHistoryPost(idx) {
  let history = getManifestHistory();
  if (history[idx]) {
    const temp = document.createElement('textarea');
    temp.value = history[idx].content;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    showNotificationOverlay("History post copied to clipboard!", 'success');
  }
}

function saveManifestToHistory(manifest) {
  let history = JSON.parse(localStorage.getItem('discordHistory') || '[]');
  history.push(manifest);
  localStorage.setItem('discordHistory', JSON.stringify(history));
}

function getManifestHistory() {
  return JSON.parse(localStorage.getItem('discordHistory') || '[]');
}

function setManifestHistory(history) {
  localStorage.setItem('discordHistory', JSON.stringify(history));
}

function clearManifestHistory() {
  localStorage.removeItem('discordHistory');
}

window.deleteHistoryPost = deleteHistoryPost;
window.copyHistoryPost = copyHistoryPost;

window.sendToDiscord = sendToDiscord;

async function sendToDiscord() {
  const message = document.getElementById("discordOutput").value;
  const orderType = document.getElementById("orderType").value;
  const resourceDriveCompany = document.getElementById("resourceDriveCompany").value;
  const totalSCU = parseInt(document.getElementById("totalSCUBox").textContent.replace(/\D/g, "")) || 0;
  const captainName = document.getElementById("captainName").value;
  let shipName = document.getElementById("shipName").value;
  if (shipName === "Other") {
    shipName = document.getElementById("shipNameOther").value;
  }

  let selectedSecurityShips = [];
  let securityShipsText = "None";
  
  try {
    if (typeof getSelectedSecurityShips === 'function') {
      selectedSecurityShips = getSelectedSecurityShips();
    }
  } catch (e) {
    console.warn('Error getting selected security ships:', e);
    selectedSecurityShips = [];
  }
  
  if (!selectedSecurityShips || selectedSecurityShips.length === 0 || (selectedSecurityShips.length === 1 && (!selectedSecurityShips[0] || selectedSecurityShips[0] === "None"))) {
    securityShipsText = "None";
  } else {
    securityShipsText = selectedSecurityShips.join("\n");
  }

  // Warning: No message generated
  if (!message) {
    showNotificationOverlay("Missing Discord Post<br><br><strong>No message to send</strong><br><br>Please generate a Discord post first by clicking the 'Generate Discord Post' button.", 'warning');
    showFeedback('warning', 'No message to send. Please generate a Discord post first.');
    showCopyButton();
    logErrorToGitHub('V004', 'No message generated', 'User attempted to send without generating Discord post first', null, {
      validationStep: 'Message check',
      formCompleted: false
    });
    return;
  }

  // Warning: Required fields missing
  if (!orderType || !captainName) {
    showNotificationOverlay("Required Information Missing<br><br><strong>Order Type and Captain Name are required</strong><br><br>Please fill in these fields to send to Discord.", 'warning');
    showFeedback('warning', 'Order Type and Captain Name are required to send to Discord.');
    showCopyButton();
  logErrorToGitHub('V005', 'Required fields missing', 'Missing fields - Order Type: ' + (orderType ? 'Present' : 'Missing') + ', Captain Name: ' + (captainName ? 'Present' : 'Missing'), null, {
      validationStep: 'Required fields check',
      missingFields: [
        !orderType ? 'Order Type' : null,
        !captainName ? 'Captain Name' : null
      ].filter(Boolean)
    });
    return;
  }

  const sendBtn = Array.from(document.querySelectorAll("button"))
    .find(btn => btn.textContent.includes("Send to Discord"));
  
  if (sendBtn) {
    sendBtn.classList.add('button-loading');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<div class="loading-spinner"></div>Sending to Discord...';
  }
  
  showLoadingOverlay('Sending to Brute Haul Discord...');

 
  const endpoints = [
    "https://brutehaulrailway-production.up.railway.app/send-discord"
  ];

  try {
    const get = id => document.getElementById(id)?.value?.trim() || "";
    
    let orderCategoryText = get("orderCategory");
    if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");
    
    let companyNameText = get("companyName");
    
    let orderTypeText = get("orderType");
    if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");
    
    let captainNameText = get("captainName");
    if (captainNameText === "Other") captainNameText = get("captainNameOther");
    
    const crewAmount = parseInt(get("crewAmount"), 10);
    let crewNamesList = [];
    for (let i = 1; i <= crewAmount; i++) {
  var crewInput = document.getElementById('crewName' + i);
      if (crewInput && crewInput.value.trim()) {
        crewNamesList.push(crewInput.value.trim());
      }
    }
  var crewAmountWithNames = crewAmount > 0 ? (crewAmount + ' (' + crewNamesList.join(', ') + ')') : '0';
    
    const totalUECInput = document.getElementById("totalUECBox");
    const totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) || 0 : 0;
    
    const repairs = parseInt(get("repairs") || "0", 10);
    const restock = parseInt(get("restock") || "0", 10);
    const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
    const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
    const crewCosts = parseInt(get("crewCosts") || "0", 10);
    
    let response;
    let successfulEndpoint = null;
    let lastError = null;
    
    for (const endpoint of endpoints) {
      try {
  console.log('Trying endpoint: ' + endpoint);
        response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            date: new Date().toISOString().split('T')[0], // Current date
            orderCategory: orderCategoryText,
            companyName: companyNameText,
            orderType: orderTypeText,
            shipName: shipName,
            captainName: captainNameText,
            crewAmount: crewAmountWithNames,
            securityShips: securityShipsText,
            securityShipsData: selectedSecurityShips.filter(ship => ship && ship !== 'None' && ship !== 'Other' && ship.trim() !== '').map(ship => {
              const shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
              var captainInput = document.getElementById('securityCaptain_' + shipId);
              return {
                ship: ship,
                captain: captainInput ? captainInput.value.trim() : ''
              };
            }),
            startLocation: get("startLocation"),
            departureTimestamp: get("departureTime"),
            routeStart: get("routeStart"),
            routeEnd: get("routeEnd"),
            totalSCU: totalSCU,
            totalUEC: totalUEC,
            orderCompletionTimestamp: get("completionTime"),
            orderTime: getOrderDurationText(),
            repairs: repairs,
            restock: restock,
            quantumFuel: quantumFuel,
            hydrogenFuel: hydrogenFuel,
            crewShipCosts: crewCosts,
            notes: get("notes"),
            resourceDriveCompany,
            shipNames: typeof allShips !== "undefined" ? allShips : []
          })
        });
        
        if (response.ok) {
          successfulEndpoint = endpoint;
          console.log('Success with endpoint: ' + endpoint);
          break;
        } else {
          lastError = 'HTTP ' + response.status + ': ' + response.statusText;
          console.log('HTTP error with ' + endpoint + ': ' + lastError);
        }
      } catch (error) {
        lastError = error.message;
        console.log('Network error with ' + endpoint + ':', error.message);
        continue;
      }
    }
    
    if (!response || !response.ok) {
      throw new Error(lastError || "Railway server connection failed - please check server status");
    }

    let data;
    try {
      data = await response.json();
    } catch {
      hideLoadingOverlay();
      showNotificationOverlay("Server Restarting<br><br>The Brute Haul System is currently restarting.<br><br><strong>Error E005:</strong> Please try again in 30 seconds.", 'warning');
      showFeedback('warning', 'Server restarting (E005) - Please try again shortly');
      showCopyButton();
      
      logErrorToGitHub('E005', 'Server restarting', 'JSON parsing failed - server likely restarting', null, {
        responseStatus: response?.status || 'Unknown',
        responseOk: response?.ok || false,
        endpoint: successfulEndpoint || 'Unknown endpoint',
        parsingError: true,
        serverState: 'Restarting'
      });
      
      if (sendBtn) {
        sendBtn.classList.remove('button-loading');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />Send to Discord';
      }
      return;
    }

    if (response.ok) {
      hideLoadingOverlay();
      
      saveSuccessfulManifestToHistory();
      
      showLoadingMessage("✅ Successfully sent to Brute Haul Discord!<br><br>Your manifest has been posted and logged.", 2000);
      showFeedback('success', 'Successfully sent to Brute Haul');
      document.getElementById("discordSection").style.display = "none";
      clearFormFields();
    } else {
      hideLoadingOverlay();
      let errorCode = response.status || 'UNKNOWN';
      let errorMsg = data?.error || 'Unknown server error';
      let instructions = 'Please try again later. Bug Report Submitted';
      
      switch (response.status) {
        case 400:
          errorCode = 'E400';
          errorMsg = 'Invalid request data';
          instructions = 'Please check all form fields are filled correctly and try again.';
          break;
        case 401:
          errorCode = 'E401';
          errorMsg = 'Authentication required';
          instructions = 'Server access denied. Please refresh the page and try again.';
          break;
        case 403:
          errorCode = 'E403';
          errorMsg = 'Access forbidden';
          instructions = 'Server rejected the request.';
          break;
        case 404:
          errorCode = 'E404';
          errorMsg = 'Service not found';
          instructions = 'The Brute Haul service endpoint is not available.';
          break;
        case 429:
          errorCode = 'E429';
          errorMsg = 'Too many requests';
          instructions = 'You are sending requests too quickly. Please wait 1 minute and try again.';
          break;
        case 500:
          errorCode = 'E500';
          errorMsg = 'Internal server error';
          instructions = 'The Brute Haul server encountered an error. Please try again in a few minutes.';
          break;
        case 502:
          errorCode = 'E502';
          errorMsg = 'Bad gateway';
          instructions = 'Server gateway error. The service may be restarting - try again shortly.';
          break;
        case 503:
          errorCode = 'E503';
          errorMsg = 'Service unavailable';
          instructions = 'The Brute Haul server is temporarily unavailable. Please try again later.';
          break;
        case 504:
          errorCode = 'E504';
          errorMsg = 'Gateway timeout';
          instructions = 'Server took too long to respond. Please try again.';
          break;
        default:
          if (data?.error?.includes('Discord')) {
            if (data.error.includes('webhook')) {
              errorCode = 'D001';
              errorMsg = 'Discord webhook error';
              instructions = 'Discord connection failed.';
            } else if (data.error.includes('rate limit')) {
              errorCode = 'D002';
              errorMsg = 'Discord rate limited';
              instructions = 'Discord is rate limiting requests. Please wait 5 minutes and try again.';
            } else if (data.error.includes('message')) {
              errorCode = 'D003';
              errorMsg = 'Discord message error';
              instructions = 'Your message format was rejected by Discord.';
            }
          } else if (data?.error?.includes('Google') || data?.error?.includes('Sheets')) {
            if (data.error.includes('credentials') || data.error.includes('authentication')) {
              errorCode = 'G001';
              errorMsg = 'Google Sheets credentials error';
              instructions = 'Server configuration issue.';
            } else if (data.error.includes('permission') || data.error.includes('access')) {
              errorCode = 'G003';
              errorMsg = 'Google Sheets permission denied';
              instructions = 'Server lacks permission to write data.';
            } else if (data.error.includes('quota') || data.error.includes('limit')) {
              errorCode = 'G004';
              errorMsg = 'Google Sheets quota exceeded';
              instructions = 'Google Sheets API limit reached. Please try again in an hour.';
            } else {
              errorCode = 'G002';
              errorMsg = 'Google Sheets connection failed';
              instructions = 'Unable to save to spreadsheet. Your Discord post was sent but data logging failed.';
            }
          } else if (data?.error?.includes('bot') || data?.error?.includes('token')) {
            if (data.error.includes('token') || data.error.includes('authentication')) {
              errorCode = 'B001';
              errorMsg = 'Discord bot authentication failed';
              instructions = 'Server configuration issue.';
            } else if (data.error.includes('offline') || data.error.includes('disconnected')) {
              errorCode = 'B002';
              errorMsg = 'Discord bot offline';
              instructions = 'The Discord bot is currently offline.';
            } else if (data.error.includes('channel') || data.error.includes('not found')) {
              errorCode = 'B003';
              errorMsg = 'Discord channel not found';
              instructions = 'Server cannot find the Discord channel.';
            } else if (data.error.includes('permission') || data.error.includes('access')) {
              errorCode = 'B004';
              errorMsg = 'Discord bot lacks permissions';
              instructions = 'Bot cannot post to channel.';
            }
          } else if (data?.error?.includes('validation') || data?.error?.includes('invalid')) {
            if (data.error.includes('manifest') || data.error.includes('format')) {
              errorCode = 'V001';
              errorMsg = 'Invalid manifest data format';
              instructions = 'Your form data format is invalid. Please refresh the page and try again.';
            } else if (data.error.includes('required') || data.error.includes('missing')) {
              errorCode = 'V002';
              errorMsg = 'Server validation failed';
              instructions = 'Server rejected your data. Please check all required fields and try again.';
            } else if (data.error.includes('parse') || data.error.includes('JSON')) {
              errorCode = 'V003';
              errorMsg = 'Data parsing error';
              instructions = 'Server cannot read your form data. Please refresh the page and try again.';
            }
          }
          break;
      }
      
      showNotificationOverlay('❌ Failed to send to Discord<br><br><strong>Error ' + errorCode + ':</strong> ' + errorMsg + '<br><br>' + instructions, 'error');
      showFeedback('error', 'Error sending to Brute Haul (' + errorCode + '): ' + errorMsg);
      showCopyButton();
      
      logErrorToGitHub(errorCode, errorMsg, 'HTTP ' + response.status + ': ' + (data && data.error || 'Unknown server error'), null, {
        httpStatus: response.status,
        httpStatusText: response.statusText,
        serverResponse: data,
        endpoint: successfulEndpoint || 'No successful endpoint',
        attemptedEndpoints: endpoints.length,
        requestPayload: {
          messageLength: message?.length || 0,
          orderType: orderType,
          captainName: captainName ? 'Present' : 'Missing',
          shipName: shipName ? 'Present' : 'Missing',
          totalSCU: totalSCU
        }
      });
      
      setTimeout(showErrorReportLink, 1000);
    }
  } catch (err) {
    hideLoadingOverlay();
    console.error('Send to Discord error:', err);
    
    let errorCode = 'E701';
    let errorMsg = 'Connection failed';
    let instructions = 'Please try again later or contact DyslexicNerd01';
    
    if (err.message.includes('Railway server connection failed')) {
      errorCode = 'R001';
      errorMsg = 'Railway server connection failed';
      instructions = 'The Brute Haul server may be restarting. Please try again in a few moments.';
    } else if (err.message.includes('fetch') || err.message.includes('Network')) {
      errorCode = 'E703';
      errorMsg = 'Network connection error';
      instructions = 'Check your internet connection and try again.';
    } else if (err.message.includes('CORS')) {
      errorCode = 'E704';
      errorMsg = 'Cross-origin request blocked';
      instructions = 'Browser security blocked the request. Try refreshing the page.';
    } else if (err.message.includes('timeout') || err.message.includes('aborted')) {
      errorCode = 'E408';
      errorMsg = 'Request timeout';
      instructions = 'The server took too long to respond. Please try again.';
    } else if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
      errorCode = 'E702';
      errorMsg = 'Network request blocked';
      instructions = 'Check your firewall/antivirus settings or try a different network.';
    } else if (err.message.includes('SSL') || err.message.includes('certificate')) {
      errorCode = 'S001';
      errorMsg = 'SSL/Certificate error';
      instructions = 'Server SSL certificate issue. Try using HTTP or contact DyslexicNerd01.';
    } else if (err.message.includes('abort') || err.message.includes('cancelled')) {
      errorCode = 'C001';
      errorMsg = 'Request cancelled';
      instructions = 'The request was cancelled. Please try again.';
    } else if (err.message.includes('quota') || err.message.includes('usage limit')) {
      errorCode = 'Q001';
      errorMsg = 'API quota exceeded';
      instructions = 'Service usage limit reached. Please try again in an hour.';
    } else if (err.message.includes('maintenance') || err.message.includes('scheduled')) {
      errorCode = 'M001';
      errorMsg = 'Scheduled maintenance';
      instructions = 'System is under maintenance. Please check Discord for updates.';
    } else if (err.message.includes('memory') || err.message.includes('resource')) {
      errorCode = 'R002';
      errorMsg = 'Server resource limit';
      instructions = 'Server is under high load. Please try again in a few minutes.';
    }
    
    showNotificationOverlay('❌ Connection Failed<br><br><strong>Error ' + errorCode + ':</strong> ' + errorMsg + '<br><br>' + instructions, 'error');
    showFeedback('error', 'The Brute Haul System is currently offline (' + errorCode + '). Please try again later.');
    showCopyButton();
    
    logErrorToGitHub(errorCode, errorMsg, err.message, err.stack, {
      errorType: err.name || 'Unknown',
      networkError: true,
      endpointsAttempted: endpoints,
      lastEndpointTried: endpoints[endpoints.length - 1],
      connectionDetails: {
        online: navigator.onLine,
        effectiveType: navigator.connection?.effectiveType || 'Unknown',
        downlink: navigator.connection?.downlink || 'Unknown'
      },
      requestContext: {
        messageLength: message?.length || 0,
        formCompleted: !!(orderType && captainName && message),
        totalSCU: totalSCU,
        hasShipName: !!shipName
      }
    });
    
    setTimeout(showErrorReportLink, 1000);
  } finally {
    if (sendBtn) {
      sendBtn.classList.remove('button-loading');
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />Send to Discord';
    }
  }
}
function generateAnnouncement() {
  const title = document.getElementById("announcementTitle").value.trim();
  const body = document.getElementById("announcementBody").value.trim();
  if (!title && !body) {
    showNotificationOverlay("Please enter a title or body for the announcement.", 'warning', 3000);
    return;
  }
  var output = '📢 **' + (title || "Announcement") + '**\n\n' + body;
  document.getElementById("announcementOutput").value = output;
}

function copyAnnouncementOutput() {
  const output = document.getElementById("announcementOutput");
  output.select();
  output.setSelectionRange(0, 99999);
  document.execCommand("copy");
  showNotificationOverlay("Announcement copied to clipboard!", 'success');
}

window.generateAnnouncement = generateAnnouncement;
window.copyAnnouncementOutput = copyAnnouncementOutput;

async function logErrorToGitHub(errorCode, errorMsg, fullError, stackTrace, additionalContext = {}) {
  console.log('🔧 logErrorToGitHub called with:', { errorCode, errorMsg });
  
  try {    
    function getGitHubToken() {
      let token = 'ERROR_REPORTER_TOKEN_PLACEHOLDER';
      if (token !== 'ERROR_REPORTER_TOKEN_PLACEHOLDER') {
        return token;
      }
      
      if (localStorage.getItem('simulate_deployed_token')) {
        return localStorage.getItem('simulate_deployed_token');
      }
      
      if (typeof process !== 'undefined' && process.env?.ERROR_REPORTER_TOKEN) {
        return process.env.ERROR_REPORTER_TOKEN;
      }
      
      const storedToken = localStorage.getItem('github_error_token_encrypted');
      if (storedToken) {
        try {
          return atob(storedToken.split('').reverse().join(''));
        } catch (e) {
          console.warn('Failed to decode stored token');
        }
      }
      
      if (confirm('GitHub error logging is not configured. Would you like to set it up now? (This will enable automatic error reporting)')) {
        const userToken = prompt('Enter your GitHub Personal Access Token (this will be stored locally and encrypted):');
        if (userToken && userToken.startsWith('ghp_')) {
          const encrypted = btoa(userToken).split('').reverse().join('');
          localStorage.setItem('github_error_token_encrypted', encrypted);
          return userToken;
        }
      }
      
      return null;
    }
    
    const GITHUB_TOKEN = getGitHubToken();
    const GITHUB_REPO = 'DyslexicNerd01/Brute-Haul-Cargo-Log';
    
    console.log('🔧 GitHub token status:', GITHUB_TOKEN ? 'Found' : 'Not found');
    
    if (!GITHUB_TOKEN) {
      console.log('🔧 GitHub error logging not configured - add your GitHub Personal Access Token to enable automatic error reporting');
      return;
    }
    
    console.log('🔧 Proceeding with GitHub issue creation...');
    
    const errorContext = {
      timestamp: new Date().toISOString(),
      errorCode: errorCode,
      errorMessage: errorMsg,
      fullError: fullError,
      stackTrace: stackTrace,
      userAgent: navigator.userAgent,
      pageUrl: window.location.href,
      viewport: window.innerWidth + 'x' + window.innerHeight,
      language: navigator.language,
      platform: navigator.platform,
      cookiesEnabled: navigator.cookieEnabled,
      onlineStatus: navigator.onLine,
      referrer: document.referrer || 'Direct access',
      ...additionalContext
    };
    
    try {
      const get = id => document.getElementById(id)?.value?.trim() || "";
      
      const formData = {
        orderType: get("orderType"),
        orderCategory: get("orderCategory"),
        orderCategoryOther: get("orderCategoryOther"),
        orderTypeOther: get("orderTypeOther"),
        companyName: get("companyName"),
        resourceDriveCompany: get("resourceDriveCompany"),
        shipName: get("shipName"),
        shipNameOther: get("shipNameOther"),
        captainName: get("captainName"),
        captainNameOther: get("captainNameOther"),
        crewAmount: get("crewAmount"),
        startLocation: get("startLocation"),
        routeStart: get("routeStart"),
        routeEnd: get("routeEnd"),
        departureTime: get("departureTime"),
        completionTime: get("completionTime"),
        totalSCU: document.getElementById("totalSCUBox")?.textContent || '0',
        totalUEC: get("totalUECBox"),
        repairs: get("repairs"),
        restock: get("restock"),
        quantumFuel: get("quantumFuel"),
        hydrogenFuel: get("hydrogenFuel"),
        crewCosts: get("crewCosts"),
        notes: get("notes"),
        discordMessage: document.getElementById("discordOutput")?.value || 'No message generated',
        messageLength: document.getElementById("discordOutput")?.value?.length || 0
      };
      
      // crew names
      const crewAmount = parseInt(get("crewAmount"), 10);
      const crewNames = [];
      for (let i = 1; i <= crewAmount; i++) {
        var crewName = get('crewName' + i);
        if (crewName) crewNames.push(crewName);
      }
      formData.crewNames = crewNames;
      
      // security ships data
      if (typeof getSelectedSecurityShips === 'function') {
        try {
          const selectedSecurityShips = getSelectedSecurityShips();
          formData.securityShips = selectedSecurityShips;
          
          const securityShipsData = [];
          selectedSecurityShips.forEach(ship => {
            if (ship && ship !== 'None') {
              const shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
              var captainInput = document.getElementById('securityCaptain_' + shipId);
              var crewInput = document.getElementById('securityCrew_' + shipId);
              securityShipsData.push({
                ship: ship,
                captain: captainInput ? captainInput.value.trim() : '',
                crewAmount: crewInput ? crewInput.value : '0'
              });
            }
          });
          formData.securityShipsData = securityShipsData;
        } catch (e) {
          formData.securityShipsError = e.message;
        }
      }
      
      // manifest data
      const manifestRows = document.querySelectorAll('.manifest-row');
      const manifestData = [];
      manifestRows.forEach(row => {
        const scu = row.querySelector('.manifest-scu')?.value || '';
        const material = row.querySelector('.manifest-material')?.value || '';
        const uec = row.querySelector('.manifest-uec')?.value || '';
        if (scu || material || uec) {
          manifestData.push({ scu, material, uec });
        }
      });
      formData.manifestData = manifestData;
      
      errorContext.formData = formData;
    } catch (formError) {
      errorContext.formDataError = 'Could not collect form data: ' + formError.message;
    }
  } catch (setupError) {
    console.error('❌ GitHub setup error:', setupError);
    return;
  }
  
  try {
    var issueData = {
      title: 'Brute Haul Bot Send Failure - ' + errorCode + ': ' + errorMsg,
      body: '## Automatic Error Report Generation\n\n' +
            '**Error Code:** ' + errorCode + '\n' +
            '**Error Message:** ' + errorMsg + '\n' +
            '**Timestamp:** ' + errorContext.timestamp + '\n\n' +
            '---\n\n' +
            '## Error Details\n\n' +
            '| Field | Value |\n' +
            '|----------|-------|\n' +
            '| **Error Code** | ' + errorCode + ' |\n' +
            '| **Error Message** | ' + errorMsg + ' |\n' +
            '| **Page URL** | ' + errorContext.pageUrl + ' |\n' +
            '| **User Agent** | ' + errorContext.userAgent + ' |\n' +
            '| **Viewport** | ' + errorContext.viewport + ' |\n' +
            '| **Language** | ' + errorContext.language + ' |\n' +
            '| **Platform** | ' + errorContext.platform + ' |\n' +
            '| **Online Status** | ' + (errorContext.onlineStatus ? 'Online' : 'Offline') + ' |\n' +
            '| **Cookies Enabled** | ' + (errorContext.cookiesEnabled ? 'Yes' : 'No') + ' |\n' +
            '| **Referrer** | ' + errorContext.referrer + ' |\n\n' +
            '---\n\n' +
            '## Technical Details\n\n' +
            '### Full Error Message\n' +
            (fullError || 'No additional error details') + '\n\n' +
            '### Stack Trace\n' +
            (stackTrace || 'No stack trace available') + '\n\n' +
            '---\n\n## Form Data Context\n\n' +
            (errorContext.formData ? 
              '| Field | Value |\n|-------|-------|\n' +
              '| **Order Type** | ' + (errorContext.formData.orderType || 'Not set') + ' |\n' +
              '| **Captain Name** | ' + (errorContext.formData.captainName || 'Not set') + ' |\n' +
              '| **Ship Name** | ' + (errorContext.formData.shipName || 'Not set') + ' |\n' +
              '| **Company Name** | ' + (errorContext.formData.companyName || 'Not set') + ' |\n' +
              '| **Total SCU** | ' + (errorContext.formData.totalSCU || '0') + ' |\n' +
              '| **Total UEC** | ' + (errorContext.formData.totalUEC || '0') + ' |\n' +
              '| **Message Length** | ' + errorContext.formData.messageLength + ' characters |\n' +
              '| **Manifest Items** | ' + (errorContext.formData.manifestData ? errorContext.formData.manifestData.length : 0) + ' items |\n' +
              '| **Security Ships** | ' + (errorContext.formData.securityShips ? errorContext.formData.securityShips.join(', ') : 'None') + ' |\n' +
              '| **Crew Amount** | ' + (errorContext.formData.crewAmount || '0') + ' |\n' :
              'Form data unavailable: ' + (errorContext.formDataError || 'Unknown reason')) +
            '\n\n### Complete Form Data\n\n' +
            (errorContext.formData ? 
              '**Order Information**\n' +
              '- **Order Category:** ' + (errorContext.formData.orderCategory || 'Not set') + 
              (errorContext.formData.orderCategoryOther ? ' (Other: ' + errorContext.formData.orderCategoryOther + ')' : '') + '\n' +
              '- **Order Type:** ' + (errorContext.formData.orderType || 'Not set') + 
              (errorContext.formData.orderTypeOther ? ' (Other: ' + errorContext.formData.orderTypeOther + ')' : '') + '\n' +
              '- **Company Name:** ' + (errorContext.formData.companyName || 'Not set') + '\n' +
              '- **Resource Drive Company:** ' + (errorContext.formData.resourceDriveCompany || 'Not applicable') + '\n\n' +
              '**Transport Ship Information**\n' +
              '- **Ship Name:** ' + (errorContext.formData.shipName || 'Not set') + 
              (errorContext.formData.shipNameOther ? ' (Other: ' + errorContext.formData.shipNameOther + ')' : '') + '\n' +
              '- **Captain Name:** ' + (errorContext.formData.captainName || 'Not set') + 
              (errorContext.formData.captainNameOther ? ' (Other: ' + errorContext.formData.captainNameOther + ')' : '') + '\n' +
              '- **Crew Amount:** ' + (errorContext.formData.crewAmount || '0') + '\n' +
              (errorContext.formData.crewNames && errorContext.formData.crewNames.length > 0 ? '- **Crew Names:** ' + errorContext.formData.crewNames.join(', ') + '\n' : '') + '\n' +
              '**Security Ships**\n' +
              (errorContext.formData.securityShips && errorContext.formData.securityShips.length > 0 ? 
                errorContext.formData.securityShips.map(function(ship) { return ship === 'None' ? '- None' : '- ' + ship; }).join('\n') : 
                '- None') + '\n' :
              'No form data available') + '\n\n' +

            '**Route Information**\n' +
            '- **Start Location:** ' + (errorContext.formData.startLocation || 'Not set') + '\n' +
            '- **Route Start:** ' + (errorContext.formData.routeStart || 'Not set') + '\n' +
            '- **Route End:** ' + (errorContext.formData.routeEnd || 'Not set') + '\n' +
            '- **Departure Time:** ' + (errorContext.formData.departureTime || 'Not set') + '\n' +
            '- **Completion Time:** ' + (errorContext.formData.completionTime || 'Not set') + '\n\n' +

            '**Manifest Data**\n' +
            '- **Total SCU:** ' + (errorContext.formData.totalSCU || '0') + '\n' +
            '- **Total UEC:** ' + (errorContext.formData.totalUEC || '0') + '\n' +
            (errorContext.formData ?
              (errorContext.formData.manifestData && errorContext.formData.manifestData.length > 0 ? 
                '\n**Manifest Items:**\n' + errorContext.formData.manifestData.map(function(item, index) {
                  return (index + 1) + '. ' + (item.scu || '0') + ' SCU - ' + (item.material || 'Not set') + ' - ' + (item.uec || '0') + ' UEC';
                }).join('\n') : 
                '\n**No manifest items found**') + '\n\n' +

              '**Deductibles**\n' +
              '- **Repairs:** ' + (errorContext.formData.repairs || '0') + ' UEC\n' +
              '- **Restock:** ' + (errorContext.formData.restock || '0') + ' UEC\n' +
              '- **Quantum Fuel:** ' + (errorContext.formData.quantumFuel || '0') + ' UEC\n' +
              '- **Hydrogen Fuel:** ' + (errorContext.formData.hydrogenFuel || '0') + ' UEC\n' +
              '- **Crew/Ship Costs:** ' + (errorContext.formData.crewCosts || '0') + ' UEC\n\n' +

              '**Notes**\\n' +
              String.fromCharCode(96) + String.fromCharCode(96) + String.fromCharCode(96) + '\\n' +
              (errorContext.formData.notes || 'No notes provided') + '\\n' +
              String.fromCharCode(96) + String.fromCharCode(96) + String.fromCharCode(96) + '\\n\\n' +
              
              '**Generated Discord Message**\\n' +
              String.fromCharCode(96) + String.fromCharCode(96) + String.fromCharCode(96) + '\\n' +
              (errorContext.formData.discordMessage || 'No message was generated') + '\\n' +
              String.fromCharCode(96) + String.fromCharCode(96) + String.fromCharCode(96) + '\\n' 
            : 'Form data could not be collected') +
        
        '\n\n</details>\n\n' +
        '---\n\n' +
        '## User Impact\n\n' +
        'A user attempted to send a cargo manifest to Discord but encountered this error. The error was displayed to the user with appropriate instructions for resolution.\n\n' +
        '**User Experience:**\n' +
        '- ❌ Discord send failed\n' +
        '- ✅ Error message displayed to user\n' +
        '- ✅ Copy button provided as fallback\n' +
        '- ✅ Error logged for developer review\n\n' +
        '---\n\n' +
        '## Related Information\n\n' +
        '**Error Category:** ' + (errorCode.startsWith('E') ? 'Network/Server Error' : errorCode.startsWith('D') ? 'Discord API Error' : errorCode.startsWith('G') ? 'Google Sheets Error' : errorCode.startsWith('B') ? 'Bot Error' : errorCode.startsWith('V') ? 'Validation Error' : 'Other') + '\n',
      labels: [
        'bug',
        'error-report',
        errorCode.startsWith('E') ? 'network-error' : 
        errorCode.startsWith('D') ? 'discord-error' : 
        errorCode.startsWith('G') ? 'sheets-error' : 
        errorCode.startsWith('B') ? 'bot-error' : 
        errorCode.startsWith('V') ? 'validation-error' : 'other-error'
      ]
    };
    
    console.log('Attempting to create GitHub issue for error:', errorCode);
    
    const response = await fetch('https://api.github.com/repos/' + GITHUB_REPO + '/issues', {
      method: 'POST',
      headers: {
        'Authorization': 'token ' + GITHUB_TOKEN,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'User-Agent': 'Brute-Haul-Error-Reporter/1.0'
      },
      body: JSON.stringify(issueData)
    });
    
    if (response.ok) {
      const issueResult = await response.json();
      console.log('✅ Error logged to GitHub Issues successfully: #' + issueResult.number);
      console.log('📋 Issue URL: ' + issueResult.html_url);
      
      localStorage.setItem('lastErrorIssue', issueResult.html_url);
    } else {
      const errorText = await response.text();
      console.error('❌ Failed to log error to GitHub:', response.status, response.statusText, errorText);
    }
  } catch (logError) {
    console.error('❌ GitHub error logging failed:', logError);
  }
}

function showErrorReportLink() {
  const lastErrorIssue = localStorage.getItem('lastErrorIssue');
  if (lastErrorIssue) {
    const linkElement = document.createElement('div');
    linkElement.innerHTML = 
      '<div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px;">' +
        '📋 <a href="' + lastErrorIssue + '" target="_blank" style="color: #781d15;">View error report</a> ' +
        '(Developer has been notified)' +
      '</div>';
    
    const errorFeedback = document.getElementById('errorFeedback');
    if (errorFeedback && errorFeedback.style.display !== 'none') {
      errorFeedback.appendChild(linkElement);
    }
  }
}
window.copyAnnouncementOutput = copyAnnouncementOutput;

window.setupGitHubErrorReporting = function() {
  const token = prompt('Enter your GitHub Personal Access Token for error reporting:');
  if (token && token.startsWith('ghp_')) {
    localStorage.setItem('simulate_deployed_token', token);
    console.log('✅ GitHub token stored (simulating deployed environment)');
    
    fetch('https://api.github.com/user', {
      headers: {
        'Authorization': 'token ' + token,
        'Accept': 'application/vnd.github.v3+json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.login) {
        console.log('✅ Token validated for user: ' + data.login);
        alert('GitHub token setup successful!\\nUser: ' + data.login + '\\nError reporting is now active.\\n\\nNote: This simulates the deployed environment.');
      } else {
        console.error('❌ Token validation failed:', data);
        alert('Token validation failed. Please check your token.');
      }
    })
    .catch(err => {
      console.error('❌ Token test failed:', err);
      alert('Token test failed. Please check your internet connection.');
    });
  } else {
    alert('Invalid token. GitHub tokens start with "ghp_"');
  }
};

window.testGitHubErrorReporting = function() {
  console.log('🧪 Testing GitHub error reporting...');
  logErrorToGitHub('TEST001', 'Manual test error', 'This is a test error to verify GitHub Issues integration', null, {
    testType: 'Manual test',
    timestamp: new Date().toISOString(),
    testUser: 'FrontEndConsole'
  });
};

window.checkGitHubTokenStatus = function() {
  const storedToken = localStorage.getItem('github_error_token_encrypted');
  if (storedToken) {
    try {
      const decrypted = atob(storedToken.split('').reverse().join(''));
      if (decrypted.startsWith('ghp_')) {
        console.log('✅ GitHub token found in localStorage');
        console.log('✅ Token format appears valid');
        return true;
      } else {
        console.log('❌ Token format invalid');
        return false;
      }
    } catch (e) {
      console.log('❌ Failed to decode stored token');
      return false;
    }
  } else {
    console.log('❌ No GitHub token found in localStorage');
    return false;
  }
};

window.addEventListener('error', function(event) {
  handleError('Uncaught JavaScript error occurred', event.error, {
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno,
    message: event.message
  });
});

window.addEventListener('unhandledrejection', function(event) {
  handleError('Unhandled promise rejection', event.reason, {
    promise: event.promise
  });
  event.preventDefault();
});

</script>

</body>
</html>
