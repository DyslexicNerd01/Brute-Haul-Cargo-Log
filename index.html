<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brute Haul Cargo Manifest Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
      background: #e2e2e2;
      color: #230e09;
    }
    form {
      background: #781d15;
      border-radius: 12px;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 400px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    #notes {
      height: 80px;
      width: 100%;
      resize: vertical;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      color: #9d7523;
    }
    input, select, textarea {
      margin-bottom: 10px;
      width: 100%;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .section {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #9d7523;
      background: #fff;
      border-radius: 8px;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 250px;    /* Orignal Size: 250px */
      width: 100%;
      background: #e2e2e2;
      border-radius: 8px;
    }
    input[type="number"] {
      width: 120px;
      padding: 5px;
      font-size: 1.1em;
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    #crewAmount {
      width: 60px;
      font-size: 1em;
      padding: 3px;
      display: inline-block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .other-div {
      display: none;
      margin-left: 30px;
    }
    .other-div label {
      font-weight: bold;
      color: #9d7523;
      margin-top: 10px;
      display: block;
    }
    .other-div input {
      font-size: 0.95em;
      width: 60%;
      color: #230e09;
      background: #e2e2e2;
      border: 1px solid #781d15;
      margin-bottom: 10px;
    }
    .crew-label {
      display: block;
      margin-left: 30px;
      font-size: 0.95em;
      margin-top: 5px;
      color: #9d7523;
      font-weight: bold;
    }
    .crew-input {
      display: block;
      width: 60%;
      font-size: 0.95em;
      margin-left: 30px;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .deductible-input {
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .error {
      border: 2px solid #9d7523 !important;
      background: #b32428 !important;
    }
    select.error option[value=""] {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error:focus {
      background: #e2e2e2 !important;
      color: #230e09 !important;
    }
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .route-arrow {
      font-weight: bold;
      color: #230e09;
      font-size: 1.2em;
      padding: 0 8px;
    }
    button {
      background: #5865F2;
      color: #fff;
      border: none;
      padding: 10px 24px 10px 16px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      background: #404EED;
      color: #fff;
      border: 1px solid #9d7523;
    }
    .discord-btn-logo {
      height: 1.6em;
      width: auto;
      vertical-align: middle;
      filter: invert(1);
    }
    h1 {
      color: #9d7523;
      text-align: center;
      font-size: 2.4em;
      font-weight: bold; 
    }
    h2 {
      color: #9d7523;
    }
    .manifest-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 12px;
      border: 2px solid #9d7523;
      border-radius: 8px;
      background: #f8f6f2;
      box-shadow: 0 2px 6px rgba(157,117,35,0.07);
      position: relative;
    }
    .manifest-row label {
      margin: 0;
      font-weight: normal;
      color: #230e09;
      min-width: 60px;
    }
    .manifest-row input,
    .manifest-row select {
      width: auto;
      margin-bottom: 0;
    }
    .manifest-btn {
      font-size: 1em;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
      margin-right: 0;
      transition: background 0.2s;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 0;
    }
    .manifest-btn.add {
      background: #43b581;
      color: #fff;
    }
    .manifest-btn.add:hover {
      background: #2ea964;
    }
    .manifest-btn.remove {
      background: #ed4245;
      color: #fff;
    }
    .manifest-btn.remove:hover {
      background: #b32428;
    }
    .manifest-total-box {
      display: flex;
      gap: 24px;
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: bold;
      color: #230e09;
      background: #f8f6f2;
      border: 2px solid #9d7523;
      border-radius: 8px;
      padding: 12px;
      align-items: center;
      justify-content: flex-start;
    }
  </style>
</head>
<body>
  <img class="logo" src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo">
  <h1>Brute Haul Cargo Manifest Form</h1>

  <form id="haulForm">
    <div class="section">
      <label>Order Category:</label>
      <select id="orderCategory" required>
        <option value="" selected disabled>Select category</option>
        <option value="Transport">Transport</option>
        <option value="Security">Security</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderCategoryOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderCategoryOther" required />
      </div>

      <label>Company Name:</label>
      <select id="companyName" required onchange="toggleCompanyNameOther()">
        <option value="" selected disabled>Select company</option>
        <option value="Brute Haul">Brute Haul</option>
        <option value="Wildcard Inc.">Wildcard Inc.</option>
        <option value="Space Rats">Space Rats</option>
        <option value="The Benjineering Project">The Benjineering Project</option>
        <option value="Other">Other</option>
      </select>
      <div id="companyNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="companyNameOther" required />
      </div>

      <label>Order Type:</label>
      <select id="orderType" required onchange="toggleOrderTypeOther()">
        <option value="" selected disabled>Select order type</option>
        <option value="Supplies">Supplies</option>
        <option value="Trade">Trade</option>
        <option value="Resources">Resources</option>
        <option value="Salvage">Salvage</option>
        <option value="Contract">Contract</option>
        <option value="Resource Drive">Resource Drive</option>
        <option value="Relocation">Relocation</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderTypeOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderTypeOther" required />
      </div>
      <div id="resourceDriveCompanyDiv" class="other-div" style="display:none;">
        <label>Resource Drive Company:</label>
        <select id="resourceDriveCompany">
          <option value="" selected disabled>Select company</option>
          <option value="Hurston Dynamics">Hurston Dynamics</option>
          <option value="Arccorp">Arccorp</option>
          <option value="Crusader Industries">Crusader Industries</option>
          <option value="Microtech">Microtech</option>
        </select>
      </div>

      <label>Ship Name:</label>
      <select id="shipName" required onchange="toggleShipNameOther()">
        <!-- Options will be populated by JS -->
      </select>
      <div id="shipNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="shipNameOther" required />
      </div>

      <label>Captain Name:</label>
      <select id="captainName" required onchange="toggleCaptainNameOther()">
        <option value="" selected disabled>Select captain</option>
        <option value="DyslexicNerd">DyslexicNerd</option>
        <option value="Spartan">Spartan</option>
        <option value="jjetstreamm">jjetstreamm</option>
        <option value="Roflnomish">Roflnomish</option>
        <option value="BenjiNotorious">BenjiNotorious</option>
        <option value="Other">Other</option>
      </select>
      <div id="captainNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="captainNameOther" required />
      </div>

      <label>Crew Amount:</label>
      <input type="number" id="crewAmount" min="0" max="20" step="1" required oninput="generateCrewInputs()" />

      <div id="crewNamesDiv"></div>

      <label>Start Location:</label>
      <select id="startLocation" required></select>

      <label>Departure Timestamp:</label>
      <input type="datetime-local" id="departureTime" required>

      <label>Route:</label>
      <div class="route-row">
        <select id="routeStart" required></select>
        <span class="route-arrow" style="font-size:1.5em;">➡️</span>
        <select id="routeEnd" required></select>
      </div>
    </div>

    <div class="section">
      <label>Cargo Manifest (add/remove lines as needed):</label>
      <div id="manifestLines"></div>
      <div class="manifest-total-box">
        <span id="totalSCUBox">Total SCU: 0</span>
        <span id="totalUECBox">Total UEC: 0</span>
      </div>
    </div>

    <div class="section">
      <label>Order Completion Time (timestamp):</label>
      <input type="datetime-local" id="completionTime" required>

      <label>Repairs (UEC):</label>
      <input type="number" id="repairs" min="0" step="1" class="deductible-input" required value="0">

      <label>Restock (UEC):</label>
      <input type="number" id="restock" min="0" step="1" class="deductible-input" required value="0">

      <label>Quantum Fuel (UEC):</label>
      <input type="number" id="quantumFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Hydrogen Fuel (UEC):</label>
      <input type="number" id="hydrogenFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Crew/Ship Costs (UEC):</label>
      <input type="number" id="crewCosts" min="0" step="1" class="deductible-input" required value="0">

      <label>Notes:</label>
      <textarea id="notes"></textarea>
    </div>

    <button type="button" onclick="generateOutput()">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" class="discord-btn-logo" style="filter: brightness(0) invert(1);" />
      Generate Discord Post
    </button>
  </form>

  <div class="section" id="discordSection" style="display:none;">
    <h2>Copy & Paste for Discord</h2>
    <textarea id="discordOutput" readonly></textarea>
    <button type="button" onclick="copyDiscordOutput()" style="background:#5865F2;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
      Copy
    </button>
  </div>

  <script>
    const locations = [
      "Area18","Bajini Point","ArcCorp Mining Area 061","ArcCorp Mining Area 045","ArcCorp Mining Area 157",
      "ArcCorp Mining Area 141","ArcCorp Mining Area 056","ArcCorp Mining Area 073","ArcCorp Mining Area 022",
      "ArcCorp Mining Area 048","Everus Harbor","Lorville","HDMS Oparei","HDMS Shubin","HDMS Edmond",
      "HDMS Hadley","HDMS Pinewood","HDMS Stanhope","HDMS Lathan","HDMS Ryder","HDMS Anderson","HDMS Beck",
      "HDMS Perlman","HDMS Humboldt","HDMS MacEwan","HDMS Stokes","HDMS Woodruff","HDMS Foster","HDMS Deakin",
      "HDMS Dobbs","HDMS Eri","HDMS Laskowski","HDMS McGrath","HDMS O'Neill","HDMS Reilly","HDMS Sutter",
      "HDMS Tompkins","HDMS Wightman","HDMS Young","HDMS Ziegler","Port Olisar","Levski","Grim HEX",
      "Port Tressler","New Babbage","CRU-L1","CRU-L4","CRU-L5","HUR-L1","HUR-L2","HUR-L3","HUR-L4","HUR-L5",
      "MIC-L1","MIC-L2","MIC-L3","MIC-L4","MIC-L5","ARC-L1","ARC-L2","ARC-L3","ARC-L4","ARC-L5","Orison",
      "Seraphim Station","Ambitious Dream Station","Brio's Breaker Yard","Covalex Hub Gundo","Covalex Hub Gallete",
      "Covalex Hub Lagrange","Covalex Hub Laskowski","Covalex Hub O'Neill","Covalex Hub Reilly","Covalex Hub Sutter",
      "Covalex Hub Tompkins","Covalex Hub Wightman","Covalex Hub Young","Covalex Hub Ziegler"
    ];

    // Ship lists for each category
    const transportShips = [
      "SPRT Icarus", "BRHS Lednik", "BRHS Trireme", "WINC Caterpillar"
    ];
    const securityShips = [
      "AACS Landsknecht", "AACS Feder"
    ];
    const allShips = [
      ...transportShips,
      ...securityShips,
      "BRHS Seastorm"
    ];

    // Manifest material list (customize as needed)
    const materialList = [
      "Select Material", "Agricium", "Aluminium", "Aphorite", "Beryl", "Bexalite", "Borase", "Copper", "Corundum", "Diamond", "Dolivine", "Dyslexium", "Gold", "Hadanite", "Hephaestanite", "Inert materials", "Laranite", "Placeholder", "Quantanium", "Quartz", "Taranite", "Tungsten", "Titanium"
    ];

    function populateLocationDropdown(id) {
      const select = document.getElementById(id);
      if (!select) return;
      select.innerHTML = `<option value="" selected disabled>Select location</option>` +
        locations.map(loc => `<option value="${loc}">${loc}</option>`).join("");
    }

    function populateShipDropdown(category) {
      const select = document.getElementById("shipName");
      let ships = [];
      if (category === "Transport") {
        ships = transportShips;
      } else if (category === "Security") {
        ships = securityShips;
      } else {
        ships = allShips;
      }
      select.innerHTML = `<option value="" selected disabled>Select ship</option>` +
        ships.map(ship => `<option value="${ship}">${ship}</option>`).join("") +
        `<option value="Other">Other</option>`;
      toggleShipNameOther();
    }

    // Manifest dynamic rows
    let manifestLineCount = 0;
    function createManifestLine(index) {
      const isLast = index === manifestLineCount;
      return `
        <div class="manifest-row" id="manifestRow${index}">
          <label>SCU:</label>
          <input type="number" min="0" step="1" class="manifest-scu" id="manifestSCU${index}" style="width:70px;" oninput="updateManifestTotals()">
          <label>Material:</label>
          <select class="manifest-material" id="manifestMaterial${index}" style="width:120px;">
            ${materialList.map(m => `<option value="${m}">${m}</option>`).join("")}
          </select>
          <label>UEC:</label>
          <input type="number" min="0" step="1" class="manifest-uec" id="manifestUEC${index}" style="width:90px;" oninput="updateManifestTotals()">
          <button type="button" onclick="removeManifestLine(${index})" class="manifest-btn remove" title="Remove line">－</button>
          ${isLast ? `<button type="button" onclick="addManifestLine()" class="manifest-btn add" title="Add line">＋</button>` : ""}
        </div>
      `;
    }
    function renderManifestLines() {
      const manifestLines = document.getElementById("manifestLines");
      // Save current manifest line values
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });

      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        const isLast = i === manifestLineCount;
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }

      // Restore previous values
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
    }
    function addManifestLine() {
      manifestLineCount++;
      renderManifestLines();
    }
    function removeManifestLine(index) {
      const row = document.getElementById(`manifestRow${index}`);
      if (row) row.remove();
      manifestLineCount = document.querySelectorAll('.manifest-row').length;
      // Always keep at least one manifest line
      if (manifestLineCount === 0) {
        manifestLineCount = 1;
      }
      renderManifestLines();
    }
    function updateManifestTotals() {
      let totalSCU = 0;
      let totalUEC = 0;
      document.querySelectorAll('.manifest-row').forEach(row => {
        const scu = parseInt(row.querySelector('.manifest-scu').value, 10);
        const uec = parseInt(row.querySelector('.manifest-uec').value, 10);
        if (!isNaN(scu)) totalSCU += scu;
        if (!isNaN(uec)) totalUEC += uec;
      });
      document.getElementById("totalSCUBox").textContent = `Total SCU: ${totalSCU}`;
      document.getElementById("totalUECBox").textContent = `Total UEC: ${totalUEC}`;
    }

    window.addEventListener("DOMContentLoaded", function() {
      populateLocationDropdown("startLocation");
      populateLocationDropdown("routeStart");
      populateLocationDropdown("routeEnd");
      populateShipDropdown(""); // Show all ships initially
      document.getElementById("discordSection").style.display = "none";
      manifestLineCount = 1;
      renderManifestLines();
    });

    document.getElementById("orderCategory").addEventListener("change", function() {
      toggleOrderCategoryOther();
      populateShipDropdown(this.value);
    });

    function toDiscordTimestamp(dtString) {
      if (!dtString) return "";
      const date = new Date(dtString);
      if (isNaN(date.getTime())) return "";
      // Add 930 years
      const yearsToAdd = 930;
      date.setFullYear(date.getFullYear() + yearsToAdd);
      const unix = Math.floor(date.getTime() / 1000);
      return `<t:${unix}:f>`;
    }

    const shipLinks = {
      "BRHS Lednik": "https://discord.com/channels/900478857436606535/1391878505905524817/1392397123907223643",
      "AACS Feder": "https://discord.com/channels/900478857436606535/1391878505905524817/1393365523407835196",
      "AACS Landsknecht": "https://discord.com/channels/900478857436606535/1391878505905524817/1392713534005186730",
      "BRHS Seastorm": "https://discord.com/channels/900478857436606535/1391878505905524817/1392395299275800576",
      "BRHS Trireme": "https://discord.com/channels/900478857436606535/1391878505905524817/1391904991710806069",
      "WINC Caterpillar": "https://discord.com/channels/900478857436606535/1391878505905524817/1391904347117322322",
      "SPRT Icarus": "https://discord.com/channels/900478857436606535/1391878505905524817/1396265862268190830"
    };

    function toggleOrderCategoryOther() {
      const val = document.getElementById("orderCategory").value;
      const otherDiv = document.getElementById("orderCategoryOtherDiv");
      if (val === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderCategoryOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("orderCategoryOther").required = false;
      }
    }

    function toggleCompanyNameOther() {
      const companyName = document.getElementById("companyName").value;
      const otherDiv = document.getElementById("companyNameOtherDiv");
      if (companyName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("companyNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("companyNameOther").required = false;
      }
    }

    function toggleOrderTypeOther() {
      const orderType = document.getElementById("orderType").value;
      const otherDiv = document.getElementById("orderTypeOtherDiv");
      const resourceDriveDiv = document.getElementById("resourceDriveCompanyDiv");
      if (orderType === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderTypeOther").required = true;
        resourceDriveDiv.style.display = "none";
        document.getElementById("resourceDriveCompany").required = false;
      } else if (orderType === "Resource Drive") {
        resourceDriveDiv.style.display = "block";
        document.getElementById("resourceDriveCompany").required = true;
        otherDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
      } else {
        otherDiv.style.display = "none";
        resourceDriveDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
        document.getElementById("resourceDriveCompany").required = false;
      }
    }

    function toggleShipNameOther() {
      const shipName = document.getElementById("shipName").value;
      const otherDiv = document.getElementById("shipNameOtherDiv");
      if (shipName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("shipNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("shipNameOther").required = false;
      }
    }

    function toggleCaptainNameOther() {
      const captainName = document.getElementById("captainName").value;
      const otherDiv = document.getElementById("captainNameOtherDiv");
      if (captainName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("captainNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("captainNameOther").required = false;
      }
    }

    function generateCrewInputs() {
      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      const crewNamesDiv = document.getElementById("crewNamesDiv");
      crewNamesDiv.innerHTML = "";
      if (!isNaN(crewAmount) && crewAmount > 0) {
        for (let i = 1; i <= crewAmount; i++) {
          const label = document.createElement("label");
          label.textContent = `Crew ${i} Name:`;
          label.htmlFor = `crewName${i}`;
          label.className = "crew-label";
          const input = document.createElement("input");
          input.type = "text";
          input.id = `crewName${i}`;
          input.name = `crewName${i}`;
          input.required = true;
          input.className = "crew-input";
          crewNamesDiv.appendChild(label);
          crewNamesDiv.appendChild(input);
        }
      }
    }

    function validateRequiredFields() {
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      // Add event listeners to required fields to remove error class on input/change
      const requiredFields = [
        "orderCategory",
        "companyName",
        "orderType",
        "shipName",
        "captainName",
        "crewAmount",
        "startLocation",
        "departureTime",
        "routeStart",
        "routeEnd",
        "completionTime",
        "repairs",
        "restock",
        "quantumFuel",
        "hydrogenFuel",
        "crewCosts"
      ];
      requiredFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', () => el.classList.remove('error'));
          el.addEventListener('change', () => el.classList.remove('error'));
        }
      });

      // Also handle manifest and crew fields
      document.querySelectorAll('.manifest-scu, .manifest-material, .crew-input').forEach(el => {
        el.addEventListener('input', () => el.classList.remove('error'));
        el.addEventListener('change', () => el.classList.remove('error'));
      });

      let firstError = null;
      for (const id of requiredFields) {
        const el = document.getElementById(id);
        if (!el || el.value === "" || el.value === null) {
          if (el) el.classList.add('error');
          if (!firstError && el) firstError = el;
        }
      }

      const otherFields = [
        {select: "orderCategory", other: "orderCategoryOtherDiv", input: "orderCategoryOther"},
        {select: "companyName", other: "companyNameOtherDiv", input: "companyNameOther"},
        {select: "orderType", other: "orderTypeOtherDiv", input: "orderTypeOther"},
        {select: "shipName", other: "shipNameOtherDiv", input: "shipNameOther"},
        {select: "captainName", other: "captainNameOtherDiv", input: "captainNameOther"}
      ];
      for (const field of otherFields) {
        const selectEl = document.getElementById(field.select);
        const otherDiv = document.getElementById(field.other);
        const otherInput = document.getElementById(field.input);
        if (selectEl && selectEl.value === "Other" && otherDiv.style.display === "block") {
          if (!otherInput.value.trim()) {
            otherInput.classList.add('error');
            if (!firstError) firstError = otherInput;
          }
        }
      }

      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      for (let i = 1; i <= crewAmount; i++) {
        const crewInput = document.getElementById(`crewName${i}`);
        if (!crewInput || !crewInput.value.trim()) {
          if (crewInput) crewInput.classList.add('error');
          if (!firstError && crewInput) firstError = crewInput;
        }
      }

      // Validate manifest lines (UEC is now optional)
      const manifestRows = document.querySelectorAll('.manifest-row');
      if (manifestRows.length === 0) {
        alert("Please add at least one manifest line.");
        return false;
      }
      for (const row of manifestRows) {
        const scu = row.querySelector('.manifest-scu');
        const mat = row.querySelector('.manifest-material');
        // const uec = row.querySelector('.manifest-uec'); // UEC is optional
        if (!scu.value || !mat.value) {
          scu.classList.add('error');
          mat.classList.add('error');
          if (!firstError) firstError = scu;
        }
      }

      if (firstError) {
        firstError.scrollIntoView({behavior: "smooth", block: "center"});
        alert("Please fill out all required fields before generating the Discord post. Unanswered questions are highlighted in red.");
        return false;
      }
      return true;
    }

    function copyDiscordOutput() {
      const discordOutput = document.getElementById("discordOutput");
      discordOutput.select();
      discordOutput.setSelectionRange(0, 99999);
      document.execCommand("copy");
    }

    function generateOutput() {
      if (!validateRequiredFields()) return;

      const get = id => document.getElementById(id)?.value?.trim() || "";
      const departureDiscord = toDiscordTimestamp(get("departureTime"));
      const completionDiscord = toDiscordTimestamp(get("completionTime"));

      let orderCategoryText = get("orderCategory");
      if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");

      let companyNameText = get("companyName");
      if (companyNameText === "Other") companyNameText = get("companyNameOther");

      let orderTypeText = get("orderType");
      if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");

      let resourceDriveCompanyText = "";
      if (orderTypeText === "Resource Drive") {
        resourceDriveCompanyText = document.getElementById("resourceDriveCompany").value || "";
      }

      let shipNameText = get("shipName");
      if (shipNameText === "Other") shipNameText = get("shipNameOther");

      let captainNameText = get("captainName");
      if (captainNameText === "Other") captainNameText = get("captainNameOther");

      const shipLink = shipLinks[shipNameText] || "#";

      const crewAmount = parseInt(get("crewAmount"), 10);
      let crewNamesList = [];
      for (let i = 1; i <= crewAmount; i++) {
        const crewInput = document.getElementById(`crewName${i}`);
        if (crewInput && crewInput.value.trim()) {
          crewNamesList.push(crewInput.value.trim());
        }
      }
      const crewNamesText = crewNamesList.length > 0 ? crewNamesList.join(", ") : "";

      const routeStart = get("routeStart");
      const routeEnd = get("routeEnd");
      const routeText = routeStart && routeEnd ? `${routeStart} ➡️ ${routeEnd}` : "";

      // Gather manifest lines and totals
      let manifestLines = [];
      let totalSCU = 0;
      let totalUEC = 0;
      document.querySelectorAll('.manifest-row').forEach(row => {
        const scu = parseInt(row.querySelector('.manifest-scu').value, 10);
        const mat = row.querySelector('.manifest-material').value;
        const uecValue = row.querySelector('.manifest-uec').value;
        const uec = parseInt(uecValue, 10);

        if (!isNaN(scu)) totalSCU += scu;
        // Only count UEC if not blank and not zero
        if (uecValue !== "" && !isNaN(uec) && uec !== 0) totalUEC += uec;

        // Only include UEC in output if not blank and not zero
        const uecText = (uecValue !== "" && uec !== 0) ? ` - ${uec} UEC` : "";
        manifestLines.push(`${scu} SCU ${mat}${uecText}`);
      });

      const totalUECText = totalUEC > 0 ? ` - ${totalUEC} UEC` : "";

      const output = `**${orderCategoryText}**
${companyNameText} ${orderTypeText}${resourceDriveCompanyText ? `\nResource Drive Company: ${resourceDriveCompanyText}` : ""}

Ship - [**${shipNameText}**](${shipLink})
Captain: ${captainNameText}
Crew: ${get("crewAmount")}${crewNamesText ? " (" + crewNamesText + ")" : ""}
-

Departure - ${get("startLocation")}
Departure time - ${departureDiscord}

Route - ${routeText}

Manifest
${manifestLines.join('\n')}

Total - ${totalSCU} SCU${totalUECText}

Sign off
Order completion time - ${completionDiscord}

Deductibles:
Repairs - ${get("repairs")} UEC
Restock - ${get("restock")} UEC
Quantum fuel - ${get("quantumFuel")} UEC
Hydrogen fuel - ${get("hydrogenFuel")} UEC
Crew/ ship costs - ${get("crewCosts")} UEC

${get("notes")}`.trim();

      document.getElementById("discordOutput").value = output;
      document.getElementById("discordSection").style.display = "block";

      // Data logging stub (add logic here to send to server/db if needed)
      console.log("Submitted Data:", {
        orderCategory: orderCategoryText,
        companyName: companyNameText,
        orderType: orderTypeText,
        shipName: shipNameText,
        shipLink: shipLink,
        captainName: captainNameText,
        crewAmount: get("crewAmount"),
        crewNames: crewNamesList,
        startLocation: get("startLocation"),
        departureTime: get("departureTime"),
        route: routeText,
        manifest: manifestLines,
        totalSCU: totalSCU,
        totalUEC: totalUEC,
        completionTime: get("completionTime"),
        repairs: get("repairs"),
        restock: get("restock"),
        quantumFuel: get("quantumFuel"),
        hydrogenFuel: get("hydrogenFuel"),
        crewCosts: get("crewCosts"),
        notes: get("notes")
      });
    }
  </script>
</body>
</html>
