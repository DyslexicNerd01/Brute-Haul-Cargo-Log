<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brute Haul Cargo Manifest Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
      background: #e2e2e2;
      color: #230e09;
    }
    form {
      background: #781d15;
      border-radius: 12px;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 400px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    #notes {
      height: 80px;
      width: 100%;
      resize: vertical;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      color: #9d7523;
    }
    input, select, textarea {
      margin-bottom: 10px;
      width: 100%;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .section {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #9d7523;
      background: #fff;
      border-radius: 8px;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 250px;
      width: 100%;
      background: #e2e2e2;
      border-radius: 8px;
    }
    input[type="number"] {
      width: 120px;
      padding: 5px;
      font-size: 1.1em;
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    #crewAmount {
      width: 60px;
      font-size: 1em;
      padding: 3px;
      display: inline-block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .other-div {
      display: none;
      margin-left: 30px;
    }
    .other-div label {
      font-weight: bold;
      color: #9d7523;
      margin-top: 10px;
      display: block;
    }
    .other-div input {
      font-size: 0.95em;
      width: 60%;
      color: #230e09;
      background: #e2e2e2;
      border: 1px solid #781d15;
      margin-bottom: 10px;
    }
    .crew-label {
      display: block;
      margin-left: 30px;
      font-size: 0.95em;
      margin-top: 5px;
      color: #9d7523;
      font-weight: bold;
    }
    .crew-input {
      display: block;
      width: 60%;
      font-size: 0.95em;
      margin-left: 30px;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .deductible-input {
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .error {
      border: 2px solid #9d7523 !important;
      background: #b32428 !important;
    }
    select.error option[value=""] {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error:focus {
      background: #e2e2e2 !important;
      color: #230e09 !important;
    }
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .route-arrow {
      font-weight: bold;
      color: #230e09;
      font-size: 1.2em;
      padding: 0 8px;
    }
    button {
      background: #5865F2;
      color: #fff;
      border: none;
      padding: 10px 24px 10px 16px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      background: #404EED;
      color: #fff;
      border: 1px solid #9d7523;
    }
    .discord-btn-logo {
      height: 1.6em;
      width: auto;
      vertical-align: middle;
      filter: invert(1);
    }
    h1 {
      color: #9d7523;
      text-align: center;
      font-size: 2.4em;
      font-weight: bold;
    }
    h2 {
      color: #9d7523;
    }
    .manifest-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 12px;
      border: 2px solid #9d7523;
      border-radius: 8px;
      background: #f8f6f2;
      box-shadow: 0 2px 6px rgba(157,117,35,0.07);
      position: relative;
    }
    .manifest-row label {
      margin: 0;
      font-weight: normal;
      color: #230e09;
      min-width: 60px;
    }
    .manifest-row input,
    .manifest-row select {
      width: auto;
      margin-bottom: 0;
    }
    .manifest-btn {
      font-size: 1em;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
      margin-right: 0;
      transition: background 0.2s;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 0;
    }
    .manifest-btn.add {
      background: #43b581;
      color: #fff;
    }
    .manifest-btn.add:hover {
      background: #2ea964;
    }
    .manifest-btn.remove {
      background: #ed4245;
      color: #fff;
    }
    .manifest-btn.remove:hover {
      background: #b32428;
    }
    .manifest-total-box {
      display: flex;
      gap: 24px;
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: bold;
      color: #230e09;
      background: #f8f6f2;
      border: 2px solid #9d7523;
      border-radius: 8px;
      padding: 12px;
      align-items: center;
      justify-content: flex-start;
    }
    .resource-preset-btn {
      background: #9d7523;
      color: #fff;
      border: none;
      padding: 6px 14px;
      font-size: 11px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
      white-space: nowrap;
      transition: background 0.2s;
      display: inline-block;
    }
    .resource-preset-btn.selected {
      background: #43b581 !important;
      color: #fff !important;
    }
    .resource-preset-btn:hover {
      background: #bfa14d;
      color: #fff;
    }
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4245;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
    }
    .tab-button-container {
      position: relative;
      display: contents;
    }

    /* Searchable dropdown styles */
    .searchable-dropdown {
      position: relative;
      width: 100%;
    }
    .searchable-dropdown input {
      width: 100%;
      padding: 8px;
      border: 1px solid #781d15;
      background: #e2e2e2;
      color: #230e09;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .searchable-dropdown .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #e2e2e2;
      border: 1px solid #781d15;
      border-top: none;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .searchable-dropdown .dropdown-list.show {
      display: block;
    }
    .searchable-dropdown .dropdown-item {
      padding: 6px 12px;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
      background: #e2e2e2;
      color: #230e09;
      font-size: 14px;
    }
    .searchable-dropdown .dropdown-item:hover {
      background: #d0d0d0;
    }
    .searchable-dropdown .dropdown-item.selected {
      background: #781d15;
      color: #e2e2e2;
    }
    .searchable-dropdown .dropdown-item:last-child {
      border-bottom: none;
    }
    
    /* Route row styling for searchable dropdowns */
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .route-row .searchable-dropdown {
      flex: 1;
    }
    .tab-button-container button {
      position: relative;
    }
    #announcementsTabBtn::after {
      content: "1";
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4245;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #announcementsTabBtn.badge-hidden::after {
      display: none;
    }
  </style>
  <script src="locations.js"></script>
</head>
<body>
  <img class="logo" src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo">
  <h1>Brute Haul Online Documentation System</h1>

  <div style="display: flex; gap: 12px; margin-bottom: 0;">
  <button type="button" onclick="showTab('formTab')" id="formTabBtn" style="border: 3px solid transparent;">Form</button>
  <button type="button" onclick="showTab('historyTab')" id="historyTabBtn" style="border: 3px solid transparent;">History</button>
  <div class="tab-button-container">
    <button type="button" onclick="showTab('announcementsTab')" id="announcementsTabBtn" style="border: 3px solid transparent;">Announcements</button>
  </div>
  <a href="https://robertsspaceindustries.com/en/orgs/BRHS" target="_blank" title="Join BRHS"
     style="margin-left:auto; display:inline-flex; align-items:center; justify-content:center; width:60px; height:60px; background:#222; border-radius:8px; text-decoration:none; border:0px solid #9d7523;">
    <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/starcitizenwhite.png" alt="Star Citizen" style="width:82px; height:82px; object-fit:contain; filter:invert(1);">
  </a>
</div>
<hr style="border: none; border-bottom: 5px solid #9d7523; margin: 0 0 20px 0;">
<div id="formTab">
  <div style="background:#e2e2e2; border-radius:8px; padding:12px; margin-bottom:5px;">
  <h2 style="color:#9d7523; margin:0; text-align:left;">Cargo Form</h2>
</div>
  <form id="haulForm">
    <div class="section">
      <label>Order Category:</label>
      <select id="orderCategory" required>
        <option value="" selected disabled>Select category</option>
        <option value="Transport">Transport</option>
        <option value="Security">Security</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderCategoryOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderCategoryOther" required />
      </div>

      <label>Company Name:</label>
      <select id="companyName" required onchange="toggleCompanyNameOther()">
        <option value="" selected disabled>Select company</option>
        <option value="Brute Haul">Brute Haul</option>
        <option value="Wildcard Inc.">Wildcard Inc.</option>
        <option value="Space Rats">Space Rats</option>
        <option value="The Benjineering Project">The Benjineering Project</option>
        <option value="Other">Other</option>
      </select>
      <div id="companyNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="companyNameOther" required />
      </div>

      <label>Order Type:</label>
      <select id="orderType" required onchange="toggleOrderTypeOther()">
        <option value="" selected disabled>Select order type</option>
        <option value="Resource Drive">Resource Drive</option>
        <option value="Supplies">Supplies</option>
        <option value="Trade">Trade</option>
        <option value="Resources">Resources</option>
        <option value="Salvage">Salvage</option>
        <option value="Contract">Contract</option>
        <option value="Relocation">Relocation</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderTypeOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderTypeOther" required />
      </div>
      <div id="resourceDriveCompanyDiv" class="other-div" style="display:none;">
        <label>Resource Drive Company:</label>
        <select id="resourceDriveCompany">
          <option value="" selected disabled>Select company</option>
          <option value="Hurston Dynamics">Hurston Dynamics</option>
          <option value="Arccorp">Arccorp</option>
          <option value="üèÜ Crusader Industries üèÜ">üèÜ Crusader Industries üèÜ</option>
          <option value="Microtech">Microtech</option>
        </select>
      </div>

      <label>Ship Name:</label>
      <select id="shipName" required onchange="toggleShipNameOther()">
        <!-- Options will be populated by JS -->
      </select>
      <div id="shipNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="shipNameOther" required />
      </div>

      <label>Captain Name:</label>
      <select id="captainName" required onchange="toggleCaptainNameOther()">
        <option value="" selected disabled>Select captain</option>
        <option value="DyslexicNerd">DyslexicNerd</option>
        <option value="Spartan">Spartan</option>
        <option value="jjetstreamm">jjetstreamm</option>
        <option value="Roflnomish">Roflnomish</option>
        <option value="BenjiNotorious">BenjiNotorious</option>
        <option value="zarainia">zarainia</option>
        <option value="Venomnom">Venomnom</option>
        <option value="BigDaddyTortuga">BigDaddyTortuga</option>
        <option value="ItzProto">ItzProto</option>
        <option value="Newt">Newt</option>
        <option value="Xolion">Xolion</option>
        <option value="Bakes Kamuari">Bakes Kamuari</option>
        <option value="LockEmUpJas">LockEmUpJas</option>
        <option value="Other">Other</option>
      </select>
      <div id="captainNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="captainNameOther" required />
      </div>

      <label>Crew Amount:</label>
      <input type="number" id="crewAmount" min="0" max="20" step="1" required oninput="generateCrewInputs()" />

      <div id="crewNamesDiv"></div>

      <label>Start Location:</label>
      <div class="searchable-dropdown" id="startLocationDropdown">
        <input type="text" id="startLocation" placeholder="Search start location..." autocomplete="off" required>
        <div class="dropdown-list" id="startLocationList"></div>
      </div>

      <label>Departure Timestamp:</label>
      <input type="datetime-local" id="departureTime" required>

      <label>Route:</label>
      <div class="route-row">
        <div class="searchable-dropdown" id="routeStartDropdown">
          <input type="text" id="routeStart" placeholder="Search route start..." autocomplete="off" required>
          <div class="dropdown-list" id="routeStartList"></div>
        </div>
        <span class="route-arrow" style="font-size:1.5em;">‚û°Ô∏è</span>
        <div class="searchable-dropdown" id="routeEndDropdown">
          <input type="text" id="routeEnd" placeholder="Search route end..." autocomplete="off" required>
          <div class="dropdown-list" id="routeEndList"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <label>Cargo Manifest (add/remove lines as needed):</label>
      <div id="resourceDrivePresets" style="display:none; margin-bottom:10px;">
        <span style="font-size:13px; font-weight:bold; vertical-align:middle; margin-right:8px;">Resource Drive Presets:</span>
        <span style="display:inline-flex; gap:10px; vertical-align:middle;">
          <button type="button" class="resource-preset-btn" id="presetLargeBtn" onclick="applyManifestPreset('large')">Large Haul</button>
          <button type="button" class="resource-preset-btn" id="presetMediumBtn" onclick="applyManifestPreset('medium')">Medium Haul</button>
          <button type="button" class="resource-preset-btn" id="presetSmallBtn" onclick="applyManifestPreset('small')">Small Haul</button>
        </span>
      </div>
      <div id="manifestLines"></div>
      <div class="manifest-total-box">
  <span id="totalSCUBox">Total SCU: 0</span>
  <span style="margin-right:6px;">Total UEC:</span>
<input type="number" id="totalUECBox" style="color:#230e09; font-weight:bold; vertical-align:middle; width:120px;" value="" />
</div>
    </div>

    <div class="section">
      <label>Order Completion Timestamp:</label>
      <input type="datetime-local" id="completionTime" required>
      <div id="orderDuration" style="font-weight:bold; color:#9d7523; margin-top:8px;"></div>

      <label>Repairs (UEC):</label>
      <input type="number" id="repairs" min="0" step="1" class="deductible-input" required value="0">

      <label>Restock (UEC):</label>
      <input type="number" id="restock" min="0" step="1" class="deductible-input" required value="0">

      <label>Quantum Fuel (UEC):</label>
      <input type="number" id="quantumFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Hydrogen Fuel (UEC):</label>
      <input type="number" id="hydrogenFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Crew/Ship Costs (UEC):</label>
      <input type="number" id="crewCosts" min="0" step="1" class="deductible-input" required value="0">

      <label>Notes:</label>
      <textarea id="notes"></textarea>
    </div>

    <button type="button" onclick="generateOutput()">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" class="discord-btn-logo" style="filter: brightness(0) invert(1);" />
      Generate Discord Post
    </button>
    <button type="button" onclick="clearFormFields()" style="background:#b32428;color:#fff;border:none;padding:10px 16px;border-radius:5px;font-weight:bold;display:flex;align-items:center;gap:8px;margin-left:8px;">
  Clear Form
</button>
  </form>
  <div class="section" id="discordSection" style="display:none;">
    </button>
    <button type="button" onclick="sendToDiscord()" style="background:#43b581;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;margin-left:8px;">
    <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
    Send to Discord
  </button>
    <h2>Discord Output:</h2>
    <textarea id="discordOutput" readonly></textarea>
    <button type="button" onclick="copyDiscordOutput()" style="background:#5865F2;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
      Copy to Clipboard
    </button>
  </div>
</div>
<div id="historyTab" style="display:none;">
  <h2>Session History</h2>
  <div id="historyList" style="max-height:400px;overflow-y:auto;background:#fff;border-radius:8px;padding:12px;border:1px solid #9d7523;"></div>
</div>
<div id="announcementsTab" style="display:none;">
  <div style="text-align:center; margin-bottom:30px;">
    <h2 style="color:#9d7523;">Announcements</h2>
  </div>
  
  <div id="announcementsList" style="max-height:600px;overflow-y:auto;">
    <!-- Announcement Post -->
    <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
      <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
        <h3 style="color:#781d15;margin:0;font-size:1.4em;">Send to Discord Enabled!</h3>
        <div style="color:#666;font-size:0.9em;margin-top:5px;">
          <strong>By:</strong> DyslexicNerd01 | <strong>Date:</strong> July 25, 2025
        </div>
      </div>
      <div class="announcement-body" style="color:#230e09;line-height:1.6;">
        <p>The Send to Discord feature is now enabled! <b>Please only use the <i>"Send to Discord"</i> button to upload your cargo manifests.</b> </p>
        <p>If you encounter any issues, please report them to the development team as soon as possible. Hotfixes will be regularly released to keep the form up-to-date with any changes to Star Citizen or Brute Haul policy.</p>
        <p>The copy button will remain active in the event that there is an issue with the discord bot in the future. If you do not see the message appear in Discord after 5 minutes, please use the copy button to manually copy the message. Please alert the Brute Haul staff of the issue as soon as possible</p>
        <p>Thank you for your patience and support!</p>
      </div>
    </div>
  </div>
</div>

<script type="module">
   // Locations are now loaded from external locations.js file


    // Ship lists for each category
    const transportShips = [
      "SPRT Icarus", "BRHS Lednik", "BRHS Trireme", "WINC Caterpillar", "WINC Rafto"    
    ];
    const securityShips = [
      "AACS Landsknecht", "AACS Feder", "BRHS Seastorm"
    ];
    const allShips = [
      ...transportShips,
      ...securityShips,
    ];

    // Manifest material list (customize as needed)
    const materialList = [
      "Select Material", "Agricium", "Aluminium", "Aphorite", "Beryl", "Bexalite", "Borase", "Copper", "Corundum", "Diamond", "Dolivine", "Dyslexium", "Gold", "Hadanite", "Hephaestanite", "Inert materials", "Laranite", "Placeholder", "Spartanium", "Quantanium", "Quartz", "Taranite", "Tungsten", "Titanium"
    ];

    function clearFormFields() {
  // Clear timestamps
  document.getElementById("departureTime").value = "";
  document.getElementById("completionTime").value = "";
  document.getElementById("orderDuration").textContent = "";

  // Reset manifest to one empty line
  manifestLineCount = 1;
  renderManifestLines();
  // Clear values in the first manifest line
  const firstManifestRow = document.querySelector('.manifest-row');
  if (firstManifestRow) {
    firstManifestRow.querySelector('.manifest-scu').value = "";
    firstManifestRow.querySelector('.manifest-material').selectedIndex = 0;
    firstManifestRow.querySelector('.manifest-uec').value = "";
  }

  // Reset total SCU display
  document.getElementById("totalSCUBox").textContent = "Total SCU: 0";

  // Clear deductibles
  document.getElementById("repairs").value = "0";
  document.getElementById("restock").value = "0";
  document.getElementById("quantumFuel").value = "0";
  document.getElementById("hydrogenFuel").value = "0";
  document.getElementById("crewCosts").value = "0";
  document.getElementById("totalUECBox").value = "";

  // Clear route
  document.getElementById("routeStart").value = "";
  document.getElementById("routeEnd").value = "";

  // Clear start location
  document.getElementById("startLocation").value = "";

  // Clear notes
  document.getElementById("notes").value = "";
}

function showTab(tab) {
  document.getElementById('formTab').style.display = tab === 'formTab' ? 'block' : 'none';
  document.getElementById('historyTab').style.display = tab === 'historyTab' ? 'block' : 'none';
  document.getElementById('announcementsTab').style.display = tab === 'announcementsTab' ? 'block' : 'none';

  // Hide notification badge when announcements tab is clicked
  if (tab === 'announcementsTab') {
    const announcementsBtn = document.getElementById('announcementsTabBtn');
    if (announcementsBtn) {
      announcementsBtn.classList.add('badge-hidden');
    }
  }

  // Tab highlighting
  document.getElementById('formTabBtn').style.background = tab === 'formTab' ? '#9d7523' : '#781d15';
  document.getElementById('historyTabBtn').style.background = tab === 'historyTab' ? '#9d7523' : '#781d15';
  document.getElementById('announcementsTabBtn').style.background = tab === 'announcementsTab' ? '#9d7523' : '#781d15';

  document.getElementById('formTabBtn').style.color = '#fff';
  document.getElementById('historyTabBtn').style.color = '#fff';
  document.getElementById('announcementsTabBtn').style.color = '#fff';

  // Black outline for selected tab
  document.getElementById('formTabBtn').style.border = tab === 'formTab' ? '3px solid #000' : '3px solid transparent';
  document.getElementById('historyTabBtn').style.border = tab === 'historyTab' ? '3px solid #000' : '3px solid transparent';
  document.getElementById('announcementsTabBtn').style.border = tab === 'announcementsTab' ? '3px solid #000' : '3px solid transparent';
}
window.showTab = showTab;

window.addEventListener("DOMContentLoaded", function() {
  showTab('formTab');
  renderHistory();
  // Ensure totalUECBox starts blank on first load
  const totalUECInput = document.getElementById("totalUECBox");
  if (totalUECInput) totalUECInput.value = "";
});

    function populateLocationDropdown(id) {
      const inputId = id;
      const listId = id + 'List';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let selectedValue = '';
      let filteredLocations = locations;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterLocations(searchTerm) {
        const term = searchTerm.toLowerCase();
        return locations.filter(location => 
          location.toLowerCase().includes(term)
        ); // Show all matching results
      }

      function renderDropdownItems(locationsToShow) {
        list.innerHTML = '';
        locationsToShow.forEach(location => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = location;
          item.addEventListener('click', () => {
            input.value = location;
            selectedValue = location;
            hideDropdown();
            input.classList.remove('error');
          });
          list.appendChild(item);
        });
      }

      // Initialize with all locations
      renderDropdownItems(locations);

      // Handle input events
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredLocations = locations; // Show all locations when no search term
        } else {
          filteredLocations = filterLocations(searchTerm);
        }
        renderDropdownItems(filteredLocations);
        showDropdown();
        selectedValue = '';
      });

      input.addEventListener('focus', () => {
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      // Handle keyboard navigation
      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      // Custom validation function
      input.validateValue = function() {
        return locations.includes(input.value);
      };
    }

    // Close all dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.searchable-dropdown')) {
        document.querySelectorAll('.dropdown-list').forEach(list => {
          list.classList.remove('show');
        });
      }
    });

    function populateShipDropdown(category) {
      const select = document.getElementById("shipName");
      let ships = [];
      if (category === "Transport") {
        ships = transportShips;
      } else if (category === "Security") {
        ships = securityShips;
      } else {
        ships = allShips;
      }
      select.innerHTML = `<option value="" selected disabled>Select ship</option>` +
        ships.map(ship => `<option value="${ship}">${ship}</option>`).join("") +
        `<option value="Other">Other</option>`;
      toggleShipNameOther();
    }

    let manifestLineCount = 1;

    function createManifestLine(index) {
      const isLast = index === manifestLineCount;
      return `
        <div class="manifest-row" id="manifestRow${index}">
          <label>SCU:</label>
          <input type="number" min="0" step="1" class="manifest-scu" id="manifestSCU${index}" style="width:70px;" oninput="updateManifestTotals()">
          <label>Material:</label>
          <select class="manifest-material" id="manifestMaterial${index}" style="width:120px;">
            ${materialList.map(m => `<option value="${m}">${m}</option>`).join("")}
          </select>
          <label>UEC:</label>
          <input type="number" min="0" step="1" class="manifest-uec" id="manifestUEC${index}" style="width:90px;" oninput="updateManifestTotals()">
          <button type="button" onclick="removeManifestLine(${index})" class="manifest-btn remove" title="Remove line">Ôºç</button>
          ${isLast ? `<button type="button" onclick="addManifestLine()" class="manifest-btn add" title="Add line">Ôºã</button>` : ""}
        </div>
      `;
    }

    function renderManifestLines() {
      // Save current manifest line values
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }

      // Restore previous values
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
    }
    // Resource Drive manifest presets
    function applyManifestPreset(type) {
      var preset = [];
      var totalUEC = 0;
      if (type === 'large') {
        preset = [
          { scu: 72, material: 'Corundum' },
          { scu: 36, material: 'Tungsten' },
          { scu: 72, material: 'Copper' }
        ];
        totalUEC = 101750;
      } else if (type === 'medium') {
        preset = [
          { scu: 19, material: 'Corundum' },
          { scu: 10, material: 'Tungsten' },
          { scu: 19, material: 'Copper' }
        ];
        totalUEC = 58400;
      } else if (type === 'small') {
        preset = [
          { scu: 2, material: 'Corundum' },
          { scu: 4, material: 'Tungsten' },
          { scu: 2, material: 'Copper' }
        ];
        totalUEC = 53250;
      }
      manifestLineCount = preset.length;
      renderManifestLines();
      // Calculate total SCU
      var totalSCU = preset.reduce(function(sum, item) { return sum + item.scu; }, 0);
      // Distribute UEC by SCU per material
      var rows = document.querySelectorAll('.manifest-row');
      var uecAssigned = 0;
      for (var idx = 0; idx < preset.length; idx++) {
        var row = rows[idx];
        if (row) {
          row.querySelector('.manifest-scu').value = preset[idx].scu;
          row.querySelector('.manifest-material').value = preset[idx].material;
          // Calculate UEC for this line
          var uec = Math.floor((preset[idx].scu / totalSCU) * totalUEC);
          // For last line, assign remainder
          if (idx === preset.length - 1) {
            uec = totalUEC - uecAssigned;
          }
          row.querySelector('.manifest-uec').value = uec;
          uecAssigned += uec;
        }
      }
      // Set total UEC box
      var totalUECInput = document.getElementById('totalUECBox');
      if (totalUECInput) totalUECInput.value = totalUEC;
      updateManifestTotals();
      // Highlight selected preset button
      var largeBtn = document.getElementById('presetLargeBtn');
      var mediumBtn = document.getElementById('presetMediumBtn');
      var smallBtn = document.getElementById('presetSmallBtn');
      if (largeBtn) largeBtn.classList.remove('selected');
      if (mediumBtn) mediumBtn.classList.remove('selected');
      if (smallBtn) smallBtn.classList.remove('selected');
      if (type === 'large' && largeBtn) largeBtn.classList.add('selected');
      if (type === 'medium' && mediumBtn) mediumBtn.classList.add('selected');
      if (type === 'small' && smallBtn) smallBtn.classList.add('selected');
    }

    function addManifestLine() {
      manifestLineCount++;
      renderManifestLines();
    }

    function removeManifestLine(index) {
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });
      manifestData.splice(index - 1, 1);

      manifestLineCount--;
      if (manifestLineCount < 1) manifestLineCount = 1;

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }
      // Restore previous values except the deleted one
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
    }

    function updateManifestTotals() {
  let totalSCU = 0;
  let totalUEC = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scu = parseInt(row.querySelector('.manifest-scu').value, 10);
    const uec = parseInt(row.querySelector('.manifest-uec').value, 10);
    if (!isNaN(scu)) totalSCU += scu;
    if (!isNaN(uec)) totalUEC += uec;
  });

  document.getElementById("totalSCUBox").textContent = `Total SCU: ${totalSCU.toLocaleString()}`;

  // Set totalUECBox to the sum unless the user is editing it
  const totalUECInput = document.getElementById("totalUECBox");
  if (document.activeElement !== totalUECInput) {
    totalUECInput.value = totalUEC > 0 ? totalUEC : "";
  }
}

    window.toggleOrderTypeOther = toggleOrderTypeOther;
    window.toggleCompanyNameOther = toggleCompanyNameOther;
    window.toggleOrderCategoryOther = toggleOrderCategoryOther;
    window.toggleShipNameOther = toggleShipNameOther;
    window.toggleCaptainNameOther = toggleCaptainNameOther;
    window.generateCrewInputs = generateCrewInputs;
    window.addManifestLine = addManifestLine;
    window.removeManifestLine = removeManifestLine;
    window.updateManifestTotals = updateManifestTotals;
    window.generateOutput = generateOutput;
    window.copyDiscordOutput = copyDiscordOutput;
    window.clearFormFields = clearFormFields;

    // Make applyManifestPreset available globally
window.applyManifestPreset = applyManifestPreset;

    window.addEventListener("DOMContentLoaded", function() {
      populateLocationDropdown("startLocation");
      populateLocationDropdown("routeStart");
      populateLocationDropdown("routeEnd");
      populateShipDropdown(""); // Show all ships initially
      document.getElementById("discordSection").style.display = "none";
      manifestLineCount = 1;
      renderManifestLines();
      renderHistory();
    });

    document.getElementById("orderCategory").addEventListener("change", function() {
      toggleOrderCategoryOther();
      populateShipDropdown(this.value);
    });
    document.getElementById("orderType").addEventListener("change", function() {
      toggleOrderTypeOther();
      // Show/hide Resource Drive presets
      const val = this.value;
      const presetsDiv = document.getElementById("resourceDrivePresets");
      if (val === "Resource Drive") {
        presetsDiv.style.display = "block";
      } else {
        presetsDiv.style.display = "none";
      }
    });

    function toDiscordTimestamp(dtString) {
      if (!dtString) return "";
      const date = new Date(dtString);
      if (isNaN(date.getTime())) return "";
      // Add 930 years
      const yearsToAdd = 930;
      date.setFullYear(date.getFullYear() + yearsToAdd);
      const unix = Math.floor(date.getTime() / 1000);
      return `<t:${unix}:f>`;
    }

    const shipLinks = {
      "BRHS Lednik": "https://discord.com/channels/900478857436606535/1391878505905524817/1392397123907223643",
      "AACS Feder": "https://discord.com/channels/900478857436606535/1391878505905524817/1393365523407835196",
      "AACS Landsknecht": "https://discord.com/channels/900478857436606535/1391878505905524817/1392713534005186730",
      "BRHS Seastorm": "https://discord.com/channels/900478857436606535/1391878505905524817/1392395299275800576",
      "BRHS Trireme": "https://discord.com/channels/900478857436606535/1391878505905524817/1391904991710806069",
      "WINC Caterpillar": "https://discord.com/channels/900478857436606535/1391878505905524817/1391904347117322322",
      "SPRT Icarus": "https://discord.com/channels/900478857436606535/1391878505905524817/1396265862268190830"
    };

    function toggleOrderCategoryOther() {
      const val = document.getElementById("orderCategory").value;
      const otherDiv = document.getElementById("orderCategoryOtherDiv");
      if (val === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderCategoryOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("orderCategoryOther").required = false;
      }
    }

    function toggleCompanyNameOther() {
      const companyName = document.getElementById("companyName").value;
      const otherDiv = document.getElementById("companyNameOtherDiv");
      if (companyName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("companyNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("companyNameOther").required = false;
      }
    }

    function toggleOrderTypeOther() {
      const orderType = document.getElementById("orderType").value;
      const otherDiv = document.getElementById("orderTypeOtherDiv");
      const resourceDriveDiv = document.getElementById("resourceDriveCompanyDiv");
      if (orderType === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderTypeOther").required = true;
        resourceDriveDiv.style.display = "none";
        document.getElementById("resourceDriveCompany").required = false;
      } else if (orderType === "Resource Drive") {
        resourceDriveDiv.style.display = "block";
        document.getElementById("resourceDriveCompany").required = true;
        otherDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
      } else {
        otherDiv.style.display = "none";
        resourceDriveDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
        document.getElementById("resourceDriveCompany").required = false;
      }
    }

    function toggleShipNameOther() {
      const shipName = document.getElementById("shipName").value;
      const otherDiv = document.getElementById("shipNameOtherDiv");
      if (shipName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("shipNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("shipNameOther").required = false;
      }
    }

    function toggleCaptainNameOther() {
      const captainName = document.getElementById("captainName").value;
      const otherDiv = document.getElementById("captainNameOtherDiv");
      if (captainName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("captainNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("captainNameOther").required = false;
      }
    }

    function generateCrewInputs() {
      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      const crewNamesDiv = document.getElementById("crewNamesDiv");
      crewNamesDiv.innerHTML = "";
      if (!isNaN(crewAmount) && crewAmount > 0) {
        for (let i = 1; i <= crewAmount; i++) {
          const label = document.createElement("label");
          label.textContent = `Crew ${i} Name:`;
          label.htmlFor = `crewName${i}`;
          label.className = "crew-label";
          const input = document.createElement("input");
          input.type = "text";
          input.id = `crewName${i}`;
          input.name = `crewName${i}`;
          input.required = true;
          input.className = "crew-input";
          crewNamesDiv.appendChild(label);
          crewNamesDiv.appendChild(input);
        }
      }
    }

    function validateRequiredFields() {
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      // Add event listeners to required fields to remove error class on input/change
      const requiredFields = [
        "orderCategory",
        "companyName",
        "orderType",
        "shipName",
        "captainName",
        "crewAmount",
        "startLocation",
        "departureTime",
        "routeStart",
        "routeEnd",
        "completionTime",
        "repairs",
        "restock",
        "quantumFuel",
        "hydrogenFuel",
        "crewCosts",
        "totalUECBox"
      ];
      requiredFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => el.classList.remove('error'));
      el.addEventListener('change', () => el.classList.remove('error'));
    }
  });

  // Also handle manifest and crew fields
  document.querySelectorAll('.manifest-scu, .manifest-material, .crew-input').forEach(el => {
    el.addEventListener('input', () => el.classList.remove('error'));
    el.addEventListener('change', () => el.classList.remove('error'));
  });

  let firstError = null;
  for (const id of requiredFields) {
    const el = document.getElementById(id);
    let isValid = false;
    
    if (!el) continue;
    
    // Special validation for location fields
    if (id === 'startLocation' || id === 'routeStart' || id === 'routeEnd') {
      isValid = el.value.trim() !== "" && locations.includes(el.value);
    } else {
      isValid = el.value !== "" && el.value !== null;
    }
    
    if (!isValid) {
      if (el) el.classList.add('error');
      if (!firstError && el) firstError = el;
    }
  }

      const otherFields = [
        {select: "orderCategory", other: "orderCategoryOtherDiv", input: "orderCategoryOther"},
        {select: "companyName", other: "companyNameOtherDiv", input: "companyNameOther"},
        {select: "orderType", other: "orderTypeOtherDiv", input: "orderTypeOther"},
        {select: "shipName", other: "shipNameOtherDiv", input: "shipNameOther"},
        {select: "captainName", other: "captainNameOtherDiv", input: "captainNameOther"}
      ];
      for (const field of otherFields) {
        const selectEl = document.getElementById(field.select);
        const otherDiv = document.getElementById(field.other);
        const otherInput = document.getElementById(field.input);
        if (selectEl && selectEl.value === "Other" && otherDiv.style.display === "block") {
          if (!otherInput.value.trim()) {
            otherInput.classList.add('error');
            if (!firstError) firstError = otherInput;
          }
        }
      }

      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      for (let i = 1; i <= crewAmount; i++) {
        const crewInput = document.getElementById(`crewName${i}`);
        if (!crewInput || !crewInput.value.trim()) {
          if (crewInput) crewInput.classList.add('error');
          if (!firstError && crewInput) firstError = crewInput;
        }
      }

       // Validate manifest lines (UEC and material now required)
  const manifestRows = document.querySelectorAll('.manifest-row');
  if (manifestRows.length === 0) {
    alert("Please add at least one manifest line. Do not report repositioning flights.");
    return false;
  }
  for (const row of manifestRows) {
    const scu = row.querySelector('.manifest-scu');
    const mat = row.querySelector('.manifest-material');
    // UEC is NOT required
    if (!scu.value || !mat.value) {
      scu.classList.add('error');
      mat.classList.add('error');
      if (!firstError) firstError = scu;
    }
  }

  if (firstError) {
    firstError.scrollIntoView({behavior: "smooth", block: "center"});
    alert("Please fill out all required fields!. Unanswered questions are highlighted in red.");
    return false;
  }
  return true;
}

    function copyDiscordOutput() {
      const discordOutput = document.getElementById("discordOutput");
      discordOutput.select();
      discordOutput.setSelectionRange(0, 99999);
      document.execCommand("copy");
    }

    function updateOrderDuration() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      const durationDiv = document.getElementById("orderDuration");
      if (!dep || !comp) {
        durationDiv.textContent = "";
        return;
      }
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) {
        durationDiv.textContent = "";
        return;
      }
      let diffMs = compDate - depDate;
      if (diffMs < 0) {
        durationDiv.textContent = "Completion time is before departure!";
        return;
      }
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      durationDiv.textContent = `Order Duration: ${hours}h ${mins}m`;
    }

    function getOrderDurationText() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      if (!dep || !comp) return "";
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) return "";
      let diffMs = compDate - depDate;
      if (diffMs < 0) return "";
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      return `Order Duration: ${hours}h ${mins}m`;
    }

    function generateOutput() {
  if (!validateRequiredFields()) return;

  const get = id => document.getElementById(id)?.value?.trim() || "";
  const departureDiscord = toDiscordTimestamp(get("departureTime"));
  const completionDiscord = toDiscordTimestamp(get("completionTime"));

  let orderCategoryText = get("orderCategory");
  if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");

  let companyNameText = get("companyName");
  if (companyNameText === "Other") companyNameText = get("companyNameOther");

  let orderTypeText = get("orderType");
  if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");

  let resourceDriveCompanyText = "";
  if (orderTypeText === "Resource Drive") {
    resourceDriveCompanyText = document.getElementById("resourceDriveCompany").value || "";
  }

  let shipNameText = get("shipName");
  if (shipNameText === "Other") shipNameText = get("shipNameOther");

  let captainNameText = get("captainName");
  if (captainNameText === "Other") captainNameText = get("captainNameOther");

  const shipLink = shipLinks[shipNameText] || "#";

  const crewAmount = parseInt(get("crewAmount"), 10);
  let crewNamesList = [];
  for (let i = 1; i <= crewAmount; i++) {
    const crewInput = document.getElementById(`crewName${i}`);
    if (crewInput && crewInput.value.trim()) {
      crewNamesList.push(crewInput.value.trim());
    }
  }
  let postCounter = parseInt(sessionStorage.getItem('discordHistoryCounter') || '1', 10);
  const crewNamesText = crewNamesList.length > 0 ? crewNamesList.join(", ") : "0";

  const routeStart = get("routeStart");
  const routeEnd = get("routeEnd");
  const routeText = routeStart && routeEnd ? `${routeStart} :arrow_right: ${routeEnd}` : "";

  // Gather manifest lines and totals
  let manifestLines = [];
  let totalSCU = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scuValue = row.querySelector('.manifest-scu').value;
    const scu = parseInt(scuValue, 10);
    const mat = row.querySelector('.manifest-material').value;
    const uecValue = row.querySelector('.manifest-uec').value;
    if (!isNaN(scu)) totalSCU += scu;
    manifestLines.push({
      scu: scuValue,
      mat: mat,
      uec: uecValue
    });
  });

  // Format manifest table
  let manifestTable = "SCU   Material         UEC\n";
  manifestLines.forEach(line => {
    manifestTable += `${line.scu.padEnd(5)} ${line.mat.padEnd(15)} ${line.uec ? line.uec : ""}\n`;
  });

  // Get total UEC from the box (manual or auto)
  const totalUECInput = document.getElementById("totalUECBox");
  let totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) : 0;

  // Format total line
  let totalLine = `**Total: ${totalSCU.toLocaleString()} SCU`;
  if (totalUEC && !isNaN(totalUEC)) {
    totalLine += ` / ${totalUEC.toLocaleString()} UEC`;
  }
  totalLine += "**";
  // Format total SCU
  const totalSCUText = `**Total: ${totalSCU.toLocaleString()} SCU**`;

  // Deductibles
  const repairs = parseInt(get("repairs") || "0", 10);
  const restock = parseInt(get("restock") || "0", 10);
  const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
  const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
  const crewCosts = parseInt(get("crewCosts") || "0", 10);
  const totalDeductibles = repairs + restock + quantumFuel + hydrogenFuel + crewCosts;

  // Notes
  const notesText = get("notes");

  // Build Discord output
    let output = `**${orderCategoryText}**
${companyNameText} ${orderTypeText === "Resource Drive" ? "Resource Drive" : orderTypeText}
${resourceDriveCompanyText ? `Resource Drive Company: ${resourceDriveCompanyText}` : ""}

**Ship:** [${shipNameText}](${shipLink})
**Captain:** ${captainNameText}
**Crew:** ${crewNamesText}

‚Äî‚Äî‚Äî

 **Departure:** ${get("startLocation")}
 **Departure Time:** ${departureDiscord}
 **Route:** ${routeText}

‚Äî‚Äî‚Äî

**Manifest**
\`\`\`
${manifestTable.trim()}
\`\`\`
${totalLine}

‚Äî‚Äî‚Äî

**Sign Off**
Order completion time: ${completionDiscord}
${getOrderDurationText()}

**Deductibles**
- **Repairs:** ${repairs.toLocaleString()} UEC
- **Restock:** ${restock.toLocaleString()} UEC
- **Quantum fuel:** ${quantumFuel.toLocaleString()} UEC
- **Hydrogen fuel:** ${hydrogenFuel.toLocaleString()} UEC
- **Crew/ship costs:** ${crewCosts.toLocaleString()} UEC
**Total Deductibles: ${totalDeductibles.toLocaleString()} UEC**

‚Äî‚Äî‚Äî

**Notes**
\`\`\`
${notesText}
\`\`\`
`;

  // Store in session history (as string)
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  history.push({ id: postCounter, content: output });
  sessionStorage.setItem('discordHistory', JSON.stringify(history));
  sessionStorage.setItem('discordHistoryCounter', (postCounter + 1).toString());
  renderHistory();

  document.getElementById("discordOutput").value = output;
  document.getElementById("discordSection").style.display = "block";
}

function renderHistory() {
  const historyList = document.getElementById('historyList');
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  if (history.length === 0) {
    historyList.innerHTML = `
      <div style="text-align:center;">
        <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo" style="max-width:200px;width:100%;margin-bottom:16px;border-radius:8px;">
        <h2 style="color:#9d7523;">Brute Haul Manifest Log</h2>
        <strong><em>No posts generated this session.</em></strong>
      </div>
    `;
    return;
  }
  historyList.innerHTML = history.map((post, idx) => `
    <div style="margin-bottom:18px;padding:10px;border-bottom:1px solid #9d7523;">
      <strong>Post #${post.id}</strong>
      <textarea readonly style="width:100%;height:120px;">${post.content}</textarea>
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button type="button" onclick="copyHistoryPost(${idx})" style="padding:2px 6px;font-size:0.85em;min-width:28px;">Copy</button>
        <button type="button" onclick="deleteHistoryPost(${idx})" style="background:#ed4245;padding:2px 6px;font-size:0.85em;min-width:28px;">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
}

function deleteHistoryPost(idx) {
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  history.splice(idx, 1);
  sessionStorage.setItem('discordHistory', JSON.stringify(history));
  renderHistory();
}

function copyHistoryPost(idx) {
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  if (history[idx]) {
    const temp = document.createElement('textarea');
    temp.value = history[idx].content; // Use only the discord output string
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
  }
}

window.deleteHistoryPost = deleteHistoryPost;
window.copyHistoryPost = copyHistoryPost;

window.sendToDiscord = sendToDiscord;

async function sendToDiscord() {
  const message = document.getElementById("discordOutput").value;
  const orderType = document.getElementById("orderType").value;
  const resourceDriveCompany = document.getElementById("resourceDriveCompany").value;
  const totalSCU = parseInt(document.getElementById("totalSCUBox").textContent.replace(/\D/g, "")) || 0;
  const captainName = document.getElementById("captainName").value;
  let shipName = document.getElementById("shipName").value;
  if (shipName === "Other") {
    shipName = document.getElementById("shipNameOther").value;
  }

  // Collect all additional fields for Google Sheets
  const get = id => document.getElementById(id)?.value?.trim() || "";
  
  let orderCategoryText = get("orderCategory");
  if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");
  
  let companyNameText = get("companyName");
  if (companyNameText === "Other") companyNameText = get("companyNameOther");
  
  let orderTypeText = get("orderType");
  if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");
  
  let captainNameText = get("captainName");
  if (captainNameText === "Other") captainNameText = get("captainNameOther");
  
  const crewAmount = parseInt(get("crewAmount"), 10);
  let crewNamesList = [];
  for (let i = 1; i <= crewAmount; i++) {
    const crewInput = document.getElementById(`crewName${i}`);
    if (crewInput && crewInput.value.trim()) {
      crewNamesList.push(crewInput.value.trim());
    }
  }
  const crewAmountWithNames = crewAmount > 0 ? `${crewAmount} (${crewNamesList.join(", ")})` : "0";
  
  const totalUECInput = document.getElementById("totalUECBox");
  const totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) || 0 : 0;
  
  const repairs = parseInt(get("repairs") || "0", 10);
  const restock = parseInt(get("restock") || "0", 10);
  const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
  const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
  const crewCosts = parseInt(get("crewCosts") || "0", 10);

  // Error: No message generated
  if (!message) {
    alert("No message to send. Please generate a Discord post first.");
    return;
  }

  // Error: Required fields missing
  if (!orderType || !captainName) {
    alert("Order Type and Captain Name are required to send to Discord.");
    return;
  }

  // Error: SCU is zero
  if (totalSCU <= 0) {
    if (!confirm("Total SCU is zero. Are you sure you want to send this manifest?")) {
      return;
    }
  }

  // Disable button to prevent duplicate submissions
  const sendBtn = Array.from(document.querySelectorAll("button"))
    .find(btn => btn.textContent.includes("Send to Discord"));
  if (sendBtn) sendBtn.disabled = true;

  try {
    // Try HTTPS first (required for GitHub Pages), then HTTP fallback
    const endpoints = [
      "https://astro.wisp.uno:10478/send-discord",
      "https://astro.wisp.uno:8080/send-discord",
      "https://astro.wisp.uno:3000/send-discord",
      "http://astro.wisp.uno:10478/send-discord",
      "http://astro.wisp.uno:8080/send-discord",
      "https://127.0.0.1:10478/send-discord",
      "https://127.18.1.57:10478/send-discord",
      "http://127.18.1.57:10478/send-discord",
      "http://127.0.0.1:10478/send-discord"
    ];
    
    let response;
    let successfulEndpoint = null;
    
    for (const endpoint of endpoints) {
      try {
        console.log(`Trying endpoint: ${endpoint}`);
        response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            date: new Date().toISOString().split('T')[0], // Current date in YYYY-MM-DD format
            orderCategory: orderCategoryText,
            companyName: companyNameText,
            orderType: orderTypeText,
            shipName: shipName,
            captainName: captainNameText,
            crewAmount: crewAmountWithNames,
            startLocation: get("startLocation"),
            departureTimestamp: get("departureTime"),
            routeStart: get("routeStart"),
            routeEnd: get("routeEnd"),
            totalSCU: totalSCU,
            totalUEC: totalUEC,
            orderCompletionTimestamp: get("completionTime"),
            orderTime: getOrderDurationText(),
            repairs: repairs,
            restock: restock,
            quantumFuel: quantumFuel,
            hydrogenFuel: hydrogenFuel,
            crewShipCosts: crewCosts,
            notes: get("notes"),
            // Legacy fields for Discord functionality
            resourceDriveCompany,
            shipNames: typeof allShips !== "undefined" ? allShips : []
          })
        });
        
        if (response.ok) {
          successfulEndpoint = endpoint;
          console.log(`Success with endpoint: ${endpoint}`);
          break;
        }
      } catch (error) {
        console.log(`Failed with ${endpoint}:`, error.message);
        continue;
      }
    }
    
    if (!response || !response.ok) {
      throw new Error("All endpoints failed - please check server status");
    }

    let data;
    try {
      data = await response.json();
    } catch {
      alert("The Brute Haul System is currently restarting. Please try again shortly.");
      if (sendBtn) sendBtn.disabled = false;
      return;
    }

    if (response.ok) {
      alert("Successfully sent to Brute Haul - Standy by for updated logs");
      // Hide the Discord output section
      document.getElementById("discordSection").style.display = "none";
      // Clear the form fields
      clearFormFields();
    } else {
      alert("Error sending to Brute Haul: " + (data.error || "Contact DyslexicNerd01"));
    }
  } catch (err) {
    alert("The Brute Haul System is currently offline. Please try again later.");
  } finally {
    if (sendBtn) sendBtn.disabled = false;
  }
}
function generateAnnouncement() {
  const title = document.getElementById("announcementTitle").value.trim();
  const body = document.getElementById("announcementBody").value.trim();
  if (!title && !body) {
    alert("Please enter a title or body for the announcement.");
    return;
  }
  const output = `üì¢ **${title || "Announcement"}**\n\n${body}`;
  document.getElementById("announcementOutput").value = output;
}

function copyAnnouncementOutput() {
  const output = document.getElementById("announcementOutput");
  output.select();
  output.setSelectionRange(0, 99999);
  document.execCommand("copy");
}

window.generateAnnouncement = generateAnnouncement;
window.copyAnnouncementOutput = copyAnnouncementOutput;
  </script>
</div>
