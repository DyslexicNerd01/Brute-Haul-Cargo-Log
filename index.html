<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brute Haul Cargo Manifest Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 800px;
      background: #e2e2e2;
      color: #230e09;
    }
    form {
      background: #781d15;
      border-radius: 12px;
      padding: 20px;
    }
    textarea {
      width: 100%;
      height: 400px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    #notes {
      height: 80px;
      width: 100%;
      resize: vertical;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      color: #9d7523;
    }
    input, select, textarea {
      margin-bottom: 10px;
      width: 100%;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .section {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #9d7523;
      background: #fff;
      border-radius: 8px;
    }
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 250px;
      width: 100%;
      background: #e2e2e2;
      border-radius: 8px;
    }
    input[type="number"] {
      width: 120px;
      padding: 5px;
      font-size: 1.1em;
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    #crewAmount {
      width: 60px;
      font-size: 1em;
      padding: 3px;
      display: inline-block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .other-div {
      display: none;
      margin-left: 30px;
    }
    .other-div label {
      font-weight: bold;
      color: #9d7523;
      margin-top: 10px;
      display: block;
    }
    .other-div input {
      font-size: 0.95em;
      width: 60%;
      color: #230e09;
      background: #e2e2e2;
      border: 1px solid #781d15;
      margin-bottom: 10px;
    }
    .crew-label {
      display: block;
      margin-left: 30px;
      font-size: 0.95em;
      margin-top: 5px;
      color: #9d7523;
      font-weight: bold;
    }
    .crew-input {
      display: block;
      width: 60%;
      font-size: 0.95em;
      margin-left: 30px;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .deductible-input {
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .error {
      border: 2px solid #9d7523 !important;
      background: #b32428 !important;
    }
    select.error option[value=""] {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error:focus {
      background: #e2e2e2 !important;
      color: #230e09 !important;
    }
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .route-arrow {
      font-weight: bold;
      color: #230e09;
      font-size: 1.2em;
      padding: 0 8px;
    }
    button {
      background: #5865F2;
      color: #fff;
      border: none;
      padding: 10px 24px 10px 16px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      background: #404EED;
      color: #fff;
      border: 1px solid #9d7523;
    }
    .discord-btn-logo {
      height: 1.6em;
      width: auto;
      vertical-align: middle;
      filter: invert(1);
    }
    h1 {
      color: #9d7523;
      text-align: center;
      font-size: 2.4em;
      font-weight: bold;
    }
    h2 {
      color: #9d7523;
    }
    .manifest-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 12px;
      border: 2px solid #9d7523;
      border-radius: 8px;
      background: #f8f6f2;
      box-shadow: 0 2px 6px rgba(157,117,35,0.07);
      position: relative;
    }
    .manifest-row label {
      margin: 0;
      font-weight: normal;
      color: #230e09;
      min-width: 60px;
    }
    .manifest-row input,
    .manifest-row select {
      width: auto;
      margin-bottom: 0;
    }
    .manifest-btn {
      font-size: 1em;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
      margin-right: 0;
      transition: background 0.2s;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 0;
    }
    .manifest-btn.add {
      background: #43b581;
      color: #fff;
    }
    .manifest-btn.add:hover {
      background: #2ea964;
    }
    .manifest-btn.remove {
      background: #ed4245;
      color: #fff;
    }
    .manifest-btn.remove:hover {
      background: #b32428;
    }
    .manifest-total-box {
      display: flex;
      gap: 24px;
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: bold;
      color: #230e09;
      background: #f8f6f2;
      border: 2px solid #9d7523;
      border-radius: 8px;
      padding: 12px;
      align-items: center;
      justify-content: flex-start;
    }
    .resource-preset-btn {
      background: #9d7523;
      color: #fff;
      border: none;
      padding: 6px 14px;
      font-size: 11px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
      white-space: nowrap;
      transition: background 0.2s;
      display: inline-block;
    }
    .resource-preset-btn.selected {
      background: #43b581 !important;
      color: #fff !important;
    }
    .resource-preset-btn:hover {
      background: #bfa14d;
      color: #fff;
    }
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4245;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
    }
    .tab-button-container {
      position: relative;
      display: contents;
    }

    /* Searchable dropdown styles */
    .searchable-dropdown {
      position: relative;
      width: 100%;
    }
    .searchable-dropdown input {
      width: 100%;
      padding: 8px;
      border: 1px solid #781d15;
      background: #e2e2e2;
      color: #230e09;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .searchable-dropdown .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #e2e2e2;
      border: 1px solid #781d15;
      border-top: none;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .searchable-dropdown .dropdown-list.show {
      display: block;
    }
    .searchable-dropdown .dropdown-item {
      padding: 6px 12px;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
      background: #e2e2e2;
      color: #230e09;
      font-size: 14px;
    }
    .searchable-dropdown .dropdown-item:hover {
      background: #d0d0d0;
    }
    .searchable-dropdown .dropdown-item.selected {
      background: #781d15;
      color: #e2e2e2;
    }
    .searchable-dropdown .dropdown-item:last-child {
      border-bottom: none;
    }
    
    /* Route row styling for searchable dropdowns */
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .route-row .searchable-dropdown {
      flex: 1;
    }
    .tab-button-container button {
      position: relative;
    }
    #announcementsTabBtn::after {
      content: "1";
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4245;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #announcementsTabBtn.badge-hidden::after {
      display: none;
    }

    /* Loading States & Progress Indicators */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(35, 14, 9, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }

    .loading-content {
      background: #781d15;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      color: #e2e2e2;
      border: 2px solid #9d7523;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .loading-spinner-large {
      width: 40px;
      height: 40px;
      border: 4px solid #9d7523;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto 16px auto;
    }

    .progress-bar-container {
      background: #e2e2e2;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #9d7523;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ccc;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #43b581, #9d7523);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      font-size: 14px;
      color: #230e09;
      font-weight: bold;
      text-align: center;
    }

    .button-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .success-feedback {
      background: #43b581;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    .error-feedback {
      background: #ed4245;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-step {
      transition: border-left 0.3s ease, padding-left 0.3s ease;
    }

    .form-step.active {
      border-left: 4px solid #9d7523;
      padding-left: 16px;
    }

    .form-step.completed {
      border-left: 4px solid #43b581;
      padding-left: 16px;
    }
  </style>
  <script src="locations.js"></script>
</head>
<body>

  <img class="logo" src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo">
  <h1>Brute Haul Online Documentation System</h1>

  <div style="display: flex; gap: 12px; margin-bottom: 0;">
  <button type="button" onclick="showTab('formTab')" id="formTabBtn" style="border: 3px solid transparent;">Form</button>
  <button type="button" onclick="showTab('historyTab')" id="historyTabBtn" style="border: 3px solid transparent;">History</button>
  <div class="tab-button-container">
    <button type="button" onclick="showTab('announcementsTab')" id="announcementsTabBtn" style="border: 3px solid transparent;">Announcements</button>
  </div>
  <a href="https://robertsspaceindustries.com/en/orgs/BRHS" target="_blank" title="Join BRHS"
     style="margin-left:auto; display:inline-flex; align-items:center; justify-content:center; width:60px; height:60px; background:#222; border-radius:8px; text-decoration:none; border:0px solid #9d7523;">
    <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/starcitizenwhite.png" alt="Star Citizen" style="width:82px; height:82px; object-fit:contain; filter:invert(1);">
  </a>
</div>
<hr style="border: none; border-bottom: 5px solid #9d7523; margin: 0 0 20px 0;">
<div id="formTab">
  <div style="background:#e2e2e2; border-radius:8px; padding:12px; margin-bottom:5px;">
  <h2 style="color:#9d7523; margin:0; text-align:left;">Cargo Form</h2>
</div>
  
  <!-- Feedback Messages -->
  <div class="success-feedback" id="successFeedback">
    <span>✓</span>
    <span id="successMessage">Success!</span>
  </div>
  <div class="error-feedback" id="errorFeedback">
    <span>⚠</span>
    <span id="errorMessage">Error occurred!</span>
  </div>

  <form id="haulForm">
    <div class="section form-step" id="basicInfoStep">
      <label>Order Category:</label>
      <select id="orderCategory" required>
        <option value="" selected disabled>Select category</option>
        <option value="Transport">Transport</option>
        <option value="Security">Security</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderCategoryOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderCategoryOther" required />
      </div>

      <label>Company Name:</label>
      <select id="companyName" required onchange="toggleCompanyNameOther()">
        <option value="" selected disabled>Select company</option>
        <option value="Brute Haul">Brute Haul</option>
        <option value="Wildcard Inc.">Wildcard Inc.</option>
        <option value="Space Rats">Space Rats</option>
        <option value="The Benjineering Project">The Benjineering Project</option>
        <option value="Other">Other</option>
      </select>
      <div id="companyNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="companyNameOther" required />
      </div>

      <label>Order Type:</label>
      <select id="orderType" required onchange="toggleOrderTypeOther()">
        <option value="" selected disabled>Select order type</option>
        <option value="Resource Drive">Resource Drive</option>
        <option value="Supplies">Supplies</option>
        <option value="Trade">Trade</option>
        <option value="Resources">Resources</option>
        <option value="Salvage">Salvage</option>
        <option value="Contract">Contract</option>
        <option value="Relocation">Relocation</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderTypeOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderTypeOther" required />
      </div>
      <div id="resourceDriveCompanyDiv" class="other-div" style="display:none;">
        <label>Resource Drive Company:</label>
        <select id="resourceDriveCompany">
          <option value="" selected disabled>Select company</option>
          <option value="Hurston Dynamics">Hurston Dynamics</option>
          <option value="Arccorp">Arccorp</option>
          <option value="🏆 Crusader Industries 🏆">🏆 Crusader Industries 🏆</option>
          <option value="Microtech">Microtech</option>
        </select>
      </div>

      <label>Ship Name:</label>
      <div class="searchable-dropdown" id="shipNameDropdown">
        <input type="text" id="shipName" placeholder="Search ship name..." autocomplete="off" required>
        <div class="dropdown-list" id="shipNameList"></div>
      </div>
      <div id="shipNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="shipNameOther" required />
      </div>

      <label>Captain Name:</label>
      <div class="searchable-dropdown" id="captainNameDropdown">
        <input type="text" id="captainName" placeholder="Search captain name..." autocomplete="off" required>
        <div class="dropdown-list" id="captainNameList"></div>
      </div>
      <div id="captainNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="captainNameOther" required />
      </div>

      <label>Crew Amount:</label>
      <input type="number" id="crewAmount" min="0" max="20" step="1" required oninput="generateCrewInputs()" />

      <div id="crewNamesDiv"></div>
    </div>

    <div class="section form-step" id="locationTimeStep">
      <label>Start Location:</label>
      <div class="searchable-dropdown" id="startLocationDropdown">
        <input type="text" id="startLocation" placeholder="Search start location..." autocomplete="off" required>
        <div class="dropdown-list" id="startLocationList"></div>
      </div>

      <label>Departure Timestamp:</label>
      <input type="datetime-local" id="departureTime" required>

      <label>Route:</label>
      <div class="route-row">
        <div class="searchable-dropdown" id="routeStartDropdown">
          <input type="text" id="routeStart" placeholder="Search route start..." autocomplete="off" required>
          <div class="dropdown-list" id="routeStartList"></div>
        </div>
        <span class="route-arrow" style="font-size:1.5em;">➡️</span>
        <div class="searchable-dropdown" id="routeEndDropdown">
          <input type="text" id="routeEnd" placeholder="Search route end..." autocomplete="off" required>
          <div class="dropdown-list" id="routeEndList"></div>
        </div>
      </div>
    </div>

    <div class="section form-step" id="manifestStep">
      <label>Cargo Manifest (add/remove lines as needed):</label>
      <div id="resourceDrivePresets" style="display:none; margin-bottom:10px;">
        <span style="font-size:13px; font-weight:bold; vertical-align:middle; margin-right:8px;">Resource Drive Presets:</span>
        <span style="display:inline-flex; gap:10px; vertical-align:middle;">
          <button type="button" class="resource-preset-btn" id="presetLargeBtn" onclick="applyManifestPreset('large')">Large Haul</button>
          <button type="button" class="resource-preset-btn" id="presetMediumBtn" onclick="applyManifestPreset('medium')">Medium Haul</button>
          <button type="button" class="resource-preset-btn" id="presetSmallBtn" onclick="applyManifestPreset('small')">Small Haul</button>
        </span>
      </div>
      <div id="manifestLines"></div>
      <div class="manifest-total-box">
  <span id="totalSCUBox">Total SCU: 0</span>
  <span style="margin-right:6px;">Total UEC:</span>
<input type="number" id="totalUECBox" style="color:#230e09; font-weight:bold; vertical-align:middle; width:120px;" value="" />
</div>
    </div>

    <div class="section form-step" id="completionStep">
      <label>Order Completion Timestamp:</label>
      <input type="datetime-local" id="completionTime" required>
      <div id="orderDuration" style="font-weight:bold; color:#9d7523; margin-top:8px;"></div>

      <label>Repairs (UEC):</label>
      <input type="number" id="repairs" min="0" step="1" class="deductible-input" required value="0">

      <label>Restock (UEC):</label>
      <input type="number" id="restock" min="0" step="1" class="deductible-input" required value="0">

      <label>Quantum Fuel (UEC):</label>
      <input type="number" id="quantumFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Hydrogen Fuel (UEC):</label>
      <input type="number" id="hydrogenFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Crew/Ship Costs (UEC):</label>
      <input type="number" id="crewCosts" min="0" step="1" class="deductible-input" required value="0">

      <label>Notes:</label>
      <textarea id="notes"></textarea>
    </div>

    <button type="button" onclick="generateOutput()" id="generateBtn">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" class="discord-btn-logo" style="filter: brightness(0) invert(1);" />
      Generate Discord Post
    </button>
    <button type="button" onclick="clearFormFields()" style="background:#b32428;color:#fff;border:none;padding:10px 16px;border-radius:5px;font-weight:bold;display:flex;align-items:center;gap:8px;margin-left:8px;">
  Clear Form
</button>
  </form>
  <!-- Progress Bar -->
  <div class="progress-bar-container">
    <div class="progress-bar">
      <div class="progress-fill" id="formProgressFill"></div>
    </div>
    <div class="progress-text" id="formProgressText">Form Completion: 0%</div>
  </div>

  <div class="section" id="discordSection" style="display:none;">
    </button>
    <button type="button" onclick="sendToDiscord()" style="background:#43b581;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;margin-left:8px;">
    <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
    Send to Discord
  </button>
    <h2>Discord Output:</h2>
    <textarea id="discordOutput" readonly></textarea>
    <button type="button" onclick="copyDiscordOutput()" id="copyDiscordBtn" style="background:#5865F2;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:none;align-items:center;gap:8px;">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
      Copy to Clipboard
    </button>
  </div>
</div>
<div id="historyTab" style="display:none;">
  <h2>Session History</h2>
  <div id="historyList" style="max-height:400px;overflow-y:auto;background:#fff;border-radius:8px;padding:12px;border:1px solid #9d7523;"></div>
</div>
<div id="announcementsTab" style="display:none;">
  <div style="text-align:center; margin-bottom:30px;">
    <h2 style="color:#9d7523;">Announcements</h2>
  </div>  
  <div id="announcementsList" style="max-height:600px;overflow-y:auto;">
    <!-- Announcement Post 1 -->
    <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
      <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
        <h3 style="color:#781d15;margin:0;font-size:1.4em;">* Send to Discord Enabled! (For Real)</h3>
        <div style="color:#666;font-size:0.9em;margin-top:5px;">
          <strong>By:</strong> DyslexicNerd01 | <strong>Date:</strong> August 3, 2025
        </div>
      </div>
      <div class="announcement-body" style="color:#230e09;line-height:1.6;">
        <p>The Send to Discord feature is now enabled! (For real this time!) <b>Please only use the <i>"Send to Discord"</i> button to upload your cargo manifests.</b> </p>
        <p>If you encounter any issues, please report them to the development team as soon as possible. Hotfixes will be regularly released to keep the form up-to-date with any changes to Star Citizen or Brute Haul policy.</p>
        <p>The copy button will remain active in the event that there is an issue with the discord bot in the future. If the discord bot does not respond, and error code will appear and you will gain access to the copy button again. The copy button no longer will appear under the output box as it did before.</p>
      </div>
    </div>
    <!-- Announcement Post 2 -->
    <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
      <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
        <h3 style="color:#781d15;margin:0;font-size:1.4em;">KNOWN FREIGHT ELEVATOR ISSUES</h3>
        <div style="color:#666;font-size:0.9em;margin-top:5px;">
          <strong>By:</strong> DyslexicNerd01 | <strong>Date:</strong> August 2, 2025
        </div>
      </div>
      <div class="announcement-body" style="color:#230e09;line-height:1.6;">
        <p><strong>Below are currently known major issues affecting Brute Haul/Ad Astra Operations. Currently there are no official fixes or 100% reliable workarounds.</strong></p>

        <p><strong>🟢 Issue:</strong> <u>Unable to lower hanger freight elevator. (Confirmed Fixed)</u></p>
        <strong>Fix:</strong> Only place 1 layer of containers on the elevator then send it down. The elevators will not move if there is more than one layer/containers stacked on top of each other.</p>
        
        <p><strong>🔴 Issue:</strong> <u>Freight Elevator Overloaded</u></p>
        <p><strong>Workaround:</strong> Follow this Reddit post: <a href="https://www.reddit.com/r/starcitizen/comments/1mbaxkj/elevator_overloaded_fix" target="_blank" style="color:#781d15;">https://www.reddit.com/r/starcitizen/comments/1mbaxkj/elevator_overloaded_fix</a><br>
        It does not work 100% of the time. We have found a success rate of about 25% when going to -40k. At this time there are no other workarounds.</p>

        <p><strong>🔴 Issue:</strong> <u>Elevators not lowering/storing items</u></p>
        <p><strong>Workaround:</strong> There is no known work around. Do not use the Stormageddon Specimen facility and possibly the Shubin Mining Facility elevators</p>
        <p><strong>____________________________________________________________________________________</strong></p>
        <p>We will provide updates as these issues develop or if new solutions are found.</p>
        <p>Follow this support ticket for more information on current issues within the game: <a href="https://support.robertsspaceindustries.com/hc/en-us/articles/360056254754-Star-Citizen-Alpha-4-2-1-Known-Issues" target="_blank" style="color:#781d15;">Star Citizen Alpha 4.2.1 Known Issues</a></p>
      </div>
    </div>
  </div>
</div>

<script type="module">
   // Locations are now loaded from external locations.js file

   // ========================================
   // 🔧 GITHUB ERROR REPORTING CONFIGURATION
   // ========================================
   // 
   // To enable automatic error reporting to GitHub Issues:
   // 1. Create a GitHub Personal Access Token (PAT):
   //    - Go to: https://github.com/settings/tokens/new
   //    - Name: "Brute Haul Error Reporter"
   //    - Expiration: Your choice (90 days recommended)
   //    - Scopes: Check "repo" (Full control of private repositories)
   //    - Click "Generate token"
   //    - Copy the token (it will only be shown once!)
   //
   // 2. Replace 'your_github_personal_access_token_here' below with your actual token
   //
   // 3. Update the repository name if different from 'DyslexicNerd01/Brute-Haul-Cargo-Log'
   //
   // 4. SECURITY NOTE: For production, consider moving the token to your Railway server
   //    and sending errors there first, then forwarding to GitHub to avoid exposing the token
   //
   // 5. When enabled, the system will automatically create GitHub Issues when:
   //    - Discord sends fail with any error code
   //    - Network/server connection issues occur
   //    - Form validation errors happen
   //    - Server restart/maintenance errors occur
   //
   // Each issue will include detailed error information, user context, 
   // form data (anonymized), and technical debugging details.
   // ========================================

   // Announcement notification badge configuration
   // Set to true to show the "1" badge on the Announcements tab
   // Set to false to hide the badge completely
   let showAnnouncementBadge = true;

   // Function to toggle the announcement badge
   function toggleAnnouncementBadge(show = null) {
     if (show !== null) {
       showAnnouncementBadge = show;
     } else {
       showAnnouncementBadge = !showAnnouncementBadge;
     }
     updateAnnouncementBadgeVisibility();
   }

   // Function to update badge visibility
   function updateAnnouncementBadgeVisibility() {
     const announcementsBtn = document.getElementById('announcementsTabBtn');
     if (announcementsBtn) {
       if (showAnnouncementBadge) {
         announcementsBtn.classList.remove('badge-hidden');
       } else {
         announcementsBtn.classList.add('badge-hidden');
       }
     }
   }

   // Make toggle function globally available
   window.toggleAnnouncementBadge = toggleAnnouncementBadge;

    // Ship lists for each category
    const transportShips = [
      "SPRT Icarus", "BRHS Lednik", "BRHS Trireme", "WINC Caterpillar", "WINC Rafto"    
    ];
    const securityShips = [
      "AACS Landsknecht", "AACS Feder", "BRHS Seastorm", "BRHS Sword Of Twilight", "AACS Dendrobium", "AACS Judgement’s Bow"
    ];
    const allShips = [
      ...transportShips,
      ...securityShips,
    ];

    // Captain names list
    const captainNames = [
      "DyslexicNerd", "Spartan", "Lightblade", "jjetstreamm", "Roflnomish", 
      "BenjiNotorious", "zarainia", "Astol", "Venomnom", "BigDaddyTortuga", 
      "ItzProto", "Newt", "Xolion", "Bakes Kamuari", "LockEmUpJas", 
      "sadfish", "Efazer"
    ];

    // Manifest material list (customize as needed)
    const materialList = [
      "Select Material", "Agricium", "Aluminium", "Aphorite", "Beryl", "Bexalite", "Borase", "Copper", "Corundum", "Diamond", "Dolivine", "Dyslexium", "Gold", "Hadanite", "Hephaestanite", "Inert materials", "Laranite", "Placeholder", "Spartanium", "Quantanium", "Quartz", "Taranite", "Tungsten", "Titanium"
    ];

    function clearFormFields() {
  // Clear timestamps
  document.getElementById("departureTime").value = "";
  document.getElementById("completionTime").value = "";
  document.getElementById("orderDuration").textContent = "";

  // Reset manifest to one empty line
  manifestLineCount = 1;
  renderManifestLines();
  // Clear values in the first manifest line
  const firstManifestRow = document.querySelector('.manifest-row');
  if (firstManifestRow) {
    firstManifestRow.querySelector('.manifest-scu').value = "";
    firstManifestRow.querySelector('.manifest-material').selectedIndex = 0;
    firstManifestRow.querySelector('.manifest-uec').value = "";
  }

  // Reset total SCU display
  document.getElementById("totalSCUBox").textContent = "Total SCU: 0";

  // Clear deductibles
  document.getElementById("repairs").value = "0";
  document.getElementById("restock").value = "0";
  document.getElementById("quantumFuel").value = "0";
  document.getElementById("hydrogenFuel").value = "0";
  document.getElementById("crewCosts").value = "0";
  document.getElementById("totalUECBox").value = "";

  // Clear route
  document.getElementById("routeStart").value = "";
  document.getElementById("routeEnd").value = "";

  // Clear start location
  document.getElementById("startLocation").value = "";

  // Clear ship name and captain name
  document.getElementById("shipName").value = "";
  document.getElementById("captainName").value = "";

  // Clear notes
  document.getElementById("notes").value = "";
  
  // Hide Discord section and copy button
  document.getElementById("discordSection").style.display = "none";
  hideCopyButton();
  
  // Reset progress bar
  calculateFormProgress();
}

function showTab(tab) {
  document.getElementById('formTab').style.display = tab === 'formTab' ? 'block' : 'none';
  document.getElementById('historyTab').style.display = tab === 'historyTab' ? 'block' : 'none';
  document.getElementById('announcementsTab').style.display = tab === 'announcementsTab' ? 'block' : 'none';

  // Hide notification badge when announcements tab is clicked (if badge is enabled)
  if (tab === 'announcementsTab' && showAnnouncementBadge) {
    const announcementsBtn = document.getElementById('announcementsTabBtn');
    if (announcementsBtn) {
      announcementsBtn.classList.add('badge-hidden');
    }
  }

  // Tab highlighting
  document.getElementById('formTabBtn').style.background = tab === 'formTab' ? '#9d7523' : '#781d15';
  document.getElementById('historyTabBtn').style.background = tab === 'historyTab' ? '#9d7523' : '#781d15';
  document.getElementById('announcementsTabBtn').style.background = tab === 'announcementsTab' ? '#9d7523' : '#781d15';

  document.getElementById('formTabBtn').style.color = '#fff';
  document.getElementById('historyTabBtn').style.color = '#fff';
  document.getElementById('announcementsTabBtn').style.color = '#fff';

  // Black outline for selected tab
  document.getElementById('formTabBtn').style.border = tab === 'formTab' ? '3px solid #000' : '3px solid transparent';
  document.getElementById('historyTabBtn').style.border = tab === 'historyTab' ? '3px solid #000' : '3px solid transparent';
  document.getElementById('announcementsTabBtn').style.border = tab === 'announcementsTab' ? '3px solid #000' : '3px solid transparent';
}
window.showTab = showTab;

window.addEventListener("DOMContentLoaded", function() {
  showTab('formTab');
  renderHistory();
  // Initialize announcement badge visibility
  updateAnnouncementBadgeVisibility();
  // Ensure totalUECBox starts blank on first load
  const totalUECInput = document.getElementById("totalUECBox");
  if (totalUECInput) totalUECInput.value = "";
});

    function populateLocationDropdown(id) {
      const inputId = id;
      const listId = id + 'List';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let selectedValue = '';
      let filteredLocations = locations;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterLocations(searchTerm) {
        const term = searchTerm.toLowerCase();
        return locations.filter(location => 
          location.toLowerCase().includes(term)
        ); // Show all matching results
      }

      function renderDropdownItems(locationsToShow) {
        list.innerHTML = '';
        locationsToShow.forEach(location => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = location;
          item.addEventListener('click', () => {
            input.value = location;
            selectedValue = location;
            hideDropdown();
            input.classList.remove('error');
          });
          list.appendChild(item);
        });
      }

      // Initialize with all locations
      renderDropdownItems(locations);

      // Handle input events
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredLocations = locations; // Show all locations when no search term
        } else {
          filteredLocations = filterLocations(searchTerm);
        }
        renderDropdownItems(filteredLocations);
        showDropdown();
        selectedValue = '';
      });

      input.addEventListener('focus', () => {
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      // Handle keyboard navigation
      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      // Custom validation function
      input.validateValue = function() {
        return locations.includes(input.value);
      };
    }

    // Close all dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.searchable-dropdown')) {
        document.querySelectorAll('.dropdown-list').forEach(list => {
          list.classList.remove('show');
        });
      }
    });

    function populateShipDropdown(category) {
      const inputId = 'shipName';
      const listId = 'shipNameList';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let ships = [];
      if (category === "Transport") {
        ships = transportShips;
      } else if (category === "Security") {
        ships = securityShips;
      } else {
        ships = allShips;
      }

      // Add "Other" option to the ships list
      const shipsWithOther = [...ships, "Other"];

      let selectedValue = '';
      let filteredShips = shipsWithOther;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterShips(searchTerm) {
        const term = searchTerm.toLowerCase();
        return shipsWithOther.filter(ship => 
          ship.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(shipsToShow) {
        list.innerHTML = '';
        shipsToShow.forEach(ship => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = ship;
          item.addEventListener('click', () => {
            input.value = ship;
            selectedValue = ship;
            hideDropdown();
            input.classList.remove('error');
            toggleShipNameOther();
          });
          list.appendChild(item);
        });
      }

      // Initialize with ships for category
      renderDropdownItems(shipsWithOther);

      // Remove existing event listeners
      input.removeEventListener('input', input._shipInputHandler);
      input.removeEventListener('focus', input._shipFocusHandler);
      input.removeEventListener('blur', input._shipBlurHandler);
      input.removeEventListener('keydown', input._shipKeydownHandler);

      // Handle input events
      input._shipInputHandler = (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredShips = shipsWithOther;
        } else {
          filteredShips = filterShips(searchTerm);
        }
        renderDropdownItems(filteredShips);
        showDropdown();
        selectedValue = '';
      };
      input.addEventListener('input', input._shipInputHandler);

      input._shipFocusHandler = () => {
        showDropdown();
      };
      input.addEventListener('focus', input._shipFocusHandler);

      input._shipBlurHandler = () => {
        hideDropdown();
      };
      input.addEventListener('blur', input._shipBlurHandler);

      // Handle keyboard navigation
      input._shipKeydownHandler = (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            toggleShipNameOther();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      };
      input.addEventListener('keydown', input._shipKeydownHandler);

      // Custom validation function
      input.validateValue = function() {
        return shipsWithOther.includes(input.value);
      };
    }

    function populateCaptainDropdown() {
      const inputId = 'captainName';
      const listId = 'captainNameList';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      // Add "Other" option to the captains list
      const captainsWithOther = [...captainNames, "Other"];

      let selectedValue = '';
      let filteredCaptains = captainsWithOther;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterCaptains(searchTerm) {
        const term = searchTerm.toLowerCase();
        return captainsWithOther.filter(captain => 
          captain.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(captainsToShow) {
        list.innerHTML = '';
        captainsToShow.forEach(captain => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = captain;
          item.addEventListener('click', () => {
            input.value = captain;
            selectedValue = captain;
            hideDropdown();
            input.classList.remove('error');
            toggleCaptainNameOther();
          });
          list.appendChild(item);
        });
      }

      // Initialize with all captains
      renderDropdownItems(captainsWithOther);

      // Handle input events
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredCaptains = captainsWithOther;
        } else {
          filteredCaptains = filterCaptains(searchTerm);
        }
        renderDropdownItems(filteredCaptains);
        showDropdown();
        selectedValue = '';
      });

      input.addEventListener('focus', () => {
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      // Handle keyboard navigation
      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            toggleCaptainNameOther();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      // Custom validation function
      input.validateValue = function() {
        return captainsWithOther.includes(input.value);
      };
    }

    let manifestLineCount = 1;

    function createManifestLine(index) {
      const isLast = index === manifestLineCount;
      return `
        <div class="manifest-row" id="manifestRow${index}">
          <label>SCU:</label>
          <input type="number" min="0" step="1" class="manifest-scu" id="manifestSCU${index}" style="width:70px;" oninput="updateManifestTotals()">
          <label>Material:</label>
          <select class="manifest-material" id="manifestMaterial${index}" style="width:120px;">
            ${materialList.map(m => `<option value="${m}">${m}</option>`).join("")}
          </select>
          <label>UEC:</label>
          <input type="number" min="0" step="1" class="manifest-uec" id="manifestUEC${index}" style="width:90px;" oninput="updateManifestTotals()">
          <button type="button" onclick="removeManifestLine(${index})" class="manifest-btn remove" title="Remove line">－</button>
          ${isLast ? `<button type="button" onclick="addManifestLine()" class="manifest-btn add" title="Add line">＋</button>` : ""}
        </div>
      `;
    }

    function renderManifestLines() {
      // Save current manifest line values
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }

      // Restore previous values
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
    }
    // Resource Drive manifest presets
    function applyManifestPreset(type) {
      var preset = [];
      var totalUEC = 0;
      if (type === 'large') {
        preset = [
          { scu: 72, material: 'Corundum' },
          { scu: 36, material: 'Tungsten' },
          { scu: 72, material: 'Copper' }
        ];
        totalUEC = 101750;
      } else if (type === 'medium') {
        preset = [
          { scu: 19, material: 'Corundum' },
          { scu: 10, material: 'Tungsten' },
          { scu: 19, material: 'Copper' }
        ];
        totalUEC = 58400;
      } else if (type === 'small') {
        preset = [
          { scu: 2, material: 'Corundum' },
          { scu: 4, material: 'Tungsten' },
          { scu: 2, material: 'Copper' }
        ];
        totalUEC = 53250;
      }
      manifestLineCount = preset.length;
      renderManifestLines();
      // Calculate total SCU
      var totalSCU = preset.reduce(function(sum, item) { return sum + item.scu; }, 0);
      // Distribute UEC by SCU per material
      var rows = document.querySelectorAll('.manifest-row');
      var uecAssigned = 0;
      for (var idx = 0; idx < preset.length; idx++) {
        var row = rows[idx];
        if (row) {
          row.querySelector('.manifest-scu').value = preset[idx].scu;
          row.querySelector('.manifest-material').value = preset[idx].material;
          // Calculate UEC for this line
          var uec = Math.floor((preset[idx].scu / totalSCU) * totalUEC);
          // For last line, assign remainder
          if (idx === preset.length - 1) {
            uec = totalUEC - uecAssigned;
          }
          row.querySelector('.manifest-uec').value = uec;
          uecAssigned += uec;
        }
      }
      // Set total UEC box
      var totalUECInput = document.getElementById('totalUECBox');
      if (totalUECInput) totalUECInput.value = totalUEC;
      updateManifestTotals();
      // Highlight selected preset button
      var largeBtn = document.getElementById('presetLargeBtn');
      var mediumBtn = document.getElementById('presetMediumBtn');
      var smallBtn = document.getElementById('presetSmallBtn');
      if (largeBtn) largeBtn.classList.remove('selected');
      if (mediumBtn) mediumBtn.classList.remove('selected');
      if (smallBtn) smallBtn.classList.remove('selected');
      if (type === 'large' && largeBtn) largeBtn.classList.add('selected');
      if (type === 'medium' && mediumBtn) mediumBtn.classList.add('selected');
      if (type === 'small' && smallBtn) smallBtn.classList.add('selected');
    }

    function addManifestLine() {
      manifestLineCount++;
      renderManifestLines();
      calculateFormProgress(); // Update progress when adding manifest line
    }

    function removeManifestLine(index) {
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });
      manifestData.splice(index - 1, 1);

      manifestLineCount--;
      if (manifestLineCount < 1) manifestLineCount = 1;

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }
      // Restore previous values except the deleted one
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
      calculateFormProgress(); // Update progress when removing manifest line
    }

    function updateManifestTotals() {
  let totalSCU = 0;
  let totalUEC = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scu = parseInt(row.querySelector('.manifest-scu').value, 10);
    const uec = parseInt(row.querySelector('.manifest-uec').value, 10);
    if (!isNaN(scu)) totalSCU += scu;
    if (!isNaN(uec)) totalUEC += uec;
  });

  document.getElementById("totalSCUBox").textContent = `Total SCU: ${totalSCU.toLocaleString()}`;

  // Set totalUECBox to the sum unless the user is editing it
  const totalUECInput = document.getElementById("totalUECBox");
  if (document.activeElement !== totalUECInput) {
    totalUECInput.value = totalUEC > 0 ? totalUEC : "";
  }
}

    window.toggleOrderTypeOther = toggleOrderTypeOther;
    window.toggleCompanyNameOther = toggleCompanyNameOther;
    window.toggleOrderCategoryOther = toggleOrderCategoryOther;
    window.toggleShipNameOther = toggleShipNameOther;
    window.toggleCaptainNameOther = toggleCaptainNameOther;
    window.generateCrewInputs = generateCrewInputs;
    window.addManifestLine = addManifestLine;
    window.removeManifestLine = removeManifestLine;
    window.updateManifestTotals = updateManifestTotals;
    window.generateOutput = generateOutput;
    window.copyDiscordOutput = copyDiscordOutput;
    window.showCopyButton = showCopyButton;
    window.hideCopyButton = hideCopyButton;
    window.clearFormFields = clearFormFields;

    // Make applyManifestPreset available globally
window.applyManifestPreset = applyManifestPreset;

    window.addEventListener("DOMContentLoaded", function() {
      populateLocationDropdown("startLocation");
      populateLocationDropdown("routeStart");
      populateLocationDropdown("routeEnd");
      populateShipDropdown(""); // Show all ships initially
      populateCaptainDropdown(); // Initialize captain dropdown
      document.getElementById("discordSection").style.display = "none";
      manifestLineCount = 1;
      renderManifestLines();
      renderHistory();
      
      // Initialize progress tracking
      calculateFormProgress();
      
      // Add event listeners for progress tracking
      const formElements = document.querySelectorAll('input, select, textarea');
      formElements.forEach(element => {
        element.addEventListener('input', calculateFormProgress);
        element.addEventListener('change', calculateFormProgress);
      });
      
      // Add manifest-specific listeners
      const manifestContainer = document.getElementById('manifestLines');
      if (manifestContainer) {
        const observer = new MutationObserver(calculateFormProgress);
        observer.observe(manifestContainer, { childList: true, subtree: true });
      }
    });

    document.getElementById("orderCategory").addEventListener("change", function() {
      toggleOrderCategoryOther();
      populateShipDropdown(this.value);
    });
    document.getElementById("orderType").addEventListener("change", function() {
      toggleOrderTypeOther();
      // Show/hide Resource Drive presets
      const val = this.value;
      const presetsDiv = document.getElementById("resourceDrivePresets");
      if (val === "Resource Drive") {
        presetsDiv.style.display = "block";
      } else {
        presetsDiv.style.display = "none";
      }
    });

    function toDiscordTimestamp(dtString) {
      if (!dtString) return "";
      const date = new Date(dtString);
      if (isNaN(date.getTime())) return "";
      // Add 930 years
      const yearsToAdd = 930;
      date.setFullYear(date.getFullYear() + yearsToAdd);
      const unix = Math.floor(date.getTime() / 1000);
      return `<t:${unix}:f>`;
    }

    const shipLinks = {
      "AACS Feder": "https://discord.com/channels/900478857436606535/1391878505905524817/1393365523407835196",
      "AACS Landsknecht": "https://discord.com/channels/900478857436606535/1391878505905524817/1392713534005186730",
      "WINC Caterpillar": "https://discord.com/channels/900478857436606535/1391878505905524817/1391904347117322322",
      "SPRT Icarus": "https://discord.com/channels/900478857436606535/1391878505905524817/1396265862268190830",
    };

    // Loading States & Progress Indicators
    function showLoadingOverlay(message = "Processing...") {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingOverlay';
      overlay.innerHTML = `
        <div class="loading-content">
          <div class="loading-spinner-large"></div>
          <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${message}</div>
          <div style="font-size: 14px; opacity: 0.8;">Please wait...</div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function showNotificationOverlay(message, type = 'info', duration = 3000) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'notificationOverlay';
      
      let icon = '';
      let bgColor = '#781d15';
      let borderColor = '#9d7523';
      
      switch(type) {
        case 'success':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">✓</div>';
          bgColor = '#43b581';
          borderColor = '#2ea964';
          break;
        case 'error':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">⚠</div>';
          bgColor = '#ed4245';
          borderColor = '#b32428';
          break;
        case 'warning':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">⚠</div>';
          bgColor = '#faa61a';
          borderColor = '#e18d00';
          break;
        default:
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">ℹ</div>';
      }
      
      overlay.innerHTML = `
        <div class="loading-content" style="background: ${bgColor}; border-color: ${borderColor};">
          ${icon}
          <div style="font-size: 16px; font-weight: bold; text-align: center; line-height: 1.4;">${message}</div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      // Auto-hide after duration
      setTimeout(() => {
        const notificationOverlay = document.getElementById('notificationOverlay');
        if (notificationOverlay) {
          notificationOverlay.remove();
        }
      }, duration);
      
      // Allow clicking to dismiss
      overlay.addEventListener('click', () => {
        overlay.remove();
      });
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function showButtonLoading(buttonId, loadingText = null) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.add('button-loading');
        button.disabled = true;
        const originalHTML = button.innerHTML;
        button.setAttribute('data-original-html', originalHTML);
        
        if (loadingText) {
          button.innerHTML = `<div class="loading-spinner"></div>${loadingText}`;
        } else {
          button.innerHTML = `<div class="loading-spinner"></div>Processing...`;
        }
      }
    }

    function hideButtonLoading(buttonId) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.remove('button-loading');
        button.disabled = false;
        const originalHTML = button.getAttribute('data-original-html');
        if (originalHTML) {
          button.innerHTML = originalHTML;
          button.removeAttribute('data-original-html');
        }
      }
    }

    function showFeedback(type, message, duration = 5000) {
      const feedbackElement = type === 'success' ? 
        document.getElementById('successFeedback') : 
        document.getElementById('errorFeedback');
      const messageElement = type === 'success' ? 
        document.getElementById('successMessage') : 
        document.getElementById('errorMessage');
      
      if (feedbackElement && messageElement) {
        messageElement.textContent = message;
        feedbackElement.style.display = 'flex';
        
        setTimeout(() => {
          feedbackElement.style.display = 'none';
        }, duration);
      }
    }

    function calculateFormProgress() {
      const requiredFields = [
        'orderCategory', 'companyName', 'orderType', 'shipName', 'captainName',
        'crewAmount', 'startLocation', 'departureTime', 'routeStart', 'routeEnd',
        'completionTime'
      ];
      
      let filledFields = 0;
      let totalFields = requiredFields.length;
      
      // Check main fields
      for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        let isFieldValid = false;
        
        if (field) {
          // Special validation for location fields
          if (fieldId === 'startLocation' || fieldId === 'routeStart' || fieldId === 'routeEnd') {
            isFieldValid = field.value && field.value.trim() !== '' && locations.includes(field.value);
          } 
          // Special validation for ship name field
          else if (fieldId === 'shipName') {
            isFieldValid = field.value && field.value.trim() !== '' && (allShips.includes(field.value) || field.value === 'Other');
          }
          // Special validation for captain name field
          else if (fieldId === 'captainName') {
            isFieldValid = field.value && field.value.trim() !== '' && (captainNames.includes(field.value) || field.value === 'Other');
          }
          else {
            isFieldValid = field.value && field.value.trim() !== '';
          }
          
          if (isFieldValid) {
            filledFields++;
          }
        }
      }
      
      // Check "Other" fields if applicable
      const otherFieldChecks = [
        { select: 'orderCategory', other: 'orderCategoryOther' },
        { select: 'companyName', other: 'companyNameOther' },
        { select: 'orderType', other: 'orderTypeOther' },
        { select: 'shipName', other: 'shipNameOther' },
        { select: 'captainName', other: 'captainNameOther' }
      ];
      
      for (const check of otherFieldChecks) {
        const selectField = document.getElementById(check.select);
        const otherField = document.getElementById(check.other);
        const otherDiv = document.getElementById(check.other + 'Div');
        
        if (selectField && selectField.value === 'Other' && otherDiv && otherDiv.style.display !== 'none') {
          totalFields++; // Add the "other" field to total count
          if (otherField && otherField.value && otherField.value.trim() !== '') {
            filledFields++;
          }
        }
      }
      
      // Check crew names
      const crewAmount = parseInt(document.getElementById('crewAmount')?.value || '0', 10);
      if (crewAmount > 0) {
        totalFields += crewAmount;
        for (let i = 1; i <= crewAmount; i++) {
          const crewField = document.getElementById(`crewName${i}`);
          if (crewField && crewField.value && crewField.value.trim() !== '') {
            filledFields++;
          }
        }
      }
      
      // Check manifest (at least one line with material)
      const manifestRows = document.querySelectorAll('.manifest-row');
      let hasValidManifest = false;
      manifestRows.forEach(row => {
        const material = row.querySelector('.manifest-material');
        if (material && material.value && material.value.trim() !== '' && material.value !== 'Select Material') {
          hasValidManifest = true;
        }
      });
      
      if (hasValidManifest) {
        filledFields++;
      }
      totalFields++; // Add manifest to total count
      
      const percentage = Math.round((filledFields / totalFields) * 100);
      
      // Update progress bar
      const progressFill = document.getElementById('formProgressFill');
      const progressText = document.getElementById('formProgressText');
      
      if (progressFill) {
        progressFill.style.width = `${percentage}%`;
      }
      
      if (progressText) {
        progressText.textContent = `Form Completion: ${percentage}%`;
      }
      
      // Update form step states
      updateFormStepStates();
      
      return percentage;
    }

    function updateFormStepStates() {
      const steps = [
        {
          id: 'basicInfoStep',
          fields: ['orderCategory', 'companyName', 'orderType', 'shipName', 'captainName', 'crewAmount']
        },
        {
          id: 'locationTimeStep',
          fields: ['startLocation', 'departureTime', 'routeStart', 'routeEnd']
        },
        {
          id: 'manifestStep',
          fields: [] // Special handling below
        },
        {
          id: 'completionStep',
          fields: ['completionTime']
        }
      ];
      
      steps.forEach(step => {
        const stepElement = document.getElementById(step.id);
        if (!stepElement) return;
        
        let completedFields = 0;
        let totalStepFields = step.fields.length;
        
        // Handle manifest step separately
        if (step.id === 'manifestStep') {
          const manifestRows = document.querySelectorAll('.manifest-row');
          let hasValidManifest = false;
          manifestRows.forEach(row => {
            const material = row.querySelector('.manifest-material');
            if (material && material.value && material.value.trim() !== '' && material.value !== 'Select Material') {
              hasValidManifest = true;
            }
          });
          completedFields = hasValidManifest ? 1 : 0;
          totalStepFields = 1;
        } else {
          // Handle regular fields
          for (const fieldId of step.fields) {
            const field = document.getElementById(fieldId);
            let isFieldValid = false;
            
            if (field) {
              // Special validation for location fields
              if (fieldId === 'startLocation' || fieldId === 'routeStart' || fieldId === 'routeEnd') {
                isFieldValid = field.value && field.value.trim() !== '' && locations.includes(field.value);
              } else {
                isFieldValid = field.value && field.value.trim() !== '';
              }
              
              if (isFieldValid) {
                completedFields++;
              }
            }
          }
          
          // Add crew names to basic info step
          if (step.id === 'basicInfoStep') {
            const crewAmount = parseInt(document.getElementById('crewAmount')?.value || '0', 10);
            if (crewAmount > 0) {
              totalStepFields += crewAmount;
              for (let i = 1; i <= crewAmount; i++) {
                const crewField = document.getElementById(`crewName${i}`);
                if (crewField && crewField.value && crewField.value.trim() !== '') {
                  completedFields++;
                }
              }
            }
            
            // Add "Other" fields if visible
            const otherFieldChecks = [
              { select: 'orderCategory', other: 'orderCategoryOther' },
              { select: 'companyName', other: 'companyNameOther' },
              { select: 'orderType', other: 'orderTypeOther' },
              { select: 'shipName', other: 'shipNameOther' },
              { select: 'captainName', other: 'captainNameOther' }
            ];
            
            for (const check of otherFieldChecks) {
              const selectField = document.getElementById(check.select);
              const otherField = document.getElementById(check.other);
              const otherDiv = document.getElementById(check.other + 'Div');
              
              if (selectField && selectField.value === 'Other' && otherDiv && otherDiv.style.display !== 'none') {
                totalStepFields++;
                if (otherField && otherField.value && otherField.value.trim() !== '') {
                  completedFields++;
                }
              }
            }
          }
        }
        
        // Update step classes
        stepElement.classList.remove('active', 'completed');
        if (completedFields === totalStepFields && completedFields > 0) {
          stepElement.classList.add('completed');
        } else if (completedFields > 0) {
          stepElement.classList.add('active');
        }
      });
    }

    function toggleOrderCategoryOther() {
      const val = document.getElementById("orderCategory").value;
      const otherDiv = document.getElementById("orderCategoryOtherDiv");
      if (val === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderCategoryOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("orderCategoryOther").required = false;
      }
    }

    function toggleCompanyNameOther() {
      const companyName = document.getElementById("companyName").value;
      const otherDiv = document.getElementById("companyNameOtherDiv");
      if (companyName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("companyNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("companyNameOther").required = false;
      }
    }

    function toggleOrderTypeOther() {
      const orderType = document.getElementById("orderType").value;
      const otherDiv = document.getElementById("orderTypeOtherDiv");
      const resourceDriveDiv = document.getElementById("resourceDriveCompanyDiv");
      if (orderType === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderTypeOther").required = true;
        resourceDriveDiv.style.display = "none";
        document.getElementById("resourceDriveCompany").required = false;
      } else if (orderType === "Resource Drive") {
        resourceDriveDiv.style.display = "block";
        document.getElementById("resourceDriveCompany").required = true;
        otherDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
      } else {
        otherDiv.style.display = "none";
        resourceDriveDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
        document.getElementById("resourceDriveCompany").required = false;
      }
    }

    function toggleShipNameOther() {
      const shipName = document.getElementById("shipName").value;
      const otherDiv = document.getElementById("shipNameOtherDiv");
      if (shipName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("shipNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("shipNameOther").required = false;
      }
    }

    function toggleCaptainNameOther() {
      const captainName = document.getElementById("captainName").value;
      const otherDiv = document.getElementById("captainNameOtherDiv");
      if (captainName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("captainNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("captainNameOther").required = false;
      }
    }

    function generateCrewInputs() {
      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      const crewNamesDiv = document.getElementById("crewNamesDiv");
      crewNamesDiv.innerHTML = "";
      if (!isNaN(crewAmount) && crewAmount > 0) {
        for (let i = 1; i <= crewAmount; i++) {
          const label = document.createElement("label");
          label.textContent = `Crew ${i} Name:`;
          label.htmlFor = `crewName${i}`;
          label.className = "crew-label";
          const input = document.createElement("input");
          input.type = "text";
          input.id = `crewName${i}`;
          input.name = `crewName${i}`;
          input.required = true;
          input.className = "crew-input";
          // Add event listener for progress tracking
          input.addEventListener('input', calculateFormProgress);
          input.addEventListener('change', calculateFormProgress);
          crewNamesDiv.appendChild(label);
          crewNamesDiv.appendChild(input);
        }
      }
      calculateFormProgress(); // Update progress when crew inputs change
    }

    function validateRequiredFields() {
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      // Add event listeners to required fields to remove error class on input/change
      const requiredFields = [
        "orderCategory",
        "companyName",
        "orderType",
        "shipName",
        "captainName",
        "crewAmount",
        "startLocation",
        "departureTime",
        "routeStart",
        "routeEnd",
        "completionTime",
        "repairs",
        "restock",
        "quantumFuel",
        "hydrogenFuel",
        "crewCosts",
        "totalUECBox"
      ];
      requiredFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => el.classList.remove('error'));
      el.addEventListener('change', () => el.classList.remove('error'));
    }
  });

  // Also handle manifest and crew fields
  document.querySelectorAll('.manifest-scu, .manifest-material, .crew-input').forEach(el => {
    el.addEventListener('input', () => el.classList.remove('error'));
    el.addEventListener('change', () => el.classList.remove('error'));
  });

  let firstError = null;
  for (const id of requiredFields) {
    const el = document.getElementById(id);
    let isValid = false;
    
    if (!el) continue;
    
    // Special validation for location fields
    if (id === 'startLocation' || id === 'routeStart' || id === 'routeEnd') {
      isValid = el.value.trim() !== "" && locations.includes(el.value);
    } else {
      isValid = el.value !== "" && el.value !== null;
    }
    
    if (!isValid) {
      if (el) el.classList.add('error');
      if (!firstError && el) firstError = el;
    }
  }

      const otherFields = [
        {select: "orderCategory", other: "orderCategoryOtherDiv", input: "orderCategoryOther"},
        {select: "companyName", other: "companyNameOtherDiv", input: "companyNameOther"},
        {select: "orderType", other: "orderTypeOtherDiv", input: "orderTypeOther"},
        {select: "shipName", other: "shipNameOtherDiv", input: "shipNameOther"},
        {select: "captainName", other: "captainNameOtherDiv", input: "captainNameOther"}
      ];
      for (const field of otherFields) {
        const selectEl = document.getElementById(field.select);
        const otherDiv = document.getElementById(field.other);
        const otherInput = document.getElementById(field.input);
        if (selectEl && selectEl.value === "Other" && otherDiv.style.display === "block") {
          if (!otherInput.value.trim()) {
            otherInput.classList.add('error');
            if (!firstError) firstError = otherInput;
          }
        }
      }

      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      for (let i = 1; i <= crewAmount; i++) {
        const crewInput = document.getElementById(`crewName${i}`);
        if (!crewInput || !crewInput.value.trim()) {
          if (crewInput) crewInput.classList.add('error');
          if (!firstError && crewInput) firstError = crewInput;
        }
      }

       // Validate manifest lines (UEC and material now required)
  const manifestRows = document.querySelectorAll('.manifest-row');
  if (manifestRows.length === 0) {
    showNotificationOverlay("Please add at least one manifest line.<br><br>Do not report repositioning flights.", 'error', 4000);
    return false;
  }
  for (const row of manifestRows) {
    const scu = row.querySelector('.manifest-scu');
    const mat = row.querySelector('.manifest-material');
    // UEC is NOT required
    if (!scu.value || !mat.value) {
      scu.classList.add('error');
      mat.classList.add('error');
      if (!firstError) firstError = scu;
    }
  }

  if (firstError) {
    firstError.scrollIntoView({behavior: "smooth", block: "center"});
    showNotificationOverlay("Please fill out all required fields!<br><br>Unanswered questions are highlighted in red.", 'error', 4000);
    return false;
  }
  return true;
}

    function copyDiscordOutput() {
      const discordOutput = document.getElementById("discordOutput");
      discordOutput.select();
      discordOutput.setSelectionRange(0, 99999);
      document.execCommand("copy");
      showNotificationOverlay("Discord post copied to clipboard!", 'success', 2000);
    }

    function showCopyButton() {
      const copyBtn = document.getElementById("copyDiscordBtn");
      if (copyBtn) {
        copyBtn.style.display = "inline-flex";
      }
    }

    function hideCopyButton() {
      const copyBtn = document.getElementById("copyDiscordBtn");
      if (copyBtn) {
        copyBtn.style.display = "none";
      }
    }

    function updateOrderDuration() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      const durationDiv = document.getElementById("orderDuration");
      if (!dep || !comp) {
        durationDiv.textContent = "";
        return;
      }
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) {
        durationDiv.textContent = "";
        return;
      }
      let diffMs = compDate - depDate;
      if (diffMs < 0) {
        durationDiv.textContent = "Completion time is before departure!";
        return;
      }
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      durationDiv.textContent = `Order Duration: ${hours}h ${mins}m`;
    }

    function getOrderDurationText() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      if (!dep || !comp) return "";
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) return "";
      let diffMs = compDate - depDate;
      if (diffMs < 0) return "";
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      return `Order Duration: ${hours}h ${mins}m`;
    }

    function generateOutput() {
  if (!validateRequiredFields()) return;

  // Show loading state
  showButtonLoading('generateBtn', 'Generating...');
  showLoadingOverlay('Generating Discord post...');

  // Simulate processing time for better UX
  setTimeout(() => {
    try {
      const get = id => document.getElementById(id)?.value?.trim() || "";
      const departureDiscord = toDiscordTimestamp(get("departureTime"));
      const completionDiscord = toDiscordTimestamp(get("completionTime"));

  let orderCategoryText = get("orderCategory");
  if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");

  let companyNameText = get("companyName");
  if (companyNameText === "Other") companyNameText = get("companyNameOther");

  let orderTypeText = get("orderType");
  if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");

  let resourceDriveCompanyText = "";
  if (orderTypeText === "Resource Drive") {
    resourceDriveCompanyText = document.getElementById("resourceDriveCompany").value || "";
  }

  let shipNameText = get("shipName");
  if (shipNameText === "Other") shipNameText = get("shipNameOther");

  let captainNameText = get("captainName");
  if (captainNameText === "Other") captainNameText = get("captainNameOther");

  const shipLink = shipLinks[shipNameText] || "#";

  const crewAmount = parseInt(get("crewAmount"), 10);
  let crewNamesList = [];
  for (let i = 1; i <= crewAmount; i++) {
    const crewInput = document.getElementById(`crewName${i}`);
    if (crewInput && crewInput.value.trim()) {
      crewNamesList.push(crewInput.value.trim());
    }
  }
  let postCounter = parseInt(sessionStorage.getItem('discordHistoryCounter') || '1', 10);
  const crewNamesText = crewNamesList.length > 0 ? crewNamesList.join(", ") : "0";

  const routeStart = get("routeStart");
  const routeEnd = get("routeEnd");
  const routeText = routeStart && routeEnd ? `${routeStart} :arrow_right: ${routeEnd}` : "";

  // Gather manifest lines and totals
  let manifestLines = [];
  let totalSCU = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scuValue = row.querySelector('.manifest-scu').value;
    const scu = parseInt(scuValue, 10);
    const mat = row.querySelector('.manifest-material').value;
    const uecValue = row.querySelector('.manifest-uec').value;
    if (!isNaN(scu)) totalSCU += scu;
    manifestLines.push({
      scu: scuValue,
      mat: mat,
      uec: uecValue
    });
  });

  // Validate SCU before generating post
  if (totalSCU <= 0) {
    hideLoadingOverlay();
    hideButtonLoading('generateBtn');
    // Reset button text manually
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
      generateBtn.innerHTML = 'Generate Post';
    }
    showNotificationOverlay(`❌ Manifest Validation Error<br><br><strong>Total SCU is 0</strong><br><br>Please add cargo to your manifest before generating the Discord post.`, 'error', 6000);
    showFeedback('error', 'Cannot generate post: Total SCU is 0. Please add cargo to your manifest.');
    return;
  }

  // Format manifest table
  let manifestTable = "SCU   Material         UEC\n";
  manifestLines.forEach(line => {
    manifestTable += `${line.scu.padEnd(5)} ${line.mat.padEnd(15)} ${line.uec ? line.uec : ""}\n`;
  });

  // Get total UEC from the box (manual or auto)
  const totalUECInput = document.getElementById("totalUECBox");
  let totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) : 0;

  // Format total line
  let totalLine = `**Total: ${totalSCU.toLocaleString()} SCU`;
  if (totalUEC && !isNaN(totalUEC)) {
    totalLine += ` / ${totalUEC.toLocaleString()} UEC`;
  }
  totalLine += "**";
  // Format total SCU
  const totalSCUText = `**Total: ${totalSCU.toLocaleString()} SCU**`;

  // Deductibles
  const repairs = parseInt(get("repairs") || "0", 10);
  const restock = parseInt(get("restock") || "0", 10);
  const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
  const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
  const crewCosts = parseInt(get("crewCosts") || "0", 10);
  const totalDeductibles = repairs + restock + quantumFuel + hydrogenFuel + crewCosts;

  // Notes
  const notesText = get("notes");

  // Build Discord output
    let output = `**${orderCategoryText}**
${companyNameText} ${orderTypeText === "Resource Drive" ? "Resource Drive" : orderTypeText}
${resourceDriveCompanyText ? `Resource Drive Company: ${resourceDriveCompanyText}` : ""}

**Ship:** [${shipNameText}](${shipLink})
**Captain:** ${captainNameText}
**Crew:** ${crewNamesText}

———

 **Departure:** ${get("startLocation")}
 **Departure Time:** ${departureDiscord}
 **Route:** ${routeText}

———

**Manifest**
\`\`\`
${manifestTable.trim()}
\`\`\`
${totalLine}

———

**Sign Off**
Order completion time: ${completionDiscord}
${getOrderDurationText()}

**Deductibles**
- **Repairs:** ${repairs.toLocaleString()} UEC
- **Restock:** ${restock.toLocaleString()} UEC
- **Quantum fuel:** ${quantumFuel.toLocaleString()} UEC
- **Hydrogen fuel:** ${hydrogenFuel.toLocaleString()} UEC
- **Crew/ship costs:** ${crewCosts.toLocaleString()} UEC
**Total Deductibles: ${totalDeductibles.toLocaleString()} UEC**

———

**Notes**
\`\`\`
${notesText}
\`\`\`
`;

  // Store in session history (as string)
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  history.push({ id: postCounter, content: output });
  sessionStorage.setItem('discordHistory', JSON.stringify(history));
  sessionStorage.setItem('discordHistoryCounter', (postCounter + 1).toString());
  renderHistory();

  document.getElementById("discordOutput").value = output;
  document.getElementById("discordSection").style.display = "block";
  
  // Hide the copy button since we're generating a new post
  hideCopyButton();
  
  // Hide loading states and show success
  hideLoadingOverlay();
  hideButtonLoading('generateBtn');
  showFeedback('success', 'Discord post generated successfully!');
  
    } catch (error) {
      console.error('Error generating output:', error);
      hideLoadingOverlay();
      hideButtonLoading('generateBtn');
      showFeedback('error', 'Failed to generate Discord post. Please try again.');
    }
  }, 500); // Small delay for better UX
}

function renderHistory() {
  const historyList = document.getElementById('historyList');
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  if (history.length === 0) {
    historyList.innerHTML = `
      <div style="text-align:center;">
        <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo" style="max-width:200px;width:100%;margin-bottom:16px;border-radius:8px;">
        <h2 style="color:#9d7523;">Brute Haul Manifest Log</h2>
        <strong><em>No posts generated this session.</em></strong>
      </div>
    `;
    return;
  }
  historyList.innerHTML = history.map((post, idx) => `
    <div style="margin-bottom:18px;padding:10px;border-bottom:1px solid #9d7523;">
      <strong>Post #${post.id}</strong>
      <textarea readonly style="width:100%;height:120px;">${post.content}</textarea>
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button type="button" onclick="copyHistoryPost(${idx})" style="padding:2px 6px;font-size:0.85em;min-width:28px;">Copy</button>
        <button type="button" onclick="deleteHistoryPost(${idx})" style="background:#ed4245;padding:2px 6px;font-size:0.85em;min-width:28px;">🗑️</button>
      </div>
    </div>
  `).join('');
}

function deleteHistoryPost(idx) {
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  history.splice(idx, 1);
  sessionStorage.setItem('discordHistory', JSON.stringify(history));
  renderHistory();
}

function copyHistoryPost(idx) {
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  if (history[idx]) {
    const temp = document.createElement('textarea');
    temp.value = history[idx].content; // Use only the discord output string
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    showNotificationOverlay("History post copied to clipboard!", 'success', 2000);
  }
}

window.deleteHistoryPost = deleteHistoryPost;
window.copyHistoryPost = copyHistoryPost;

window.sendToDiscord = sendToDiscord;

async function sendToDiscord() {
  const message = document.getElementById("discordOutput").value;
  const orderType = document.getElementById("orderType").value;
  const resourceDriveCompany = document.getElementById("resourceDriveCompany").value;
  const totalSCU = parseInt(document.getElementById("totalSCUBox").textContent.replace(/\D/g, "")) || 0;
  const captainName = document.getElementById("captainName").value;
  let shipName = document.getElementById("shipName").value;
  if (shipName === "Other") {
    shipName = document.getElementById("shipNameOther").value;
  }

  // Error: No message generated
  if (!message) {
    showFeedback('error', 'No message to send. Please generate a Discord post first.');
    // Log validation error
    logErrorToGitHub('V004', 'No message generated', 'User attempted to send without generating Discord post first', null, {
      validationStep: 'Message check',
      formCompleted: false
    });
    return;
  }

  // Error: Required fields missing
  if (!orderType || !captainName) {
    showFeedback('error', 'Order Type and Captain Name are required to send to Discord.');
    // Log validation error
    logErrorToGitHub('V005', 'Required fields missing', `Missing fields - Order Type: ${orderType ? 'Present' : 'Missing'}, Captain Name: ${captainName ? 'Present' : 'Missing'}`, null, {
      validationStep: 'Required fields check',
      missingFields: [
        !orderType ? 'Order Type' : null,
        !captainName ? 'Captain Name' : null
      ].filter(Boolean)
    });
    return;
  }

  // Show loading states
  const sendBtn = Array.from(document.querySelectorAll("button"))
    .find(btn => btn.textContent.includes("Send to Discord"));
  
  if (sendBtn) {
    sendBtn.classList.add('button-loading');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<div class="loading-spinner"></div>Sending to Discord...';
  }
  
  showLoadingOverlay('Sending to Brute Haul Discord...');

  try {
    // Collect all additional fields for Google Sheets
    const get = id => document.getElementById(id)?.value?.trim() || "";
    
    let orderCategoryText = get("orderCategory");
    if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");
    
    let companyNameText = get("companyName");
    if (companyNameText === "Other") companyNameText = get("companyNameOther");
    
    let orderTypeText = get("orderType");
    if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");
    
    let captainNameText = get("captainName");
    if (captainNameText === "Other") captainNameText = get("captainNameOther");
    
    const crewAmount = parseInt(get("crewAmount"), 10);
    let crewNamesList = [];
    for (let i = 1; i <= crewAmount; i++) {
      const crewInput = document.getElementById(`crewName${i}`);
      if (crewInput && crewInput.value.trim()) {
        crewNamesList.push(crewInput.value.trim());
      }
    }
    const crewAmountWithNames = crewAmount > 0 ? `${crewAmount} (${crewNamesList.join(", ")})` : "0";
    
    const totalUECInput = document.getElementById("totalUECBox");
    const totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) || 0 : 0;
    
    const repairs = parseInt(get("repairs") || "0", 10);
    const restock = parseInt(get("restock") || "0", 10);
    const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
    const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
    const crewCosts = parseInt(get("crewCosts") || "0", 10);

    
    // Configure endpoints based on environment
    const endpoints = [
      // Railway production endpoint - works for both GitHub Pages and local
      "https://brutehaulrailway-production.up.railway.app/send-discord"
    ];
    
    let response;
    let successfulEndpoint = null;
    let lastError = null;
    
    for (const endpoint of endpoints) {
      try {
        console.log(`Trying endpoint: ${endpoint}`);
        response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            date: new Date().toISOString().split('T')[0], // Current date in YYYY-MM-DD format
            orderCategory: orderCategoryText,
            companyName: companyNameText,
            orderType: orderTypeText,
            shipName: shipName,
            captainName: captainNameText,
            crewAmount: crewAmountWithNames,
            startLocation: get("startLocation"),
            departureTimestamp: get("departureTime"),
            routeStart: get("routeStart"),
            routeEnd: get("routeEnd"),
            totalSCU: totalSCU,
            totalUEC: totalUEC,
            orderCompletionTimestamp: get("completionTime"),
            orderTime: getOrderDurationText(),
            repairs: repairs,
            restock: restock,
            quantumFuel: quantumFuel,
            hydrogenFuel: hydrogenFuel,
            crewShipCosts: crewCosts,
            notes: get("notes"),
            // Legacy fields for Discord functionality
            resourceDriveCompany,
            shipNames: typeof allShips !== "undefined" ? allShips : []
          })
        });
        
        if (response.ok) {
          successfulEndpoint = endpoint;
          console.log(`Success with endpoint: ${endpoint}`);
          break;
        } else {
          lastError = `HTTP ${response.status}: ${response.statusText}`;
          console.log(`HTTP error with ${endpoint}: ${lastError}`);
        }
      } catch (error) {
        lastError = error.message;
        console.log(`Network error with ${endpoint}:`, error.message);
        continue;
      }
    }
    
    if (!response || !response.ok) {
      // Railway should provide stable HTTPS connection
      throw new Error(lastError || "Railway server connection failed - please check server status");
    }

    let data;
    try {
      data = await response.json();
    } catch {
      hideLoadingOverlay();
      showNotificationOverlay("⚠️ Server Restarting<br><br>The Brute Haul System is currently restarting.<br><br><strong>Error E005:</strong> Please try again in 30 seconds.", 'warning', 5000);
      showFeedback('warning', 'Server restarting (E005) - Please try again shortly');
      showCopyButton(); // Show copy button when Discord posting fails
      
      // Log server restart error to GitHub Issues
      logErrorToGitHub('E005', 'Server restarting', 'JSON parsing failed - server likely restarting', null, {
        responseStatus: response?.status || 'Unknown',
        responseOk: response?.ok || false,
        endpoint: successfulEndpoint || 'Unknown endpoint',
        parsingError: true,
        serverState: 'Restarting'
      });
      
      if (sendBtn) {
        sendBtn.classList.remove('button-loading');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />Send to Discord';
      }
      return;
    }

    if (response.ok) {
      hideLoadingOverlay();
      showNotificationOverlay("✅ Successfully sent to Brute Haul Discord!<br><br>Your manifest has been posted and logged.", 'success', 4000);
      showFeedback('success', 'Successfully sent to Brute Haul - Standy by for updated logs');
      // Hide the Discord output section
      document.getElementById("discordSection").style.display = "none";
      // Clear the form fields
      clearFormFields();
    } else {
      hideLoadingOverlay();
      let errorCode = response.status || 'UNKNOWN';
      let errorMsg = data?.error || 'Unknown server error';
      let instructions = 'Please try again or contact DyslexicNerd01';
      
      // Enhanced error code handling
      switch (response.status) {
        case 400:
          errorCode = 'E400';
          errorMsg = 'Invalid request data';
          instructions = 'Please check all form fields are filled correctly and try again.';
          break;
        case 401:
          errorCode = 'E401';
          errorMsg = 'Authentication required';
          instructions = 'Server access denied. Please refresh the page and try again.';
          break;
        case 403:
          errorCode = 'E403';
          errorMsg = 'Access forbidden';
          instructions = 'Server rejected the request. Contact DyslexicNerd01 if this persists.';
          break;
        case 404:
          errorCode = 'E404';
          errorMsg = 'Service not found';
          instructions = 'The Brute Haul service endpoint is not available. Contact DyslexicNerd01.';
          break;
        case 429:
          errorCode = 'E429';
          errorMsg = 'Too many requests';
          instructions = 'You are sending requests too quickly. Please wait 1 minute and try again.';
          break;
        case 500:
          errorCode = 'E500';
          errorMsg = 'Internal server error';
          instructions = 'The Brute Haul server encountered an error. Please try again in a few minutes.';
          break;
        case 502:
          errorCode = 'E502';
          errorMsg = 'Bad gateway';
          instructions = 'Server gateway error. The service may be restarting - try again shortly.';
          break;
        case 503:
          errorCode = 'E503';
          errorMsg = 'Service unavailable';
          instructions = 'The Brute Haul server is temporarily unavailable. Please try again later.';
          break;
        case 504:
          errorCode = 'E504';
          errorMsg = 'Gateway timeout';
          instructions = 'Server took too long to respond. Please try again.';
          break;
        default:
          if (data?.error?.includes('Discord')) {
            if (data.error.includes('webhook')) {
              errorCode = 'D001';
              errorMsg = 'Discord webhook error';
              instructions = 'Discord connection failed. Contact DyslexicNerd01 to check webhook settings.';
            } else if (data.error.includes('rate limit')) {
              errorCode = 'D002';
              errorMsg = 'Discord rate limited';
              instructions = 'Discord is rate limiting requests. Please wait 5 minutes and try again.';
            } else if (data.error.includes('message')) {
              errorCode = 'D003';
              errorMsg = 'Discord message error';
              instructions = 'Your message format was rejected by Discord. Contact DyslexicNerd01.';
            }
          } else if (data?.error?.includes('Google') || data?.error?.includes('Sheets')) {
            if (data.error.includes('credentials') || data.error.includes('authentication')) {
              errorCode = 'G001';
              errorMsg = 'Google Sheets credentials error';
              instructions = 'Server configuration issue. Contact DyslexicNerd01 to fix Google Sheets access.';
            } else if (data.error.includes('permission') || data.error.includes('access')) {
              errorCode = 'G003';
              errorMsg = 'Google Sheets permission denied';
              instructions = 'Server lacks permission to write data. Contact DyslexicNerd01.';
            } else if (data.error.includes('quota') || data.error.includes('limit')) {
              errorCode = 'G004';
              errorMsg = 'Google Sheets quota exceeded';
              instructions = 'Google Sheets API limit reached. Please try again in an hour.';
            } else {
              errorCode = 'G002';
              errorMsg = 'Google Sheets connection failed';
              instructions = 'Unable to save to spreadsheet. Your Discord post was sent but data logging failed.';
            }
          } else if (data?.error?.includes('bot') || data?.error?.includes('token')) {
            if (data.error.includes('token') || data.error.includes('authentication')) {
              errorCode = 'B001';
              errorMsg = 'Discord bot authentication failed';
              instructions = 'Server configuration issue. Contact DyslexicNerd01 to fix bot authentication.';
            } else if (data.error.includes('offline') || data.error.includes('disconnected')) {
              errorCode = 'B002';
              errorMsg = 'Discord bot offline';
              instructions = 'The Discord bot is currently offline. Contact DyslexicNerd01.';
            } else if (data.error.includes('channel') || data.error.includes('not found')) {
              errorCode = 'B003';
              errorMsg = 'Discord channel not found';
              instructions = 'Server cannot find the Discord channel. Contact DyslexicNerd01.';
            } else if (data.error.includes('permission') || data.error.includes('access')) {
              errorCode = 'B004';
              errorMsg = 'Discord bot lacks permissions';
              instructions = 'Bot cannot post to channel. Contact DyslexicNerd01 to fix bot permissions.';
            }
          } else if (data?.error?.includes('validation') || data?.error?.includes('invalid')) {
            if (data.error.includes('manifest') || data.error.includes('format')) {
              errorCode = 'V001';
              errorMsg = 'Invalid manifest data format';
              instructions = 'Your form data format is invalid. Please refresh the page and try again.';
            } else if (data.error.includes('required') || data.error.includes('missing')) {
              errorCode = 'V002';
              errorMsg = 'Server validation failed';
              instructions = 'Server rejected your data. Please check all required fields and try again.';
            } else if (data.error.includes('parse') || data.error.includes('JSON')) {
              errorCode = 'V003';
              errorMsg = 'Data parsing error';
              instructions = 'Server cannot read your form data. Please refresh the page and try again.';
            }
          }
          break;
      }
      
      showNotificationOverlay(`❌ Failed to send to Discord<br><br><strong>Error ${errorCode}:</strong> ${errorMsg}<br><br>${instructions}`, 'error', 8000);
      showFeedback('error', `Error sending to Brute Haul (${errorCode}): ${errorMsg}`);
      showCopyButton(); // Show copy button when Discord posting fails
      
      // Log server errors to GitHub Issues with additional context
      logErrorToGitHub(errorCode, errorMsg, `HTTP ${response.status}: ${data?.error || 'Unknown server error'}`, null, {
        httpStatus: response.status,
        httpStatusText: response.statusText,
        serverResponse: data,
        endpoint: successfulEndpoint || 'No successful endpoint',
        attemptedEndpoints: endpoints.length,
        requestPayload: {
          messageLength: message?.length || 0,
          orderType: orderType,
          captainName: captainName ? 'Present' : 'Missing',
          shipName: shipName ? 'Present' : 'Missing',
          totalSCU: totalSCU
        }
      });
      
      // Show error report link after a brief delay
      setTimeout(showErrorReportLink, 1000);
    }
  } catch (err) {
    hideLoadingOverlay();
    console.error('Send to Discord error:', err);
    
    // Determine error type and code based on error
    let errorCode = 'E701';
    let errorMsg = 'Connection failed';
    let instructions = 'Please try again later or contact DyslexicNerd01';
    
    if (err.message.includes('Railway server connection failed')) {
      errorCode = 'R001';
      errorMsg = 'Railway server connection failed';
      instructions = 'The Brute Haul server may be restarting. Please try again in a few moments.';
    } else if (err.message.includes('fetch') || err.message.includes('Network')) {
      errorCode = 'E703';
      errorMsg = 'Network connection error';
      instructions = 'Check your internet connection and try again.';
    } else if (err.message.includes('CORS')) {
      errorCode = 'E704';
      errorMsg = 'Cross-origin request blocked';
      instructions = 'Browser security blocked the request. Try refreshing the page.';
    } else if (err.message.includes('timeout') || err.message.includes('aborted')) {
      errorCode = 'E408';
      errorMsg = 'Request timeout';
      instructions = 'The server took too long to respond. Please try again.';
    } else if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
      errorCode = 'E702';
      errorMsg = 'Network request blocked';
      instructions = 'Check your firewall/antivirus settings or try a different network.';
    } else if (err.message.includes('SSL') || err.message.includes('certificate')) {
      errorCode = 'S001';
      errorMsg = 'SSL/Certificate error';
      instructions = 'Server SSL certificate issue. Try using HTTP or contact DyslexicNerd01.';
    } else if (err.message.includes('abort') || err.message.includes('cancelled')) {
      errorCode = 'C001';
      errorMsg = 'Request cancelled';
      instructions = 'The request was cancelled. Please try again.';
    } else if (err.message.includes('quota') || err.message.includes('usage limit')) {
      errorCode = 'Q001';
      errorMsg = 'API quota exceeded';
      instructions = 'Service usage limit reached. Please try again in an hour.';
    } else if (err.message.includes('maintenance') || err.message.includes('scheduled')) {
      errorCode = 'M001';
      errorMsg = 'Scheduled maintenance';
      instructions = 'System is under maintenance. Please check Discord for updates.';
    } else if (err.message.includes('memory') || err.message.includes('resource')) {
      errorCode = 'R002';
      errorMsg = 'Server resource limit';
      instructions = 'Server is under high load. Please try again in a few minutes.';
    }
    
    showNotificationOverlay(`❌ Connection Failed<br><br><strong>Error ${errorCode}:</strong> ${errorMsg}<br><br>${instructions}`, 'error', 8000);
    showFeedback('error', `The Brute Haul System is currently offline (${errorCode}). Please try again later.`);
    showCopyButton(); // Show copy button when Discord posting fails
    
    // Log error to GitHub Issues for developer visibility with enhanced context
    logErrorToGitHub(errorCode, errorMsg, err.message, err.stack, {
      errorType: err.name || 'Unknown',
      networkError: true,
      endpointsAttempted: endpoints,
      lastEndpointTried: endpoints[endpoints.length - 1],
      connectionDetails: {
        online: navigator.onLine,
        effectiveType: navigator.connection?.effectiveType || 'Unknown',
        downlink: navigator.connection?.downlink || 'Unknown'
      },
      requestContext: {
        messageLength: message?.length || 0,
        formCompleted: !!(orderType && captainName && message),
        totalSCU: totalSCU,
        hasShipName: !!shipName
      }
    });
    
    // Show error report link after a brief delay
    setTimeout(showErrorReportLink, 1000);
  } finally {
    if (sendBtn) {
      sendBtn.classList.remove('button-loading');
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />Send to Discord';
    }
  }
}
function generateAnnouncement() {
  const title = document.getElementById("announcementTitle").value.trim();
  const body = document.getElementById("announcementBody").value.trim();
  if (!title && !body) {
    showNotificationOverlay("Please enter a title or body for the announcement.", 'warning', 3000);
    return;
  }
  const output = `📢 **${title || "Announcement"}**\n\n${body}`;
  document.getElementById("announcementOutput").value = output;
}

function copyAnnouncementOutput() {
  const output = document.getElementById("announcementOutput");
  output.select();
  output.setSelectionRange(0, 99999);
  document.execCommand("copy");
  showNotificationOverlay("Announcement copied to clipboard!", 'success', 2000);
}

window.generateAnnouncement = generateAnnouncement;
window.copyAnnouncementOutput = copyAnnouncementOutput;

// GitHub Error Logging Function
async function logErrorToGitHub(errorCode, errorMsg, fullError, stackTrace, additionalContext = {}) {
  // Add debug logging to see if function is called
  console.log('🔧 logErrorToGitHub called with:', { errorCode, errorMsg });
  
  try {
    // ========================================
    // 🔧 SECURE TOKEN CONFIGURATION:
    // ========================================
    // Multi-layered approach to securely obtain GitHub token:
    // 1. GitHub Actions injection (production)
    // 2. Local environment variable (development) 
    // 3. Encrypted storage in localStorage (fallback)
    // ========================================
    
    function getGitHubToken() {
      // Method 1: GitHub Actions injected token (production)
      let token = 'ERROR_REPORTER_TOKEN_PLACEHOLDER';
      if (token !== 'ERROR_REPORTER_TOKEN_PLACEHOLDER') {
        return token;
      }
      
      // Method 1.5: For local testing - simulate deployed environment
      if (localStorage.getItem('simulate_deployed_token')) {
        return localStorage.getItem('simulate_deployed_token');
      }
      
      // Method 2: Check for environment-specific token (if available)
      if (typeof process !== 'undefined' && process.env?.ERROR_REPORTER_TOKEN) {
        return process.env.ERROR_REPORTER_TOKEN;
      }
      
      // Method 3: Encrypted localStorage (user must set once)
      const storedToken = localStorage.getItem('github_error_token_encrypted');
      if (storedToken) {
        try {
          // Simple obfuscation - not true encryption but hides token from casual viewing
          return atob(storedToken.split('').reverse().join(''));
        } catch (e) {
          console.warn('Failed to decode stored token');
        }
      }
      
      // Method 4: Prompt user to set token (one-time setup)
      if (confirm('GitHub error logging is not configured. Would you like to set it up now? (This will enable automatic error reporting)')) {
        const userToken = prompt('Enter your GitHub Personal Access Token (this will be stored locally and encrypted):');
        if (userToken && userToken.startsWith('ghp_')) {
          // Simple obfuscation before storing
          const encrypted = btoa(userToken).split('').reverse().join('');
          localStorage.setItem('github_error_token_encrypted', encrypted);
          return userToken;
        }
      }
      
      return null;
    }
    
    const GITHUB_TOKEN = getGitHubToken();
    const GITHUB_REPO = 'DyslexicNerd01/Brute-Haul-Cargo-Log'; // 📁 UPDATE YOUR REPO NAME HERE
    
    console.log('🔧 GitHub token status:', GITHUB_TOKEN ? 'Found' : 'Not found');
    
    if (!GITHUB_TOKEN) {
      console.log('🔧 GitHub error logging not configured - add your GitHub Personal Access Token to enable automatic error reporting');
      return;
    }
    
    console.log('🔧 Proceeding with GitHub issue creation...');
    
    // Collect comprehensive error context
    const errorContext = {
      timestamp: new Date().toISOString(),
      errorCode: errorCode,
      errorMessage: errorMsg,
      fullError: fullError,
      stackTrace: stackTrace,
      userAgent: navigator.userAgent,
      pageUrl: window.location.href,
      viewport: `${window.innerWidth}x${window.innerHeight}`,
      language: navigator.language,
      platform: navigator.platform,
      cookiesEnabled: navigator.cookieEnabled,
      onlineStatus: navigator.onLine,
      referrer: document.referrer || 'Direct access',
      ...additionalContext
    };
    
    // Try to get form data context (if available)
    try {
      const formData = {
        orderType: document.getElementById("orderType")?.value || 'Not set',
        captainName: document.getElementById("captainName")?.value || 'Not set',
        shipName: document.getElementById("shipName")?.value || 'Not set',
        companyName: document.getElementById("companyName")?.value || 'Not set',
        totalSCU: document.getElementById("totalSCUBox")?.textContent || '0',
        messageLength: document.getElementById("discordOutput")?.value?.length || 0
      };
      errorContext.formData = formData;
    } catch (formError) {
      errorContext.formDataError = 'Could not collect form data';
    }
    
    // Create detailed GitHub issue
    const issueData = {
      title: `🚨 Discord Send Failure - ${errorCode}: ${errorMsg}`,
      body: `## 🚨 Automatic Error Report

**Error Code:** \`${errorCode}\`  
**Error Message:** ${errorMsg}  
**Timestamp:** ${errorContext.timestamp}  
**Status:** 🔴 Needs Investigation

---

## 📊 Error Details

| Field | Value |
|-------|-------|
| **Error Code** | \`${errorCode}\` |
| **Error Message** | ${errorMsg} |
| **Page URL** | ${errorContext.pageUrl} |
| **User Agent** | ${errorContext.userAgent} |
| **Viewport** | ${errorContext.viewport} |
| **Language** | ${errorContext.language} |
| **Platform** | ${errorContext.platform} |
| **Online Status** | ${errorContext.onlineStatus ? '✅ Online' : '❌ Offline'} |
| **Cookies Enabled** | ${errorContext.cookiesEnabled ? '✅ Yes' : '❌ No'} |
| **Referrer** | ${errorContext.referrer} |

---

## 🔍 Technical Details

### Full Error Message
\`\`\`
${fullError || 'No additional error details'}
\`\`\`

### Stack Trace
\`\`\`
${stackTrace || 'No stack trace available'}
\`\`\`

---

## 📝 Form Data Context

${errorContext.formData ? `
| Field | Value |
|-------|-------|
| **Order Type** | ${errorContext.formData.orderType} |
| **Captain Name** | ${errorContext.formData.captainName} |
| **Ship Name** | ${errorContext.formData.shipName} |
| **Company Name** | ${errorContext.formData.companyName} |
| **Total SCU** | ${errorContext.formData.totalSCU} |
| **Message Length** | ${errorContext.formData.messageLength} characters |
` : `⚠️ Form data unavailable: ${errorContext.formDataError || 'Unknown reason'}`}

---

## 🎯 User Impact

A user attempted to send a cargo manifest to Discord but encountered this error. The error was displayed to the user with appropriate instructions for resolution.

**User Experience:**
- ❌ Discord send failed
- ✅ Error message displayed to user
- ✅ Copy button provided as fallback
- ✅ Error logged for developer review

---

## 🔧 Next Steps

- [ ] Investigate error cause
- [ ] Implement fix if needed
- [ ] Test resolution
- [ ] Update error handling if necessary

---

## 📊 Related Information

**Error Category:** ${errorCode.startsWith('E') ? 'Network/Server Error' : errorCode.startsWith('D') ? 'Discord API Error' : errorCode.startsWith('G') ? 'Google Sheets Error' : errorCode.startsWith('B') ? 'Bot Error' : errorCode.startsWith('V') ? 'Validation Error' : 'Other'}

**Severity:** ${['E500', 'E503', 'E504', 'R001', 'D001', 'B001', 'B002'].includes(errorCode) ? '🔴 High' : ['E400', 'E401', 'E403', 'E404', 'D002', 'G001', 'G003'].includes(errorCode) ? '🟡 Medium' : '🟢 Low'}

---

*🤖 This issue was automatically created by the Brute Haul Cargo Log error reporting system at ${errorContext.timestamp}*`,
      labels: [
        'bug', 
        'discord-failure', 
        'auto-generated',
        `error-${errorCode.toLowerCase()}`,
        errorCode.startsWith('E') ? 'network-error' : 
        errorCode.startsWith('D') ? 'discord-error' : 
        errorCode.startsWith('G') ? 'sheets-error' : 
        errorCode.startsWith('B') ? 'bot-error' : 
        errorCode.startsWith('V') ? 'validation-error' : 'other-error'
      ]
    };
    
    console.log('Attempting to create GitHub issue for error:', errorCode);
    
    const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues`, {
      method: 'POST',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'User-Agent': 'Brute-Haul-Error-Reporter/1.0'
      },
      body: JSON.stringify(issueData)
    });
    
    if (response.ok) {
      const issueResult = await response.json();
      console.log(`✅ Error logged to GitHub Issues successfully: #${issueResult.number}`);
      console.log(`📋 Issue URL: ${issueResult.html_url}`);
      
      // Optionally store the issue URL for user reference
      sessionStorage.setItem('lastErrorIssue', issueResult.html_url);
    } else {
      const errorText = await response.text();
      console.error('❌ Failed to log error to GitHub:', response.status, response.statusText, errorText);
    }
  } catch (logError) {
    console.error('❌ GitHub error logging failed:', logError);
    // Don't show this error to users - it's just for logging
    // But do log it to console for debugging
  }
}

// Optional: Show error report link to users
function showErrorReportLink() {
  const lastErrorIssue = sessionStorage.getItem('lastErrorIssue');
  if (lastErrorIssue) {
    const linkElement = document.createElement('div');
    linkElement.innerHTML = `
      <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px;">
        📋 <a href="${lastErrorIssue}" target="_blank" style="color: #781d15;">View error report</a> 
        (Developer has been notified)
      </div>
    `;
    
    const errorFeedback = document.getElementById('errorFeedback');
    if (errorFeedback && errorFeedback.style.display !== 'none') {
      errorFeedback.appendChild(linkElement);
    }
  }
}
window.copyAnnouncementOutput = copyAnnouncementOutput;

// Debug function to manually set GitHub token for local testing
window.setupGitHubErrorReporting = function() {
  const token = prompt('Enter your GitHub Personal Access Token for error reporting:');
  if (token && token.startsWith('ghp_')) {
    // Store as if it was injected by GitHub Actions
    localStorage.setItem('simulate_deployed_token', token);
    console.log('✅ GitHub token stored (simulating deployed environment)');
    
    // Test the token by making a simple API call
    fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.login) {
        console.log(`✅ Token validated for user: ${data.login}`);
        alert(`GitHub token setup successful!\nUser: ${data.login}\nError reporting is now active.\n\nNote: This simulates the deployed environment.`);
      } else {
        console.error('❌ Token validation failed:', data);
        alert('Token validation failed. Please check your token.');
      }
    })
    .catch(err => {
      console.error('❌ Token test failed:', err);
      alert('Token test failed. Please check your internet connection.');
    });
  } else {
    alert('Invalid token. GitHub tokens start with "ghp_"');
  }
};

// Debug function to test error reporting
window.testGitHubErrorReporting = function() {
  console.log('🧪 Testing GitHub error reporting...');
  logErrorToGitHub('TEST001', 'Manual test error', 'This is a test error to verify GitHub Issues integration', null, {
    testType: 'Manual test',
    timestamp: new Date().toISOString(),
    testUser: 'Developer'
  });
};

// Debug function to check token status
window.checkGitHubTokenStatus = function() {
  const storedToken = localStorage.getItem('github_error_token_encrypted');
  if (storedToken) {
    try {
      const decrypted = atob(storedToken.split('').reverse().join(''));
      if (decrypted.startsWith('ghp_')) {
        console.log('✅ GitHub token found in localStorage');
        console.log('✅ Token format appears valid');
        return true;
      } else {
        console.log('❌ Token format invalid');
        return false;
      }
    } catch (e) {
      console.log('❌ Failed to decode stored token');
      return false;
    }
  } else {
    console.log('❌ No GitHub token found in localStorage');
    return false;
  }
};

  </script>
</div>