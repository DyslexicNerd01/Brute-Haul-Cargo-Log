<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brute Haul Cargo Manifest Form</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #e2e2e2 0%, #d0d0d0 100%);
      color: #230e09;
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
    }

    .main-container {
      max-width: 95%;
      width: 100%;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      padding: 0 20px;
    }

    .page-header {
      background: linear-gradient(135deg, #781d15 0%, #5a1510 100%);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      margin-bottom: 8px;
    }

    .page-header h1 {
      color: #e2e2e2;
      margin: 0;
      font-size: 2.5em;
      font-weight: 300;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      margin-bottom: 24px;
      width: 100%;
    }

    .card {
      background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(157, 117, 35, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 24px;
    }

    .card.form-step {
      margin-bottom: 24px;
    }
    
    #navigationCard {
      margin-bottom: 24px;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #9d7523;
    }

    .card-header h2 {
      color: #781d15;
      margin: 0;
      font-size: 1.4em;
      font-weight: 600;
    }

    .card-icon {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      background: #9d7523;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .icon {
      font-size: 24px;
      margin-right: 12px;
      display: inline-block;
      font-style: normal;
    }

    form {
      background: transparent;
      border-radius: 0;
      padding: 0;
    }
    textarea {
      width: 100%;
      height: 400px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    #notes {
      height: 80px;
      width: 100%;
      resize: vertical;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      color: #9d7523;
    }
    input, select, textarea {
      margin-bottom: 10px;
      width: 100%;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .section {
      margin-top: 0;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: 0;
    }

    .form-step {
      margin-bottom: 0;
    }

    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 200px;
      width: 100%;
      background: transparent;
      border-radius: 8px;
    }
    input[type="number"] {
      width: 120px;
      padding: 5px;
      font-size: 1.1em;
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    #crewAmount {
      width: 60px;
      font-size: 1em;
      padding: 3px;
      display: inline-block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .other-div {
      display: none;
      margin-left: 30px;
    }
    .other-div label {
      font-weight: bold;
      color: #9d7523;
      margin-top: 10px;
      display: block;
    }
    .other-div input {
      font-size: 0.95em;
      width: 60%;
      color: #230e09;
      background: #e2e2e2;
      border: 1px solid #781d15;
      margin-bottom: 10px;
    }
    .crew-label {
      display: block;
      margin-left: 30px;
      font-size: 0.95em;
      margin-top: 5px;
      color: #9d7523;
      font-weight: bold;
    }
    .crew-input {
      display: block;
      width: 60%;
      font-size: 0.95em;
      margin-left: 30px;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .deductible-input {
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .error {
      border: 2px solid #9d7523 !important;
      background: #b32428 !important;
    }
    select.error option[value=""] {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error:focus {
      background: #e2e2e2 !important;
      color: #230e09 !important;
    }
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .route-arrow {
      font-weight: bold;
      color: #230e09;
      font-size: 1.2em;
      padding: 0 8px;
    }
    button {
      background: #5865F2;
      color: #fff;
      border: none;
      padding: 10px 24px 10px 16px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      background: #404EED;
      color: #fff;
      border: 1px solid #9d7523;
    }
    .discord-btn-logo {
      height: 1.6em;
      width: auto;
      vertical-align: middle;
      filter: invert(1);
    }
    h1 {
      color: #9d7523;
      text-align: center;
      font-size: 2.4em;
      font-weight: bold;
    }
    h2 {
      color: #9d7523;
    }
    .manifest-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 12px;
      border: 2px solid #9d7523;
      border-radius: 8px;
      background: #f8f6f2;
      box-shadow: 0 2px 6px rgba(157,117,35,0.07);
      position: relative;
    }
    .manifest-row label {
      margin: 0;
      font-weight: normal;
      color: #230e09;
      min-width: 60px;
    }
    .manifest-row input,
    .manifest-row select {
      width: auto;
      margin-bottom: 0;
    }
    .manifest-btn {
      font-size: 1em;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
      margin-right: 0;
      transition: background 0.2s;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 0;
    }
    .manifest-btn.add {
      background: #43b581;
      color: #fff;
    }
    .manifest-btn.add:hover {
      background: #2ea964;
    }
    .manifest-btn.remove {
      background: #ed4245;
      color: #fff;
    }
    .manifest-btn.remove:hover {
      background: #b32428;
    }
    .manifest-total-box {
      display: flex;
      gap: 24px;
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: bold;
      color: #230e09;
      background: #f8f6f2;
      border: 2px solid #9d7523;
      border-radius: 8px;
      padding: 12px;
      align-items: center;
      justify-content: flex-start;
    }
    .resource-preset-btn {
      background: #9d7523;
      color: #fff;
      border: none;
      padding: 6px 14px;
      font-size: 11px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
      white-space: nowrap;
      transition: background 0.2s;
      display: inline-block;
    }
    .resource-preset-btn.selected {
      background: #43b581 !important;
      color: #fff !important;
    }
    .resource-preset-btn:hover {
      background: #bfa14d;
      color: #fff;
    }
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4245;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
    }
    .tab-button-container {
      position: relative;
      display: contents;
    }

    .searchable-dropdown {
      position: relative;
      width: 100%;
    }
    .searchable-dropdown input {
      width: 100%;
      padding: 8px;
      border: 1px solid #781d15;
      background: #e2e2e2;
      color: #230e09;
      border-radius: 4px;
      box-sizing: border-box;
      min-height: 36px;
    }
    .searchable-dropdown .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #e2e2e2;
      border: 1px solid #781d15;
      border-top: none;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .searchable-dropdown .dropdown-list.show {
      display: block;
    }
    .searchable-dropdown .dropdown-item {
      padding: 6px 12px;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
      background: #e2e2e2;
      color: #230e09;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .searchable-dropdown .dropdown-item:hover {
      background: #d0d0d0;
    }
    .searchable-dropdown .dropdown-item.selected {
      background: #781d15;
      color: #e2e2e2;
    }
    .searchable-dropdown .dropdown-item:last-child {
      border-bottom: none;
    }
    
    .searchable-dropdown .dropdown-item input[type="checkbox"] {
      width: 14px;
      height: 14px;
      margin: 0;
      margin-right: 6px;
      transform: none;
      vertical-align: middle;
      flex-shrink: 0;
    }
    
    .searchable-dropdown .dropdown-item span {
      vertical-align: middle;
      line-height: 14px;
      flex-grow: 1;
    }
    
    .checkbox-dropdown {
      position: relative;
      width: 100%;
    }
    .checkbox-dropdown .dropdown-toggle {
      width: 100%;
      padding: 8px;
      border: 1px solid #781d15;
      background: #e2e2e2;
      color: #230e09;
      border-radius: 4px;
      box-sizing: border-box;
      cursor: pointer;
      text-align: left;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .checkbox-dropdown .dropdown-toggle:after {
      content: "▼";
      font-size: 12px;
    }
    .checkbox-dropdown .checkbox-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #e2e2e2;
      border: 1px solid #781d15;
      border-top: none;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .checkbox-dropdown .checkbox-list.show {
      display: block;
    }
    .checkbox-dropdown .checkbox-item {
      padding: 8px 12px;
      border-bottom: 1px solid #ccc;
      background: #e2e2e2;
      color: #230e09;
      font-size: 14px;
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .checkbox-dropdown .checkbox-item:hover {
      background: #d0d0d0;
    }
    .checkbox-dropdown .checkbox-item:last-child {
      border-bottom: none;
    }
    .checkbox-dropdown .checkbox-item input[type="checkbox"] {
      margin-right: 8px;
      width: auto;
      height: auto;
      pointer-events: none;
    }
    .checkbox-dropdown .checkbox-item label {
      cursor: pointer;
      margin: 0;
      flex: 1;
      pointer-events: none;
    }
    .checkbox-dropdown .dropdown-toggle.error {
      border-color: #ed4245;
      background: #fee;
    }
    
    .security-ship-captains {
      margin-top: 12px;
    }
    .security-captain-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 8px;
      background: #f8f6f2;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .security-captain-row label {
      font-weight: 600;
      min-width: 150px;
      margin: 0;
    }
    .security-captain-row .searchable-dropdown {
      flex: 1;
    }
    
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .route-row .searchable-dropdown {
      flex: 1;
    }

    #historyTab {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .main-content-wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      align-items: start;
    }
    
    .form-column {
      min-width: 0;
      width: 100%;
    }
    
    .announcements-sidebar {
      position: static;
      height: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .announcements-sidebar .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .announcements-sidebar .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    @media (max-width: 1200px) {
      .main-content-wrapper {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(35, 14, 9, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }

    .loading-content {
      background: #781d15;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      color: #e2e2e2;
      border: 2px solid #9d7523;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: relative;
    }

    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: #e2e2e2;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s, color 0.2s;
    }

    .close-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
      color: #ffffff;
    }

    .close-button:active {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .datetime-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    input[type="datetime-local"] {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      flex: 1;
      box-sizing: border-box;
      line-height: 1.2;
    }

    .time-now-btn {
      background: linear-gradient(135deg, #9d7523 0%, #8a6b1f 100%);
      color: #ffffff;
      border: 2px solid transparent;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      transition: all 0.2s ease;
      white-space: nowrap;
      box-sizing: border-box;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      line-height: 1.2;
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(16.8px + 20px + 4px);
      align-self: flex-start;
      margin-top: 3px;
    }

    .time-now-btn:hover {
      background: #b88629;
      color: #ffffff;
      transform: translateY(-1px);
    }

    .time-now-btn:active {
      background: #8a6b1f;
      transform: translateY(0);
    }

    input, select, textarea {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    input:focus, select:focus, textarea:focus {
      border-color: #9d7523;
      outline: none;
      box-shadow: 0 0 0 3px rgba(157, 117, 35, 0.1);
      transform: translateY(-1px);
    }

    input:hover, select:hover, textarea:hover {
      border-color: #c4a140;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    label {
      font-weight: 600;
      color: #781d15;
      margin-bottom: 8px;
      font-size: 14px;
    }

    button {
      background: linear-gradient(135deg, #9d7523 0%, #8a6b1f 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(157, 117, 35, 0.3);
    }

    button:hover {
      background: linear-gradient(135deg, #b88629 0%, #9d7523 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(157, 117, 35, 0.4);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(157, 117, 35, 0.3);
    }

    .primary-btn {
      background: linear-gradient(135deg, #781d15 0%, #5a1510 100%);
      font-size: 16px;
      padding: 16px 32px;
      box-shadow: 0 6px 16px rgba(120, 29, 21, 0.3);
    }

    .primary-btn:hover {
      background: linear-gradient(135deg, #8a2419 0%, #6b1914 100%);
      box-shadow: 0 8px 20px rgba(120, 29, 21, 0.4);
    }

    .loading-spinner-large {
      width: 40px;
      height: 40px;
      border: 4px solid #9d7523;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto 16px auto;
    }

    .progress-bar-container {
      background: #e2e2e2;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #9d7523;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ccc;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #43b581, #9d7523);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      font-size: 14px;
      color: #230e09;
      font-weight: bold;
      text-align: center;
    }

    .button-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .success-feedback {
      background: #43b581;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    .error-feedback {
      background: #ed4245;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-step {
      transition: border-left 0.3s ease, padding-left 0.3s ease;
    }

    .form-step.active {
      border-left: 4px solid #9d7523;
      padding-left: 16px;
    }

    .form-step.completed {
      border-left: 4px solid #43b581;
      padding-left: 16px;
    }

    @media (max-width: 1200px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .main-container {
        max-width: 900px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .page-header {
        padding: 20px;
      }
      
      .page-header h1 {
        font-size: 2em;
      }
      
      .card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .card.form-step {
        margin-bottom: 20px;
      }
      
      .form-grid {
        gap: 20px;
        grid-template-columns: 1fr;
      }
      
      input, select, textarea {
        padding: 10px 12px;
      }
      
      button {
        padding: 10px 20px;
      }
      
      .primary-btn {
        padding: 14px 28px;
      }
    }

    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.6em;
      }
      
      .card {
        padding: 16px;
      }
      
      .card-header h2 {
        font-size: 1.2em;
      }
    }
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #formTab {
      display: block;
    }
    
    #historyTab {
      display: none;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      position: relative !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      min-height: 300px !important;
      z-index: 1000 !important;
    }
    
    #historyTab.active {
      display: block !important;
    }
    
    #historyList {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      min-height: 200px !important;
    }
    
    #discordOutputContainer {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    #toggleOutputBtn {
      transition: all 0.2s ease;
    }
    
    #toggleOutputBtn:hover {
      background: #7d6a1e !important;
      transform: translateY(-1px);
    }
    
    #toggleOutputIcon {
      transition: transform 0.2s ease;
      font-size: 12px;
      display: inline-block;
    }
  </style>
  <script src="locations.js"></script>
</head>
<body>
  <div class="main-container">
    <div class="page-header">
      <img class="logo" src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo">
      <h1>Brute Haul Online Documentation System</h1>
    </div>

    <div class="card" id="navigationCard">
      <div style="display: flex; gap: 12px; margin-bottom: 0;">
        <button type="button" onclick="showTab('formTab')" id="formTabBtn" style="border: 3px solid transparent;">Form</button>
        <button type="button" onclick="showTab('historyTab')" id="historyTabBtn" style="border: 3px solid transparent;">History</button>
        <a href="https://robertsspaceindustries.com/en/orgs/BRHS" target="_blank" title="Join BRHS"
           style="margin-left:auto; display:inline-flex; align-items:center; justify-content:center; width:60px; height:60px; background:#222; border-radius:8px; text-decoration:none; border:0px solid #9d7523;">
          <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/starcitizenwhite.png" alt="Star Citizen" style="width:82px; height:82px; object-fit:contain; filter:invert(1);">
        </a>
      </div>
    </div>

    <div id="historyTab" style="display: none; width: 100%; max-width: 95%; margin: 0 auto;">
      <div style="background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%); border-radius: 16px; padding: 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(157, 117, 35, 0.2);">
        <div id="historyList" style="min-height: 300px; padding: 20px;">
          <div style="text-align: center; background: #fff; border: 3px solid #9d7523; border-radius: 12px; padding: 30px;">
            <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" 
                 alt="BruteHaul Logo" 
                 style="max-width: 200px; width: 100%; margin-bottom: 20px; border-radius: 8px;">
            <h2 style="color: #9d7523; margin: 20px 0; font-size: 24px;">Brute Haul Manifest Log</h2>
            <p style="font-size: 18px; color: #781d15; font-weight: bold; margin: 15px 0;">
              No posts generated this session.
            </p>
            <p style="color: #666; margin: 10px 0; font-size: 16px;">
              Complete and submit manifests to see them listed here.
            </p>
            <div style="margin-top: 20px; padding: 10px; background: #e8f5e8; border-radius: 8px; border: 2px solid #28a745;">
              <strong style="color: #28a745;">✓ History Tab Working!</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="formTab">
      <div class="form-grid">
  
  <div class="success-feedback" id="successFeedback">
    <span>✓</span>
    <span id="successMessage">Success!</span>
  </div>
  <div class="error-feedback" id="errorFeedback">
    <span>⚠</span>
    <span id="errorMessage">Error occurred!</span>
  </div>

  <div class="main-content-wrapper">
    <div class="form-column">
      <form id="haulForm">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">1</div>
        <h2>Basic Information</h2>
      </div>
      <div class="section form-step" id="basicInfoStep">
      <label>Order Category:</label>
      <select id="orderCategory" required>
        <option value="" selected disabled>Select category</option>
        <option value="Transport">Transport</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderCategoryOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderCategoryOther" required />
      </div>

      <label>Company Name:</label>
      <select id="companyName" required>
        <option value="" selected disabled>Select company</option>
        <option value="Brute Haul">Brute Haul</option>
        <option value="Wildcard Inc.">Wildcard Inc.</option>
        <option value="Space Rats">Space Rats</option>
        <option value="The Benjineering Project">The Benjineering Project</option>
      </select>

      <label>Order Type:</label>
      <select id="orderType" required onchange="toggleOrderTypeOther()">
        <option value="" selected disabled>Select order type</option>
        <option value="Resource Drive">Resource Drive</option>
        <option value="Supplies">Supplies</option>
        <option value="Trade">Trade</option>
        <option value="Resources">Resources</option>
        <option value="Salvage">Salvage</option>
        <option value="Contract">Contract</option>
        <option value="Relocation">Relocation</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderTypeOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderTypeOther" required />
      </div>
      <div id="resourceDriveCompanyDiv" class="other-div" style="display:none;">
        <label>Resource Drive Company:</label>
        <select id="resourceDriveCompany">
          <option value="" selected disabled>Select company</option>
          <option value="Hurston Dynamics">Hurston Dynamics</option>
          <option value="Arccorp">Arccorp</option>
          <option value="🏆 Crusader Industries">🏆 Crusader Industries</option>
          <option value="Microtech">Microtech</option>
        </select>
      </div>

      <label>Ship Name:</label>
      <div class="searchable-dropdown" id="shipNameDropdown">
        <input type="text" id="shipName" placeholder="Search ship name..." autocomplete="off" required>
        <div class="dropdown-list" id="shipNameList"></div>
      </div>
      <div id="shipNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="shipNameOther" required />
      </div>

      <label>Captain Name:</label>
      <div class="searchable-dropdown" id="captainNameDropdown">
        <input type="text" id="captainName" placeholder="Search captain name..." autocomplete="off" required>
        <div class="dropdown-list" id="captainNameList"></div>
      </div>
      <div id="captainNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="captainNameOther" required />
      </div>

      <label>Crew Amount:</label>
      <input type="number" id="crewAmount" min="0" max="20" step="1" required oninput="generateCrewInputs()" />

      <div id="crewNamesDiv"></div>
    </div>
    </div>

    <div class="card form-step" id="securityShipsStep">
      <div class="card-header">
        <i class="icon">🛡️</i>
        <h2>Security Ships</h2>
      </div>
      <div class="card-content">
      <label>Security Ships:</label>
      <div class="searchable-dropdown" id="securityShipsDropdown">
        <input type="text" id="securityShips" placeholder="Search security ships..." autocomplete="off" required>
        <div class="dropdown-list" id="securityShipsList"></div>
      </div>
      <div id="securityShipsOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="securityShipsOther" required />
      </div>
      <div class="security-ship-captains" id="securityShipCaptains"></div>
    </div>
    </div>

    <div class="card form-step" id="locationTimeStep">
      <div class="card-header">
        <i class="icon">📍</i>
        <h2>Locations & Timeline</h2>
      </div>
      <div class="card-content">
      <label>Start Location:</label>
      <div class="searchable-dropdown" id="startLocationDropdown">
        <input type="text" id="startLocation" placeholder="Search start location..." autocomplete="off" required>
        <div class="dropdown-list" id="startLocationList"></div>
      </div>

      <label>Departure Timestamp:</label>
      <div class="datetime-container">
        <input type="datetime-local" id="departureTime" required>
        <button type="button" class="time-now-btn" onclick="setCurrentTime('departureTime')" title="Set to current time">Now</button>
      </div>

      <label>Route:</label>
      <div class="route-row">
        <div class="searchable-dropdown" id="routeStartDropdown">
          <input type="text" id="routeStart" placeholder="Search route start..." autocomplete="off" required>
          <div class="dropdown-list" id="routeStartList"></div>
        </div>
        <span class="route-arrow" style="font-size:1.5em;">➡️</span>
        <div class="searchable-dropdown" id="routeEndDropdown">
          <input type="text" id="routeEnd" placeholder="Search route end..." autocomplete="off" required>
          <div class="dropdown-list" id="routeEndList"></div>
        </div>
      </div>
    </div>
    </div>

    <div class="card form-step" id="manifestStep">
      <div class="card-header">
        <i class="icon">📦</i>
        <h2>Cargo Manifest</h2>
      </div>
      <div class="card-content">
      <label>Cargo Manifest (add/remove lines as needed):</label>
      <div id="resourceDrivePresets" style="display:none; margin-bottom:10px;">
        <span style="font-size:13px; font-weight:bold; vertical-align:middle; margin-right:8px;">Resource Drive Presets:</span>
        <span style="display:inline-flex; gap:10px; vertical-align:middle;">
          <button type="button" class="resource-preset-btn" id="presetLargeBtn" onclick="applyManifestPreset('large')">Heavy Haul</button>
          <button type="button" class="resource-preset-btn" id="presetMediumBtn" onclick="applyManifestPreset('medium')">Medium Haul</button>
          <button type="button" class="resource-preset-btn" id="presetSmallBtn" onclick="applyManifestPreset('small')">Small Haul</button>
        </span>
      </div>
      <div id="manifestLines"></div>
      <div class="manifest-total-box">
  <span id="totalSCUBox">Total SCU: 0</span>
  <span style="margin-right:6px;">Total UEC:</span>
<input type="number" id="totalUECBox" style="color:#230e09; font-weight:bold; vertical-align:middle; width:120px;" value="0" />
</div>
    </div>
    </div>

    <div class="card form-step" id="completionStep">
      <div class="card-header">
        <i class="icon">✅</i>
        <h2>Order Completion</h2>
      </div>
      <div class="card-content">
      <label>Order Completion Timestamp:</label>
      <div class="datetime-container">
        <input type="datetime-local" id="completionTime" required>
        <button type="button" class="time-now-btn" onclick="setCurrentTime('completionTime')" title="Set to current time">Now</button>
      </div>
      <div id="orderDuration" style="font-weight:bold; color:#9d7523; margin-top:8px;"></div>

      <label>Repairs (UEC):</label>
      <input type="number" id="repairs" min="0" step="1" class="deductible-input" required value="0">

      <label>Restock (UEC):</label>
      <input type="number" id="restock" min="0" step="1" class="deductible-input" required value="0">

      <label>Quantum Fuel (UEC):</label>
      <input type="number" id="quantumFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Hydrogen Fuel (UEC):</label>
      <input type="number" id="hydrogenFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Crew/Ship Costs (UEC):</label>
      <input type="number" id="crewCosts" min="0" step="1" class="deductible-input" required value="0">

      <label>Notes:</label>
      <textarea id="notes" style="width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
    </div>
    </div>

    <button type="button" onclick="generateOutput()" id="generateBtn">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" class="discord-btn-logo" style="filter: brightness(0) invert(1);" />
      Generate Discord Post
    </button>
    <button type="button" onclick="clearFormFields()" style="background:#b32428;color:#fff;border:none;padding:10px 16px;border-radius:5px;font-weight:bold;display:flex;align-items:center;gap:8px;margin-left:8px;margin-bottom:20px;">
  Clear Form
</button>
  </form>

  <div class="section" id="discordSection" style="display:none;">
    
    <div style="border-bottom: 1px solid #9d7523; margin-bottom: 16px;"></div>
    
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <button type="button" onclick="sendToDiscord()" style="background:#43b581;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:bold;font-size:16px;display:inline-flex;align-items:center;gap:10px;">
        <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.8em;width:auto;filter:brightness(0) invert(1);" />
        Send to Discord
      </button>
    </div>
    
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <button type="button" onclick="toggleDiscordOutput()" id="toggleOutputBtn" style="background:#9d7523;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;">
        <span id="toggleOutputIcon">▶</span>
        <span id="toggleOutputText">Show Generated Output</span>
      </button>
    </div>
    
    <div id="discordOutputContainer" style="display:none;">
      <textarea id="discordOutput" readonly></textarea>
      <button type="button" onclick="copyDiscordOutput()" id="copyDiscordBtn" style="background:#5865F2;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:none;align-items:center;gap:8px;">
        <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
        Copy to Clipboard
      </button>
    </div>
  </div>
    </div>

    <!-- THIS IS A JUMPPOINT FOR ANNOUCEMENTS BECAUSE I'M LAZY AND I DON'T WANT TO SCROLL TO FIND THIS SECTION-->
    <!-- I really should make annoucements a seperate file but that would be too smart of me-->
    <div class="announcements-sidebar">
      <div class="card" id="announcementsSection">
        <div class="card-header">
          <i class="icon">📢</i>
          <h2>Announcements</h2>
        </div>
        <div class="card-content">
          <div id="announcementsContent" style="height: auto; max-height: none;">
            <!-- Announcement Post 1 -->
            <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
                <h3 style="color:#781d15;margin:0;font-size:1.2em;">Brute Haul Manifest Error Reporting</h3>
                <div style="color:#666;font-size:0.8em;margin-top:5px;">
                  <strong>By:</strong> DyslexicNerd01<br><strong>Date:</strong> August 14, 2025
                </div>
              </div>
              <div class="announcement-body" style="color:#230e09;line-height:1.5;font-size:0.9em;">
                <p><strong>Brute Haul Manifest Logs now automatically get sent to discord after pressing the "Send to Discord" button!</strong></p>
                <p>If you do encounter any issues, you should see an error code and message explaining the problem. If this issue relates to the function of the bot, a GitHub issue will automatically open adressing the issue to have it solved as soon as possible.</p>
                <p>If you do see any of these messages, please do not panic as your current manifest will be printed in the bug report to be uploaded later! If you encounter an issue that does not generate an error message, please report it in <i>#space-truckers-diner</i> to be addressed later.</p>
                <p>Please do not report your ship not appearing in the list! The list is automatically generated from ships in <i>#ship-log</i>. Please DM Spartan to have your ship added! Until then please use the <i>"Other"</i> selection to manually enter your captain name/ship name.</p>
              </div>
            </div>
            
            <!-- Announcement Post 2 -->
            <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
                <h3 style="color:#781d15;margin:0;font-size:1.2em;">Known Issues Affecting Brute Haul Operations</h3>
                <div style="color:#666;font-size:0.8em;margin-top:5px;">
                  <strong>By:</strong> DyslexicNerd01<br><strong>Updated:</strong> August 25, 2025
                </div>
              </div>
              <div class="announcement-body" style="color:#230e09;line-height:1.5;font-size:0.9em;">
                <p><strong>✅</strong> <u>No Issues Currently Affecting Brute Haul Operations!</u><br>
                  There are currently no known issues majorly affecting Brute Haul Operations or Ad Astra Operations!</p>
                <p><strong>Follow this support ticket for more information on current bugs/issues or other issues within the game:<br> <a href="https://support.robertsspaceindustries.com/hc/en-us/articles/360056254754-Star-Citizen-Alpha-4-3-Known-Issues" target="_blank" style="color:#781d15;">Star Citizen Known Issues</a></strong></p>
              </div>
            </div>
            
            <!-- Announcement Post 3 -->
            <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
                <h3 style="color:#781d15;margin:0;font-size:1.2em;">📋 How to Use the Manifest Generator</h3>
                <div style="color:#666;font-size:0.8em;margin-top:5px;">
                  <strong>By:</strong> DyslexicNerd01<br><strong>Date:</strong> August 24, 2025
                </div>
              </div>
              <div class="announcement-body" style="color:#230e09;line-height:1.5;font-size:0.9em;">
                <p><strong>Complete guide to using the Brute Haul Cargo Manifest Generator:</strong></p>
                
                <p><strong>Step 1: Basic Information</strong><br>
                • Fill in Order Category, Company Name, Order Type<br>
                • Select your Transport Ship and Captain<br>
                • If you don't see your ship or name on the list, use the "Other" option<br>
                • Add crew members (if any)</p>
                
                <p><strong>Step 2: Security Ships</strong><br>
                • Select security escort ships from the dropdown (If any)<br>
                • Assign captains to each security ship<br>
                • Add crew members (if any)<br>
                • Use "Other" if your ship isn't listed</p>
                
                <p><strong>Step 3: Locations & Timeline</strong><br>
                • Set departure location and time<br>
                • Choose route start (Collection Point) and end points (Delivery Point)<br>
                • Set order completion time<br>
                • Duration is calculated automatically</p>
                
                <p><strong>Step 4: Manifest</strong><br>
                • Add cargo lines with SCU amounts and materials<br>
                • UEC values are optional but recommended<br>
                • Use presets for common cargo types in the Resource Drive<br>
                • Total SCU and UEC calculated automatically</p>
                
                <p><strong>Step 5: Completion & Costs</strong><br>
                • Enter repair costs, restocking, fuel costs<br>
                • Add crew/ship ie. Food/Drinks, Repairs, Fuel, etc.<br>
                • Add any notes from the mission. Not required<br>
                • Review your manifest before generating</p>
                
                <p><strong>Final Steps:</strong><br>
                • Click "Generate Discord Post" to create formatted output<br>
                • Click "Send to Discord" to post automatically<br>
                • Your manifest is logged to the Discord Channel!</p>
                
                <p><strong>Tips:</strong><br>
                • Green progress bars show completed sections<br>
                • Use "Clear Form" to start over while keeping basic information. This is automatically done when hitting "Send to Discord"<br>
                • Form validation prevents common errors<br>
                • History tab saves your previous manifests<br>
                • The announcement section displays important information regarding Brute Haul</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="progress-bar-container" style="width: 100%; margin: 24px 0; padding: 0 40px; box-sizing: border-box;">
    <div class="progress-bar">
      <div class="progress-fill" id="formProgressFill"></div>
    </div>
    <div class="progress-text" id="formProgressText">Form Completion: 0%</div>
  </div>
  </div>
  </div>
<script type="module">
   // Locations in locations.js

    // Ships
    const transportShips = [
      "SPRT Icarus", "BRHS Lednik", "BRHS Trireme", "WINC Caterpillar", "WINCO Rafto", "BRHS Ledokol",
    ];
    const securityShips = [
      "AACS Landsknecht", "AACS Feder", "BRHS Seastrom", "BRHS Sword of Twilight", "AACS Dendrobium", "AACS Judgements Bow", "BRHS Knight",
    ];
    const allShips = [
      ...transportShips,
      ...securityShips,
    ];

    // Captains
    const captainNames = [
      "DyslexicNerd", "Spartan", "Lightblade", "jjetstreamm", "Roflnomish", 
      "BenjiNotorious", "zarainia", "Astol", "Venomnom", "BigDaddyTortuga", 
      "ItzProto", "Newt", "Xolion", "Bakes Kamuari", "LockEmUpJas", 
      "sadfish", "Efazer"
    ];

    // Manifest materials
    const materialList = [
      "Select Material", "Agricium", "Aluminium", "Aphorite", "Beryl", "Bexalite", "Borase", "Copper", "Corundum", "Diamond", "Dolivine", "Dyslexium", "Gold", "Hadanite", "Hephaestanite", "Inert materials", "Laranite", "Placeholder", "Spartanium", "Quantanium", "Quartz", "Taranite", "Tungsten", "Titanium"
    ];

    function clearFormFields() {

  document.getElementById("departureTime").value = "";
  document.getElementById("completionTime").value = "";
  document.getElementById("orderDuration").textContent = "";
  manifestLineCount = 1;
  renderManifestLines();
  const firstManifestRow = document.querySelector('.manifest-row');
  if (firstManifestRow) {
    firstManifestRow.querySelector('.manifest-scu').value = "";
    firstManifestRow.querySelector('.manifest-material').selectedIndex = 0;
    firstManifestRow.querySelector('.manifest-uec').value = "";
  }

  document.getElementById("totalSCUBox").textContent = "Total SCU: 0";

  document.getElementById("repairs").value = "0";
  document.getElementById("restock").value = "0";
  document.getElementById("quantumFuel").value = "0";
  document.getElementById("hydrogenFuel").value = "0";
  document.getElementById("crewCosts").value = "0";
  document.getElementById("totalUECBox").value = "0";

  document.getElementById("routeStart").value = "";
  document.getElementById("routeEnd").value = "";

  document.getElementById("startLocation").value = "";

  document.getElementById("notes").value = "";
  
  document.getElementById("discordSection").style.display = "none";
  hideCopyButton();
  
  const generateBtn = document.getElementById("generateBtn");
  if (generateBtn) {
    generateBtn.style.display = "inline-flex";
  }
  
  calculateFormProgress();
}

function showTab(tab) {
  const formTab = document.getElementById('formTab');
  const historyTab = document.getElementById('historyTab');
  
  if (formTab && historyTab) {
    if (tab === 'formTab') {
      formTab.style.display = 'block';
      historyTab.style.display = 'none';
    } else if (tab === 'historyTab') {
      formTab.style.display = 'none';
      historyTab.style.display = 'block';
      renderHistory();
    }
  }

  const formTabBtn = document.getElementById('formTabBtn');
  const historyTabBtn = document.getElementById('historyTabBtn');
  
  if (formTabBtn && historyTabBtn) {
    formTabBtn.style.background = tab === 'formTab' ? '#9d7523' : '#781d15';
    historyTabBtn.style.background = tab === 'historyTab' ? '#9d7523' : '#781d15';

    formTabBtn.style.color = '#fff';
    historyTabBtn.style.color = '#fff';

    formTabBtn.style.border = tab === 'formTab' ? '3px solid #000' : '3px solid transparent';
    historyTabBtn.style.border = tab === 'historyTab' ? '3px solid #000' : '3px solid transparent';
  }
}
window.showTab = showTab;

window.addEventListener("DOMContentLoaded", function() {
  showTab('formTab');
  const totalUECInput = document.getElementById("totalUECBox");
  if (totalUECInput) totalUECInput.value = "0";
  resizeAnnouncementsContent();
});
function resizeAnnouncementsContent() {
  const announcementsContent = document.getElementById('announcementsContent');
  const formCompletionCard = document.getElementById('completionStep');
  
  if (announcementsContent && formCompletionCard) {
    announcementsContent.style.height = 'auto';
    announcementsContent.style.maxHeight = 'none';
    announcementsContent.style.overflow = 'visible';
    
    const contentRect = announcementsContent.getBoundingClientRect();
    const completionRect = formCompletionCard.getBoundingClientRect();
    
    if (contentRect.bottom > completionRect.bottom) {
      const maxHeight = completionRect.bottom - contentRect.top - 20;
      announcementsContent.style.height = maxHeight + 'px';
      announcementsContent.style.maxHeight = maxHeight + 'px';
      announcementsContent.style.overflow = 'auto';
    }
  }
}

window.addEventListener('resize', resizeAnnouncementsContent);

    function populateLocationDropdown(id) {
      const inputId = id;
      const listId = id + 'List';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let selectedValue = '';
      let filteredLocations = locations;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterLocations(searchTerm) {
        const term = searchTerm.toLowerCase();
        return locations.filter(location => 
          location.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(locationsToShow) {
        list.innerHTML = '';
        locationsToShow.forEach(location => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = location;
          item.addEventListener('click', () => {
            input.value = location;
            selectedValue = location;
            hideDropdown();
            input.classList.remove('error');
            showGenerateButtonOnChange();
          });
          list.appendChild(item);
        });
      }

      renderDropdownItems(locations);
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredLocations = locations;
        } else {
          filteredLocations = filterLocations(searchTerm);
        }
        renderDropdownItems(filteredLocations);
        showDropdown();
        selectedValue = '';
        showGenerateButtonOnChange();
      });

      input.addEventListener('focus', () => {
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            showGenerateButtonOnChange();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      input.validateValue = function() {
        return locations.includes(input.value);
      };
    }

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.searchable-dropdown')) {
        document.querySelectorAll('.dropdown-list').forEach(list => {
          list.classList.remove('show');
        });
      }
    });

    function populateShipDropdown(category) {
      const inputId = 'shipName';
      const listId = 'shipNameList';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let ships = [];
      if (category === "Transport") {
        ships = transportShips;
      } else {
        ships = transportShips;
      }

      const shipsWithOther = [...ships, "Other"];

      let selectedValue = '';
      let filteredShips = shipsWithOther;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterShips(searchTerm) {
        const term = searchTerm.toLowerCase();
        return shipsWithOther.filter(ship => 
          ship.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(shipsToShow) {
        list.innerHTML = '';
        shipsToShow.forEach(ship => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = ship;
          item.addEventListener('click', () => {
            input.value = ship;
            selectedValue = ship;
            hideDropdown();
            input.classList.remove('error');
            toggleShipNameOther();
          });
          list.appendChild(item);
        });
      }

      renderDropdownItems(shipsWithOther);

      input.removeEventListener('input', input._shipInputHandler);
      input.removeEventListener('focus', input._shipFocusHandler);
      input.removeEventListener('blur', input._shipBlurHandler);
      input.removeEventListener('keydown', input._shipKeydownHandler);

      input._shipInputHandler = (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredShips = shipsWithOther;
        } else {
          filteredShips = filterShips(searchTerm);
        }
        renderDropdownItems(filteredShips);
        showDropdown();
        selectedValue = '';
      };
      input.addEventListener('input', input._shipInputHandler);

      input._shipFocusHandler = () => {
        showDropdown();
      };
      input.addEventListener('focus', input._shipFocusHandler);

      input._shipBlurHandler = () => {
        hideDropdown();
      };
      input.addEventListener('blur', input._shipBlurHandler);

      input._shipKeydownHandler = (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            toggleShipNameOther();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      };
      input.addEventListener('keydown', input._shipKeydownHandler);

      input.validateValue = function() {
        return shipsWithOther.includes(input.value);
      };
    }

    function populateCaptainDropdown(inputId = 'captainName') {
      const listId = inputId + 'List';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      const captainsWithOther = [...captainNames, "Other"];

      let selectedValue = '';
      let filteredCaptains = captainsWithOther;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterCaptains(searchTerm) {
        const term = searchTerm.toLowerCase();
        return captainsWithOther.filter(captain => 
          captain.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(captainsToShow) {
        list.innerHTML = '';
        captainsToShow.forEach(captain => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = captain;
          item.addEventListener('click', () => {
            input.value = captain;
            selectedValue = captain;
            hideDropdown();
            input.classList.remove('error');
            if (inputId === 'captainName') {
              toggleCaptainNameOther();
            }
            calculateFormProgress();
          });
          list.appendChild(item);
        });
      }

      renderDropdownItems(captainsWithOther);

      if (input.dataset.initialized === 'true') {
        return;
      }
      input.dataset.initialized = 'true';

      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredCaptains = captainsWithOther;
        } else {
          filteredCaptains = filterCaptains(searchTerm);
        }
        renderDropdownItems(filteredCaptains);
        showDropdown();
        selectedValue = '';
      });

      input.addEventListener('focus', () => {
        renderDropdownItems(filteredCaptains);
        showDropdown();
      });

      input.addEventListener('click', () => {
        renderDropdownItems(filteredCaptains);
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            if (inputId === 'captainName') {
              toggleCaptainNameOther();
            }
            calculateFormProgress();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      input.validateValue = function() {
        return captainsWithOther.includes(input.value);
      };
    }

    function populateSecurityShipsDropdown() {
      const inputId = 'securityShips';
      const listId = 'securityShipsList';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      const securityShipsWithOther = ["None", ...securityShips, "Other"];
      let selectedShips = ['None'];

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function updateInputDisplay() {
        if (selectedShips.length === 0) {
          input.value = '';
          input.placeholder = 'Select security ships...';
        } else if (selectedShips.length === 1) {
          input.value = selectedShips[0];
        } else {
          input.value = `${selectedShips.length} ships selected`;
        }
      }

      function renderDropdownItems(shipsToShow) {
        list.innerHTML = '';
        renderShipItems(shipsToShow);
      }

      function renderShipItems(shipsToShow) {
        list.innerHTML = '';

        shipsToShow.forEach(ship => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = selectedShips.includes(ship);
          checkbox.addEventListener('click', (e) => e.stopPropagation());
          
          const label = document.createElement('span');
          label.textContent = ship;
          
          item.appendChild(checkbox);
          item.appendChild(label);
          
          item.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (ship === 'None') {
              if (selectedShips.includes('None')) {
                selectedShips = [];
              } else {
                selectedShips = ['None'];
              }
            } else {
              if (selectedShips.includes('None')) {
                selectedShips = selectedShips.filter(s => s !== 'None');
              }
              
              if (selectedShips.includes(ship)) {
                selectedShips = selectedShips.filter(s => s !== ship);
              } else {
                selectedShips.push(ship);
              }
            }
            
            updateInputDisplay();
            renderShipItems(shipsToShow);
            input.classList.remove('error');
            toggleSecurityShipsOther();
            
            const validShips = selectedShips.filter(s => s !== 'None' && s !== 'Other');
            updateSecurityCaptainDropdowns(validShips);
            calculateFormProgress();
          });
          
          item.addEventListener('mouseenter', () => {
            if (!item.style.backgroundColor || item.style.backgroundColor === '') {
              item.style.backgroundColor = '#d0d0d0';
            }
          });
          
          item.addEventListener('mouseleave', () => {
            if (item.style.backgroundColor === 'rgb(208, 208, 208)') {
              item.style.backgroundColor = '';
            }
          });
          
          list.appendChild(item);
        });
      }

      renderDropdownItems(securityShipsWithOther);
      updateInputDisplay();

      if (input.dataset.initialized === 'true') {
        return;
      }
      input.dataset.initialized = 'true';

      input.addEventListener('focus', () => {
        renderDropdownItems(securityShipsWithOther);
        showDropdown();
      });

      input.addEventListener('click', (e) => {
        e.stopPropagation();
        renderDropdownItems(securityShipsWithOther);
        showDropdown();
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideDropdown();
        } else if (e.key === 'Backspace' || e.key === 'Delete') {
          if (selectedShips.length > 0) {
            selectedShips = [];
            updateInputDisplay();
            updateSecurityCaptainDropdowns([]);
            calculateFormProgress();
          }
        } else {
          e.preventDefault();
        }
      });

      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          hideDropdown();
        }
      });

      input.validateValue = function() {
        return selectedShips.length > 0;
      };

      input.getSelectedShips = function() {
        return [...selectedShips];
      };
    }

    function toggleSecurityShipsOther() {
      const securityShipsInput = document.getElementById("securityShips");
      const otherDiv = document.getElementById("securityShipsOtherDiv");
      
      if (!securityShipsInput || !otherDiv) return;
      
      const selectedShips = securityShipsInput.getSelectedShips ? securityShipsInput.getSelectedShips() : [];
      const hasOther = selectedShips.includes("Other");
      
      if (hasOther) {
        otherDiv.style.display = "block";
      } else {
        otherDiv.style.display = "none";
      }
    }

    let manifestLineCount = 1;

    function createManifestLine(index) {
      const isLast = index === manifestLineCount;
      return `
        <div class="manifest-row" id="manifestRow${index}">
          <label>SCU:</label>
          <input type="number" min="0" step="1" class="manifest-scu" id="manifestSCU${index}" style="width:70px;" oninput="updateManifestTotals()">
          <label>Material:</label>
          <select class="manifest-material" id="manifestMaterial${index}" style="width:160px;">
            ${materialList.map(m => `<option value="${m}">${m}</option>`).join("")}
          </select>
          <label>UEC:</label>
          <input type="number" min="0" step="1" class="manifest-uec" id="manifestUEC${index}" style="width:90px;" oninput="updateManifestTotals()">
          <button type="button" onclick="removeManifestLine(${index})" class="manifest-btn remove" title="Remove line">－</button>
          ${isLast ? `<button type="button" onclick="addManifestLine()" class="manifest-btn add" title="Add line">＋</button>` : ""}
        </div>
      `;
    }

    function renderManifestLines() {
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }

      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
    }
    function applyManifestPreset(type) {
      var preset = [];
      var totalUEC = 0;
      if (type === 'large') {
        preset = [
          { scu: 72, material: 'Corundum' },
          { scu: 36, material: 'Tungsten' },
          { scu: 72, material: 'Copper' }
        ];
        totalUEC = 101750;
      } else if (type === 'medium') {
        preset = [
          { scu: 19, material: 'Corundum' },
          { scu: 10, material: 'Tungsten' },
          { scu: 19, material: 'Copper' }
        ];
        totalUEC = 58400;
      } else if (type === 'small') {
        preset = [
          { scu: 2, material: 'Corundum' },
          { scu: 4, material: 'Tungsten' },
          { scu: 2, material: 'Copper' }
        ];
        totalUEC = 53250;
      }
      manifestLineCount = preset.length;
      renderManifestLines();
      var totalSCU = preset.reduce(function(sum, item) { return sum + item.scu; }, 0);
      var rows = document.querySelectorAll('.manifest-row');
      var uecAssigned = 0;
      for (var idx = 0; idx < preset.length; idx++) {
        var row = rows[idx];
        if (row) {
          row.querySelector('.manifest-scu').value = preset[idx].scu;
          row.querySelector('.manifest-material').value = preset[idx].material;
          var uec = Math.floor((preset[idx].scu / totalSCU) * totalUEC);
          if (idx === preset.length - 1) {
            uec = totalUEC - uecAssigned;
          }
          row.querySelector('.manifest-uec').value = uec;
          uecAssigned += uec;
        }
      }
      var totalUECInput = document.getElementById('totalUECBox');
      if (totalUECInput) totalUECInput.value = totalUEC;
      updateManifestTotals();
      var largeBtn = document.getElementById('presetLargeBtn');
      var mediumBtn = document.getElementById('presetMediumBtn');
      var smallBtn = document.getElementById('presetSmallBtn');
      if (largeBtn) largeBtn.classList.remove('selected');
      if (mediumBtn) mediumBtn.classList.remove('selected');
      if (smallBtn) smallBtn.classList.remove('selected');
      if (type === 'large' && largeBtn) largeBtn.classList.add('selected');
      if (type === 'medium' && mediumBtn) mediumBtn.classList.add('selected');
      if (type === 'small' && smallBtn) smallBtn.classList.add('selected');
    }

    function addManifestLine() {
      manifestLineCount++;
      renderManifestLines();
      calculateFormProgress();
    }

    function removeManifestLine(index) {
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });
      manifestData.splice(index - 1, 1);

      manifestLineCount--;
      if (manifestLineCount < 1) manifestLineCount = 1;

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
      calculateFormProgress();
    }

    function updateManifestTotals() {
  let totalSCU = 0;
  let totalUEC = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scu = parseInt(row.querySelector('.manifest-scu').value, 10);
    const uec = parseInt(row.querySelector('.manifest-uec').value, 10);
    if (!isNaN(scu)) totalSCU += scu;
    if (!isNaN(uec)) totalUEC += uec;
  });

  document.getElementById("totalSCUBox").textContent = `Total SCU: ${totalSCU.toLocaleString()}`;

  const totalUECInput = document.getElementById("totalUECBox");
  if (document.activeElement !== totalUECInput) {
    totalUECInput.value = totalUEC;
  }
  
  showGenerateButtonOnChange();
}

    function updateSecurityCaptainDropdowns(selectedShips) {
      const container = document.getElementById('securityShipCaptains');
      if (!container) return;
      
      container.innerHTML = '';
      
      const shipsArray = Array.isArray(selectedShips) ? selectedShips : [selectedShips];
      const validShips = shipsArray.filter(ship => ship && ship !== 'None' && ship.trim() !== '');
      
      validShips.forEach(ship => {
        let displayShipName = ship;
        let shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        
        if (ship === 'Other') {
          const otherInput = document.getElementById('securityShipsOther');
          const otherValue = otherInput ? otherInput.value.trim() : '';
          if (otherValue === '') {
            return;
          }
          displayShipName = otherValue;
          shipId = `Other_${otherValue.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`;
        }
        
        const row = document.createElement('div');
        row.className = 'security-captain-row';
        row.style.border = '2px solid #781d15';
        row.style.background = '#f9f9f9';
        row.style.padding = '15px';
        row.style.borderRadius = '8px';
        row.style.marginBottom = '15px';
        row.style.display = 'block';
        row.style.width = '100%';
        row.style.boxSizing = 'border-box';
        
        const shipHeader = document.createElement('h3');
        shipHeader.textContent = displayShipName;
        shipHeader.style.margin = '0 0 15px 0';
        shipHeader.style.padding = '0 0 5px 0';
        shipHeader.style.fontSize = '16px';
        shipHeader.style.fontWeight = 'bold';
        shipHeader.style.color = '#781d15';
        shipHeader.style.borderBottom = '1px solid #781d15';
        shipHeader.style.display = 'block';
        shipHeader.style.width = '100%';
        
        const captainSection = document.createElement('div');
        captainSection.style.marginLeft = '20px';
        captainSection.style.marginBottom = '15px';
        captainSection.style.display = 'block';
        captainSection.style.width = '100%';
        
        const label = document.createElement('label');
        label.textContent = 'Captain:';
        label.style.display = 'block';
        label.style.marginBottom = '5px';
        label.style.fontWeight = 'bold';
        label.style.fontSize = '14px';
        label.style.width = '100%';
        
        const dropdownDiv = document.createElement('div');
        dropdownDiv.className = 'searchable-dropdown';
        dropdownDiv.style.position = 'relative';
        dropdownDiv.style.width = '100%';
        dropdownDiv.style.marginBottom = '10px';
        dropdownDiv.style.display = 'block';
        
        const input = document.createElement('input');
        input.type = 'text';
        input.id = `securityCaptain_${shipId}`;
        input.placeholder = 'Click to select captain...';
        input.autocomplete = 'off';
        input.required = true;
        input.style.width = 'calc(100% - 10px)';
        input.style.padding = '8px';
        input.style.border = '1px solid #781d15';
        input.style.background = '#e2e2e2';
        input.style.color = '#230e09';
        input.style.borderRadius = '4px';
        input.style.boxSizing = 'border-box';
        
        const list = document.createElement('div');
        list.className = 'dropdown-list';
        list.id = `securityCaptain_${shipId}_List`;
        list.style.position = 'absolute';
        list.style.top = '100%';
        list.style.left = '0';
        list.style.right = '0';
        list.style.background = '#e2e2e2';
        list.style.border = '1px solid #781d15';
        list.style.borderTop = 'none';
        list.style.maxHeight = '150px';
        list.style.overflowY = 'auto';
        list.style.zIndex = '1000';
        list.style.display = 'none';
        list.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
        
        dropdownDiv.appendChild(input);
        dropdownDiv.appendChild(list);
        captainSection.appendChild(label);
        captainSection.appendChild(dropdownDiv);
        
        const crewSection = document.createElement('div');
        crewSection.style.marginLeft = '20px';
        crewSection.style.marginBottom = '15px';
        crewSection.style.display = 'block';
        crewSection.style.width = '100%';
        crewSection.style.clear = 'both';
        
        const crewLabel = document.createElement('label');
        crewLabel.textContent = 'Crew Amount:';
        crewLabel.style.display = 'block';
        crewLabel.style.marginBottom = '5px';
        crewLabel.style.fontWeight = 'bold';
        crewLabel.style.fontSize = '14px';
        crewLabel.style.width = '100%';
        
        const crewInput = document.createElement('input');
        crewInput.type = 'number';
        crewInput.id = `securityCrew_${shipId}`;
        crewInput.min = '0';
        crewInput.max = '20';
        crewInput.step = '1';
        crewInput.value = '0';
        crewInput.style.width = '100px';
        crewInput.style.padding = '8px';
        crewInput.style.border = '1px solid #781d15';
        crewInput.style.background = '#e2e2e2';
        crewInput.style.color = '#230e09';
        crewInput.style.borderRadius = '4px';
        crewInput.style.boxSizing = 'border-box';
        crewInput.style.fontSize = '14px';
        
        crewInput.addEventListener('input', function() {
          generateSecurityCrewInputs(shipId, displayShipName, parseInt(this.value, 10) || 0);
          calculateFormProgress();
          showGenerateButtonOnChange();
          updateSecurityShipSectionStyling(shipId);
        });
        
        crewSection.appendChild(crewLabel);
        crewSection.appendChild(crewInput);
        
        const crewNamesContainer = document.createElement('div');
        crewNamesContainer.className = 'security-crew-names';
        crewNamesContainer.id = `securityCrewNames_${shipId}`;
        crewNamesContainer.style.marginLeft = '20px';
        crewNamesContainer.style.display = 'block';
        crewNamesContainer.style.width = '100%';
        crewNamesContainer.style.clear = 'both';
        
        row.appendChild(shipHeader);
        row.appendChild(captainSection);
        row.appendChild(crewSection);
        row.appendChild(crewNamesContainer);
        container.appendChild(row);
        
        input.addEventListener('input', () => {
          updateSecurityShipSectionStyling(shipId);
        });
        input.addEventListener('change', () => {
          updateSecurityShipSectionStyling(shipId);
        });
        
        initializeCaptainDropdown(input, list, ship);
      });
      
      setTimeout(() => {
        updateAllSecurityShipStylings();
      }, 100);
    }
    
    function createSecurityShipElement(ship, shipId, container) {
      let displayShipName = ship;
      
      if (ship === 'Other') {
        const otherInput = document.getElementById('securityShipsOther');
        const otherValue = otherInput ? otherInput.value.trim() : '';
        if (otherValue === '') {
          return;
        }
        displayShipName = otherValue;
      }
    }
    
    function initializeCaptainDropdown(input, list, shipName) {
      const captainsArray = typeof captainNames !== 'undefined' ? captainNames : [
        "DyslexicNerd", "Spartan", "Lightblade", "jjetstreamm", "Roflnomish", 
        "BenjiNotorious", "zarainia", "Astol", "Venomnom", "BigDaddyTortuga", 
        "ItzProto", "Newt", "Xolion", "Bakes Kamuari", "LockEmUpJas", 
        "sadfish", "Efazer"
      ];
      const captainsWithOther = [...captainsArray, "Other"];
      
      function renderItems(captains) {
        list.innerHTML = '';
        captains.forEach(captain => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.style.padding = '6px 12px';
          item.style.cursor = 'pointer';
          item.style.borderBottom = '1px solid #ccc';
          item.style.background = '#e2e2e2';
          item.style.color = '#230e09';
          item.style.fontSize = '14px';
          item.textContent = captain;
          
          item.addEventListener('mouseenter', () => {
            item.style.background = '#d0d0d0';
          });
          
          item.addEventListener('mouseleave', () => {
            item.style.background = '#e2e2e2';
          });
          
          item.addEventListener('click', () => {
            if (captain === "Other") {
              const customName = prompt(`Enter captain name for ${shipName}:`);
              if (customName && customName.trim()) {
                input.value = customName.trim();
              } else {
                input.value = "";
              }
            } else {
              input.value = captain;
            }
            list.style.display = 'none';
            input.classList.remove('error');
            calculateFormProgress();
            showGenerateButtonOnChange();
            
            const shipId = input.id.replace('securityCaptain_', '');
            updateSecurityShipSectionStyling(shipId);
          });
          
          list.appendChild(item);
        });
      }
      
      function showDropdown() {
        renderItems(captainsWithOther);
        list.style.display = 'block';
      }
      
      function hideDropdown() {
        setTimeout(() => {
          list.style.display = 'none';
        }, 200);
      }
      
      function filterCaptains(searchTerm) {
        const term = searchTerm.toLowerCase();
        return captainsWithOther.filter(captain => 
          captain.toLowerCase().includes(term)
        );
      }
      
      input.addEventListener('click', (e) => {
        e.stopPropagation();
        showDropdown();
      });
      
      input.addEventListener('focus', () => {
        showDropdown();
      });
      
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        const filtered = searchTerm.length === 0 ? captainsWithOther : filterCaptains(searchTerm);
        renderItems(filtered);
        list.style.display = 'block';
        calculateFormProgress();
        showGenerateButtonOnChange();
      });
      
      input.addEventListener('blur', () => {
        hideDropdown();
      });
      
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !list.contains(e.target)) {
          list.style.display = 'none';
        }
      });
      
      renderItems(captainsWithOther);
    }
    
    function getSelectedSecurityShips() {
      const securityShipsInput = document.getElementById('securityShips');
      if (!securityShipsInput) return [];
      
      if (securityShipsInput.getSelectedShips) {
        return securityShipsInput.getSelectedShips();
      }
      
      const value = securityShipsInput.value.trim();
      if (value === '') return [];
      
      return [value];
    }
    
    function validateSecurityShips() {
      const securityShipsInput = document.getElementById('securityShips');
      if (!securityShipsInput) return false;
      
      if (securityShipsInput.getSelectedShips) {
        const selectedShips = securityShipsInput.getSelectedShips();
        return selectedShips.length > 0;
      }
      
      const value = securityShipsInput.value.trim();
      return value !== '';
    }

    window.addEventListener("DOMContentLoaded", function() {
      populateLocationDropdown("startLocation");
      populateLocationDropdown("routeStart");
      populateLocationDropdown("routeEnd");
      populateShipDropdown("");
      populateCaptainDropdown();
      populateSecurityShipsDropdown();
      
      const securityShipsOtherInput = document.getElementById('securityShipsOther');
      if (securityShipsOtherInput) {
        securityShipsOtherInput.addEventListener('input', function() {
          const securityShipsInput = document.getElementById('securityShips');
          if (securityShipsInput && securityShipsInput.getSelectedShips) {
            const selectedShips = securityShipsInput.getSelectedShips();
            if (selectedShips.includes('Other')) {
              updateSecurityCaptainDropdowns(selectedShips);
            }
          }
        });
      }
      
      document.getElementById("discordSection").style.display = "none";
      manifestLineCount = 1;
      renderManifestLines();
      renderHistory();
      calculateFormProgress();
      
      const formElements = document.querySelectorAll('input, select, textarea');
      formElements.forEach(element => {
        element.addEventListener('input', calculateFormProgress);
        element.addEventListener('change', calculateFormProgress);
        element.addEventListener('input', showGenerateButtonOnChange);
        element.addEventListener('change', showGenerateButtonOnChange);
      });
      
      const manifestContainer = document.getElementById('manifestLines');
      if (manifestContainer) {
        const observer = new MutationObserver(calculateFormProgress);
        observer.observe(manifestContainer, { childList: true, subtree: true });
      }
    });

    document.getElementById("orderCategory").addEventListener("change", function() {
      toggleOrderCategoryOther();
      populateShipDropdown(this.value);
    });
    document.getElementById("orderType").addEventListener("change", function() {
      toggleOrderTypeOther();

      const val = this.value;
      const presetsDiv = document.getElementById("resourceDrivePresets");
      if (val === "Resource Drive") {
        presetsDiv.style.display = "block";
      } else {
        presetsDiv.style.display = "none";
      }
    });

    document.getElementById("departureTime").addEventListener("change", function() {
      this.classList.remove('error');
      updateOrderDuration();
      showGenerateButtonOnChange();
    });
    
    document.getElementById("completionTime").addEventListener("change", function() {
      this.classList.remove('error');
      updateOrderDuration();
      showGenerateButtonOnChange();
    });

    function toDiscordTimestamp(dtString) {
      if (!dtString) return "";
      const date = new Date(dtString);
      if (isNaN(date.getTime())) return "";
      // Add 930 years (Updates to SC time automatically)
      const yearsToAdd = 930;
      date.setFullYear(date.getFullYear() + yearsToAdd);
      const unix = Math.floor(date.getTime() / 1000);
      return `<t:${unix}:f>`;
    }
    // Ship Message Links - Adapted from Threads
    const shipLinks = {
      "BRHS Seastrom": "https://discord.com/channels/900478857436606535/1391878505905524817/1404322180329898046",
      "AACS Judgements Bow": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319407106293843",
      "BRHS Sword of Twilight": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319218261954661",
      "BRHS Trireme": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319148888031312",
      "AACS Dendrobium": "https://discord.com/channels/900478857436606535/1391878505905524817/1403127587567439872",
      "WINCO Rafto": "https://discord.com/channels/900478857436606535/1391878505905524817/1398047073097482262",
      "BRHS Lednik": "https://discord.com/channels/900478857436606535/1391878505905524817/1398045703367823461",
      "SPRT Icarus": "https://discord.com/channels/900478857436606535/1391878505905524817/1396265862268190830",
      "AACS Feder": "https://discord.com/channels/900478857436606535/1391878505905524817/1393365523407835196",
      "AACS Landsknecht": "https://discord.com/channels/900478857436606535/1391878505905524817/1392713534005186730",
      "WINC Caterpillar": "https://discord.com/channels/900478857436606535/1391878505905524817/1391904347117322322",
      "BRHS Knight": "https://discord.com/channels/900478857436606535/1391878505905524817/1408243741508108501",
      "BRHS Ledokol": "https://discord.com/channels/900478857436606535/1391878505905524817/1409173959382925514",
    };

    function showLoadingOverlay(message = "Processing...") {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingOverlay';
      overlay.innerHTML = `
        <div class="loading-content">
          <div class="loading-spinner-large"></div>
          <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${message}</div>
          <div style="font-size: 14px; opacity: 0.8;">Please wait...</div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function showNotificationOverlay(message, type = 'info', duration = 0) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'notificationOverlay';
      
      let icon = '';
      let bgColor = '#781d15';
      let borderColor = '#9d7523';
      
      switch(type) {
        case 'success':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">✓</div>';
          bgColor = '#43b581';
          borderColor = '#2ea964';
          break;
        case 'error':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">⚠</div>';
          bgColor = '#ed4245';
          borderColor = '#b32428';
          break;
        case 'warning':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">⚠</div>';
          bgColor = '#faa61a';
          borderColor = '#e18d00';
          break;
        default:
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">ℹ</div>';
      }
      
      overlay.innerHTML = `
        <div class="loading-content" style="background: ${bgColor}; border-color: ${borderColor};">
          <button class="close-button" onclick="document.getElementById('notificationOverlay').remove()">×</button>
          ${icon}
          <div style="font-size: 16px; font-weight: bold; text-align: center; line-height: 1.4;">${message}</div>
        </div>
      `;
      document.body.appendChild(overlay);
      
    }

    function showLoadingMessage(message, autoCloseAfterMs = 0) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingMessageOverlay';
      
      overlay.innerHTML = `
        <div class="loading-content">
          <div class="loading-spinner-large"></div>
          <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${message}</div>
          <div style="font-size: 14px; opacity: 0.8;">Please wait...</div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      if (autoCloseAfterMs > 0) {
        setTimeout(() => {
          const loadingOverlay = document.getElementById('loadingMessageOverlay');
          if (loadingOverlay) {
            loadingOverlay.remove();
          }
        }, autoCloseAfterMs);
      }
      
      return overlay;
    }

    function hideLoadingMessage() {
      const overlay = document.getElementById('loadingMessageOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function showButtonLoading(buttonId, loadingText = null) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.add('button-loading');
        button.disabled = true;
        const originalHTML = button.innerHTML;
        button.setAttribute('data-original-html', originalHTML);
        
        if (loadingText) {
          button.innerHTML = `<div class="loading-spinner"></div>${loadingText}`;
        } else {
          button.innerHTML = `<div class="loading-spinner"></div>Processing...`;
        }
      }
    }

    function hideButtonLoading(buttonId) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.remove('button-loading');
        button.disabled = false;
        const originalHTML = button.getAttribute('data-original-html');
        if (originalHTML) {
          button.innerHTML = originalHTML;
          button.removeAttribute('data-original-html');
        }
      }
    }

    function showFeedback(type, message, duration = 5000) {
      const feedbackElement = type === 'success' ? 
        document.getElementById('successFeedback') : 
        document.getElementById('errorFeedback');
      const messageElement = type === 'success' ? 
        document.getElementById('successMessage') : 
        document.getElementById('errorMessage');
      
      if (feedbackElement && messageElement) {
        messageElement.textContent = message;
        feedbackElement.style.display = 'flex';
        
        setTimeout(() => {
          feedbackElement.style.display = 'none';
        }, duration);
      }
    }

    function calculateFormProgress() {
      const requiredFields = [
        'orderCategory', 'companyName', 'orderType', 'shipName', 'captainName',
        'crewAmount', 'startLocation', 'departureTime', 'routeStart', 'routeEnd',
        'completionTime'
      ];
      
      let filledFields = 0;
      let totalFields = requiredFields.length;
      
      for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        let isFieldValid = false;
        
        if (field) {
          if (fieldId === 'startLocation' || fieldId === 'routeStart' || fieldId === 'routeEnd') {
            isFieldValid = field.value && field.value.trim() !== '' && locations.includes(field.value);
          } 
          else if (fieldId === 'shipName') {
            isFieldValid = field.value && field.value.trim() !== '' && (allShips.includes(field.value) || field.value === 'Other');
          }
          else if (fieldId === 'captainName') {
            isFieldValid = field.value && field.value.trim() !== '' && (captainNames.includes(field.value) || field.value === 'Other');
          }
          else {
            isFieldValid = field.value && field.value.trim() !== '';
          }
          
          if (isFieldValid) {
            filledFields++;
          }
        }
      }
      
      const otherFieldChecks = [
        { select: 'orderCategory', other: 'orderCategoryOther' },
        { select: 'orderType', other: 'orderTypeOther' },
        { select: 'shipName', other: 'shipNameOther' },
        { select: 'captainName', other: 'captainNameOther' }
      ];
      
      for (const check of otherFieldChecks) {
        const selectField = document.getElementById(check.select);
        const otherField = document.getElementById(check.other);
        const otherDiv = document.getElementById(check.other + 'Div');
        
        if (selectField && selectField.value === 'Other' && otherDiv && otherDiv.style.display !== 'none') {
          totalFields++;
          if (otherField && otherField.value && otherField.value.trim() !== '') {
            filledFields++;
          }
        }
      }
      
      const crewAmount = parseInt(document.getElementById('crewAmount')?.value || '0', 10);
      if (crewAmount > 0) {
        totalFields += crewAmount;
        for (let i = 1; i <= crewAmount; i++) {
          const crewField = document.getElementById(`crewName${i}`);
          if (crewField && crewField.value && crewField.value.trim() !== '') {
            filledFields++;
          }
        }
      }
      
      const selectedSecurityShips = getSelectedSecurityShips();
      const hasNonNoneSecurityShips = selectedSecurityShips.some(ship => ship && ship !== 'None');
      
      if (hasNonNoneSecurityShips) {
        totalFields++;
        if (validateSecurityShips()) {
          filledFields++;
        }
      }
      
      const validSecurityShips = selectedSecurityShips.filter(ship => ship && ship !== 'None' && ship !== 'Other' && ship.trim() !== '');
      totalFields += validSecurityShips.length;
      validSecurityShips.forEach(ship => {
        const shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        const captainInput = document.getElementById(`securityCaptain_${shipId}`);
        if (captainInput && captainInput.value && captainInput.value.trim() !== '') {
          filledFields++;
        }
      });

      const securityShipsInput = document.getElementById('securityShips');
      const securityShipsOtherDiv = document.getElementById('securityShipsOtherDiv');
      const securityShipsOtherInput = document.getElementById('securityShipsOther');
      if (securityShipsInput && securityShipsInput.value === "Other" && securityShipsOtherDiv && securityShipsOtherDiv.style.display !== 'none') {
        totalFields++;
        if (securityShipsOtherInput && securityShipsOtherInput.value && securityShipsOtherInput.value.trim() !== '') {
          filledFields++;
        }
      }
      
      const manifestRows = document.querySelectorAll('.manifest-row');
      let hasValidManifest = false;
      manifestRows.forEach(row => {
        const material = row.querySelector('.manifest-material');
        if (material && material.value && material.value.trim() !== '' && material.value !== 'Select Material') {
          hasValidManifest = true;
        }
      });
      
      if (hasValidManifest) {
        filledFields++;
      }
      totalFields++; 
      const percentage = Math.round((filledFields / totalFields) * 100);
      

      const progressFill = document.getElementById('formProgressFill');
      const progressText = document.getElementById('formProgressText');
      
      if (progressFill) {
        progressFill.style.width = `${percentage}%`;
      }
      
      if (progressText) {
        progressText.textContent = `Form Completion: ${percentage}%`;
      }
      

      updateFormStepStates();
      
      return percentage;
    }

    function updateFormStepStates() {
      const steps = [
        {
          id: 'basicInfoStep',
          fields: ['orderCategory', 'companyName', 'orderType', 'shipName', 'captainName', 'crewAmount']
        },
        {
          id: 'securityShipsStep',
          fields: []
        },
        {
          id: 'locationTimeStep',
          fields: ['startLocation', 'departureTime', 'routeStart', 'routeEnd']
        },
        {
          id: 'manifestStep',
          fields: []
        },
        {
          id: 'completionStep',
          fields: ['completionTime']
        }
      ];
      
      steps.forEach(step => {
        const stepElement = document.getElementById(step.id);
        if (!stepElement) return;
        
        let completedFields = 0;
        let totalStepFields = step.fields.length;
        
        if (step.id === 'manifestStep') {
          const manifestRows = document.querySelectorAll('.manifest-row');
          let hasValidManifest = false;
          manifestRows.forEach(row => {
            const material = row.querySelector('.manifest-material');
            if (material && material.value && material.value.trim() !== '' && material.value !== 'Select Material') {
              hasValidManifest = true;
            }
          });
          completedFields = hasValidManifest ? 1 : 0;
          totalStepFields = 1;
        } else if (step.id === 'securityShipsStep') {
          if (validateSecurityShips()) {
            completedFields = 1;
            
            const selectedSecurityShips = getSelectedSecurityShips();
            const validSecurityShips = selectedSecurityShips.filter(ship => ship && ship !== 'None' && ship.trim() !== '');
            
            let securityShipFieldsCompleted = 0;
            let totalSecurityFields = 0;
            
            validSecurityShips.forEach(ship => {
              let shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
              
              if (ship === 'Other') {
                const otherInput = document.getElementById('securityShipsOther');
                const otherValue = otherInput ? otherInput.value.trim() : '';
                if (otherValue === '') return;
                shipId = `Other_${otherValue.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`;
              }
              
              totalSecurityFields++;
              const captainInput = document.getElementById(`securityCaptain_${shipId}`);
              if (captainInput && captainInput.value.trim()) {
                securityShipFieldsCompleted++;
              }
              
              const crewAmountInput = document.getElementById(`securityCrew_${shipId}`);
              if (crewAmountInput) {
                const securityCrewAmount = parseInt(crewAmountInput.value, 10);
                if (!isNaN(securityCrewAmount) && securityCrewAmount > 0) {
                  totalSecurityFields += securityCrewAmount;
                  for (let i = 1; i <= securityCrewAmount; i++) {
                    const crewInput = document.getElementById(`securityCrew_${shipId}_${i}`);
                    if (crewInput && crewInput.value.trim()) {
                      securityShipFieldsCompleted++;
                    }
                  }
                }
              }
            });
            
            completedFields = securityShipFieldsCompleted;
            totalStepFields = Math.max(totalSecurityFields, 1);
          } else {
            completedFields = 0;
            totalStepFields = 1;
          }
        } else {
          
          for (const fieldId of step.fields) {
            const field = document.getElementById(fieldId);
            let isFieldValid = false;
            
            if (field) {

              if (fieldId === 'startLocation' || fieldId === 'routeStart' || fieldId === 'routeEnd') {
                isFieldValid = field.value && field.value.trim() !== '';
              } else {
                isFieldValid = field.value && field.value.trim() !== '';
              }
              
              if (isFieldValid) {
                completedFields++;
              }
            }
          }
          
          if (step.id === 'basicInfoStep') {
            const crewAmount = parseInt(document.getElementById('crewAmount')?.value || '0', 10);
            if (crewAmount > 0) {
              totalStepFields += crewAmount;
              for (let i = 1; i <= crewAmount; i++) {
                const crewField = document.getElementById(`crewName${i}`);
                if (crewField && crewField.value && crewField.value.trim() !== '') {
                  completedFields++;
                }
              }
            }
            
            const otherFieldChecks = [
              { select: 'orderCategory', other: 'orderCategoryOther' },
              { select: 'orderType', other: 'orderTypeOther' },
              { select: 'shipName', other: 'shipNameOther' },
              { select: 'captainName', other: 'captainNameOther' }
            ];
            
            for (const check of otherFieldChecks) {
              const selectField = document.getElementById(check.select);
              const otherField = document.getElementById(check.other);
              const otherDiv = document.getElementById(check.other + 'Div');
              
              if (selectField && selectField.value === 'Other' && otherDiv && otherDiv.style.display !== 'none') {
                totalStepFields++;
                if (otherField && otherField.value && otherField.value.trim() !== '') {
                  completedFields++;
                }
              }
            }
          }
        }
        
        stepElement.classList.remove('active', 'completed');
        if (completedFields === totalStepFields && completedFields > 0) {
          stepElement.classList.add('completed');
        } else if (completedFields > 0) {
          stepElement.classList.add('active');
        }
      });
    }

    function toggleOrderCategoryOther() {
      const val = document.getElementById("orderCategory").value;
      const otherDiv = document.getElementById("orderCategoryOtherDiv");
      if (val === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderCategoryOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("orderCategoryOther").required = false;
      }
    }

    function toggleOrderTypeOther() {
      const orderType = document.getElementById("orderType").value;
      const otherDiv = document.getElementById("orderTypeOtherDiv");
      const resourceDriveDiv = document.getElementById("resourceDriveCompanyDiv");
      if (orderType === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderTypeOther").required = true;
        resourceDriveDiv.style.display = "none";
        document.getElementById("resourceDriveCompany").required = false;
      } else if (orderType === "Resource Drive") {
        resourceDriveDiv.style.display = "block";
        document.getElementById("resourceDriveCompany").required = true;
        otherDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
      } else {
        otherDiv.style.display = "none";
        resourceDriveDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
        document.getElementById("resourceDriveCompany").required = false;
      }
    }

    function toggleShipNameOther() {
      const shipName = document.getElementById("shipName").value;
      const otherDiv = document.getElementById("shipNameOtherDiv");
      if (shipName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("shipNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("shipNameOther").required = false;
      }
    }

    function toggleCaptainNameOther() {
      const captainName = document.getElementById("captainName").value;
      const otherDiv = document.getElementById("captainNameOtherDiv");
      if (captainName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("captainNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("captainNameOther").required = false;
      }
    }

    function generateCrewInputs() {
      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      const crewNamesDiv = document.getElementById("crewNamesDiv");
      crewNamesDiv.innerHTML = "";
      if (!isNaN(crewAmount) && crewAmount > 0) {
        for (let i = 1; i <= crewAmount; i++) {
          const label = document.createElement("label");
          label.textContent = `Crew ${i} Name:`;
          label.htmlFor = `crewName${i}`;
          label.className = "crew-label";
          const input = document.createElement("input");
          input.type = "text";
          input.id = `crewName${i}`;
          input.name = `crewName${i}`;
          input.required = true;
          input.className = "crew-input";
          input.addEventListener('input', calculateFormProgress);
          input.addEventListener('change', calculateFormProgress);
          crewNamesDiv.appendChild(label);
          crewNamesDiv.appendChild(input);
        }
      }
      calculateFormProgress();
    }

    function generateSecurityCrewInputs(shipId, shipName, crewAmount) {
      const crewNamesContainer = document.getElementById(`securityCrewNames_${shipId}`);
      if (!crewNamesContainer) return;
      
      crewNamesContainer.innerHTML = "";
      
      if (!isNaN(crewAmount) && crewAmount > 0) {
        const crewNamesHeader = document.createElement("label");
        crewNamesHeader.textContent = "Crew Names:";
        crewNamesHeader.style.display = 'block';
        crewNamesHeader.style.marginBottom = '10px';
        crewNamesHeader.style.fontWeight = 'bold';
        crewNamesHeader.style.fontSize = '14px';
        crewNamesContainer.appendChild(crewNamesHeader);
        
        for (let i = 1; i <= crewAmount; i++) {
          const label = document.createElement("label");
          label.textContent = `Crew ${i} Name:`;
          label.htmlFor = `securityCrew_${shipId}_${i}`;
          label.className = "crew-label";
          label.style.fontSize = '14px';
          label.style.marginTop = '8px';
          label.style.display = 'block';
          label.style.marginLeft = '20px';
          
          const input = document.createElement("input");
          input.type = "text";
          input.id = `securityCrew_${shipId}_${i}`;
          input.name = `securityCrew_${shipId}_${i}`;
          input.required = true;
          input.className = "crew-input";
          input.style.width = 'calc(100% - 40px)';
          input.style.marginLeft = '20px';
          input.style.padding = '8px';
          input.style.border = '1px solid #781d15';
          input.style.background = '#e2e2e2';
          input.style.color = '#230e09';
          input.style.borderRadius = '4px';
          input.style.boxSizing = 'border-box';
          input.style.marginBottom = '5px';
          input.style.fontSize = '14px';
          
          input.addEventListener('input', calculateFormProgress);
          input.addEventListener('change', calculateFormProgress);
          input.addEventListener('input', showGenerateButtonOnChange);
          input.addEventListener('change', showGenerateButtonOnChange);
          input.addEventListener('input', () => {
            const shipIdFromInput = input.id.split('_').slice(1, -1).join('_');
            updateSecurityShipSectionStyling(shipIdFromInput);
          });
          input.addEventListener('change', () => {
            const shipIdFromInput = input.id.split('_').slice(1, -1).join('_');
            updateSecurityShipSectionStyling(shipIdFromInput);
          });
          
          crewNamesContainer.appendChild(label);
          crewNamesContainer.appendChild(input);
        }
      }
      calculateFormProgress();
      updateSecurityShipSectionStyling(shipId);
    }

    function checkSecurityShipCompletion(shipId) {
      const captainInput = document.getElementById(`securityCaptain_${shipId}`);
      const crewAmountInput = document.getElementById(`securityCrew_${shipId}`);
      
      if (!captainInput || !crewAmountInput) return false;
      
      const hasCaptain = captainInput.value.trim() !== '';
      
      const crewAmount = parseInt(crewAmountInput.value, 10) || 0;
      const hasCrewAmount = crewAmount >= 0;
      
      let allCrewNamesFilled = true;
      if (crewAmount > 0) {
        for (let i = 1; i <= crewAmount; i++) {
          const crewInput = document.getElementById(`securityCrew_${shipId}_${i}`);
          if (!crewInput || crewInput.value.trim() === '') {
            allCrewNamesFilled = false;
            break;
          }
        }
      }
      
      return hasCaptain && hasCrewAmount && allCrewNamesFilled;
    }
    
    function updateSecurityShipSectionStyling(shipId) {
      const allRows = document.querySelectorAll('#securityShipCaptains .security-captain-row');
      for (let row of allRows) {
        if (row.querySelector(`#securityCaptain_${shipId}`)) {
          const isComplete = checkSecurityShipCompletion(shipId);
          if (isComplete) {
            row.style.border = '2px solid #22c55e';
          } else {
            row.style.border = '2px solid #781d15';
          }
          return;
        }
      }
    }
    
    function updateAllSecurityShipStylings() {
      const allCaptainInputs = document.querySelectorAll('[id^="securityCaptain_"]');
      allCaptainInputs.forEach(input => {
        const shipId = input.id.replace('securityCaptain_', '');
        updateSecurityShipSectionStyling(shipId);
      });
    }

    window.toggleOrderTypeOther = toggleOrderTypeOther;
    window.toggleOrderCategoryOther = toggleOrderCategoryOther;
    window.toggleShipNameOther = toggleShipNameOther;
    window.toggleCaptainNameOther = toggleCaptainNameOther;
    window.generateCrewInputs = generateCrewInputs;
    window.generateSecurityCrewInputs = generateSecurityCrewInputs;
    window.checkSecurityShipCompletion = checkSecurityShipCompletion;
    window.updateSecurityShipSectionStyling = updateSecurityShipSectionStyling;
    window.updateAllSecurityShipStylings = updateAllSecurityShipStylings;
    window.updateSecurityCaptainDropdowns = updateSecurityCaptainDropdowns;
    window.initializeCaptainDropdown = initializeCaptainDropdown;
    window.addManifestLine = addManifestLine;
    window.removeManifestLine = removeManifestLine;
    window.updateManifestTotals = updateManifestTotals;
    window.generateOutput = generateOutput;
    window.copyDiscordOutput = copyDiscordOutput;
    window.toggleDiscordOutput = toggleDiscordOutput;
    window.showCopyButton = showCopyButton;
    window.hideCopyButton = hideCopyButton;
    window.showGenerateButtonOnChange = showGenerateButtonOnChange;
    window.clearFormFields = clearFormFields;
    window.applyManifestPreset = applyManifestPreset;

    function validateRequiredFields() {
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      const requiredFields = [
        "orderCategory",
        "companyName",
        "orderType",
        "shipName",
        "captainName",
        "crewAmount",
        "startLocation",
        "departureTime",
        "routeStart",
        "routeEnd",
        "completionTime",
        "repairs",
        "restock",
        "quantumFuel",
        "hydrogenFuel",
        "crewCosts",
        "totalUECBox"
      ];
      requiredFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => el.classList.remove('error'));
      el.addEventListener('change', () => el.classList.remove('error'));
    }
  });

  document.querySelectorAll('.manifest-scu, .manifest-material, .crew-input').forEach(el => {
    el.addEventListener('input', () => el.classList.remove('error'));
    el.addEventListener('change', () => el.classList.remove('error'));
  });

  let allErrors = [];
  let firstErrorElement = null;

  function addError(element, message, fieldName) {
    if (element) {
      element.classList.add('error');
      if (!firstErrorElement) firstErrorElement = element;
    }
    allErrors.push({ element, message, fieldName });
  }

  for (const id of requiredFields) {
    const el = document.getElementById(id);
    let isValid = false;
    let fieldLabel = id.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
    
    if (id === 'totalUECBox') {
      fieldLabel = 'Total UEC Box';
    }
    
    if (!el) continue;
    
    if (id === 'startLocation' || id === 'routeStart' || id === 'routeEnd') {
      if (el.value.trim() === "") {
        addError(el, `${fieldLabel} is required`, fieldLabel);
      } else if (!locations.includes(el.value)) {
        addError(el, `${fieldLabel} must be a valid location from the dropdown`, fieldLabel);
      }
    } else {
      if (el.value === "" || el.value === null) {
        addError(el, `${fieldLabel} is required`, fieldLabel);
      }
    }
  }

  const routeStartEl = document.getElementById('routeStart');
  const routeEndEl = document.getElementById('routeEnd');
  if (routeStartEl && routeEndEl && routeStartEl.value && routeEndEl.value) {
    if (routeStartEl.value === routeEndEl.value) {
      routeStartEl.classList.add('error');
      routeEndEl.classList.add('error');
      addError(routeStartEl, 'Route Start and Route End cannot be the same location', 'Route Validation');
    }
  }

  const otherFields = [
    {select: "orderCategory", other: "orderCategoryOtherDiv", input: "orderCategoryOther", label: "Order Category (Other)"},
    {select: "orderType", other: "orderTypeOtherDiv", input: "orderTypeOther", label: "Order Type (Other)"},
    {select: "shipName", other: "shipNameOtherDiv", input: "shipNameOther", label: "Ship Name (Other)"},
    {select: "captainName", other: "captainNameOtherDiv", input: "captainNameOther", label: "Captain Name (Other)"}
  ];
  
  for (const field of otherFields) {
    const selectEl = document.getElementById(field.select);
    const otherDiv = document.getElementById(field.other);
    const otherInput = document.getElementById(field.input);
    if (selectEl && selectEl.value === "Other" && otherDiv && otherDiv.style.display === "block") {
      if (!otherInput || !otherInput.value.trim()) {
        addError(otherInput, `${field.label} is required when "Other" is selected`, field.label);
      }
    }
  }

  const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
  if (!isNaN(crewAmount) && crewAmount > 0) {
    for (let i = 1; i <= crewAmount; i++) {
      const crewInput = document.getElementById(`crewName${i}`);
      if (!crewInput || !crewInput.value.trim()) {
        addError(crewInput, `Crew ${i} Name is required`, `Crew ${i} Name`);
      }
    }
  }

  const selectedSecurityShips = getSelectedSecurityShips();
  const validSecurityShips = selectedSecurityShips.filter(ship => ship && ship !== 'None' && ship.trim() !== '');
  
  validSecurityShips.forEach(ship => {
    let shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
    let displayShipName = ship;
    
    if (ship === 'Other') {
      const otherInput = document.getElementById('securityShipsOther');
      const otherValue = otherInput ? otherInput.value.trim() : '';
      if (otherValue === '') {
        return;
      }
      displayShipName = otherValue;
      shipId = `Other_${otherValue.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`;
    }
    
    const captainInput = document.getElementById(`securityCaptain_${shipId}`);
    if (!captainInput || !captainInput.value.trim()) {
      addError(captainInput, `Captain name is required for ${displayShipName}`, `${displayShipName} Captain`);
    }
    
    const crewAmountInput = document.getElementById(`securityCrew_${shipId}`);
    if (crewAmountInput) {
      const securityCrewAmount = parseInt(crewAmountInput.value, 10);
      if (!isNaN(securityCrewAmount) && securityCrewAmount > 0) {
        for (let i = 1; i <= securityCrewAmount; i++) {
          const crewInput = document.getElementById(`securityCrew_${shipId}_${i}`);
          if (!crewInput || !crewInput.value.trim()) {
            addError(crewInput, `${displayShipName} Crew ${i} Name is required`, `${displayShipName} Crew ${i} Name`);
          }
        }
      }
    }
  });

  if (!validateSecurityShips()) {
    const securityShipsInput = document.getElementById('securityShips');
    addError(securityShipsInput, "Security ships selection is required", "Security Ships");
  }

  const securityShipsOtherDiv = document.getElementById('securityShipsOtherDiv');
  const securityShipsOtherInput = document.getElementById('securityShipsOther');
  
  if (selectedSecurityShips.includes("Other") && securityShipsOtherDiv && securityShipsOtherDiv.style.display === "block") {
    if (!securityShipsOtherInput || !securityShipsOtherInput.value.trim()) {
      addError(securityShipsOtherInput, "Security Ships (Other) is required when 'Other' is selected", "Security Ships (Other)");
    }
  }

  const manifestRows = document.querySelectorAll('.manifest-row');
  if (manifestRows.length === 0) {
    allErrors.push({ 
      element: null, 
      message: "At least one manifest line is required", 
      fieldName: "Manifest" 
    });
  } else {
    let manifestIndex = 1;
    for (const row of manifestRows) {
      const scu = row.querySelector('.manifest-scu');
      const mat = row.querySelector('.manifest-material');
      
      if (!scu || !scu.value.trim()) {
        addError(scu, `Manifest Line ${manifestIndex}: SCU is required`, `Manifest Line ${manifestIndex} SCU`);
      }
      if (!mat || !mat.value.trim() || mat.value === 'Select Material') {
        addError(mat, `Manifest Line ${manifestIndex}: Material is required`, `Manifest Line ${manifestIndex} Material`);
      }
      manifestIndex++;
    }
  }

  const timestampErrors = validateTimestampsDetailed();
  if (timestampErrors.length > 0) {
    allErrors.push(...timestampErrors);
  }

  if (allErrors.length > 0) {
    if (firstErrorElement) {
      firstErrorElement.scrollIntoView({behavior: "smooth", block: "center"});
    }
    
    const errorsByCategory = {
      'Basic Information': [],
      'Security Ships': [],
      'Route & Timing': [],
      'Crew Information': [],
      'Manifest': [],
      'Financial Information': [],
      'Other': []
    };
    
    allErrors.forEach(error => {
      const fieldName = error.fieldName.toLowerCase();
      if (fieldName.includes('category') || fieldName.includes('company') || fieldName.includes('type') || fieldName.includes('ship name') || fieldName.includes('captain name')) {
        errorsByCategory['Basic Information'].push(error.message);
      } else if (fieldName.includes('security')) {
        errorsByCategory['Security Ships'].push(error.message);
      } else if (fieldName.includes('location') || fieldName.includes('route') || fieldName.includes('time') || fieldName.includes('timestamp')) {
        errorsByCategory['Route & Timing'].push(error.message);
      } else if (fieldName.includes('crew')) {
        errorsByCategory['Crew Information'].push(error.message);
      } else if (fieldName.includes('manifest')) {
        errorsByCategory['Manifest'].push(error.message);
      } else if (fieldName.includes('repair') || fieldName.includes('restock') || fieldName.includes('fuel') || fieldName.includes('cost') || fieldName.includes('uec')) {
        errorsByCategory['Financial Information'].push(error.message);
      } else {
        errorsByCategory['Other'].push(error.message);
      }
    });
    
    let validationMessage = `Form Validation Issues<br><br><strong>Please fix the following ${allErrors.length} issue${allErrors.length === 1 ? '' : 's'}:</strong><br><br>`;
    
    Object.keys(errorsByCategory).forEach(category => {
      if (errorsByCategory[category].length > 0) {
        validationMessage += `<strong>${category}:</strong><br>`;
        errorsByCategory[category].forEach(error => {
          validationMessage += `• ${error}<br>`;
        });
        validationMessage += '<br>';
      }
    });
    
    validationMessage += '<small style="opacity: 0.8;">Fields with issues are highlighted in red.</small>';
    
    showNotificationOverlay(validationMessage, 'warning');
    return false;
  }
  
  return true;
}

    function copyDiscordOutput() {
      const discordOutput = document.getElementById("discordOutput");
      discordOutput.select();
      discordOutput.setSelectionRange(0, 99999);
      document.execCommand("copy");
      showNotificationOverlay("Discord post copied to clipboard!", 'success');
    }

    function toggleDiscordOutput() {
      const container = document.getElementById("discordOutputContainer");
      const icon = document.getElementById("toggleOutputIcon");
      const text = document.getElementById("toggleOutputText");
      
      if (container.style.display === "none") {
        container.style.display = "block";
        icon.textContent = "▼";
        text.textContent = "Hide Generated Output";
      } else {
        container.style.display = "none";
        icon.textContent = "▶";
        text.textContent = "Show Generated Output";
      }
    }

    function showCopyButton() {
      const copyBtn = document.getElementById("copyDiscordBtn");
      if (copyBtn) {
        copyBtn.style.display = "inline-flex";
      }
    }

    function hideCopyButton() {
      const copyBtn = document.getElementById("copyDiscordBtn");
      if (copyBtn) {
        copyBtn.style.display = "none";
      }
    }

    function showGenerateButtonOnChange() {
      const generateBtn = document.getElementById("generateBtn");
      if (generateBtn && generateBtn.style.display === "none") {
        generateBtn.style.display = "inline-flex";
      }
    }

    function updateOrderDuration() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      const durationDiv = document.getElementById("orderDuration");
      if (!dep || !comp) {
        durationDiv.textContent = "";
        return;
      }
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) {
        durationDiv.textContent = "";
        return;
      }
      let diffMs = compDate - depDate;
      if (diffMs < 0) {
        durationDiv.textContent = "Completion time is before departure!";
        durationDiv.style.color = "#ed4245";
        return;
      }
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      durationDiv.textContent = `Order Duration: ${hours}h ${mins}m`;
      durationDiv.style.color = "#9d7523";
    }

    function setCurrentTime(fieldId) {
      try {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        const timeString = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        const field = document.getElementById(fieldId);
        if (field) {
          field.value = timeString;
          field.classList.remove('error');
          updateOrderDuration();
          
          console.log(`✓ Time set for ${fieldId}: ${timeString}`);
        } else {
          throw new Error(`Field with ID '${fieldId}' not found`);
        }
      } catch (error) {
        console.error('Error setting current time:', error);
        handleError('Failed to set current time', error, { fieldId });
      }
    }

    window.setCurrentTime = setCurrentTime;

    function handleError(message, error = null, context = {}) {
      const errorInfo = {
        message,
        error: error ? {
          name: error.name,
          message: error.message,
          stack: error.stack
        } : null,
        context,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href
      };
      
      console.error('Enhanced Error Log:', errorInfo);
      
      let userMessage = message;
      let suggestions = [];
      
      if (error) {
        switch (error.name) {
          case 'TypeError':
            if (error.message.includes('null') || error.message.includes('undefined')) {
              userMessage = 'A required field or element was not found.';
              suggestions.push('Please refresh the page and try again.');
              suggestions.push('Ensure all required fields are properly filled.');
            }
            break;
          case 'ReferenceError':
            userMessage = 'A programming error occurred.';
            suggestions.push('Please refresh the page.');
            suggestions.push('If the problem persists, contact support.');
            break;
          case 'NetworkError':
          case 'Failed to fetch':
            userMessage = 'Network connection error.';
            suggestions.push('Check your internet connection.');
            suggestions.push('Try again in a few moments.');
            break;
        }
      }
      
      if (message.includes('timestamp') || message.includes('time')) {
        suggestions.push('Ensure your system clock is set correctly.');
        suggestions.push('Try clicking the "Now" button instead of manual entry.');
      }
      
      if (message.includes('validation') || message.includes('required')) {
        suggestions.push('Check that all required fields are filled.');
        suggestions.push('Look for fields highlighted in red.');
      }
      
      const fullMessage = suggestions.length > 0 
        ? `${userMessage}<br><br><strong>Suggestions:</strong><br>• ${suggestions.join('<br>• ')}`
        : userMessage;
      
      showNotificationOverlay(fullMessage, 'error');
      
      const recentErrors = JSON.parse(localStorage.getItem('bruteHaulErrors') || '[]');
      recentErrors.push(errorInfo);
      
      if (recentErrors.length > 20) {
        recentErrors.splice(0, recentErrors.length - 20);
      }
      
      localStorage.setItem('bruteHaulErrors', JSON.stringify(recentErrors));
    }


    function validateTimestamps() {
      const departureField = document.getElementById('departureTime');
      const completionField = document.getElementById('completionTime');
      
      if (!departureField.value || !completionField.value) {
        return false;
      }
      
      try {
        const depDate = new Date(departureField.value);
        const compDate = new Date(completionField.value);
        
        if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) {
          handleError('Invalid timestamp format detected', null, { 
            departure: departureField.value, 
            completion: completionField.value 
          });
          return false;
        }
        
        if (compDate <= depDate) {
          const timeDiff = Math.abs(compDate - depDate) / (1000 * 60); // minutes
          handleError(
            `Completion time must be after departure time.<br><br>Current difference: ${Math.round(timeDiff)} minutes backwards.`, 
            null, 
            { departure: departureField.value, completion: completionField.value }
          );
          completionField.classList.add('error');
          return false;
        }
        
        const now = new Date();
        const oneYearFromNow = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000));
        
        if (depDate > oneYearFromNow || compDate > oneYearFromNow) {
          handleError('Timestamps appear to be set too far in the future. Please verify the dates.', null, {
            departure: departureField.value,
            completion: completionField.value
          });
          return false;
        }
        
        return true;
      } catch (error) {
        handleError('Error validating timestamps', error, {
          departure: departureField.value,
          completion: completionField.value
        });
        return false;
      }
    }

    function validateTimestampsDetailed() {
      const errors = [];
      const departureField = document.getElementById('departureTime');
      const completionField = document.getElementById('completionTime');
      
      if (!departureField.value || !completionField.value) {
        return errors;
      }
      
      try {
        const depDate = new Date(departureField.value);
        const compDate = new Date(completionField.value);
        
        if (isNaN(depDate.getTime())) {
          departureField.classList.add('error');
          errors.push({
            element: departureField,
            message: 'Departure timestamp has invalid format',
            fieldName: 'Departure Time'
          });
        }
        
        if (isNaN(compDate.getTime())) {
          completionField.classList.add('error');
          errors.push({
            element: completionField,
            message: 'Completion timestamp has invalid format',
            fieldName: 'Completion Time'
          });
        }
        
        if (!isNaN(depDate.getTime()) && !isNaN(compDate.getTime())) {
          if (compDate <= depDate) {
            const timeDiff = Math.abs(compDate - depDate) / (1000 * 60); // minutes
            completionField.classList.add('error');
            errors.push({
              element: completionField,
              message: `Completion time must be after departure time (currently ${Math.round(timeDiff)} minutes before departure)`,
              fieldName: 'Completion Time'
            });
          }
          
          const now = new Date();
          const oneYearFromNow = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000));
          
          if (depDate > oneYearFromNow) {
            departureField.classList.add('error');
            errors.push({
              element: departureField,
              message: 'Departure time appears to be set too far in the future',
              fieldName: 'Departure Time'
            });
          }
          
          if (compDate > oneYearFromNow) {
            completionField.classList.add('error');
            errors.push({
              element: completionField,
              message: 'Completion time appears to be set too far in the future',
              fieldName: 'Completion Time'
            });
          }
        }
        
        return errors;
      } catch (error) {
        console.error('Error validating timestamps:', error);
        errors.push({
          element: null,
          message: 'Error occurred while validating timestamps',
          fieldName: 'Timestamps'
        });
        return errors;
      }
    }

    function getOrderDurationText() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      if (!dep || !comp) return "";
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) return "";
      let diffMs = compDate - depDate;
      if (diffMs < 0) return "";
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      return `Order Duration: ${hours}h ${mins}m`;
    }

    function generateOutput() {
  if (!validateRequiredFields()) return;

  showButtonLoading('generateBtn', 'Generating...');
  showLoadingOverlay('Generating Discord post...');

  setTimeout(() => {
    try {
      const get = id => document.getElementById(id)?.value?.trim() || "";
      const departureDiscord = toDiscordTimestamp(get("departureTime"));
      const completionDiscord = toDiscordTimestamp(get("completionTime"));

  let orderCategoryText = get("orderCategory");
  if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");

  let companyNameText = get("companyName");

  let orderTypeText = get("orderType");
  if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");

  let resourceDriveCompanyText = "";
  if (orderTypeText === "Resource Drive") {
    resourceDriveCompanyText = document.getElementById("resourceDriveCompany").value || "";
  }

  let shipNameText = get("shipName");
  if (shipNameText === "Other") shipNameText = get("shipNameOther");

  let captainNameText = get("captainName");
  if (captainNameText === "Other") captainNameText = get("captainNameOther");

  const shipLink = shipLinks[shipNameText];

  const crewAmount = parseInt(get("crewAmount"), 10);
  let crewNamesList = [];
  for (let i = 1; i <= crewAmount; i++) {
    const crewInput = document.getElementById(`crewName${i}`);
    if (crewInput && crewInput.value.trim()) {
      crewNamesList.push(crewInput.value.trim());
    }
  }
  let postCounter = parseInt(sessionStorage.getItem('discordHistoryCounter') || '1', 10);
  const crewNamesText = crewNamesList.length > 0 ? crewNamesList.join(", ") : "0";

  const selectedSecurityShips = getSelectedSecurityShips();
  let securityShipsText = "";
  let securityShipsHeader = "Security Ships";
  
  if (selectedSecurityShips.length === 0 || (selectedSecurityShips.length === 1 && selectedSecurityShips[0] === '')) {
    securityShipsText = "None";
  } else if (selectedSecurityShips.includes('None')) {
    securityShipsText = "None";
  } else {
    const securityShipDetails = [];
    let shipCounter = 1;
    
    selectedSecurityShips.forEach(ship => {
      if (ship === 'Other') {
        const otherInput = document.getElementById('securityShipsOther');
        const otherValue = otherInput ? otherInput.value.trim() : '';
        if (otherValue) {
          const shipId = `Other_${otherValue.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`;
          const captainInput = document.getElementById(`securityCaptain_${shipId}`);
          const captainName = captainInput ? captainInput.value.trim() : '';
          
          const crewAmountInput = document.getElementById(`securityCrew_${shipId}`);
          const crewAmount = crewAmountInput ? parseInt(crewAmountInput.value, 10) || 0 : 0;
          let crewNames = [];
          if (crewAmount > 0) {
            for (let i = 1; i <= crewAmount; i++) {
              const crewInput = document.getElementById(`securityCrew_${shipId}_${i}`);
              if (crewInput && crewInput.value.trim()) {
                crewNames.push(crewInput.value.trim());
              }
            }
          }
          
          let shipText = `${otherValue}`;
          if (captainName) shipText += `\n**Captain:** ${captainName}`;
          if (crewNames.length > 0) shipText += `\n**Crew:** ${crewNames.join(", ")}`;
          
          securityShipDetails.push(shipText);
          shipCounter++;
        }
      } else if (ship && ship.trim() !== '' && ship !== 'None') {
        const shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        const captainInput = document.getElementById(`securityCaptain_${shipId}`);
        const captainName = captainInput ? captainInput.value.trim() : '';
        
        const crewAmountInput = document.getElementById(`securityCrew_${shipId}`);
        const crewAmount = crewAmountInput ? parseInt(crewAmountInput.value, 10) || 0 : 0;
        let crewNames = [];
        if (crewAmount > 0) {
          for (let i = 1; i <= crewAmount; i++) {
            const crewInput = document.getElementById(`securityCrew_${shipId}_${i}`);
            if (crewInput && crewInput.value.trim()) {
              crewNames.push(crewInput.value.trim());
            }
          }
        }
        
        const shipLink = shipLinks[ship];
        const shipDisplayText = shipLink ? `[${ship}](${shipLink})` : ship;
        
        let shipText = `${shipDisplayText}`;
        if (captainName) shipText += `\n**Captain:** ${captainName}`;
        if (crewNames.length > 0) shipText += `\n**Crew:** ${crewNames.join(", ")}`;
        
        securityShipDetails.push(shipText);
        shipCounter++;
      }
    });
    
    securityShipsText = securityShipDetails.length > 0 ? "\n" + securityShipDetails.join("\n—\n") : "None";
    securityShipsHeader = securityShipDetails.length === 1 ? "Security Ship" : "Security Ships";
  }

  const routeStart = get("routeStart");
  const routeEnd = get("routeEnd");
  const routeText = routeStart && routeEnd ? `${routeStart} :arrow_right: ${routeEnd}` : "";

  let manifestLines = [];
  let totalSCU = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scuValue = row.querySelector('.manifest-scu').value;
    const scu = parseInt(scuValue, 10);
    const mat = row.querySelector('.manifest-material').value;
    const uecValue = row.querySelector('.manifest-uec').value;
    if (!isNaN(scu)) totalSCU += scu;
    manifestLines.push({
      scu: scuValue,
      mat: mat,
      uec: uecValue
    });
  });

  if (totalSCU <= 0) {
    hideLoadingOverlay();
    hideButtonLoading('generateBtn');
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
      generateBtn.innerHTML = 'Generate Post';
    }
    showNotificationOverlay(`Manifest Validation Issue<br><br><strong>Total SCU is 0</strong><br><br>Please add cargo to your manifest before generating the Discord post.`, 'warning');
    showFeedback('warning', 'Cannot generate post: Total SCU is 0. Please add cargo to your manifest.');
    return;
  }

  let manifestTable = "SCU   Material         UEC\n";
  manifestLines.forEach(line => {
    manifestTable += `${line.scu.padEnd(5)} ${line.mat.padEnd(15)} ${line.uec ? line.uec : ""}\n`;
  });

  const totalUECInput = document.getElementById("totalUECBox");
  let totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) : 0;

  let totalLine = `**Total: ${totalSCU.toLocaleString()} SCU`;
  if (totalUEC && !isNaN(totalUEC)) {
    totalLine += ` / ${totalUEC.toLocaleString()} UEC`;
  }
  totalLine += "**";
  const totalSCUText = `**Total: ${totalSCU.toLocaleString()} SCU**`;

  const repairs = parseInt(get("repairs") || "0", 10);
  const restock = parseInt(get("restock") || "0", 10);
  const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
  const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
  const crewCosts = parseInt(get("crewCosts") || "0", 10);
  const totalDeductibles = repairs + restock + quantumFuel + hydrogenFuel + crewCosts;

  const notesText = get("notes") || "None";

  const shipDisplayText = shipLink ? `[${shipNameText}](${shipLink})` : shipNameText;

    let output = `**${orderCategoryText} Order**
${companyNameText} : ${orderTypeText === "Resource Drive" ? "Resource Drive" : orderTypeText}
${resourceDriveCompanyText ? `Resource Drive Company: ${resourceDriveCompanyText}` : ""}

———

**Transport Ship:** ${shipDisplayText}
**Captain:** ${captainNameText}
**Crew:** ${crewNamesText}

———

**${securityShipsHeader}:**
${securityShipsText}

———

 **Departure:** ${get("startLocation")}
 **Departure Time:** ${departureDiscord}
 **Route:** ${routeText}

———

**Manifest**
\`\`\`
${manifestTable.trim()}
\`\`\`
${totalLine}

———

**Sign Off**
Order completion time: ${completionDiscord}
${getOrderDurationText()}

**Deductibles**
- **Repairs:** ${repairs.toLocaleString()} UEC
- **Restock:** ${restock.toLocaleString()} UEC
- **Quantum fuel:** ${quantumFuel.toLocaleString()} UEC
- **Hydrogen fuel:** ${hydrogenFuel.toLocaleString()} UEC
- **Crew/ship costs:** ${crewCosts.toLocaleString()} UEC
**Total Deductibles: ${totalDeductibles.toLocaleString()} UEC**

———

**Notes**
\`\`\`
${notesText}
\`\`\`
`;

  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  history.push({ id: postCounter, content: output });
  sessionStorage.setItem('discordHistory', JSON.stringify(history));
  sessionStorage.setItem('discordHistoryCounter', (postCounter + 1).toString());
  renderHistory();

  document.getElementById("discordOutput").value = output;
  document.getElementById("discordSection").style.display = "block";
  
  const generateBtn = document.getElementById("generateBtn");
  if (generateBtn) {
    generateBtn.style.display = "none";
  }
  
  hideCopyButton();
  
  hideLoadingOverlay();
  hideButtonLoading('generateBtn');
  showFeedback('success', 'Discord post generated successfully!');
  
    } catch (error) {
      console.error('Error generating output:', error);
      hideLoadingOverlay();
      hideButtonLoading('generateBtn');
      
      logErrorToGitHub('G100', 'Discord generation failed', error.message, error.stack, {
        errorType: error.name || 'Unknown',
        generationError: true,
        formData: {
          hasManifest: document.querySelectorAll('.manifest-row').length > 0,
          hasSecurityShips: getSelectedSecurityShips().length > 0,
          totalSCU: parseInt(document.getElementById("totalSCUBox")?.textContent?.replace(/\D/g, "") || "0"),
          orderType: document.getElementById("orderType")?.value || "Unknown"
        }
      });
      
      showNotificationOverlay(`❌ Generation Failed<br><br><strong>Error G100:</strong> Failed to generate Discord post<br><br>A technical error occurred during generation. Please try again or refresh the page if the problem persists.`, 'error');
      showFeedback('error', 'Failed to generate Discord post (G100). Please try again.');
    }
  }, 500);
}

function renderHistory() {
  const historyList = document.getElementById('historyList');
  
  if (historyList) {
    const history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
    
    if (history.length === 0) {
      historyList.innerHTML = `
        <div style="text-align: center; background: #fff; border: 3px solid #9d7523; border-radius: 12px; padding: 30px;">
          <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" 
               alt="BruteHaul Logo" 
               style="max-width: 200px; width: 100%; margin-bottom: 20px; border-radius: 8px;">
          <h2 style="color: #9d7523; margin: 20px 0; font-size: 24px;">Brute Haul Manifest Log</h2>
          <p style="font-size: 18px; color: #781d15; font-weight: bold; margin: 15px 0;">
            No posts generated this session.
          </p>
          <p style="color: #666; margin: 10px 0; font-size: 16px;">
            Complete and submit manifests to see them listed here.
          </p>
        </div>
      `;
    } else {
      let historyHTML = `
        <div style="margin-bottom: 20px; text-align: center;">
          <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" 
               alt="BruteHaul Logo" 
               style="max-width: 150px; border-radius: 8px;">
          <h2 style="color: #9d7523; margin: 15px 0;">Session History (${history.length} posts)</h2>
        </div>
      `;
      
      history.forEach((post, index) => {
        historyHTML += `
          <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="color: #781d15;">Post ${index + 1}</strong>
              <button onclick="deleteHistoryPost(${index})" 
                      style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                Delete
              </button>
            </div>
            <div style="background: white; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">${post.content}</div>
            <small style="color: #666; margin-top: 10px; display: block;">${post.timestamp}</small>
          </div>
        `;
      });
      
      historyList.innerHTML = historyHTML;
    }
  }
}

function deleteHistoryPost(idx) {
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  history.splice(idx, 1);
  sessionStorage.setItem('discordHistory', JSON.stringify(history));
  renderHistory();
}

function copyHistoryPost(idx) {
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  if (history[idx]) {
    const temp = document.createElement('textarea');
    temp.value = history[idx].content;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    showNotificationOverlay("History post copied to clipboard!", 'success');
  }
}

window.deleteHistoryPost = deleteHistoryPost;
window.copyHistoryPost = copyHistoryPost;

window.sendToDiscord = sendToDiscord;

async function sendToDiscord() {
  const message = document.getElementById("discordOutput").value;
  const orderType = document.getElementById("orderType").value;
  const resourceDriveCompany = document.getElementById("resourceDriveCompany").value;
  const totalSCU = parseInt(document.getElementById("totalSCUBox").textContent.replace(/\D/g, "")) || 0;
  const captainName = document.getElementById("captainName").value;
  let shipName = document.getElementById("shipName").value;
  if (shipName === "Other") {
    shipName = document.getElementById("shipNameOther").value;
  }

  let selectedSecurityShips = [];
  let securityShipsText = "None";
  
  try {
    if (typeof getSelectedSecurityShips === 'function') {
      selectedSecurityShips = getSelectedSecurityShips();
    }
  } catch (e) {
    console.warn('Error getting selected security ships:', e);
    selectedSecurityShips = [];
  }
  
  if (!selectedSecurityShips || selectedSecurityShips.length === 0 || (selectedSecurityShips.length === 1 && (!selectedSecurityShips[0] || selectedSecurityShips[0] === "None"))) {
    securityShipsText = "None";
  } else {
    securityShipsText = selectedSecurityShips.join("\n");
  }

  // Warning: No message generated
  if (!message) {
    showNotificationOverlay("Missing Discord Post<br><br><strong>No message to send</strong><br><br>Please generate a Discord post first by clicking the 'Generate Discord Post' button.", 'warning');
    showFeedback('warning', 'No message to send. Please generate a Discord post first.');
    showCopyButton();
    logErrorToGitHub('V004', 'No message generated', 'User attempted to send without generating Discord post first', null, {
      validationStep: 'Message check',
      formCompleted: false
    });
    return;
  }

  // Warning: Required fields missing
  if (!orderType || !captainName) {
    showNotificationOverlay("Required Information Missing<br><br><strong>Order Type and Captain Name are required</strong><br><br>Please fill in these fields to send to Discord.", 'warning');
    showFeedback('warning', 'Order Type and Captain Name are required to send to Discord.');
    showCopyButton();
    logErrorToGitHub('V005', 'Required fields missing', `Missing fields - Order Type: ${orderType ? 'Present' : 'Missing'}, Captain Name: ${captainName ? 'Present' : 'Missing'}`, null, {
      validationStep: 'Required fields check',
      missingFields: [
        !orderType ? 'Order Type' : null,
        !captainName ? 'Captain Name' : null
      ].filter(Boolean)
    });
    return;
  }

  const sendBtn = Array.from(document.querySelectorAll("button"))
    .find(btn => btn.textContent.includes("Send to Discord"));
  
  if (sendBtn) {
    sendBtn.classList.add('button-loading');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<div class="loading-spinner"></div>Sending to Discord...';
  }
  
  showLoadingOverlay('Sending to Brute Haul Discord...');

 
  const endpoints = [
    "https://brutehaulrailway-production.up.railway.app/send-discord"
  ];

  try {
    const get = id => document.getElementById(id)?.value?.trim() || "";
    
    let orderCategoryText = get("orderCategory");
    if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");
    
    let companyNameText = get("companyName");
    
    let orderTypeText = get("orderType");
    if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");
    
    let captainNameText = get("captainName");
    if (captainNameText === "Other") captainNameText = get("captainNameOther");
    
    const crewAmount = parseInt(get("crewAmount"), 10);
    let crewNamesList = [];
    for (let i = 1; i <= crewAmount; i++) {
      const crewInput = document.getElementById(`crewName${i}`);
      if (crewInput && crewInput.value.trim()) {
        crewNamesList.push(crewInput.value.trim());
      }
    }
    const crewAmountWithNames = crewAmount > 0 ? `${crewAmount} (${crewNamesList.join(", ")})` : "0";
    
    const totalUECInput = document.getElementById("totalUECBox");
    const totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) || 0 : 0;
    
    const repairs = parseInt(get("repairs") || "0", 10);
    const restock = parseInt(get("restock") || "0", 10);
    const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
    const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
    const crewCosts = parseInt(get("crewCosts") || "0", 10);
    
    let response;
    let successfulEndpoint = null;
    let lastError = null;
    
    for (const endpoint of endpoints) {
      try {
        console.log(`Trying endpoint: ${endpoint}`);
        response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            date: new Date().toISOString().split('T')[0], // Current date
            orderCategory: orderCategoryText,
            companyName: companyNameText,
            orderType: orderTypeText,
            shipName: shipName,
            captainName: captainNameText,
            crewAmount: crewAmountWithNames,
            securityShips: securityShipsText,
            securityShipsData: selectedSecurityShips.filter(ship => ship && ship !== 'None' && ship !== 'Other' && ship.trim() !== '').map(ship => {
              const shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
              const captainInput = document.getElementById(`securityCaptain_${shipId}`);
              return {
                ship: ship,
                captain: captainInput ? captainInput.value.trim() : ''
              };
            }),
            startLocation: get("startLocation"),
            departureTimestamp: get("departureTime"),
            routeStart: get("routeStart"),
            routeEnd: get("routeEnd"),
            totalSCU: totalSCU,
            totalUEC: totalUEC,
            orderCompletionTimestamp: get("completionTime"),
            orderTime: getOrderDurationText(),
            repairs: repairs,
            restock: restock,
            quantumFuel: quantumFuel,
            hydrogenFuel: hydrogenFuel,
            crewShipCosts: crewCosts,
            notes: get("notes"),
            resourceDriveCompany,
            shipNames: typeof allShips !== "undefined" ? allShips : []
          })
        });
        
        if (response.ok) {
          successfulEndpoint = endpoint;
          console.log(`Success with endpoint: ${endpoint}`);
          break;
        } else {
          lastError = `HTTP ${response.status}: ${response.statusText}`;
          console.log(`HTTP error with ${endpoint}: ${lastError}`);
        }
      } catch (error) {
        lastError = error.message;
        console.log(`Network error with ${endpoint}:`, error.message);
        continue;
      }
    }
    
    if (!response || !response.ok) {
      throw new Error(lastError || "Railway server connection failed - please check server status");
    }

    let data;
    try {
      data = await response.json();
    } catch {
      hideLoadingOverlay();
      showNotificationOverlay("Server Restarting<br><br>The Brute Haul System is currently restarting.<br><br><strong>Error E005:</strong> Please try again in 30 seconds.", 'warning');
      showFeedback('warning', 'Server restarting (E005) - Please try again shortly');
      showCopyButton();
      
      logErrorToGitHub('E005', 'Server restarting', 'JSON parsing failed - server likely restarting', null, {
        responseStatus: response?.status || 'Unknown',
        responseOk: response?.ok || false,
        endpoint: successfulEndpoint || 'Unknown endpoint',
        parsingError: true,
        serverState: 'Restarting'
      });
      
      if (sendBtn) {
        sendBtn.classList.remove('button-loading');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />Send to Discord';
      }
      return;
    }

    if (response.ok) {
      hideLoadingOverlay();
      showLoadingMessage("✅ Successfully sent to Brute Haul Discord!<br><br>Your manifest has been posted and logged.", 2000);
      showFeedback('success', 'Successfully sent to Brute Haul');
      document.getElementById("discordSection").style.display = "none";
      clearFormFields();
    } else {
      hideLoadingOverlay();
      let errorCode = response.status || 'UNKNOWN';
      let errorMsg = data?.error || 'Unknown server error';
      let instructions = 'Please try again later. Bug Report Submitted';
      
      switch (response.status) {
        case 400:
          errorCode = 'E400';
          errorMsg = 'Invalid request data';
          instructions = 'Please check all form fields are filled correctly and try again.';
          break;
        case 401:
          errorCode = 'E401';
          errorMsg = 'Authentication required';
          instructions = 'Server access denied. Please refresh the page and try again.';
          break;
        case 403:
          errorCode = 'E403';
          errorMsg = 'Access forbidden';
          instructions = 'Server rejected the request.';
          break;
        case 404:
          errorCode = 'E404';
          errorMsg = 'Service not found';
          instructions = 'The Brute Haul service endpoint is not available.';
          break;
        case 429:
          errorCode = 'E429';
          errorMsg = 'Too many requests';
          instructions = 'You are sending requests too quickly. Please wait 1 minute and try again.';
          break;
        case 500:
          errorCode = 'E500';
          errorMsg = 'Internal server error';
          instructions = 'The Brute Haul server encountered an error. Please try again in a few minutes.';
          break;
        case 502:
          errorCode = 'E502';
          errorMsg = 'Bad gateway';
          instructions = 'Server gateway error. The service may be restarting - try again shortly.';
          break;
        case 503:
          errorCode = 'E503';
          errorMsg = 'Service unavailable';
          instructions = 'The Brute Haul server is temporarily unavailable. Please try again later.';
          break;
        case 504:
          errorCode = 'E504';
          errorMsg = 'Gateway timeout';
          instructions = 'Server took too long to respond. Please try again.';
          break;
        default:
          if (data?.error?.includes('Discord')) {
            if (data.error.includes('webhook')) {
              errorCode = 'D001';
              errorMsg = 'Discord webhook error';
              instructions = 'Discord connection failed.';
            } else if (data.error.includes('rate limit')) {
              errorCode = 'D002';
              errorMsg = 'Discord rate limited';
              instructions = 'Discord is rate limiting requests. Please wait 5 minutes and try again.';
            } else if (data.error.includes('message')) {
              errorCode = 'D003';
              errorMsg = 'Discord message error';
              instructions = 'Your message format was rejected by Discord.';
            }
          } else if (data?.error?.includes('Google') || data?.error?.includes('Sheets')) {
            if (data.error.includes('credentials') || data.error.includes('authentication')) {
              errorCode = 'G001';
              errorMsg = 'Google Sheets credentials error';
              instructions = 'Server configuration issue.';
            } else if (data.error.includes('permission') || data.error.includes('access')) {
              errorCode = 'G003';
              errorMsg = 'Google Sheets permission denied';
              instructions = 'Server lacks permission to write data.';
            } else if (data.error.includes('quota') || data.error.includes('limit')) {
              errorCode = 'G004';
              errorMsg = 'Google Sheets quota exceeded';
              instructions = 'Google Sheets API limit reached. Please try again in an hour.';
            } else {
              errorCode = 'G002';
              errorMsg = 'Google Sheets connection failed';
              instructions = 'Unable to save to spreadsheet. Your Discord post was sent but data logging failed.';
            }
          } else if (data?.error?.includes('bot') || data?.error?.includes('token')) {
            if (data.error.includes('token') || data.error.includes('authentication')) {
              errorCode = 'B001';
              errorMsg = 'Discord bot authentication failed';
              instructions = 'Server configuration issue.';
            } else if (data.error.includes('offline') || data.error.includes('disconnected')) {
              errorCode = 'B002';
              errorMsg = 'Discord bot offline';
              instructions = 'The Discord bot is currently offline.';
            } else if (data.error.includes('channel') || data.error.includes('not found')) {
              errorCode = 'B003';
              errorMsg = 'Discord channel not found';
              instructions = 'Server cannot find the Discord channel.';
            } else if (data.error.includes('permission') || data.error.includes('access')) {
              errorCode = 'B004';
              errorMsg = 'Discord bot lacks permissions';
              instructions = 'Bot cannot post to channel.';
            }
          } else if (data?.error?.includes('validation') || data?.error?.includes('invalid')) {
            if (data.error.includes('manifest') || data.error.includes('format')) {
              errorCode = 'V001';
              errorMsg = 'Invalid manifest data format';
              instructions = 'Your form data format is invalid. Please refresh the page and try again.';
            } else if (data.error.includes('required') || data.error.includes('missing')) {
              errorCode = 'V002';
              errorMsg = 'Server validation failed';
              instructions = 'Server rejected your data. Please check all required fields and try again.';
            } else if (data.error.includes('parse') || data.error.includes('JSON')) {
              errorCode = 'V003';
              errorMsg = 'Data parsing error';
              instructions = 'Server cannot read your form data. Please refresh the page and try again.';
            }
          }
          break;
      }
      
      showNotificationOverlay(`❌ Failed to send to Discord<br><br><strong>Error ${errorCode}:</strong> ${errorMsg}<br><br>${instructions}`, 'error');
      showFeedback('error', `Error sending to Brute Haul (${errorCode}): ${errorMsg}`);
      showCopyButton();
      
      logErrorToGitHub(errorCode, errorMsg, `HTTP ${response.status}: ${data?.error || 'Unknown server error'}`, null, {
        httpStatus: response.status,
        httpStatusText: response.statusText,
        serverResponse: data,
        endpoint: successfulEndpoint || 'No successful endpoint',
        attemptedEndpoints: endpoints.length,
        requestPayload: {
          messageLength: message?.length || 0,
          orderType: orderType,
          captainName: captainName ? 'Present' : 'Missing',
          shipName: shipName ? 'Present' : 'Missing',
          totalSCU: totalSCU
        }
      });
      
      setTimeout(showErrorReportLink, 1000);
    }
  } catch (err) {
    hideLoadingOverlay();
    console.error('Send to Discord error:', err);
    
    let errorCode = 'E701';
    let errorMsg = 'Connection failed';
    let instructions = 'Please try again later or contact DyslexicNerd01';
    
    if (err.message.includes('Railway server connection failed')) {
      errorCode = 'R001';
      errorMsg = 'Railway server connection failed';
      instructions = 'The Brute Haul server may be restarting. Please try again in a few moments.';
    } else if (err.message.includes('fetch') || err.message.includes('Network')) {
      errorCode = 'E703';
      errorMsg = 'Network connection error';
      instructions = 'Check your internet connection and try again.';
    } else if (err.message.includes('CORS')) {
      errorCode = 'E704';
      errorMsg = 'Cross-origin request blocked';
      instructions = 'Browser security blocked the request. Try refreshing the page.';
    } else if (err.message.includes('timeout') || err.message.includes('aborted')) {
      errorCode = 'E408';
      errorMsg = 'Request timeout';
      instructions = 'The server took too long to respond. Please try again.';
    } else if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
      errorCode = 'E702';
      errorMsg = 'Network request blocked';
      instructions = 'Check your firewall/antivirus settings or try a different network.';
    } else if (err.message.includes('SSL') || err.message.includes('certificate')) {
      errorCode = 'S001';
      errorMsg = 'SSL/Certificate error';
      instructions = 'Server SSL certificate issue. Try using HTTP or contact DyslexicNerd01.';
    } else if (err.message.includes('abort') || err.message.includes('cancelled')) {
      errorCode = 'C001';
      errorMsg = 'Request cancelled';
      instructions = 'The request was cancelled. Please try again.';
    } else if (err.message.includes('quota') || err.message.includes('usage limit')) {
      errorCode = 'Q001';
      errorMsg = 'API quota exceeded';
      instructions = 'Service usage limit reached. Please try again in an hour.';
    } else if (err.message.includes('maintenance') || err.message.includes('scheduled')) {
      errorCode = 'M001';
      errorMsg = 'Scheduled maintenance';
      instructions = 'System is under maintenance. Please check Discord for updates.';
    } else if (err.message.includes('memory') || err.message.includes('resource')) {
      errorCode = 'R002';
      errorMsg = 'Server resource limit';
      instructions = 'Server is under high load. Please try again in a few minutes.';
    }
    
    showNotificationOverlay(`❌ Connection Failed<br><br><strong>Error ${errorCode}:</strong> ${errorMsg}<br><br>${instructions}`, 'error');
    showFeedback('error', `The Brute Haul System is currently offline (${errorCode}). Please try again later.`);
    showCopyButton();
    
    logErrorToGitHub(errorCode, errorMsg, err.message, err.stack, {
      errorType: err.name || 'Unknown',
      networkError: true,
      endpointsAttempted: endpoints,
      lastEndpointTried: endpoints[endpoints.length - 1],
      connectionDetails: {
        online: navigator.onLine,
        effectiveType: navigator.connection?.effectiveType || 'Unknown',
        downlink: navigator.connection?.downlink || 'Unknown'
      },
      requestContext: {
        messageLength: message?.length || 0,
        formCompleted: !!(orderType && captainName && message),
        totalSCU: totalSCU,
        hasShipName: !!shipName
      }
    });
    
    setTimeout(showErrorReportLink, 1000);
  } finally {
    if (sendBtn) {
      sendBtn.classList.remove('button-loading');
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />Send to Discord';
    }
  }
}
function generateAnnouncement() {
  const title = document.getElementById("announcementTitle").value.trim();
  const body = document.getElementById("announcementBody").value.trim();
  if (!title && !body) {
    showNotificationOverlay("Please enter a title or body for the announcement.", 'warning', 3000);
    return;
  }
  const output = `📢 **${title || "Announcement"}**\n\n${body}`;
  document.getElementById("announcementOutput").value = output;
}

function copyAnnouncementOutput() {
  const output = document.getElementById("announcementOutput");
  output.select();
  output.setSelectionRange(0, 99999);
  document.execCommand("copy");
  showNotificationOverlay("Announcement copied to clipboard!", 'success');
}

window.generateAnnouncement = generateAnnouncement;
window.copyAnnouncementOutput = copyAnnouncementOutput;

async function logErrorToGitHub(errorCode, errorMsg, fullError, stackTrace, additionalContext = {}) {
  console.log('🔧 logErrorToGitHub called with:', { errorCode, errorMsg });
  
  try {    
    function getGitHubToken() {
      let token = 'ERROR_REPORTER_TOKEN_PLACEHOLDER';
      if (token !== 'ERROR_REPORTER_TOKEN_PLACEHOLDER') {
        return token;
      }
      
      if (localStorage.getItem('simulate_deployed_token')) {
        return localStorage.getItem('simulate_deployed_token');
      }
      
      if (typeof process !== 'undefined' && process.env?.ERROR_REPORTER_TOKEN) {
        return process.env.ERROR_REPORTER_TOKEN;
      }
      
      const storedToken = localStorage.getItem('github_error_token_encrypted');
      if (storedToken) {
        try {
          return atob(storedToken.split('').reverse().join(''));
        } catch (e) {
          console.warn('Failed to decode stored token');
        }
      }
      
      if (confirm('GitHub error logging is not configured. Would you like to set it up now? (This will enable automatic error reporting)')) {
        const userToken = prompt('Enter your GitHub Personal Access Token (this will be stored locally and encrypted):');
        if (userToken && userToken.startsWith('ghp_')) {
          const encrypted = btoa(userToken).split('').reverse().join('');
          localStorage.setItem('github_error_token_encrypted', encrypted);
          return userToken;
        }
      }
      
      return null;
    }
    
    const GITHUB_TOKEN = getGitHubToken();
    const GITHUB_REPO = 'DyslexicNerd01/Brute-Haul-Cargo-Log';
    
    console.log('🔧 GitHub token status:', GITHUB_TOKEN ? 'Found' : 'Not found');
    
    if (!GITHUB_TOKEN) {
      console.log('🔧 GitHub error logging not configured - add your GitHub Personal Access Token to enable automatic error reporting');
      return;
    }
    
    console.log('🔧 Proceeding with GitHub issue creation...');
    
    const errorContext = {
      timestamp: new Date().toISOString(),
      errorCode: errorCode,
      errorMessage: errorMsg,
      fullError: fullError,
      stackTrace: stackTrace,
      userAgent: navigator.userAgent,
      pageUrl: window.location.href,
      viewport: `${window.innerWidth}x${window.innerHeight}`,
      language: navigator.language,
      platform: navigator.platform,
      cookiesEnabled: navigator.cookieEnabled,
      onlineStatus: navigator.onLine,
      referrer: document.referrer || 'Direct access',
      ...additionalContext
    };
    
    try {
      const get = id => document.getElementById(id)?.value?.trim() || "";
      
      const formData = {
        orderType: get("orderType"),
        orderCategory: get("orderCategory"),
        orderCategoryOther: get("orderCategoryOther"),
        orderTypeOther: get("orderTypeOther"),
        companyName: get("companyName"),
        resourceDriveCompany: get("resourceDriveCompany"),
        shipName: get("shipName"),
        shipNameOther: get("shipNameOther"),
        captainName: get("captainName"),
        captainNameOther: get("captainNameOther"),
        crewAmount: get("crewAmount"),
        startLocation: get("startLocation"),
        routeStart: get("routeStart"),
        routeEnd: get("routeEnd"),
        departureTime: get("departureTime"),
        completionTime: get("completionTime"),
        totalSCU: document.getElementById("totalSCUBox")?.textContent || '0',
        totalUEC: get("totalUECBox"),
        repairs: get("repairs"),
        restock: get("restock"),
        quantumFuel: get("quantumFuel"),
        hydrogenFuel: get("hydrogenFuel"),
        crewCosts: get("crewCosts"),
        notes: get("notes"),
        discordMessage: document.getElementById("discordOutput")?.value || 'No message generated',
        messageLength: document.getElementById("discordOutput")?.value?.length || 0
      };
      
      // crew names
      const crewAmount = parseInt(get("crewAmount"), 10);
      const crewNames = [];
      for (let i = 1; i <= crewAmount; i++) {
        const crewName = get(`crewName${i}`);
        if (crewName) crewNames.push(crewName);
      }
      formData.crewNames = crewNames;
      
      // security ships data
      if (typeof getSelectedSecurityShips === 'function') {
        try {
          const selectedSecurityShips = getSelectedSecurityShips();
          formData.securityShips = selectedSecurityShips;
          
          const securityShipsData = [];
          selectedSecurityShips.forEach(ship => {
            if (ship && ship !== 'None') {
              const shipId = ship.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
              const captainInput = document.getElementById(`securityCaptain_${shipId}`);
              const crewInput = document.getElementById(`securityCrew_${shipId}`);
              securityShipsData.push({
                ship: ship,
                captain: captainInput ? captainInput.value.trim() : '',
                crewAmount: crewInput ? crewInput.value : '0'
              });
            }
          });
          formData.securityShipsData = securityShipsData;
        } catch (e) {
          formData.securityShipsError = e.message;
        }
      }
      
      // manifest data
      const manifestRows = document.querySelectorAll('.manifest-row');
      const manifestData = [];
      manifestRows.forEach(row => {
        const scu = row.querySelector('.manifest-scu')?.value || '';
        const material = row.querySelector('.manifest-material')?.value || '';
        const uec = row.querySelector('.manifest-uec')?.value || '';
        if (scu || material || uec) {
          manifestData.push({ scu, material, uec });
        }
      });
      formData.manifestData = manifestData;
      
      errorContext.formData = formData;
    } catch (formError) {
      errorContext.formDataError = `Could not collect form data: ${formError.message}`;
    }
    
    const issueData = {
      title: `Brute Haul Bot Send Failure - ${errorCode}: ${errorMsg}`,
      body: `## Automatic Error Report Generation

**Error Code:** \`${errorCode}\`  
**Error Message:** ${errorMsg}  
**Timestamp:** ${errorContext.timestamp}  

---

## Error Details

| Field | Value |
|-------|-------|
| **Error Code** | \`${errorCode}\` |
| **Error Message** | ${errorMsg} |
| **Page URL** | ${errorContext.pageUrl} |
| **User Agent** | ${errorContext.userAgent} |
| **Viewport** | ${errorContext.viewport} |
| **Language** | ${errorContext.language} |
| **Platform** | ${errorContext.platform} |
| **Online Status** | ${errorContext.onlineStatus ? '✅ Online' : '❌ Offline'} |
| **Cookies Enabled** | ${errorContext.cookiesEnabled ? '✅ Yes' : '❌ No'} |
| **Referrer** | ${errorContext.referrer} |

---

## Technical Details

### Full Error Message
\`\`\`
${fullError || 'No additional error details'}
\`\`\`

### Stack Trace
\`\`\`
${stackTrace || 'No stack trace available'}
\`\`\`

---

## Form Data Context

${errorContext.formData ? `
| Field | Value |
|-------|-------|
| **Order Type** | ${errorContext.formData.orderType || 'Not set'} |
| **Captain Name** | ${errorContext.formData.captainName || 'Not set'} |
| **Ship Name** | ${errorContext.formData.shipName || 'Not set'} |
| **Company Name** | ${errorContext.formData.companyName || 'Not set'} |
| **Total SCU** | ${errorContext.formData.totalSCU || '0'} |
| **Total UEC** | ${errorContext.formData.totalUEC || '0'} |
| **Message Length** | ${errorContext.formData.messageLength} characters |
| **Manifest Items** | ${errorContext.formData.manifestData ? errorContext.formData.manifestData.length : 0} items |
| **Security Ships** | ${errorContext.formData.securityShips ? errorContext.formData.securityShips.join(', ') : 'None'} |
| **Crew Amount** | ${errorContext.formData.crewAmount || '0'} |
` : `Form data unavailable: ${errorContext.formDataError || 'Unknown reason'}`}

<details>
<summary><strong>Complete Form Data Copy-Paste</strong> (Click to expand)</summary>

### User's Complete Form Submission

${errorContext.formData ? `
**Order Information**
- **Order Category:** ${errorContext.formData.orderCategory || 'Not set'}${errorContext.formData.orderCategoryOther ? ` (Other: ${errorContext.formData.orderCategoryOther})` : ''}
- **Order Type:** ${errorContext.formData.orderType || 'Not set'}${errorContext.formData.orderTypeOther ? ` (Other: ${errorContext.formData.orderTypeOther})` : ''}
- **Company Name:** ${errorContext.formData.companyName || 'Not set'}
- **Resource Drive Company:** ${errorContext.formData.resourceDriveCompany || 'Not applicable'}

**Transport Ship Information**
- **Ship Name:** ${errorContext.formData.shipName || 'Not set'}${errorContext.formData.shipNameOther ? ` (Other: ${errorContext.formData.shipNameOther})` : ''}
- **Captain Name:** ${errorContext.formData.captainName || 'Not set'}${errorContext.formData.captainNameOther ? ` (Other: ${errorContext.formData.captainNameOther})` : ''}
- **Crew Amount:** ${errorContext.formData.crewAmount || '0'}
${errorContext.formData.crewNames && errorContext.formData.crewNames.length > 0 ? `- **Crew Names:** ${errorContext.formData.crewNames.join(', ')}` : ''}

**Security Ships**
${errorContext.formData.securityShips && errorContext.formData.securityShips.length > 0 ? 
  errorContext.formData.securityShips.map(ship => ship === 'None' ? '- None' : `- ${ship}`).join('\n') : 
  '- None'
}
${errorContext.formData.securityShipsData && errorContext.formData.securityShipsData.length > 0 ? 
  errorContext.formData.securityShipsData.map(ship => 
    `  - **${ship.ship}:** Captain: ${ship.captain || 'Not set'}, Crew: ${ship.crewAmount || '0'}`
  ).join('\n') : ''
}

**Route Information**
- **Start Location:** ${errorContext.formData.startLocation || 'Not set'}
- **Route Start:** ${errorContext.formData.routeStart || 'Not set'}
- **Route End:** ${errorContext.formData.routeEnd || 'Not set'}
- **Departure Time:** ${errorContext.formData.departureTime || 'Not set'}
- **Completion Time:** ${errorContext.formData.completionTime || 'Not set'}

**Manifest Data**
- **Total SCU:** ${errorContext.formData.totalSCU || '0'}
- **Total UEC:** ${errorContext.formData.totalUEC || '0'}
${errorContext.formData.manifestData && errorContext.formData.manifestData.length > 0 ? 
  '\n**Manifest Items:**\n' + errorContext.formData.manifestData.map((item, index) => 
    `${index + 1}. ${item.scu || '0'} SCU - ${item.material || 'Not set'} - ${item.uec || '0'} UEC`
  ).join('\n') : 
  '\n**No manifest items found**'
}

**Deductibles**
- **Repairs:** ${errorContext.formData.repairs || '0'} UEC
- **Restock:** ${errorContext.formData.restock || '0'} UEC
- **Quantum Fuel:** ${errorContext.formData.quantumFuel || '0'} UEC
- **Hydrogen Fuel:** ${errorContext.formData.hydrogenFuel || '0'} UEC
- **Crew/Ship Costs:** ${errorContext.formData.crewCosts || '0'} UEC

**Notes**
\`\`\`
${errorContext.formData.notes || 'No notes provided'}
\`\`\`

**Generated Discord Message**
\`\`\`
${errorContext.formData.discordMessage || 'No message was generated'}
\`\`\`
` : 'Form data could not be collected'}

</details>

---

## User Impact

A user attempted to send a cargo manifest to Discord but encountered this error. The error was displayed to the user with appropriate instructions for resolution.

**User Experience:**
- ❌ Discord send failed
- ✅ Error message displayed to user
- ✅ Copy button provided as fallback
- ✅ Error logged for developer review

---

## Related Information

**Error Category:** ${errorCode.startsWith('E') ? 'Network/Server Error' : errorCode.startsWith('D') ? 'Discord API Error' : errorCode.startsWith('G') ? 'Google Sheets Error' : errorCode.startsWith('B') ? 'Bot Error' : errorCode.startsWith('V') ? 'Validation Error' : 'Other'}

**Severity:** ${['E500', 'E503', 'E504', 'R001', 'D001', 'B001', 'B002'].includes(errorCode) ? '🔴 High' : ['E400', 'E401', 'E403', 'E404', 'D002', 'G001', 'G003'].includes(errorCode) ? '🟡 Medium' : '🟢 Low'}

---

*This issue was automatically created by the Brute Haul Cargo Log error reporting system at ${errorContext.timestamp}*`,
      labels: [
        'bug', 
        'discord-failure', 
        'auto-generated',
        `error-${errorCode.toLowerCase()}`,
        errorCode.startsWith('E') ? 'network-error' : 
        errorCode.startsWith('D') ? 'discord-error' : 
        errorCode.startsWith('G') ? 'sheets-error' : 
        errorCode.startsWith('B') ? 'bot-error' : 
        errorCode.startsWith('V') ? 'validation-error' : 'other-error'
      ]
    };
    
    console.log('Attempting to create GitHub issue for error:', errorCode);
    
    const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues`, {
      method: 'POST',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'User-Agent': 'Brute-Haul-Error-Reporter/1.0'
      },
      body: JSON.stringify(issueData)
    });
    
    if (response.ok) {
      const issueResult = await response.json();
      console.log(`✅ Error logged to GitHub Issues successfully: #${issueResult.number}`);
      console.log(`📋 Issue URL: ${issueResult.html_url}`);
      
      sessionStorage.setItem('lastErrorIssue', issueResult.html_url);
    } else {
      const errorText = await response.text();
      console.error('❌ Failed to log error to GitHub:', response.status, response.statusText, errorText);
    }
  } catch (logError) {
    console.error('❌ GitHub error logging failed:', logError);
  }
}

function showErrorReportLink() {
  const lastErrorIssue = sessionStorage.getItem('lastErrorIssue');
  if (lastErrorIssue) {
    const linkElement = document.createElement('div');
    linkElement.innerHTML = `
      <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px;">
        📋 <a href="${lastErrorIssue}" target="_blank" style="color: #781d15;">View error report</a> 
        (Developer has been notified)
      </div>
    `;
    
    const errorFeedback = document.getElementById('errorFeedback');
    if (errorFeedback && errorFeedback.style.display !== 'none') {
      errorFeedback.appendChild(linkElement);
    }
  }
}
window.copyAnnouncementOutput = copyAnnouncementOutput;

window.setupGitHubErrorReporting = function() {
  const token = prompt('Enter your GitHub Personal Access Token for error reporting:');
  if (token && token.startsWith('ghp_')) {
    localStorage.setItem('simulate_deployed_token', token);
    console.log('✅ GitHub token stored (simulating deployed environment)');
    
    fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.login) {
        console.log(`✅ Token validated for user: ${data.login}`);
        alert(`GitHub token setup successful!\nUser: ${data.login}\nError reporting is now active.\n\nNote: This simulates the deployed environment.`);
      } else {
        console.error('❌ Token validation failed:', data);
        alert('Token validation failed. Please check your token.');
      }
    })
    .catch(err => {
      console.error('❌ Token test failed:', err);
      alert('Token test failed. Please check your internet connection.');
    });
  } else {
    alert('Invalid token. GitHub tokens start with "ghp_"');
  }
};

window.testGitHubErrorReporting = function() {
  console.log('🧪 Testing GitHub error reporting...');
  logErrorToGitHub('TEST001', 'Manual test error', 'This is a test error to verify GitHub Issues integration', null, {
    testType: 'Manual test',
    timestamp: new Date().toISOString(),
    testUser: 'FrontEndConsole'
  });
};

window.checkGitHubTokenStatus = function() {
  const storedToken = localStorage.getItem('github_error_token_encrypted');
  if (storedToken) {
    try {
      const decrypted = atob(storedToken.split('').reverse().join(''));
      if (decrypted.startsWith('ghp_')) {
        console.log('✅ GitHub token found in localStorage');
        console.log('✅ Token format appears valid');
        return true;
      } else {
        console.log('❌ Token format invalid');
        return false;
      }
    } catch (e) {
      console.log('❌ Failed to decode stored token');
      return false;
    }
  } else {
    console.log('❌ No GitHub token found in localStorage');
    return false;
  }
};

    window.addEventListener('error', function(event) {
      handleError('Uncaught JavaScript error occurred', event.error, {
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        message: event.message
      });
    });

    window.addEventListener('unhandledrejection', function(event) {
      handleError('Unhandled promise rejection', event.reason, {
        promise: event.promise
      });
      event.preventDefault();
    });

  </script>

</div>