<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brute Haul Cargo Manifest Form</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #e2e2e2 0%, #d0d0d0 100%);
      color: #230e09;
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
    }

    .main-container {
      max-width: 95%;
      width: 100%;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      padding: 0 20px;
    }

    .page-header {
      background: linear-gradient(135deg, #781d15 0%, #5a1510 100%);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      margin-bottom: 8px;
    }

    .page-header h1 {
      color: #e2e2e2;
      margin: 0;
      font-size: 2.5em;
      font-weight: 300;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      margin-bottom: 24px;
      width: 100%;
    }

    .card {
      background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(157, 117, 35, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 24px; /* Add gap between individual cards */
    }

    /* Ensure form-step cards also get spacing */
    .card.form-step {
      margin-bottom: 24px;
    }
    
    /* Remove navigation width constraints */
    #navigationCard {
      margin-bottom: 24px;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #9d7523;
    }

    .card-header h2 {
      color: #781d15;
      margin: 0;
      font-size: 1.4em;
      font-weight: 600;
    }

    .card-icon {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      background: #9d7523;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .icon {
      font-size: 24px;
      margin-right: 12px;
      display: inline-block;
      font-style: normal; /* Prevent emojis from being italicized */
    }

    form {
      background: transparent;
      border-radius: 0;
      padding: 0;
    }
    textarea {
      width: 100%;
      height: 400px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    #notes {
      height: 80px;
      width: 100%;
      resize: vertical;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #9d7523;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      color: #9d7523;
    }
    input, select, textarea {
      margin-bottom: 10px;
      width: 100%;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .section {
      margin-top: 0;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: 0;
    }

    .form-step {
      margin-bottom: 0;
    }

    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 200px;
      width: 100%;
      background: transparent;
      border-radius: 8px;
    }
    input[type="number"] {
      width: 120px;
      padding: 5px;
      font-size: 1.1em;
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    #crewAmount {
      width: 60px;
      font-size: 1em;
      padding: 3px;
      display: inline-block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .other-div {
      display: none;
      margin-left: 30px;
    }
    .other-div label {
      font-weight: bold;
      color: #9d7523;
      margin-top: 10px;
      display: block;
    }
    .other-div input {
      font-size: 0.95em;
      width: 60%;
      color: #230e09;
      background: #e2e2e2;
      border: 1px solid #781d15;
      margin-bottom: 10px;
    }
    .crew-label {
      display: block;
      margin-left: 30px;
      font-size: 0.95em;
      margin-top: 5px;
      color: #9d7523;
      font-weight: bold;
    }
    .crew-input {
      display: block;
      width: 60%;
      font-size: 0.95em;
      margin-left: 30px;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .deductible-input {
      display: block;
      margin-bottom: 10px;
      background: #e2e2e2;
      color: #230e09;
      border: 1px solid #781d15;
    }
    .error {
      border: 2px solid #9d7523 !important;
      background: #b32428 !important;
    }
    select.error option[value=""] {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error {
      background: #b32428 !important;
      color: #fff !important;
    }
    select.error:focus {
      background: #e2e2e2 !important;
      color: #230e09 !important;
    }
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .route-arrow {
      font-weight: bold;
      color: #230e09;
      font-size: 1.2em;
      padding: 0 8px;
    }
    button {
      background: #5865F2;
      color: #fff;
      border: none;
      padding: 10px 24px 10px 16px;
      font-size: 1.1em;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    button:hover {
      background: #404EED;
      color: #fff;
      border: 1px solid #9d7523;
    }
    .discord-btn-logo {
      height: 1.6em;
      width: auto;
      vertical-align: middle;
      filter: invert(1);
    }
    h1 {
      color: #9d7523;
      text-align: center;
      font-size: 2.4em;
      font-weight: bold;
    }
    h2 {
      color: #9d7523;
    }
    .manifest-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
      padding: 12px;
      border: 2px solid #9d7523;
      border-radius: 8px;
      background: #f8f6f2;
      box-shadow: 0 2px 6px rgba(157,117,35,0.07);
      position: relative;
    }
    .manifest-row label {
      margin: 0;
      font-weight: normal;
      color: #230e09;
      min-width: 60px;
    }
    .manifest-row input,
    .manifest-row select {
      width: auto;
      margin-bottom: 0;
    }
    .manifest-btn {
      font-size: 1em;
      font-weight: bold;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
      margin-right: 0;
      transition: background 0.2s;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      padding: 0;
    }
    .manifest-btn.add {
      background: #43b581;
      color: #fff;
    }
    .manifest-btn.add:hover {
      background: #2ea964;
    }
    .manifest-btn.remove {
      background: #ed4245;
      color: #fff;
    }
    .manifest-btn.remove:hover {
      background: #b32428;
    }
    .manifest-total-box {
      display: flex;
      gap: 24px;
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.1em;
      font-weight: bold;
      color: #230e09;
      background: #f8f6f2;
      border: 2px solid #9d7523;
      border-radius: 8px;
      padding: 12px;
      align-items: center;
      justify-content: flex-start;
    }
    .resource-preset-btn {
      background: #9d7523;
      color: #fff;
      border: none;
      padding: 6px 14px;
      font-size: 11px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
      white-space: nowrap;
      transition: background 0.2s;
      display: inline-block;
    }
    .resource-preset-btn.selected {
      background: #43b581 !important;
      color: #fff !important;
    }
    .resource-preset-btn:hover {
      background: #bfa14d;
      color: #fff;
    }
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ed4245;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      pointer-events: none;
    }
    .tab-button-container {
      position: relative;
      display: contents;
    }

    /* Searchable dropdown styles */
    .searchable-dropdown {
      position: relative;
      width: 100%;
    }
    .searchable-dropdown input {
      width: 100%;
      padding: 8px;
      border: 1px solid #781d15;
      background: #e2e2e2;
      color: #230e09;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .searchable-dropdown .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #e2e2e2;
      border: 1px solid #781d15;
      border-top: none;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .searchable-dropdown .dropdown-list.show {
      display: block;
    }
    .searchable-dropdown .dropdown-item {
      padding: 6px 12px;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
      background: #e2e2e2;
      color: #230e09;
      font-size: 14px;
    }
    .searchable-dropdown .dropdown-item:hover {
      background: #d0d0d0;
    }
    .searchable-dropdown .dropdown-item.selected {
      background: #781d15;
      color: #e2e2e2;
    }
    .searchable-dropdown .dropdown-item:last-child {
      border-bottom: none;
    }
    
    /* Route row styling for searchable dropdowns */
    .route-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .route-row .searchable-dropdown {
      flex: 1;
    }

    /* Tab Content Styling */
    #historyTab {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Two-column layout for form and announcements */
    .main-content-wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      align-items: start;
    }
    
    .form-column {
      min-width: 0; /* Prevents grid blowout */
      width: 100%;
    }
    
    .announcements-sidebar {
      position: static;
      height: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .announcements-sidebar .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .announcements-sidebar .card-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    /* Responsive: Stack on smaller screens */
    @media (max-width: 1200px) {
      .main-content-wrapper {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    /* Loading States & Progress Indicators */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(35, 14, 9, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(2px);
    }

    .loading-content {
      background: #781d15;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      color: #e2e2e2;
      border: 2px solid #9d7523;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: relative;
    }

    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: #e2e2e2;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s, color 0.2s;
    }

    .close-button:hover {
      background-color: rgba(255, 255, 255, 0.2);
      color: #ffffff;
    }

    .close-button:active {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .time-now-btn {
      background: #9d7523;
      color: #e2e2e2;
      border: 1px solid #781d15;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .time-now-btn:hover {
      background: #b88629;
      color: #ffffff;
      transform: translateY(-1px);
    }

    .time-now-btn:active {
      background: #8a6b1f;
      transform: translateY(0);
    }

    /* Enhanced input styling for card layout */
    input, select, textarea {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    input:focus, select:focus, textarea:focus {
      border-color: #9d7523;
      outline: none;
      box-shadow: 0 0 0 3px rgba(157, 117, 35, 0.1);
      transform: translateY(-1px);
    }

    input:hover, select:hover, textarea:hover {
      border-color: #c4a140;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    label {
      font-weight: 600;
      color: #781d15;
      margin-bottom: 8px;
      font-size: 14px;
    }

    /* Enhanced button styling */
    button {
      background: linear-gradient(135deg, #9d7523 0%, #8a6b1f 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(157, 117, 35, 0.3);
    }

    button:hover {
      background: linear-gradient(135deg, #b88629 0%, #9d7523 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(157, 117, 35, 0.4);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(157, 117, 35, 0.3);
    }

    /* Special styling for primary action buttons */
    .primary-btn {
      background: linear-gradient(135deg, #781d15 0%, #5a1510 100%);
      font-size: 16px;
      padding: 16px 32px;
      box-shadow: 0 6px 16px rgba(120, 29, 21, 0.3);
    }

    .primary-btn:hover {
      background: linear-gradient(135deg, #8a2419 0%, #6b1914 100%);
      box-shadow: 0 8px 20px rgba(120, 29, 21, 0.4);
    }

    .loading-spinner-large {
      width: 40px;
      height: 40px;
      border: 4px solid #9d7523;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin: 0 auto 16px auto;
    }

    .progress-bar-container {
      background: #e2e2e2;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #9d7523;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ccc;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #43b581, #9d7523);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      font-size: 14px;
      color: #230e09;
      font-weight: bold;
      text-align: center;
    }

    .button-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .success-feedback {
      background: #43b581;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    .error-feedback {
      background: #ed4245;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 10px 0;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideInDown 0.3s ease;
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-step {
      transition: border-left 0.3s ease, padding-left 0.3s ease;
    }

    .form-step.active {
      border-left: 4px solid #9d7523;
      padding-left: 16px;
    }

    .form-step.completed {
      border-left: 4px solid #43b581;
      padding-left: 16px;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .main-container {
        max-width: 900px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .page-header {
        padding: 20px;
      }
      
      .page-header h1 {
        font-size: 2em;
      }
      
      .card {
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .card.form-step {
        margin-bottom: 20px;
      }
      
      .form-grid {
        gap: 20px;
        grid-template-columns: 1fr;
      }
      
      input, select, textarea {
        padding: 10px 12px;
      }
      
      button {
        padding: 10px 20px;
      }
      
      .primary-btn {
        padding: 14px 28px;
      }
    }

    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.6em;
      }
      
      .card {
        padding: 16px;
      }
      
      .card-header h2 {
        font-size: 1.2em;
      }
    }
    /* Tab content styling */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #formTab {
      display: block; /* Form tab visible by default */
    }
    
    #historyTab {
      display: none; /* History tab hidden by default */
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      /* Force visibility when shown */
      position: relative !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      min-height: 300px !important;
      z-index: 1000 !important;
    }
    
    #historyTab.active {
      display: block !important;
    }
    
    #historyList {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      min-height: 200px !important;
    }
    
    /* Discord output toggle styles */
    #discordOutputContainer {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    #toggleOutputBtn {
      transition: all 0.2s ease;
    }
    
    #toggleOutputBtn:hover {
      background: #7d6a1e !important;
      transform: translateY(-1px);
    }
    
    #toggleOutputIcon {
      transition: transform 0.2s ease;
      font-size: 12px;
      display: inline-block;
    }
  </style>
  <script src="locations.js"></script>
</head>
<body>
  <div class="main-container">
    <!-- Page Header -->
    <div class="page-header">
      <img class="logo" src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" alt="BruteHaul Logo">
      <h1>Brute Haul Online Documentation System</h1>
    </div>

    <!-- Navigation Tabs -->
    <div class="card" id="navigationCard">
      <div style="display: flex; gap: 12px; margin-bottom: 0;">
        <button type="button" onclick="showTab('formTab')" id="formTabBtn" style="border: 3px solid transparent;">Form</button>
        <button type="button" onclick="showTab('historyTab')" id="historyTabBtn" style="border: 3px solid transparent;">History</button>
        <a href="https://robertsspaceindustries.com/en/orgs/BRHS" target="_blank" title="Join BRHS"
           style="margin-left:auto; display:inline-flex; align-items:center; justify-content:center; width:60px; height:60px; background:#222; border-radius:8px; text-decoration:none; border:0px solid #9d7523;">
          <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/starcitizenwhite.png" alt="Star Citizen" style="width:82px; height:82px; object-fit:contain; filter:invert(1);">
        </a>
      </div>
    </div>

    <!-- COMPLETELY NEW History Tab positioned right after navigation -->
    <div id="historyTab" style="display: none; width: 100%; max-width: 95%; margin: 0 auto;">
      <div style="background: linear-gradient(145deg, #ffffff 0%, #f8f8f8 100%); border-radius: 16px; padding: 28px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(157, 117, 35, 0.2);">
        <div id="historyList" style="min-height: 300px; padding: 20px;">
          <div style="text-align: center; background: #fff; border: 3px solid #9d7523; border-radius: 12px; padding: 30px;">
            <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" 
                 alt="BruteHaul Logo" 
                 style="max-width: 200px; width: 100%; margin-bottom: 20px; border-radius: 8px;">
            <h2 style="color: #9d7523; margin: 20px 0; font-size: 24px;">Brute Haul Manifest Log</h2>
            <p style="font-size: 18px; color: #781d15; font-weight: bold; margin: 15px 0;">
              No posts generated this session.
            </p>
            <p style="color: #666; margin: 10px 0; font-size: 16px;">
              Complete and submit manifests to see them listed here.
            </p>
            <div style="margin-top: 20px; padding: 10px; background: #e8f5e8; border-radius: 8px; border: 2px solid #28a745;">
              <strong style="color: #28a745;">‚úì History Tab Working!</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Tab Content -->
    <div id="formTab">
      <div class="form-grid">
  
  <!-- Feedback Messages -->
  <div class="success-feedback" id="successFeedback">
    <span>‚úì</span>
    <span id="successMessage">Success!</span>
  </div>
  <div class="error-feedback" id="errorFeedback">
    <span>‚ö†</span>
    <span id="errorMessage">Error occurred!</span>
  </div>

  <div class="main-content-wrapper">
    <div class="form-column">
      <form id="haulForm">
    <!-- Basic Information Card -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon">1</div>
        <h2>Basic Information</h2>
      </div>
      <div class="section form-step" id="basicInfoStep">
      <label>Order Category:</label>
      <select id="orderCategory" required>
        <option value="" selected disabled>Select category</option>
        <option value="Transport">Transport</option>
        <option value="Security">Security</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderCategoryOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderCategoryOther" required />
      </div>

      <label>Company Name:</label>
      <select id="companyName" required>
        <option value="" selected disabled>Select company</option>
        <option value="Brute Haul">Brute Haul</option>
        <option value="Wildcard Inc.">Wildcard Inc.</option>
        <option value="Space Rats">Space Rats</option>
        <option value="The Benjineering Project">The Benjineering Project</option>
      </select>

      <label>Order Type:</label>
      <select id="orderType" required onchange="toggleOrderTypeOther()">
        <option value="" selected disabled>Select order type</option>
        <option value="Resource Drive">Resource Drive</option>
        <option value="Supplies">Supplies</option>
        <option value="Trade">Trade</option>
        <option value="Resources">Resources</option>
        <option value="Salvage">Salvage</option>
        <option value="Contract">Contract</option>
        <option value="Relocation">Relocation</option>
        <option value="Other">Other</option>
      </select>
      <div id="orderTypeOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="orderTypeOther" required />
      </div>
      <div id="resourceDriveCompanyDiv" class="other-div" style="display:none;">
        <label>Resource Drive Company:</label>
        <select id="resourceDriveCompany">
          <option value="" selected disabled>Select company</option>
          <option value="Hurston Dynamics">Hurston Dynamics</option>
          <option value="Arccorp">Arccorp</option>
          <option value="üèÜ Crusader Industries üèÜ">üèÜ Crusader Industries üèÜ</option>
          <option value="Microtech">Microtech</option>
        </select>
      </div>

      <label>Ship Name:</label>
      <div class="searchable-dropdown" id="shipNameDropdown">
        <input type="text" id="shipName" placeholder="Search ship name..." autocomplete="off" required>
        <div class="dropdown-list" id="shipNameList"></div>
      </div>
      <div id="shipNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="shipNameOther" required />
      </div>

      <label>Captain Name:</label>
      <div class="searchable-dropdown" id="captainNameDropdown">
        <input type="text" id="captainName" placeholder="Search captain name..." autocomplete="off" required>
        <div class="dropdown-list" id="captainNameList"></div>
      </div>
      <div id="captainNameOtherDiv" class="other-div">
        <label>Specify Other:</label>
        <input type="text" id="captainNameOther" required />
      </div>

      <label>Crew Amount:</label>
      <input type="number" id="crewAmount" min="0" max="20" step="1" required oninput="generateCrewInputs()" />

      <div id="crewNamesDiv"></div>
    </div>
    </div>

    <div class="card form-step" id="locationTimeStep">
      <div class="card-header">
        <i class="icon">üìç</i>
        <h2>Locations & Timeline</h2>
      </div>
      <div class="card-content">
      <label>Start Location:</label>
      <div class="searchable-dropdown" id="startLocationDropdown">
        <input type="text" id="startLocation" placeholder="Search start location..." autocomplete="off" required>
        <div class="dropdown-list" id="startLocationList"></div>
      </div>

      <label>Departure Timestamp:</label>
      <div style="display: flex; gap: 8px; align-items: center;">
        <input type="datetime-local" id="departureTime" required style="flex: 1;">
        <button type="button" class="time-now-btn" onclick="setCurrentTime('departureTime')" title="Set to current time">Now</button>
      </div>

      <label>Route:</label>
      <div class="route-row">
        <div class="searchable-dropdown" id="routeStartDropdown">
          <input type="text" id="routeStart" placeholder="Search route start..." autocomplete="off" required>
          <div class="dropdown-list" id="routeStartList"></div>
        </div>
        <span class="route-arrow" style="font-size:1.5em;">‚û°Ô∏è</span>
        <div class="searchable-dropdown" id="routeEndDropdown">
          <input type="text" id="routeEnd" placeholder="Search route end..." autocomplete="off" required>
          <div class="dropdown-list" id="routeEndList"></div>
        </div>
      </div>
    </div>
    </div>

    <div class="card form-step" id="manifestStep">
      <div class="card-header">
        <i class="icon">üì¶</i>
        <h2>Cargo Manifest</h2>
      </div>
      <div class="card-content">
      <label>Cargo Manifest (add/remove lines as needed):</label>
      <div id="resourceDrivePresets" style="display:none; margin-bottom:10px;">
        <span style="font-size:13px; font-weight:bold; vertical-align:middle; margin-right:8px;">Resource Drive Presets:</span>
        <span style="display:inline-flex; gap:10px; vertical-align:middle;">
          <button type="button" class="resource-preset-btn" id="presetLargeBtn" onclick="applyManifestPreset('large')">Large Haul</button>
          <button type="button" class="resource-preset-btn" id="presetMediumBtn" onclick="applyManifestPreset('medium')">Medium Haul</button>
          <button type="button" class="resource-preset-btn" id="presetSmallBtn" onclick="applyManifestPreset('small')">Small Haul</button>
        </span>
      </div>
      <div id="manifestLines"></div>
      <div class="manifest-total-box">
  <span id="totalSCUBox">Total SCU: 0</span>
  <span style="margin-right:6px;">Total UEC:</span>
<input type="number" id="totalUECBox" style="color:#230e09; font-weight:bold; vertical-align:middle; width:120px;" value="" />
</div>
    </div>
    </div>

    <div class="card form-step" id="completionStep">
      <div class="card-header">
        <i class="icon">‚úÖ</i>
        <h2>Order Completion</h2>
      </div>
      <div class="card-content">
      <label>Order Completion Timestamp:</label>
      <div style="display: flex; gap: 8px; align-items: center;">
        <input type="datetime-local" id="completionTime" required style="flex: 1;">
        <button type="button" class="time-now-btn" onclick="setCurrentTime('completionTime')" title="Set to current time">Now</button>
      </div>
      <div id="orderDuration" style="font-weight:bold; color:#9d7523; margin-top:8px;"></div>

      <label>Repairs (UEC):</label>
      <input type="number" id="repairs" min="0" step="1" class="deductible-input" required value="0">

      <label>Restock (UEC):</label>
      <input type="number" id="restock" min="0" step="1" class="deductible-input" required value="0">

      <label>Quantum Fuel (UEC):</label>
      <input type="number" id="quantumFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Hydrogen Fuel (UEC):</label>
      <input type="number" id="hydrogenFuel" min="0" step="1" class="deductible-input" required value="0">

      <label>Crew/Ship Costs (UEC):</label>
      <input type="number" id="crewCosts" min="0" step="1" class="deductible-input" required value="0">

      <label>Notes:</label>
      <textarea id="notes" style="width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
    </div>
    </div>

    <button type="button" onclick="generateOutput()" id="generateBtn">
      <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" class="discord-btn-logo" style="filter: brightness(0) invert(1);" />
      Generate Discord Post
    </button>
    <button type="button" onclick="clearFormFields()" style="background:#b32428;color:#fff;border:none;padding:10px 16px;border-radius:5px;font-weight:bold;display:flex;align-items:center;gap:8px;margin-left:8px;margin-bottom:20px;">
  Clear Form
</button>
  </form>

  <div class="section" id="discordSection" style="display:none;">
    
    <!-- Border line -->
    <div style="border-bottom: 1px solid #9d7523; margin-bottom: 16px;"></div>
    
    <!-- Button Row: Send to Discord and Show Output Toggle -->
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
      <button type="button" onclick="sendToDiscord()" style="background:#43b581;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;">
        <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
        Send to Discord
      </button>
      
      <button type="button" onclick="toggleDiscordOutput()" id="toggleOutputBtn" style="background:#9d7523;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;">
        <span id="toggleOutputIcon">‚ñ∂</span>
        <span id="toggleOutputText">Show Generated Output</span>
      </button>
    </div>
    
    <!-- Collapsible Output Container -->
    <div id="discordOutputContainer" style="display:none;">
      <textarea id="discordOutput" readonly></textarea>
      <button type="button" onclick="copyDiscordOutput()" id="copyDiscordBtn" style="background:#5865F2;color:#fff;border:none;padding:8px 16px;border-radius:5px;font-weight:bold;display:none;align-items:center;gap:8px;">
        <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />
        Copy to Clipboard
      </button>
    </div>
  </div>
    </div>
    <!-- End form-column -->

    <!-- THIS IS A JUMPPOINT FOR ANNOUCEMENTS BECAUSE I'M LAZY AND I DON'T WANT TO SCROLL TO FIND THIS SECTION-->
    <!-- Announcements Sidebar -->
    <div class="announcements-sidebar">
      <div class="card" id="announcementsSection">
        <div class="card-header">
          <i class="icon">üì¢</i>
          <h2>Announcements</h2>
        </div>
        <div class="card-content">
          <div id="announcementsContent" style="height: auto; max-height: none;">
            <!-- Announcement Post 1 -->
            <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
                <h3 style="color:#781d15;margin:0;font-size:1.2em;">Brute Haul Manifest Error Reporting</h3>
                <div style="color:#666;font-size:0.8em;margin-top:5px;">
                  <strong>By:</strong> DyslexicNerd01<br><strong>Date:</strong> August 14, 2025
                </div>
              </div>
              <div class="announcement-body" style="color:#230e09;line-height:1.5;font-size:0.9em;">
                <p><strong>Brute Haul Manifest Logs now automatically get sent to discord after pressing the "Send to Discord" button!</strong></p>
                <p>If you do encounter any issues, you should see an error code and message explaining the problem. If this issue relates to the function of the bot, a GitHub issue will automatically open adressing the issue to have it solved as soon as possible.</p>
                <p>If you do see any of these messages, please do not panic as your current manifest will be printed in the bug report to be uploaded later! If you encounter an issue that does not generate an error message, please report it in <i>#space-truckers-diner</i> to be addressed later.</p>
                <p>Please do not report your ship not appearing in the list! The list is automatically generated from ships in <i>#ship-log</i>. Please DM Spartan to have your ship added! Until then please use the <i>"Other"</i> selection to manually enter your captain name/ship name.</p>
              </div>
            </div>
            
            <!-- Announcement Post 2 -->
            <div class="announcement-post" style="background:#fff;border-radius:8px;padding:20px;margin-bottom:20px;border:1px solid #9d7523;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div class="announcement-header" style="border-bottom:2px solid #9d7523;padding-bottom:10px;margin-bottom:15px;">
                <h3 style="color:#781d15;margin:0;font-size:1.2em;">KNOWN ISSUES AFFECTING BRUTE HAUL OPERATIONS</h3>
                <div style="color:#666;font-size:0.8em;margin-top:5px;">
                  <strong>By:</strong> DyslexicNerd01<br><strong>Updated:</strong> August 20, 2025
                </div>
              </div>
              <div class="announcement-body" style="color:#230e09;line-height:1.5;font-size:0.9em;">
                <p><strong>Below are currently known major issues affecting Brute Haul/Ad Astra Operations. Currently there are no official fixes or 100% reliable workarounds.</strong></p>
                <p><strong>üü¢ Issue:</strong> <u>Freight Elevator Overloaded</u><br>
                <strong>Verified Fixed:</strong> This issue is confirmed to be fixed in Live 4.3.0. Verified by Brute Haul memembers in Live 4.3.0 <br><i>*This issue still may be present at Pyro Locations*</i></p>
                <p><strong>üü° Issue:</strong> <u>Elevators not lowering/storing items</u><br>
                <strong>Reported as Fixed:</strong> Live 4.3.0 reports that this issue has been fixed. Brute Haul has not self verified that this issue has been resolved.</p>
                <p>Follow this support ticket for more information on current bugs/issues: <a href="https://support.robertsspaceindustries.com/hc/en-us/articles/360056254754-Star-Citizen-Alpha-4-3-Known-Issues" target="_blank" style="color:#781d15;">Star Citizen Known Issues</a></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- End main-content-wrapper -->
  <!-- Full-width Progress Bar at Bottom of Form -->
  <div class="progress-bar-container" style="width: 100%; margin: 24px 0; padding: 0 40px; box-sizing: border-box;">
    <div class="progress-bar">
      <div class="progress-fill" id="formProgressFill"></div>
    </div>
    <div class="progress-text" id="formProgressText">Form Completion: 0%</div>
  </div>
  </div> <!-- End formTab -->
  </div> <!-- End main-container -->
<script type="module">
   // Locations are loaded from external locations.js file

    // Ship lists per category
    const transportShips = [
      "SPRT Icarus", "BRHS Lednik", "BRHS Trireme", "WINC Caterpillar", "WINCO Rafto"
    ];
    const securityShips = [
      "AACS Landsknecht", "AACS Feder", "BRHS Seastrom", "BRHS Sword of Twilight", "AACS Dendrobium", "AACS Judgement‚Äôs Bow"
    ];
    const allShips = [
      ...transportShips,
      ...securityShips,
    ];

    // Captain names list
    const captainNames = [
      "DyslexicNerd", "Spartan", "Lightblade", "jjetstreamm", "Roflnomish", 
      "BenjiNotorious", "zarainia", "Astol", "Venomnom", "BigDaddyTortuga", 
      "ItzProto", "Newt", "Xolion", "Bakes Kamuari", "LockEmUpJas", 
      "sadfish", "Efazer"
    ];

    // Manifest material list
    const materialList = [
      "Select Material", "Agricium", "Aluminium", "Aphorite", "Beryl", "Bexalite", "Borase", "Copper", "Corundum", "Diamond", "Dolivine", "Dyslexium", "Gold", "Hadanite", "Hephaestanite", "Inert materials", "Laranite", "Placeholder", "Spartanium", "Quantanium", "Quartz", "Taranite", "Tungsten", "Titanium"
    ];

    // Clear button functions
    function clearFormFields() {
  // Clear timestamps
  document.getElementById("departureTime").value = "";
  document.getElementById("completionTime").value = "";
  document.getElementById("orderDuration").textContent = "";

  // Reset manifest to one empty line
  manifestLineCount = 1;
  renderManifestLines();
  // Clear values in the first manifest line
  const firstManifestRow = document.querySelector('.manifest-row');
  if (firstManifestRow) {
    firstManifestRow.querySelector('.manifest-scu').value = "";
    firstManifestRow.querySelector('.manifest-material').selectedIndex = 0;
    firstManifestRow.querySelector('.manifest-uec').value = "";
  }

  // Reset total SCU display
  document.getElementById("totalSCUBox").textContent = "Total SCU: 0";

  // Clear deductibles
  document.getElementById("repairs").value = "0";
  document.getElementById("restock").value = "0";
  document.getElementById("quantumFuel").value = "0";
  document.getElementById("hydrogenFuel").value = "0";
  document.getElementById("crewCosts").value = "0";
  document.getElementById("totalUECBox").value = "";

  // Clear route
  document.getElementById("routeStart").value = "";
  document.getElementById("routeEnd").value = "";

  // Clear start location
  document.getElementById("startLocation").value = "";

  // Keep ship name, captain name, and crew information intact - do not clear them

  // Clear notes
  document.getElementById("notes").value = "";
  
  // Hide Discord section and copy button
  document.getElementById("discordSection").style.display = "none";
  hideCopyButton();
  
  // Show the Generate button again
  const generateBtn = document.getElementById("generateBtn");
  if (generateBtn) {
    generateBtn.style.display = "inline-flex";
  }
  
  // Reset progress bar
  calculateFormProgress();
}

function showTab(tab) {
  // Simple display switching
  const formTab = document.getElementById('formTab');
  const historyTab = document.getElementById('historyTab');
  
  if (formTab && historyTab) {
    if (tab === 'formTab') {
      formTab.style.display = 'block';
      historyTab.style.display = 'none';
    } else if (tab === 'historyTab') {
      formTab.style.display = 'none';
      historyTab.style.display = 'block';
      // Render history when showing history tab
      renderHistory();
    }
  }

  // Tab highlighting
  const formTabBtn = document.getElementById('formTabBtn');
  const historyTabBtn = document.getElementById('historyTabBtn');
  
  if (formTabBtn && historyTabBtn) {
    formTabBtn.style.background = tab === 'formTab' ? '#9d7523' : '#781d15';
    historyTabBtn.style.background = tab === 'historyTab' ? '#9d7523' : '#781d15';

    formTabBtn.style.color = '#fff';
    historyTabBtn.style.color = '#fff';

    // Black outline for selected tab
    formTabBtn.style.border = tab === 'formTab' ? '3px solid #000' : '3px solid transparent';
    historyTabBtn.style.border = tab === 'historyTab' ? '3px solid #000' : '3px solid transparent';
  }
}
window.showTab = showTab;

window.addEventListener("DOMContentLoaded", function() {
  showTab('formTab');
  // Ensure totalUECBox starts blank on first load
  const totalUECInput = document.getElementById("totalUECBox");
  if (totalUECInput) totalUECInput.value = "";
  
  // Set up dynamic announcements height
  resizeAnnouncementsContent();
});

// Function to dynamically resize announcements content
function resizeAnnouncementsContent() {
  const announcementsContent = document.getElementById('announcementsContent');
  const formCompletionCard = document.getElementById('completionStep');
  
  if (announcementsContent && formCompletionCard) {
    // Get the natural height of the content
    announcementsContent.style.height = 'auto';
    announcementsContent.style.maxHeight = 'none';
    announcementsContent.style.overflow = 'visible';
    
    const contentRect = announcementsContent.getBoundingClientRect();
    const completionRect = formCompletionCard.getBoundingClientRect();
    
    // If announcements content goes below the completion card, add scroll
    if (contentRect.bottom > completionRect.bottom) {
      const maxHeight = completionRect.bottom - contentRect.top - 20; // 20px buffer
      announcementsContent.style.height = maxHeight + 'px';
      announcementsContent.style.maxHeight = maxHeight + 'px';
      announcementsContent.style.overflow = 'auto';
    }
  }
}

// Resize on window resize
window.addEventListener('resize', resizeAnnouncementsContent);

    function populateLocationDropdown(id) {
      const inputId = id;
      const listId = id + 'List';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let selectedValue = '';
      let filteredLocations = locations;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterLocations(searchTerm) {
        const term = searchTerm.toLowerCase();
        return locations.filter(location => 
          location.toLowerCase().includes(term)
        ); // Show all matching results
      }

      function renderDropdownItems(locationsToShow) {
        list.innerHTML = '';
        locationsToShow.forEach(location => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = location;
          item.addEventListener('click', () => {
            input.value = location;
            selectedValue = location;
            hideDropdown();
            input.classList.remove('error');
          });
          list.appendChild(item);
        });
      }

      // Initialize with all locations
      renderDropdownItems(locations);

      // Handle input events
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredLocations = locations;
        } else {
          filteredLocations = filterLocations(searchTerm);
        }
        renderDropdownItems(filteredLocations);
        showDropdown();
        selectedValue = '';
      });

      input.addEventListener('focus', () => {
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      // Handle keyboard navigation
      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      // Custom validation function
      input.validateValue = function() {
        return locations.includes(input.value);
      };
    }

    // Close all dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.searchable-dropdown')) {
        document.querySelectorAll('.dropdown-list').forEach(list => {
          list.classList.remove('show');
        });
      }
    });

    function populateShipDropdown(category) {
      const inputId = 'shipName';
      const listId = 'shipNameList';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      let ships = [];
      if (category === "Transport") {
        ships = transportShips;
      } else if (category === "Security") {
        ships = securityShips;
      } else {
        ships = allShips;
      }

      const shipsWithOther = [...ships, "Other"];

      let selectedValue = '';
      let filteredShips = shipsWithOther;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterShips(searchTerm) {
        const term = searchTerm.toLowerCase();
        return shipsWithOther.filter(ship => 
          ship.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(shipsToShow) {
        list.innerHTML = '';
        shipsToShow.forEach(ship => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = ship;
          item.addEventListener('click', () => {
            input.value = ship;
            selectedValue = ship;
            hideDropdown();
            input.classList.remove('error');
            toggleShipNameOther();
          });
          list.appendChild(item);
        });
      }

      // Initialize with ships for category
      renderDropdownItems(shipsWithOther);

      // Remove existing event listeners
      input.removeEventListener('input', input._shipInputHandler);
      input.removeEventListener('focus', input._shipFocusHandler);
      input.removeEventListener('blur', input._shipBlurHandler);
      input.removeEventListener('keydown', input._shipKeydownHandler);

      // Handle input events
      input._shipInputHandler = (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredShips = shipsWithOther;
        } else {
          filteredShips = filterShips(searchTerm);
        }
        renderDropdownItems(filteredShips);
        showDropdown();
        selectedValue = '';
      };
      input.addEventListener('input', input._shipInputHandler);

      input._shipFocusHandler = () => {
        showDropdown();
      };
      input.addEventListener('focus', input._shipFocusHandler);

      input._shipBlurHandler = () => {
        hideDropdown();
      };
      input.addEventListener('blur', input._shipBlurHandler);

      // Handle keyboard navigation
      input._shipKeydownHandler = (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            toggleShipNameOther();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      };
      input.addEventListener('keydown', input._shipKeydownHandler);

      // Custom validation function
      input.validateValue = function() {
        return shipsWithOther.includes(input.value);
      };
    }

    function populateCaptainDropdown() {
      const inputId = 'captainName';
      const listId = 'captainNameList';
      const input = document.getElementById(inputId);
      const list = document.getElementById(listId);
      
      if (!input || !list) return;

      const captainsWithOther = [...captainNames, "Other"];

      let selectedValue = '';
      let filteredCaptains = captainsWithOther;

      function showDropdown() {
        list.classList.add('show');
      }

      function hideDropdown() {
        setTimeout(() => {
          list.classList.remove('show');
        }, 200);
      }

      function filterCaptains(searchTerm) {
        const term = searchTerm.toLowerCase();
        return captainsWithOther.filter(captain => 
          captain.toLowerCase().includes(term)
        );
      }

      function renderDropdownItems(captainsToShow) {
        list.innerHTML = '';
        captainsToShow.forEach(captain => {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = captain;
          item.addEventListener('click', () => {
            input.value = captain;
            selectedValue = captain;
            hideDropdown();
            input.classList.remove('error');
            toggleCaptainNameOther();
          });
          list.appendChild(item);
        });
      }

      // Initialize with all captains
      renderDropdownItems(captainsWithOther);

      // Handle input events
      input.addEventListener('input', (e) => {
        const searchTerm = e.target.value;
        if (searchTerm.length === 0) {
          filteredCaptains = captainsWithOther;
        } else {
          filteredCaptains = filterCaptains(searchTerm);
        }
        renderDropdownItems(filteredCaptains);
        showDropdown();
        selectedValue = '';
      });

      input.addEventListener('focus', () => {
        showDropdown();
      });

      input.addEventListener('blur', () => {
        hideDropdown();
      });

      // Handle keyboard navigation
      input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.dropdown-item');
        let selectedIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (selectedIndex < items.length - 1) {
            if (selectedIndex >= 0) items[selectedIndex].classList.remove('selected');
            selectedIndex++;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (selectedIndex > 0) {
            items[selectedIndex].classList.remove('selected');
            selectedIndex--;
            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && items[selectedIndex]) {
            input.value = items[selectedIndex].textContent;
            selectedValue = items[selectedIndex].textContent;
            hideDropdown();
            input.classList.remove('error');
            toggleCaptainNameOther();
          }
        } else if (e.key === 'Escape') {
          hideDropdown();
        }
      });

      // Custom validation function
      input.validateValue = function() {
        return captainsWithOther.includes(input.value);
      };
    }

    let manifestLineCount = 1;

    function createManifestLine(index) {
      const isLast = index === manifestLineCount;
      return `
        <div class="manifest-row" id="manifestRow${index}">
          <label>SCU:</label>
          <input type="number" min="0" step="1" class="manifest-scu" id="manifestSCU${index}" style="width:70px;" oninput="updateManifestTotals()">
          <label>Material:</label>
          <select class="manifest-material" id="manifestMaterial${index}" style="width:160px;">
            ${materialList.map(m => `<option value="${m}">${m}</option>`).join("")}
          </select>
          <label>UEC:</label>
          <input type="number" min="0" step="1" class="manifest-uec" id="manifestUEC${index}" style="width:90px;" oninput="updateManifestTotals()">
          <button type="button" onclick="removeManifestLine(${index})" class="manifest-btn remove" title="Remove line">Ôºç</button>
          ${isLast ? `<button type="button" onclick="addManifestLine()" class="manifest-btn add" title="Add line">Ôºã</button>` : ""}
        </div>
      `;
    }

    function renderManifestLines() {
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }

      // Restore previous values
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
    }
    // Resource Drive manifest presets
    function applyManifestPreset(type) {
      var preset = [];
      var totalUEC = 0;
      if (type === 'large') {
        preset = [
          { scu: 72, material: 'Corundum' },
          { scu: 36, material: 'Tungsten' },
          { scu: 72, material: 'Copper' }
        ];
        totalUEC = 101750;
      } else if (type === 'medium') {
        preset = [
          { scu: 19, material: 'Corundum' },
          { scu: 10, material: 'Tungsten' },
          { scu: 19, material: 'Copper' }
        ];
        totalUEC = 58400;
      } else if (type === 'small') {
        preset = [
          { scu: 2, material: 'Corundum' },
          { scu: 4, material: 'Tungsten' },
          { scu: 2, material: 'Copper' }
        ];
        totalUEC = 53250;
      }
      manifestLineCount = preset.length;
      renderManifestLines();
      // Calculate total SCU
      var totalSCU = preset.reduce(function(sum, item) { return sum + item.scu; }, 0);
      // Distribute UEC by SCU per material
      var rows = document.querySelectorAll('.manifest-row');
      var uecAssigned = 0;
      for (var idx = 0; idx < preset.length; idx++) {
        var row = rows[idx];
        if (row) {
          row.querySelector('.manifest-scu').value = preset[idx].scu;
          row.querySelector('.manifest-material').value = preset[idx].material;
          var uec = Math.floor((preset[idx].scu / totalSCU) * totalUEC);
          if (idx === preset.length - 1) {
            uec = totalUEC - uecAssigned;
          }
          row.querySelector('.manifest-uec').value = uec;
          uecAssigned += uec;
        }
      }
      // Set total UEC box
      var totalUECInput = document.getElementById('totalUECBox');
      if (totalUECInput) totalUECInput.value = totalUEC;
      updateManifestTotals();
      var largeBtn = document.getElementById('presetLargeBtn');
      var mediumBtn = document.getElementById('presetMediumBtn');
      var smallBtn = document.getElementById('presetSmallBtn');
      if (largeBtn) largeBtn.classList.remove('selected');
      if (mediumBtn) mediumBtn.classList.remove('selected');
      if (smallBtn) smallBtn.classList.remove('selected');
      if (type === 'large' && largeBtn) largeBtn.classList.add('selected');
      if (type === 'medium' && mediumBtn) mediumBtn.classList.add('selected');
      if (type === 'small' && smallBtn) smallBtn.classList.add('selected');
    }

    function addManifestLine() {
      manifestLineCount++;
      renderManifestLines();
      calculateFormProgress();
    }

    function removeManifestLine(index) {
      const manifestData = [];
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        manifestData.push({
          scu: row.querySelector('.manifest-scu')?.value || "",
          material: row.querySelector('.manifest-material')?.value || "",
          uec: row.querySelector('.manifest-uec')?.value || ""
        });
      });
      manifestData.splice(index - 1, 1);

      manifestLineCount--;
      if (manifestLineCount < 1) manifestLineCount = 1;

      const manifestLines = document.getElementById("manifestLines");
      manifestLines.innerHTML = "";
      for (let i = 1; i <= manifestLineCount; i++) {
        manifestLines.insertAdjacentHTML('beforeend', createManifestLine(i));
      }
      document.querySelectorAll('.manifest-row').forEach((row, idx) => {
        if (manifestData[idx]) {
          row.querySelector('.manifest-scu').value = manifestData[idx].scu;
          row.querySelector('.manifest-material').value = manifestData[idx].material;
          row.querySelector('.manifest-uec').value = manifestData[idx].uec;
        }
      });

      updateManifestTotals();
      calculateFormProgress();
    }

    function updateManifestTotals() {
  let totalSCU = 0;
  let totalUEC = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scu = parseInt(row.querySelector('.manifest-scu').value, 10);
    const uec = parseInt(row.querySelector('.manifest-uec').value, 10);
    if (!isNaN(scu)) totalSCU += scu;
    if (!isNaN(uec)) totalUEC += uec;
  });

  document.getElementById("totalSCUBox").textContent = `Total SCU: ${totalSCU.toLocaleString()}`;

  // Set totalUECBox to the sum unless the user is editing it
  const totalUECInput = document.getElementById("totalUECBox");
  if (document.activeElement !== totalUECInput) {
    totalUECInput.value = totalUEC > 0 ? totalUEC : "";
  }
}

    window.toggleOrderTypeOther = toggleOrderTypeOther;
    window.toggleOrderCategoryOther = toggleOrderCategoryOther;
    window.toggleShipNameOther = toggleShipNameOther;
    window.toggleCaptainNameOther = toggleCaptainNameOther;
    window.generateCrewInputs = generateCrewInputs;
    window.addManifestLine = addManifestLine;
    window.removeManifestLine = removeManifestLine;
    window.updateManifestTotals = updateManifestTotals;
    window.generateOutput = generateOutput;
    window.copyDiscordOutput = copyDiscordOutput;
    window.toggleDiscordOutput = toggleDiscordOutput;
    window.showCopyButton = showCopyButton;
    window.hideCopyButton = hideCopyButton;
    window.showGenerateButtonOnChange = showGenerateButtonOnChange;
    window.clearFormFields = clearFormFields;

    // Make applyManifestPreset available globally
window.applyManifestPreset = applyManifestPreset;

    window.addEventListener("DOMContentLoaded", function() {
      populateLocationDropdown("startLocation");
      populateLocationDropdown("routeStart");
      populateLocationDropdown("routeEnd");
      populateShipDropdown("");
      populateCaptainDropdown();
      document.getElementById("discordSection").style.display = "none";
      manifestLineCount = 1;
      renderManifestLines();
      renderHistory();
      calculateFormProgress();
      
      const formElements = document.querySelectorAll('input, select, textarea');
      formElements.forEach(element => {
        element.addEventListener('input', calculateFormProgress);
        element.addEventListener('change', calculateFormProgress);
        element.addEventListener('input', showGenerateButtonOnChange);
        element.addEventListener('change', showGenerateButtonOnChange);
      });
      
      const manifestContainer = document.getElementById('manifestLines');
      if (manifestContainer) {
        const observer = new MutationObserver(calculateFormProgress);
        observer.observe(manifestContainer, { childList: true, subtree: true });
      }
    });

    document.getElementById("orderCategory").addEventListener("change", function() {
      toggleOrderCategoryOther();
      populateShipDropdown(this.value);
    });
    document.getElementById("orderType").addEventListener("change", function() {
      toggleOrderTypeOther();

      const val = this.value;
      const presetsDiv = document.getElementById("resourceDrivePresets");
      if (val === "Resource Drive") {
        presetsDiv.style.display = "block";
      } else {
        presetsDiv.style.display = "none";
      }
    });

    document.getElementById("departureTime").addEventListener("change", function() {
      this.classList.remove('error');
      updateOrderDuration();
    });
    
    document.getElementById("completionTime").addEventListener("change", function() {
      this.classList.remove('error');
      updateOrderDuration();
    });

    function toDiscordTimestamp(dtString) {
      if (!dtString) return "";
      const date = new Date(dtString);
      if (isNaN(date.getTime())) return "";
      // Add 930 years (Updates to SC time automatically)
      const yearsToAdd = 930;
      date.setFullYear(date.getFullYear() + yearsToAdd);
      const unix = Math.floor(date.getTime() / 1000);
      return `<t:${unix}:f>`;
    }
    // Ship Message Links - Adapted from Threads
    const shipLinks = {
      "BRHS Seastrom": "https://discord.com/channels/900478857436606535/1391878505905524817/1404322180329898046",
      "AACS Judgement's Bow": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319407106293843",
      "BRHS Sword of Twilight": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319218261954661",
      "BRHS Trireme": "https://discord.com/channels/900478857436606535/1391878505905524817/1404319148888031312",
      "AACS Dendrobium": "https://discord.com/channels/900478857436606535/1391878505905524817/1403127587567439872",
      "WINCO Rafto": "https://discord.com/channels/900478857436606535/1391878505905524817/1398047073097482262",
      "BRHS Lednik": "https://discord.com/channels/900478857436606535/1391878505905524817/1398045703367823461",
      "SPRT Icarus": "https://discord.com/channels/900478857436606535/1391878505905524817/1396265862268190830",
      "AACS Feder": "https://discord.com/channels/900478857436606535/1391878505905524817/1393365523407835196",
      "AACS Landsknecht": "https://discord.com/channels/900478857436606535/1391878505905524817/1392713534005186730",
      "WINC Caterpillar": "https://discord.com/channels/900478857436606535/1391878505905524817/1391904347117322322"
    };

    // Loading States & Progress Indicators
    function showLoadingOverlay(message = "Processing...") {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingOverlay';
      overlay.innerHTML = `
        <div class="loading-content">
          <div class="loading-spinner-large"></div>
          <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${message}</div>
          <div style="font-size: 14px; opacity: 0.8;">Please wait...</div>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function showNotificationOverlay(message, type = 'info', duration = 0) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'notificationOverlay';
      
      let icon = '';
      let bgColor = '#781d15';
      let borderColor = '#9d7523';
      
      switch(type) {
        case 'success':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">‚úì</div>';
          bgColor = '#43b581';
          borderColor = '#2ea964';
          break;
        case 'error':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">‚ö†</div>';
          bgColor = '#ed4245';
          borderColor = '#b32428';
          break;
        case 'warning':
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">‚ö†</div>';
          bgColor = '#faa61a';
          borderColor = '#e18d00';
          break;
        default:
          icon = '<div style="font-size: 32px; margin-bottom: 16px;">‚Ñπ</div>';
      }
      
      overlay.innerHTML = `
        <div class="loading-content" style="background: ${bgColor}; border-color: ${borderColor};">
          <button class="close-button" onclick="document.getElementById('notificationOverlay').remove()">√ó</button>
          ${icon}
          <div style="font-size: 16px; font-weight: bold; text-align: center; line-height: 1.4;">${message}</div>
        </div>
      `;
      document.body.appendChild(overlay);
      
    }

    function showLoadingMessage(message, autoCloseAfterMs = 0) {
      const overlay = document.createElement('div');
      overlay.className = 'loading-overlay';
      overlay.id = 'loadingMessageOverlay';
      
      overlay.innerHTML = `
        <div class="loading-content">
          <div class="loading-spinner-large"></div>
          <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${message}</div>
          <div style="font-size: 14px; opacity: 0.8;">Please wait...</div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      if (autoCloseAfterMs > 0) {
        setTimeout(() => {
          const loadingOverlay = document.getElementById('loadingMessageOverlay');
          if (loadingOverlay) {
            loadingOverlay.remove();
          }
        }, autoCloseAfterMs);
      }
      
      return overlay;
    }

    function hideLoadingMessage() {
      const overlay = document.getElementById('loadingMessageOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function showButtonLoading(buttonId, loadingText = null) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.add('button-loading');
        button.disabled = true;
        const originalHTML = button.innerHTML;
        button.setAttribute('data-original-html', originalHTML);
        
        if (loadingText) {
          button.innerHTML = `<div class="loading-spinner"></div>${loadingText}`;
        } else {
          button.innerHTML = `<div class="loading-spinner"></div>Processing...`;
        }
      }
    }

    function hideButtonLoading(buttonId) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.remove('button-loading');
        button.disabled = false;
        const originalHTML = button.getAttribute('data-original-html');
        if (originalHTML) {
          button.innerHTML = originalHTML;
          button.removeAttribute('data-original-html');
        }
      }
    }

    function showFeedback(type, message, duration = 5000) {
      const feedbackElement = type === 'success' ? 
        document.getElementById('successFeedback') : 
        document.getElementById('errorFeedback');
      const messageElement = type === 'success' ? 
        document.getElementById('successMessage') : 
        document.getElementById('errorMessage');
      
      if (feedbackElement && messageElement) {
        messageElement.textContent = message;
        feedbackElement.style.display = 'flex';
        
        setTimeout(() => {
          feedbackElement.style.display = 'none';
        }, duration);
      }
    }

    function calculateFormProgress() {
      const requiredFields = [
        'orderCategory', 'companyName', 'orderType', 'shipName', 'captainName',
        'crewAmount', 'startLocation', 'departureTime', 'routeStart', 'routeEnd',
        'completionTime'
      ];
      
      let filledFields = 0;
      let totalFields = requiredFields.length;
      
      for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        let isFieldValid = false;
        
        if (field) {
          if (fieldId === 'startLocation' || fieldId === 'routeStart' || fieldId === 'routeEnd') {
            isFieldValid = field.value && field.value.trim() !== '' && locations.includes(field.value);
          } 
          else if (fieldId === 'shipName') {
            isFieldValid = field.value && field.value.trim() !== '' && (allShips.includes(field.value) || field.value === 'Other');
          }
          else if (fieldId === 'captainName') {
            isFieldValid = field.value && field.value.trim() !== '' && (captainNames.includes(field.value) || field.value === 'Other');
          }
          else {
            isFieldValid = field.value && field.value.trim() !== '';
          }
          
          if (isFieldValid) {
            filledFields++;
          }
        }
      }
      
      const otherFieldChecks = [
        { select: 'orderCategory', other: 'orderCategoryOther' },
        { select: 'orderType', other: 'orderTypeOther' },
        { select: 'shipName', other: 'shipNameOther' },
        { select: 'captainName', other: 'captainNameOther' }
      ];
      
      for (const check of otherFieldChecks) {
        const selectField = document.getElementById(check.select);
        const otherField = document.getElementById(check.other);
        const otherDiv = document.getElementById(check.other + 'Div');
        
        if (selectField && selectField.value === 'Other' && otherDiv && otherDiv.style.display !== 'none') {
          totalFields++;
          if (otherField && otherField.value && otherField.value.trim() !== '') {
            filledFields++;
          }
        }
      }
      
      const crewAmount = parseInt(document.getElementById('crewAmount')?.value || '0', 10);
      if (crewAmount > 0) {
        totalFields += crewAmount;
        for (let i = 1; i <= crewAmount; i++) {
          const crewField = document.getElementById(`crewName${i}`);
          if (crewField && crewField.value && crewField.value.trim() !== '') {
            filledFields++;
          }
        }
      }
      
      const manifestRows = document.querySelectorAll('.manifest-row');
      let hasValidManifest = false;
      manifestRows.forEach(row => {
        const material = row.querySelector('.manifest-material');
        if (material && material.value && material.value.trim() !== '' && material.value !== 'Select Material') {
          hasValidManifest = true;
        }
      });
      
      if (hasValidManifest) {
        filledFields++;
      }
      totalFields++; 
      const percentage = Math.round((filledFields / totalFields) * 100);
      

      const progressFill = document.getElementById('formProgressFill');
      const progressText = document.getElementById('formProgressText');
      
      if (progressFill) {
        progressFill.style.width = `${percentage}%`;
      }
      
      if (progressText) {
        progressText.textContent = `Form Completion: ${percentage}%`;
      }
      

      updateFormStepStates();
      
      return percentage;
    }

    function updateFormStepStates() {
      const steps = [
        {
          id: 'basicInfoStep',
          fields: ['orderCategory', 'companyName', 'orderType', 'shipName', 'captainName', 'crewAmount']
        },
        {
          id: 'locationTimeStep',
          fields: ['startLocation', 'departureTime', 'routeStart', 'routeEnd']
        },
        {
          id: 'manifestStep',
          fields: []
        },
        {
          id: 'completionStep',
          fields: ['completionTime']
        }
      ];
      
      steps.forEach(step => {
        const stepElement = document.getElementById(step.id);
        if (!stepElement) return;
        
        let completedFields = 0;
        let totalStepFields = step.fields.length;
        
        if (step.id === 'manifestStep') {
          const manifestRows = document.querySelectorAll('.manifest-row');
          let hasValidManifest = false;
          manifestRows.forEach(row => {
            const material = row.querySelector('.manifest-material');
            if (material && material.value && material.value.trim() !== '' && material.value !== 'Select Material') {
              hasValidManifest = true;
            }
          });
          completedFields = hasValidManifest ? 1 : 0;
          totalStepFields = 1;
        } else {
          
          for (const fieldId of step.fields) {
            const field = document.getElementById(fieldId);
            let isFieldValid = false;
            
            if (field) {

              if (fieldId === 'startLocation' || fieldId === 'routeStart' || fieldId === 'routeEnd') {
                isFieldValid = field.value && field.value.trim() !== '' && locations.includes(field.value);
              } else {
                isFieldValid = field.value && field.value.trim() !== '';
              }
              
              if (isFieldValid) {
                completedFields++;
              }
            }
          }
          
          if (step.id === 'basicInfoStep') {
            const crewAmount = parseInt(document.getElementById('crewAmount')?.value || '0', 10);
            if (crewAmount > 0) {
              totalStepFields += crewAmount;
              for (let i = 1; i <= crewAmount; i++) {
                const crewField = document.getElementById(`crewName${i}`);
                if (crewField && crewField.value && crewField.value.trim() !== '') {
                  completedFields++;
                }
              }
            }
            
            const otherFieldChecks = [
              { select: 'orderCategory', other: 'orderCategoryOther' },
              { select: 'orderType', other: 'orderTypeOther' },
              { select: 'shipName', other: 'shipNameOther' },
              { select: 'captainName', other: 'captainNameOther' }
            ];
            
            for (const check of otherFieldChecks) {
              const selectField = document.getElementById(check.select);
              const otherField = document.getElementById(check.other);
              const otherDiv = document.getElementById(check.other + 'Div');
              
              if (selectField && selectField.value === 'Other' && otherDiv && otherDiv.style.display !== 'none') {
                totalStepFields++;
                if (otherField && otherField.value && otherField.value.trim() !== '') {
                  completedFields++;
                }
              }
            }
          }
        }
        
        stepElement.classList.remove('active', 'completed');
        if (completedFields === totalStepFields && completedFields > 0) {
          stepElement.classList.add('completed');
        } else if (completedFields > 0) {
          stepElement.classList.add('active');
        }
      });
    }

    function toggleOrderCategoryOther() {
      const val = document.getElementById("orderCategory").value;
      const otherDiv = document.getElementById("orderCategoryOtherDiv");
      if (val === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderCategoryOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("orderCategoryOther").required = false;
      }
    }

    function toggleOrderTypeOther() {
      const orderType = document.getElementById("orderType").value;
      const otherDiv = document.getElementById("orderTypeOtherDiv");
      const resourceDriveDiv = document.getElementById("resourceDriveCompanyDiv");
      if (orderType === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("orderTypeOther").required = true;
        resourceDriveDiv.style.display = "none";
        document.getElementById("resourceDriveCompany").required = false;
      } else if (orderType === "Resource Drive") {
        resourceDriveDiv.style.display = "block";
        document.getElementById("resourceDriveCompany").required = true;
        otherDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
      } else {
        otherDiv.style.display = "none";
        resourceDriveDiv.style.display = "none";
        document.getElementById("orderTypeOther").required = false;
        document.getElementById("resourceDriveCompany").required = false;
      }
    }

    function toggleShipNameOther() {
      const shipName = document.getElementById("shipName").value;
      const otherDiv = document.getElementById("shipNameOtherDiv");
      if (shipName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("shipNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("shipNameOther").required = false;
      }
    }

    function toggleCaptainNameOther() {
      const captainName = document.getElementById("captainName").value;
      const otherDiv = document.getElementById("captainNameOtherDiv");
      if (captainName === "Other") {
        otherDiv.style.display = "block";
        document.getElementById("captainNameOther").required = true;
      } else {
        otherDiv.style.display = "none";
        document.getElementById("captainNameOther").required = false;
      }
    }

    function generateCrewInputs() {
      const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
      const crewNamesDiv = document.getElementById("crewNamesDiv");
      crewNamesDiv.innerHTML = "";
      if (!isNaN(crewAmount) && crewAmount > 0) {
        for (let i = 1; i <= crewAmount; i++) {
          const label = document.createElement("label");
          label.textContent = `Crew ${i} Name:`;
          label.htmlFor = `crewName${i}`;
          label.className = "crew-label";
          const input = document.createElement("input");
          input.type = "text";
          input.id = `crewName${i}`;
          input.name = `crewName${i}`;
          input.required = true;
          input.className = "crew-input";
          input.addEventListener('input', calculateFormProgress);
          input.addEventListener('change', calculateFormProgress);
          crewNamesDiv.appendChild(label);
          crewNamesDiv.appendChild(input);
        }
      }
      calculateFormProgress();
    }

    function validateRequiredFields() {
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

      const requiredFields = [
        "orderCategory",
        "companyName",
        "orderType",
        "shipName",
        "captainName",
        "crewAmount",
        "startLocation",
        "departureTime",
        "routeStart",
        "routeEnd",
        "completionTime",
        "repairs",
        "restock",
        "quantumFuel",
        "hydrogenFuel",
        "crewCosts",
        "totalUECBox"
      ];
      requiredFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => el.classList.remove('error'));
      el.addEventListener('change', () => el.classList.remove('error'));
    }
  });

  document.querySelectorAll('.manifest-scu, .manifest-material, .crew-input').forEach(el => {
    el.addEventListener('input', () => el.classList.remove('error'));
    el.addEventListener('change', () => el.classList.remove('error'));
  });

  let allErrors = [];
  let firstErrorElement = null;

  function addError(element, message, fieldName) {
    if (element) {
      element.classList.add('error');
      if (!firstErrorElement) firstErrorElement = element;
    }
    allErrors.push({ element, message, fieldName });
  }

  for (const id of requiredFields) {
    const el = document.getElementById(id);
    let isValid = false;
    let fieldLabel = id.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
    
    if (!el) continue;
    
    if (id === 'startLocation' || id === 'routeStart' || id === 'routeEnd') {
      if (el.value.trim() === "") {
        addError(el, `${fieldLabel} is required`, fieldLabel);
      } else if (!locations.includes(el.value)) {
        addError(el, `${fieldLabel} must be a valid location from the dropdown`, fieldLabel);
      }
    } else {
      if (el.value === "" || el.value === null) {
        addError(el, `${fieldLabel} is required`, fieldLabel);
      }
    }
  }

  const otherFields = [
    {select: "orderCategory", other: "orderCategoryOtherDiv", input: "orderCategoryOther", label: "Order Category (Other)"},
    {select: "orderType", other: "orderTypeOtherDiv", input: "orderTypeOther", label: "Order Type (Other)"},
    {select: "shipName", other: "shipNameOtherDiv", input: "shipNameOther", label: "Ship Name (Other)"},
    {select: "captainName", other: "captainNameOtherDiv", input: "captainNameOther", label: "Captain Name (Other)"}
  ];
  
  for (const field of otherFields) {
    const selectEl = document.getElementById(field.select);
    const otherDiv = document.getElementById(field.other);
    const otherInput = document.getElementById(field.input);
    if (selectEl && selectEl.value === "Other" && otherDiv && otherDiv.style.display === "block") {
      if (!otherInput || !otherInput.value.trim()) {
        addError(otherInput, `${field.label} is required when "Other" is selected`, field.label);
      }
    }
  }

  const crewAmount = parseInt(document.getElementById("crewAmount").value, 10);
  if (!isNaN(crewAmount) && crewAmount > 0) {
    for (let i = 1; i <= crewAmount; i++) {
      const crewInput = document.getElementById(`crewName${i}`);
      if (!crewInput || !crewInput.value.trim()) {
        addError(crewInput, `Crew ${i} Name is required`, `Crew ${i} Name`);
      }
    }
  }

  const manifestRows = document.querySelectorAll('.manifest-row');
  if (manifestRows.length === 0) {
    allErrors.push({ 
      element: null, 
      message: "At least one manifest line is required", 
      fieldName: "Manifest" 
    });
  } else {
    let manifestIndex = 1;
    for (const row of manifestRows) {
      const scu = row.querySelector('.manifest-scu');
      const mat = row.querySelector('.manifest-material');
      
      if (!scu || !scu.value.trim()) {
        addError(scu, `Manifest Line ${manifestIndex}: SCU is required`, `Manifest Line ${manifestIndex} SCU`);
      }
      if (!mat || !mat.value.trim()) {
        addError(mat, `Manifest Line ${manifestIndex}: Material is required`, `Manifest Line ${manifestIndex} Material`);
      }
      manifestIndex++;
    }
  }

  const timestampErrors = validateTimestampsDetailed();
  if (timestampErrors.length > 0) {
    allErrors.push(...timestampErrors);
  }

  if (allErrors.length > 0) {
    if (firstErrorElement) {
      firstErrorElement.scrollIntoView({behavior: "smooth", block: "center"});
    }
    
    const errorsByCategory = {
      'Basic Information': [],
      'Route & Timing': [],
      'Crew Information': [],
      'Manifest': [],
      'Financial Information': [],
      'Other': []
    };
    
    allErrors.forEach(error => {
      const fieldName = error.fieldName.toLowerCase();
      if (fieldName.includes('category') || fieldName.includes('company') || fieldName.includes('type') || fieldName.includes('ship') || fieldName.includes('captain')) {
        errorsByCategory['Basic Information'].push(error.message);
      } else if (fieldName.includes('location') || fieldName.includes('route') || fieldName.includes('time') || fieldName.includes('timestamp')) {
        errorsByCategory['Route & Timing'].push(error.message);
      } else if (fieldName.includes('crew')) {
        errorsByCategory['Crew Information'].push(error.message);
      } else if (fieldName.includes('manifest')) {
        errorsByCategory['Manifest'].push(error.message);
      } else if (fieldName.includes('repair') || fieldName.includes('restock') || fieldName.includes('fuel') || fieldName.includes('cost') || fieldName.includes('uec')) {
        errorsByCategory['Financial Information'].push(error.message);
      } else {
        errorsByCategory['Other'].push(error.message);
      }
    });
    
    let validationMessage = `Form Validation Issues<br><br><strong>Please fix the following ${allErrors.length} issue${allErrors.length === 1 ? '' : 's'}:</strong><br><br>`;
    
    Object.keys(errorsByCategory).forEach(category => {
      if (errorsByCategory[category].length > 0) {
        validationMessage += `<strong>${category}:</strong><br>`;
        errorsByCategory[category].forEach(error => {
          validationMessage += `‚Ä¢ ${error}<br>`;
        });
        validationMessage += '<br>';
      }
    });
    
    validationMessage += '<small style="opacity: 0.8;">Fields with issues are highlighted in red.</small>';
    
    showNotificationOverlay(validationMessage, 'warning');
    return false;
  }
  
  return true;
}

    function copyDiscordOutput() {
      const discordOutput = document.getElementById("discordOutput");
      discordOutput.select();
      discordOutput.setSelectionRange(0, 99999);
      document.execCommand("copy");
      showNotificationOverlay("Discord post copied to clipboard!", 'success');
    }

    function toggleDiscordOutput() {
      const container = document.getElementById("discordOutputContainer");
      const icon = document.getElementById("toggleOutputIcon");
      const text = document.getElementById("toggleOutputText");
      
      if (container.style.display === "none") {
        container.style.display = "block";
        icon.textContent = "‚ñº";
        text.textContent = "Hide Generated Output";
      } else {
        container.style.display = "none";
        icon.textContent = "‚ñ∂";
        text.textContent = "Show Generated Output";
      }
    }

    function showCopyButton() {
      const copyBtn = document.getElementById("copyDiscordBtn");
      if (copyBtn) {
        copyBtn.style.display = "inline-flex";
      }
    }

    function hideCopyButton() {
      const copyBtn = document.getElementById("copyDiscordBtn");
      if (copyBtn) {
        copyBtn.style.display = "none";
      }
    }

    function showGenerateButtonOnChange() {
      const generateBtn = document.getElementById("generateBtn");
      if (generateBtn && generateBtn.style.display === "none") {
        generateBtn.style.display = "inline-flex";
      }
    }

    function updateOrderDuration() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      const durationDiv = document.getElementById("orderDuration");
      if (!dep || !comp) {
        durationDiv.textContent = "";
        return;
      }
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) {
        durationDiv.textContent = "";
        return;
      }
      let diffMs = compDate - depDate;
      if (diffMs < 0) {
        durationDiv.textContent = "Completion time is before departure!";
        durationDiv.style.color = "#ed4245";
        return;
      }
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      durationDiv.textContent = `Order Duration: ${hours}h ${mins}m`;
      durationDiv.style.color = "#9d7523";
    }

    // Set current time function
    function setCurrentTime(fieldId) {
      try {
        const now = new Date();
        // Format for datetime-local input (YYYY-MM-DDTHH:MM)
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        const timeString = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        const field = document.getElementById(fieldId);
        if (field) {
          field.value = timeString;
          field.classList.remove('error');
          updateOrderDuration();
          
          console.log(`‚úì Time set for ${fieldId}: ${timeString}`);
        } else {
          throw new Error(`Field with ID '${fieldId}' not found`);
        }
      } catch (error) {
        console.error('Error setting current time:', error);
        handleError('Failed to set current time', error, { fieldId });
      }
    }

    window.setCurrentTime = setCurrentTime;

    function handleError(message, error = null, context = {}) {
      const errorInfo = {
        message,
        error: error ? {
          name: error.name,
          message: error.message,
          stack: error.stack
        } : null,
        context,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href
      };
      
      console.error('Enhanced Error Log:', errorInfo);
      
      let userMessage = message;
      let suggestions = [];
      
      if (error) {
        switch (error.name) {
          case 'TypeError':
            if (error.message.includes('null') || error.message.includes('undefined')) {
              userMessage = 'A required field or element was not found.';
              suggestions.push('Please refresh the page and try again.');
              suggestions.push('Ensure all required fields are properly filled.');
            }
            break;
          case 'ReferenceError':
            userMessage = 'A programming error occurred.';
            suggestions.push('Please refresh the page.');
            suggestions.push('If the problem persists, contact support.');
            break;
          case 'NetworkError':
          case 'Failed to fetch':
            userMessage = 'Network connection error.';
            suggestions.push('Check your internet connection.');
            suggestions.push('Try again in a few moments.');
            break;
        }
      }
      
      if (message.includes('timestamp') || message.includes('time')) {
        suggestions.push('Ensure your system clock is set correctly.');
        suggestions.push('Try clicking the "Now" button instead of manual entry.');
      }
      
      if (message.includes('validation') || message.includes('required')) {
        suggestions.push('Check that all required fields are filled.');
        suggestions.push('Look for fields highlighted in red.');
      }
      
      const fullMessage = suggestions.length > 0 
        ? `${userMessage}<br><br><strong>Suggestions:</strong><br>‚Ä¢ ${suggestions.join('<br>‚Ä¢ ')}`
        : userMessage;
      
      showNotificationOverlay(fullMessage, 'error');
      
      const recentErrors = JSON.parse(localStorage.getItem('bruteHaulErrors') || '[]');
      recentErrors.push(errorInfo);
      
      if (recentErrors.length > 20) {
        recentErrors.splice(0, recentErrors.length - 20);
      }
      
      localStorage.setItem('bruteHaulErrors', JSON.stringify(recentErrors));
    }


    function validateTimestamps() {
      const departureField = document.getElementById('departureTime');
      const completionField = document.getElementById('completionTime');
      
      if (!departureField.value || !completionField.value) {
        return false;
      }
      
      try {
        const depDate = new Date(departureField.value);
        const compDate = new Date(completionField.value);
        
        if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) {
          handleError('Invalid timestamp format detected', null, { 
            departure: departureField.value, 
            completion: completionField.value 
          });
          return false;
        }
        
        if (compDate <= depDate) {
          const timeDiff = Math.abs(compDate - depDate) / (1000 * 60); // minutes
          handleError(
            `Completion time must be after departure time.<br><br>Current difference: ${Math.round(timeDiff)} minutes backwards.`, 
            null, 
            { departure: departureField.value, completion: completionField.value }
          );
          completionField.classList.add('error');
          return false;
        }
        
        const now = new Date();
        const oneYearFromNow = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000));
        
        if (depDate > oneYearFromNow || compDate > oneYearFromNow) {
          handleError('Timestamps appear to be set too far in the future. Please verify the dates.', null, {
            departure: departureField.value,
            completion: completionField.value
          });
          return false;
        }
        
        return true;
      } catch (error) {
        handleError('Error validating timestamps', error, {
          departure: departureField.value,
          completion: completionField.value
        });
        return false;
      }
    }

    function validateTimestampsDetailed() {
      const errors = [];
      const departureField = document.getElementById('departureTime');
      const completionField = document.getElementById('completionTime');
      
      if (!departureField.value || !completionField.value) {
        return errors;
      }
      
      try {
        const depDate = new Date(departureField.value);
        const compDate = new Date(completionField.value);
        
        if (isNaN(depDate.getTime())) {
          departureField.classList.add('error');
          errors.push({
            element: departureField,
            message: 'Departure timestamp has invalid format',
            fieldName: 'Departure Time'
          });
        }
        
        if (isNaN(compDate.getTime())) {
          completionField.classList.add('error');
          errors.push({
            element: completionField,
            message: 'Completion timestamp has invalid format',
            fieldName: 'Completion Time'
          });
        }
        
        if (!isNaN(depDate.getTime()) && !isNaN(compDate.getTime())) {
          if (compDate <= depDate) {
            const timeDiff = Math.abs(compDate - depDate) / (1000 * 60); // minutes
            completionField.classList.add('error');
            errors.push({
              element: completionField,
              message: `Completion time must be after departure time (currently ${Math.round(timeDiff)} minutes before departure)`,
              fieldName: 'Completion Time'
            });
          }
          
          const now = new Date();
          const oneYearFromNow = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000));
          
          if (depDate > oneYearFromNow) {
            departureField.classList.add('error');
            errors.push({
              element: departureField,
              message: 'Departure time appears to be set too far in the future',
              fieldName: 'Departure Time'
            });
          }
          
          if (compDate > oneYearFromNow) {
            completionField.classList.add('error');
            errors.push({
              element: completionField,
              message: 'Completion time appears to be set too far in the future',
              fieldName: 'Completion Time'
            });
          }
        }
        
        return errors;
      } catch (error) {
        console.error('Error validating timestamps:', error);
        errors.push({
          element: null,
          message: 'Error occurred while validating timestamps',
          fieldName: 'Timestamps'
        });
        return errors;
      }
    }

    function getOrderDurationText() {
      const dep = document.getElementById("departureTime").value;
      const comp = document.getElementById("completionTime").value;
      if (!dep || !comp) return "";
      const depDate = new Date(dep);
      const compDate = new Date(comp);
      if (isNaN(depDate.getTime()) || isNaN(compDate.getTime())) return "";
      let diffMs = compDate - depDate;
      if (diffMs < 0) return "";
      const diffMins = Math.floor(diffMs / 60000);
      const hours = Math.floor(diffMins / 60);
      const mins = diffMins % 60;
      return `Order Duration: ${hours}h ${mins}m`;
    }

    function generateOutput() {
  if (!validateRequiredFields()) return;

  showButtonLoading('generateBtn', 'Generating...');
  showLoadingOverlay('Generating Discord post...');

  setTimeout(() => {
    try {
      const get = id => document.getElementById(id)?.value?.trim() || "";
      const departureDiscord = toDiscordTimestamp(get("departureTime"));
      const completionDiscord = toDiscordTimestamp(get("completionTime"));

  let orderCategoryText = get("orderCategory");
  if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");

  let companyNameText = get("companyName");

  let orderTypeText = get("orderType");
  if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");

  let resourceDriveCompanyText = "";
  if (orderTypeText === "Resource Drive") {
    resourceDriveCompanyText = document.getElementById("resourceDriveCompany").value || "";
  }

  let shipNameText = get("shipName");
  if (shipNameText === "Other") shipNameText = get("shipNameOther");

  let captainNameText = get("captainName");
  if (captainNameText === "Other") captainNameText = get("captainNameOther");

  const shipLink = shipLinks[shipNameText];

  const crewAmount = parseInt(get("crewAmount"), 10);
  let crewNamesList = [];
  for (let i = 1; i <= crewAmount; i++) {
    const crewInput = document.getElementById(`crewName${i}`);
    if (crewInput && crewInput.value.trim()) {
      crewNamesList.push(crewInput.value.trim());
    }
  }
  let postCounter = parseInt(sessionStorage.getItem('discordHistoryCounter') || '1', 10);
  const crewNamesText = crewNamesList.length > 0 ? crewNamesList.join(", ") : "0";

  const routeStart = get("routeStart");
  const routeEnd = get("routeEnd");
  const routeText = routeStart && routeEnd ? `${routeStart} :arrow_right: ${routeEnd}` : "";

  let manifestLines = [];
  let totalSCU = 0;
  document.querySelectorAll('.manifest-row').forEach(row => {
    const scuValue = row.querySelector('.manifest-scu').value;
    const scu = parseInt(scuValue, 10);
    const mat = row.querySelector('.manifest-material').value;
    const uecValue = row.querySelector('.manifest-uec').value;
    if (!isNaN(scu)) totalSCU += scu;
    manifestLines.push({
      scu: scuValue,
      mat: mat,
      uec: uecValue
    });
  });

  if (totalSCU <= 0) {
    hideLoadingOverlay();
    hideButtonLoading('generateBtn');
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
      generateBtn.innerHTML = 'Generate Post';
    }
    showNotificationOverlay(`Manifest Validation Issue<br><br><strong>Total SCU is 0</strong><br><br>Please add cargo to your manifest before generating the Discord post.`, 'warning');
    showFeedback('warning', 'Cannot generate post: Total SCU is 0. Please add cargo to your manifest.');
    return;
  }

  let manifestTable = "SCU   Material         UEC\n";
  manifestLines.forEach(line => {
    manifestTable += `${line.scu.padEnd(5)} ${line.mat.padEnd(15)} ${line.uec ? line.uec : ""}\n`;
  });

  const totalUECInput = document.getElementById("totalUECBox");
  let totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) : 0;

  let totalLine = `**Total: ${totalSCU.toLocaleString()} SCU`;
  if (totalUEC && !isNaN(totalUEC)) {
    totalLine += ` / ${totalUEC.toLocaleString()} UEC`;
  }
  totalLine += "**";
  const totalSCUText = `**Total: ${totalSCU.toLocaleString()} SCU**`;

  const repairs = parseInt(get("repairs") || "0", 10);
  const restock = parseInt(get("restock") || "0", 10);
  const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
  const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
  const crewCosts = parseInt(get("crewCosts") || "0", 10);
  const totalDeductibles = repairs + restock + quantumFuel + hydrogenFuel + crewCosts;

  const notesText = get("notes") || "None";

  const shipDisplayText = shipLink ? `[${shipNameText}](${shipLink})` : shipNameText;

  // Build Discord output
    let output = `**${orderCategoryText}**
${companyNameText} ${orderTypeText === "Resource Drive" ? "Resource Drive" : orderTypeText}
${resourceDriveCompanyText ? `Resource Drive Company: ${resourceDriveCompanyText}` : ""}

**Ship:** ${shipDisplayText}
**Captain:** ${captainNameText}
**Crew:** ${crewNamesText}

‚Äî‚Äî‚Äî

 **Departure:** ${get("startLocation")}
 **Departure Time:** ${departureDiscord}
 **Route:** ${routeText}

‚Äî‚Äî‚Äî

**Manifest**
\`\`\`
${manifestTable.trim()}
\`\`\`
${totalLine}

‚Äî‚Äî‚Äî

**Sign Off**
Order completion time: ${completionDiscord}
${getOrderDurationText()}

**Deductibles**
- **Repairs:** ${repairs.toLocaleString()} UEC
- **Restock:** ${restock.toLocaleString()} UEC
- **Quantum fuel:** ${quantumFuel.toLocaleString()} UEC
- **Hydrogen fuel:** ${hydrogenFuel.toLocaleString()} UEC
- **Crew/ship costs:** ${crewCosts.toLocaleString()} UEC
**Total Deductibles: ${totalDeductibles.toLocaleString()} UEC**

‚Äî‚Äî‚Äî

**Notes**
\`\`\`
${notesText}
\`\`\`
`;

  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  history.push({ id: postCounter, content: output });
  sessionStorage.setItem('discordHistory', JSON.stringify(history));
  sessionStorage.setItem('discordHistoryCounter', (postCounter + 1).toString());
  renderHistory();

  document.getElementById("discordOutput").value = output;
  document.getElementById("discordSection").style.display = "block";
  
  // Hide the Generate button after successful generation
  const generateBtn = document.getElementById("generateBtn");
  if (generateBtn) {
    generateBtn.style.display = "none";
  }
  
  hideCopyButton();
  
  hideLoadingOverlay();
  hideButtonLoading('generateBtn');
  showFeedback('success', 'Discord post generated successfully!');
  
    } catch (error) {
      console.error('Error generating output:', error);
      hideLoadingOverlay();
      hideButtonLoading('generateBtn');
      showFeedback('error', 'Failed to generate Discord post. Please try again.');
    }
  }, 500);
}

function renderHistory() {
  const historyList = document.getElementById('historyList');
  
  if (historyList) {
    const history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
    
    if (history.length === 0) {
      historyList.innerHTML = `
        <div style="text-align: center; background: #fff; border: 3px solid #9d7523; border-radius: 12px; padding: 30px;">
          <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" 
               alt="BruteHaul Logo" 
               style="max-width: 200px; width: 100%; margin-bottom: 20px; border-radius: 8px;">
          <h2 style="color: #9d7523; margin: 20px 0; font-size: 24px;">Brute Haul Manifest Log</h2>
          <p style="font-size: 18px; color: #781d15; font-weight: bold; margin: 15px 0;">
            No posts generated this session.
          </p>
          <p style="color: #666; margin: 10px 0; font-size: 16px;">
            Complete and submit manifests to see them listed here.
          </p>
        </div>
      `;
    } else {
      let historyHTML = `
        <div style="margin-bottom: 20px; text-align: center;">
          <img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/BRHS-Logo.png" 
               alt="BruteHaul Logo" 
               style="max-width: 150px; border-radius: 8px;">
          <h2 style="color: #9d7523; margin: 15px 0;">Session History (${history.length} posts)</h2>
        </div>
      `;
      
      history.forEach((post, index) => {
        historyHTML += `
          <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="color: #781d15;">Post ${index + 1}</strong>
              <button onclick="deleteHistoryPost(${index})" 
                      style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                Delete
              </button>
            </div>
            <div style="background: white; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">${post.content}</div>
            <small style="color: #666; margin-top: 10px; display: block;">${post.timestamp}</small>
          </div>
        `;
      });
      
      historyList.innerHTML = historyHTML;
    }
  }
}

function deleteHistoryPost(idx) {
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  history.splice(idx, 1);
  sessionStorage.setItem('discordHistory', JSON.stringify(history));
  renderHistory();
}

function copyHistoryPost(idx) {
  let history = JSON.parse(sessionStorage.getItem('discordHistory') || '[]');
  if (history[idx]) {
    const temp = document.createElement('textarea');
    temp.value = history[idx].content; // Use only the discord output string
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    showNotificationOverlay("History post copied to clipboard!", 'success');
  }
}

window.deleteHistoryPost = deleteHistoryPost;
window.copyHistoryPost = copyHistoryPost;

window.sendToDiscord = sendToDiscord;

async function sendToDiscord() {
  const message = document.getElementById("discordOutput").value;
  const orderType = document.getElementById("orderType").value;
  const resourceDriveCompany = document.getElementById("resourceDriveCompany").value;
  const totalSCU = parseInt(document.getElementById("totalSCUBox").textContent.replace(/\D/g, "")) || 0;
  const captainName = document.getElementById("captainName").value;
  let shipName = document.getElementById("shipName").value;
  if (shipName === "Other") {
    shipName = document.getElementById("shipNameOther").value;
  }

  // Warning: No message generated
  if (!message) {
    showNotificationOverlay("Missing Discord Post<br><br><strong>No message to send</strong><br><br>Please generate a Discord post first by clicking the 'Generate Discord Post' button.", 'warning');
    showFeedback('warning', 'No message to send. Please generate a Discord post first.');
    logErrorToGitHub('V004', 'No message generated', 'User attempted to send without generating Discord post first', null, {
      validationStep: 'Message check',
      formCompleted: false
    });
    return;
  }

  // Warning: Required fields missing
  if (!orderType || !captainName) {
    showNotificationOverlay("Required Information Missing<br><br><strong>Order Type and Captain Name are required</strong><br><br>Please fill in these fields to send to Discord.", 'warning');
    showFeedback('warning', 'Order Type and Captain Name are required to send to Discord.');
    logErrorToGitHub('V005', 'Required fields missing', `Missing fields - Order Type: ${orderType ? 'Present' : 'Missing'}, Captain Name: ${captainName ? 'Present' : 'Missing'}`, null, {
      validationStep: 'Required fields check',
      missingFields: [
        !orderType ? 'Order Type' : null,
        !captainName ? 'Captain Name' : null
      ].filter(Boolean)
    });
    return;
  }

  const sendBtn = Array.from(document.querySelectorAll("button"))
    .find(btn => btn.textContent.includes("Send to Discord"));
  
  if (sendBtn) {
    sendBtn.classList.add('button-loading');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<div class="loading-spinner"></div>Sending to Discord...';
  }
  
  showLoadingOverlay('Sending to Brute Haul Discord...');

 
  const endpoints = [
    // Railway production endpoint
    "https://brutehaulrailway-production.up.railway.app/send-discord"
  ];

  try {
    // Collect all additional fields for Google Sheets
    const get = id => document.getElementById(id)?.value?.trim() || "";
    
    let orderCategoryText = get("orderCategory");
    if (orderCategoryText === "Other") orderCategoryText = get("orderCategoryOther");
    
    let companyNameText = get("companyName");
    
    let orderTypeText = get("orderType");
    if (orderTypeText === "Other") orderTypeText = get("orderTypeOther");
    
    let captainNameText = get("captainName");
    if (captainNameText === "Other") captainNameText = get("captainNameOther");
    
    const crewAmount = parseInt(get("crewAmount"), 10);
    let crewNamesList = [];
    for (let i = 1; i <= crewAmount; i++) {
      const crewInput = document.getElementById(`crewName${i}`);
      if (crewInput && crewInput.value.trim()) {
        crewNamesList.push(crewInput.value.trim());
      }
    }
    const crewAmountWithNames = crewAmount > 0 ? `${crewAmount} (${crewNamesList.join(", ")})` : "0";
    
    const totalUECInput = document.getElementById("totalUECBox");
    const totalUEC = totalUECInput && totalUECInput.value ? parseInt(totalUECInput.value.replace(/\D/g, "")) || 0 : 0;
    
    const repairs = parseInt(get("repairs") || "0", 10);
    const restock = parseInt(get("restock") || "0", 10);
    const quantumFuel = parseInt(get("quantumFuel") || "0", 10);
    const hydrogenFuel = parseInt(get("hydrogenFuel") || "0", 10);
    const crewCosts = parseInt(get("crewCosts") || "0", 10);
    
    let response;
    let successfulEndpoint = null;
    let lastError = null;
    
    for (const endpoint of endpoints) {
      try {
        console.log(`Trying endpoint: ${endpoint}`);
        response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message,
            date: new Date().toISOString().split('T')[0], // Current date
            orderCategory: orderCategoryText,
            companyName: companyNameText,
            orderType: orderTypeText,
            shipName: shipName,
            captainName: captainNameText,
            crewAmount: crewAmountWithNames,
            startLocation: get("startLocation"),
            departureTimestamp: get("departureTime"),
            routeStart: get("routeStart"),
            routeEnd: get("routeEnd"),
            totalSCU: totalSCU,
            totalUEC: totalUEC,
            orderCompletionTimestamp: get("completionTime"),
            orderTime: getOrderDurationText(),
            repairs: repairs,
            restock: restock,
            quantumFuel: quantumFuel,
            hydrogenFuel: hydrogenFuel,
            crewShipCosts: crewCosts,
            notes: get("notes"),
            resourceDriveCompany,
            shipNames: typeof allShips !== "undefined" ? allShips : []
          })
        });
        
        if (response.ok) {
          successfulEndpoint = endpoint;
          console.log(`Success with endpoint: ${endpoint}`);
          break;
        } else {
          lastError = `HTTP ${response.status}: ${response.statusText}`;
          console.log(`HTTP error with ${endpoint}: ${lastError}`);
        }
      } catch (error) {
        lastError = error.message;
        console.log(`Network error with ${endpoint}:`, error.message);
        continue;
      }
    }
    
    if (!response || !response.ok) {
      throw new Error(lastError || "Railway server connection failed - please check server status");
    }

    let data;
    try {
      data = await response.json();
    } catch {
      hideLoadingOverlay();
      showNotificationOverlay("Server Restarting<br><br>The Brute Haul System is currently restarting.<br><br><strong>Error E005:</strong> Please try again in 30 seconds.", 'warning');
      showFeedback('warning', 'Server restarting (E005) - Please try again shortly');
      showCopyButton(); // Show copy button when Discord posting fails
      
      // Log server restart error to GitHub Issues
      logErrorToGitHub('E005', 'Server restarting', 'JSON parsing failed - server likely restarting', null, {
        responseStatus: response?.status || 'Unknown',
        responseOk: response?.ok || false,
        endpoint: successfulEndpoint || 'Unknown endpoint',
        parsingError: true,
        serverState: 'Restarting'
      });
      
      if (sendBtn) {
        sendBtn.classList.remove('button-loading');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />Send to Discord';
      }
      return;
    }

    if (response.ok) {
      hideLoadingOverlay();
      showLoadingMessage("‚úÖ Successfully sent to Brute Haul Discord!<br><br>Your manifest has been posted and logged.", 2000);
      showFeedback('success', 'Successfully sent to Brute Haul');
      document.getElementById("discordSection").style.display = "none";
      clearFormFields();
    } else {
      hideLoadingOverlay();
      let errorCode = response.status || 'UNKNOWN';
      let errorMsg = data?.error || 'Unknown server error';
      let instructions = 'Please try again later. Bug Report Submitted';
      
      switch (response.status) {
        case 400:
          errorCode = 'E400';
          errorMsg = 'Invalid request data';
          instructions = 'Please check all form fields are filled correctly and try again.';
          break;
        case 401:
          errorCode = 'E401';
          errorMsg = 'Authentication required';
          instructions = 'Server access denied. Please refresh the page and try again.';
          break;
        case 403:
          errorCode = 'E403';
          errorMsg = 'Access forbidden';
          instructions = 'Server rejected the request.';
          break;
        case 404:
          errorCode = 'E404';
          errorMsg = 'Service not found';
          instructions = 'The Brute Haul service endpoint is not available.';
          break;
        case 429:
          errorCode = 'E429';
          errorMsg = 'Too many requests';
          instructions = 'You are sending requests too quickly. Please wait 1 minute and try again.';
          break;
        case 500:
          errorCode = 'E500';
          errorMsg = 'Internal server error';
          instructions = 'The Brute Haul server encountered an error. Please try again in a few minutes.';
          break;
        case 502:
          errorCode = 'E502';
          errorMsg = 'Bad gateway';
          instructions = 'Server gateway error. The service may be restarting - try again shortly.';
          break;
        case 503:
          errorCode = 'E503';
          errorMsg = 'Service unavailable';
          instructions = 'The Brute Haul server is temporarily unavailable. Please try again later.';
          break;
        case 504:
          errorCode = 'E504';
          errorMsg = 'Gateway timeout';
          instructions = 'Server took too long to respond. Please try again.';
          break;
        default:
          if (data?.error?.includes('Discord')) {
            if (data.error.includes('webhook')) {
              errorCode = 'D001';
              errorMsg = 'Discord webhook error';
              instructions = 'Discord connection failed.';
            } else if (data.error.includes('rate limit')) {
              errorCode = 'D002';
              errorMsg = 'Discord rate limited';
              instructions = 'Discord is rate limiting requests. Please wait 5 minutes and try again.';
            } else if (data.error.includes('message')) {
              errorCode = 'D003';
              errorMsg = 'Discord message error';
              instructions = 'Your message format was rejected by Discord.';
            }
          } else if (data?.error?.includes('Google') || data?.error?.includes('Sheets')) {
            if (data.error.includes('credentials') || data.error.includes('authentication')) {
              errorCode = 'G001';
              errorMsg = 'Google Sheets credentials error';
              instructions = 'Server configuration issue.';
            } else if (data.error.includes('permission') || data.error.includes('access')) {
              errorCode = 'G003';
              errorMsg = 'Google Sheets permission denied';
              instructions = 'Server lacks permission to write data.';
            } else if (data.error.includes('quota') || data.error.includes('limit')) {
              errorCode = 'G004';
              errorMsg = 'Google Sheets quota exceeded';
              instructions = 'Google Sheets API limit reached. Please try again in an hour.';
            } else {
              errorCode = 'G002';
              errorMsg = 'Google Sheets connection failed';
              instructions = 'Unable to save to spreadsheet. Your Discord post was sent but data logging failed.';
            }
          } else if (data?.error?.includes('bot') || data?.error?.includes('token')) {
            if (data.error.includes('token') || data.error.includes('authentication')) {
              errorCode = 'B001';
              errorMsg = 'Discord bot authentication failed';
              instructions = 'Server configuration issue.';
            } else if (data.error.includes('offline') || data.error.includes('disconnected')) {
              errorCode = 'B002';
              errorMsg = 'Discord bot offline';
              instructions = 'The Discord bot is currently offline.';
            } else if (data.error.includes('channel') || data.error.includes('not found')) {
              errorCode = 'B003';
              errorMsg = 'Discord channel not found';
              instructions = 'Server cannot find the Discord channel.';
            } else if (data.error.includes('permission') || data.error.includes('access')) {
              errorCode = 'B004';
              errorMsg = 'Discord bot lacks permissions';
              instructions = 'Bot cannot post to channel.';
            }
          } else if (data?.error?.includes('validation') || data?.error?.includes('invalid')) {
            if (data.error.includes('manifest') || data.error.includes('format')) {
              errorCode = 'V001';
              errorMsg = 'Invalid manifest data format';
              instructions = 'Your form data format is invalid. Please refresh the page and try again.';
            } else if (data.error.includes('required') || data.error.includes('missing')) {
              errorCode = 'V002';
              errorMsg = 'Server validation failed';
              instructions = 'Server rejected your data. Please check all required fields and try again.';
            } else if (data.error.includes('parse') || data.error.includes('JSON')) {
              errorCode = 'V003';
              errorMsg = 'Data parsing error';
              instructions = 'Server cannot read your form data. Please refresh the page and try again.';
            }
          }
          break;
      }
      
      showNotificationOverlay(`‚ùå Failed to send to Discord<br><br><strong>Error ${errorCode}:</strong> ${errorMsg}<br><br>${instructions}`, 'error');
      showFeedback('error', `Error sending to Brute Haul (${errorCode}): ${errorMsg}`);
      showCopyButton(); // Show copy button when Discord posting fails
      
      // Log server errors to GitHub Issues
      logErrorToGitHub(errorCode, errorMsg, `HTTP ${response.status}: ${data?.error || 'Unknown server error'}`, null, {
        httpStatus: response.status,
        httpStatusText: response.statusText,
        serverResponse: data,
        endpoint: successfulEndpoint || 'No successful endpoint',
        attemptedEndpoints: endpoints.length,
        requestPayload: {
          messageLength: message?.length || 0,
          orderType: orderType,
          captainName: captainName ? 'Present' : 'Missing',
          shipName: shipName ? 'Present' : 'Missing',
          totalSCU: totalSCU
        }
      });
      
      setTimeout(showErrorReportLink, 1000);
    }
  } catch (err) {
    hideLoadingOverlay();
    console.error('Send to Discord error:', err);
    
    let errorCode = 'E701';
    let errorMsg = 'Connection failed';
    let instructions = 'Please try again later or contact DyslexicNerd01';
    
    if (err.message.includes('Railway server connection failed')) {
      errorCode = 'R001';
      errorMsg = 'Railway server connection failed';
      instructions = 'The Brute Haul server may be restarting. Please try again in a few moments.';
    } else if (err.message.includes('fetch') || err.message.includes('Network')) {
      errorCode = 'E703';
      errorMsg = 'Network connection error';
      instructions = 'Check your internet connection and try again.';
    } else if (err.message.includes('CORS')) {
      errorCode = 'E704';
      errorMsg = 'Cross-origin request blocked';
      instructions = 'Browser security blocked the request. Try refreshing the page.';
    } else if (err.message.includes('timeout') || err.message.includes('aborted')) {
      errorCode = 'E408';
      errorMsg = 'Request timeout';
      instructions = 'The server took too long to respond. Please try again.';
    } else if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
      errorCode = 'E702';
      errorMsg = 'Network request blocked';
      instructions = 'Check your firewall/antivirus settings or try a different network.';
    } else if (err.message.includes('SSL') || err.message.includes('certificate')) {
      errorCode = 'S001';
      errorMsg = 'SSL/Certificate error';
      instructions = 'Server SSL certificate issue. Try using HTTP or contact DyslexicNerd01.';
    } else if (err.message.includes('abort') || err.message.includes('cancelled')) {
      errorCode = 'C001';
      errorMsg = 'Request cancelled';
      instructions = 'The request was cancelled. Please try again.';
    } else if (err.message.includes('quota') || err.message.includes('usage limit')) {
      errorCode = 'Q001';
      errorMsg = 'API quota exceeded';
      instructions = 'Service usage limit reached. Please try again in an hour.';
    } else if (err.message.includes('maintenance') || err.message.includes('scheduled')) {
      errorCode = 'M001';
      errorMsg = 'Scheduled maintenance';
      instructions = 'System is under maintenance. Please check Discord for updates.';
    } else if (err.message.includes('memory') || err.message.includes('resource')) {
      errorCode = 'R002';
      errorMsg = 'Server resource limit';
      instructions = 'Server is under high load. Please try again in a few minutes.';
    }
    
    showNotificationOverlay(`‚ùå Connection Failed<br><br><strong>Error ${errorCode}:</strong> ${errorMsg}<br><br>${instructions}`, 'error');
    showFeedback('error', `The Brute Haul System is currently offline (${errorCode}). Please try again later.`);
    showCopyButton(); // Show copy button when Discord posting fails
    
    // Log error to GitHub Issues for developer visibility with enhanced context
    logErrorToGitHub(errorCode, errorMsg, err.message, err.stack, {
      errorType: err.name || 'Unknown',
      networkError: true,
      endpointsAttempted: endpoints,
      lastEndpointTried: endpoints[endpoints.length - 1],
      connectionDetails: {
        online: navigator.onLine,
        effectiveType: navigator.connection?.effectiveType || 'Unknown',
        downlink: navigator.connection?.downlink || 'Unknown'
      },
      requestContext: {
        messageLength: message?.length || 0,
        formCompleted: !!(orderType && captainName && message),
        totalSCU: totalSCU,
        hasShipName: !!shipName
      }
    });
    
    setTimeout(showErrorReportLink, 1000);
  } finally {
    if (sendBtn) {
      sendBtn.classList.remove('button-loading');
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<img src="https://github.com/DyslexicNerd01/Brute-Haul-Cargo-Log/raw/main/DiscordLogo.png" alt="Discord Logo" style="height:1.6em;width:auto;filter:brightness(0) invert(1);" />Send to Discord';
    }
  }
}
function generateAnnouncement() {
  const title = document.getElementById("announcementTitle").value.trim();
  const body = document.getElementById("announcementBody").value.trim();
  if (!title && !body) {
    showNotificationOverlay("Please enter a title or body for the announcement.", 'warning', 3000);
    return;
  }
  const output = `üì¢ **${title || "Announcement"}**\n\n${body}`;
  document.getElementById("announcementOutput").value = output;
}

function copyAnnouncementOutput() {
  const output = document.getElementById("announcementOutput");
  output.select();
  output.setSelectionRange(0, 99999);
  document.execCommand("copy");
  showNotificationOverlay("Announcement copied to clipboard!", 'success');
}

window.generateAnnouncement = generateAnnouncement;
window.copyAnnouncementOutput = copyAnnouncementOutput;

// GitHub Error Logging Function
async function logErrorToGitHub(errorCode, errorMsg, fullError, stackTrace, additionalContext = {}) {
  console.log('üîß logErrorToGitHub called with:', { errorCode, errorMsg });
  
  try {    
    function getGitHubToken() {
      let token = 'ERROR_REPORTER_TOKEN_PLACEHOLDER';
      if (token !== 'ERROR_REPORTER_TOKEN_PLACEHOLDER') {
        return token;
      }
      
      if (localStorage.getItem('simulate_deployed_token')) {
        return localStorage.getItem('simulate_deployed_token');
      }
      
      if (typeof process !== 'undefined' && process.env?.ERROR_REPORTER_TOKEN) {
        return process.env.ERROR_REPORTER_TOKEN;
      }
      
      const storedToken = localStorage.getItem('github_error_token_encrypted');
      if (storedToken) {
        try {
          return atob(storedToken.split('').reverse().join(''));
        } catch (e) {
          console.warn('Failed to decode stored token');
        }
      }
      
      if (confirm('GitHub error logging is not configured. Would you like to set it up now? (This will enable automatic error reporting)')) {
        const userToken = prompt('Enter your GitHub Personal Access Token (this will be stored locally and encrypted):');
        if (userToken && userToken.startsWith('ghp_')) {
          const encrypted = btoa(userToken).split('').reverse().join('');
          localStorage.setItem('github_error_token_encrypted', encrypted);
          return userToken;
        }
      }
      
      return null;
    }
    
    const GITHUB_TOKEN = getGitHubToken();
    const GITHUB_REPO = 'DyslexicNerd01/Brute-Haul-Cargo-Log';
    
    console.log('üîß GitHub token status:', GITHUB_TOKEN ? 'Found' : 'Not found');
    
    if (!GITHUB_TOKEN) {
      console.log('üîß GitHub error logging not configured - add your GitHub Personal Access Token to enable automatic error reporting');
      return;
    }
    
    console.log('üîß Proceeding with GitHub issue creation...');
    
    // Collect comprehensive error context
    const errorContext = {
      timestamp: new Date().toISOString(),
      errorCode: errorCode,
      errorMessage: errorMsg,
      fullError: fullError,
      stackTrace: stackTrace,
      userAgent: navigator.userAgent,
      pageUrl: window.location.href,
      viewport: `${window.innerWidth}x${window.innerHeight}`,
      language: navigator.language,
      platform: navigator.platform,
      cookiesEnabled: navigator.cookieEnabled,
      onlineStatus: navigator.onLine,
      referrer: document.referrer || 'Direct access',
      ...additionalContext
    };
    
    try {
      const formData = {
        orderType: document.getElementById("orderType")?.value || 'Not set',
        captainName: document.getElementById("captainName")?.value || 'Not set',
        shipName: document.getElementById("shipName")?.value || 'Not set',
        companyName: document.getElementById("companyName")?.value || 'Not set',
        totalSCU: document.getElementById("totalSCUBox")?.textContent || '0',
        messageLength: document.getElementById("discordOutput")?.value?.length || 0
      };
      errorContext.formData = formData;
    } catch (formError) {
      errorContext.formDataError = 'Could not collect form data';
    }
    
    // Create detailed GitHub issue
    const issueData = {
      title: `üö® Brute Haul Bot Send Failure - ${errorCode}: ${errorMsg}`,
      body: `## üö® Automatic Error Report Generation

**Error Code:** \`${errorCode}\`  
**Error Message:** ${errorMsg}  
**Timestamp:** ${errorContext.timestamp}  
**Status:** üî¥ Needs Investigation

---

## üìä Error Details

| Field | Value |
|-------|-------|
| **Error Code** | \`${errorCode}\` |
| **Error Message** | ${errorMsg} |
| **Page URL** | ${errorContext.pageUrl} |
| **User Agent** | ${errorContext.userAgent} |
| **Viewport** | ${errorContext.viewport} |
| **Language** | ${errorContext.language} |
| **Platform** | ${errorContext.platform} |
| **Online Status** | ${errorContext.onlineStatus ? '‚úÖ Online' : '‚ùå Offline'} |
| **Cookies Enabled** | ${errorContext.cookiesEnabled ? '‚úÖ Yes' : '‚ùå No'} |
| **Referrer** | ${errorContext.referrer} |

---

## üîç Technical Details

### Full Error Message
\`\`\`
${fullError || 'No additional error details'}
\`\`\`

### Stack Trace
\`\`\`
${stackTrace || 'No stack trace available'}
\`\`\`

---

## üìù Form Data Context

${errorContext.formData ? `
| Field | Value |
|-------|-------|
| **Order Type** | ${errorContext.formData.orderType} |
| **Captain Name** | ${errorContext.formData.captainName} |
| **Ship Name** | ${errorContext.formData.shipName} |
| **Company Name** | ${errorContext.formData.companyName} |
| **Total SCU** | ${errorContext.formData.totalSCU} |
| **Message Length** | ${errorContext.formData.messageLength} characters |
` : `Form data unavailable: ${errorContext.formDataError || 'Unknown reason'}`}

---

## üéØ User Impact

A user attempted to send a cargo manifest to Discord but encountered this error. The error was displayed to the user with appropriate instructions for resolution.

**User Experience:**
- ‚ùå Discord send failed
- ‚úÖ Error message displayed to user
- ‚úÖ Copy button provided as fallback
- ‚úÖ Error logged for developer review

---

## üìä Related Information

**Error Category:** ${errorCode.startsWith('E') ? 'Network/Server Error' : errorCode.startsWith('D') ? 'Discord API Error' : errorCode.startsWith('G') ? 'Google Sheets Error' : errorCode.startsWith('B') ? 'Bot Error' : errorCode.startsWith('V') ? 'Validation Error' : 'Other'}

**Severity:** ${['E500', 'E503', 'E504', 'R001', 'D001', 'B001', 'B002'].includes(errorCode) ? 'üî¥ High' : ['E400', 'E401', 'E403', 'E404', 'D002', 'G001', 'G003'].includes(errorCode) ? 'üü° Medium' : 'üü¢ Low'}

---

*ü§ñ This issue was automatically created by the Brute Haul Cargo Log error reporting system at ${errorContext.timestamp}*`,
      labels: [
        'bug', 
        'discord-failure', 
        'auto-generated',
        `error-${errorCode.toLowerCase()}`,
        errorCode.startsWith('E') ? 'network-error' : 
        errorCode.startsWith('D') ? 'discord-error' : 
        errorCode.startsWith('G') ? 'sheets-error' : 
        errorCode.startsWith('B') ? 'bot-error' : 
        errorCode.startsWith('V') ? 'validation-error' : 'other-error'
      ]
    };
    
    console.log('Attempting to create GitHub issue for error:', errorCode);
    
    const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues`, {
      method: 'POST',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json',
        'User-Agent': 'Brute-Haul-Error-Reporter/1.0'
      },
      body: JSON.stringify(issueData)
    });
    
    if (response.ok) {
      const issueResult = await response.json();
      console.log(`‚úÖ Error logged to GitHub Issues successfully: #${issueResult.number}`);
      console.log(`üìã Issue URL: ${issueResult.html_url}`);
      
      sessionStorage.setItem('lastErrorIssue', issueResult.html_url);
    } else {
      const errorText = await response.text();
      console.error('‚ùå Failed to log error to GitHub:', response.status, response.statusText, errorText);
    }
  } catch (logError) {
    console.error('‚ùå GitHub error logging failed:', logError);
  }
}

function showErrorReportLink() {
  const lastErrorIssue = sessionStorage.getItem('lastErrorIssue');
  if (lastErrorIssue) {
    const linkElement = document.createElement('div');
    linkElement.innerHTML = `
      <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px;">
        üìã <a href="${lastErrorIssue}" target="_blank" style="color: #781d15;">View error report</a> 
        (Developer has been notified)
      </div>
    `;
    
    const errorFeedback = document.getElementById('errorFeedback');
    if (errorFeedback && errorFeedback.style.display !== 'none') {
      errorFeedback.appendChild(linkElement);
    }
  }
}
window.copyAnnouncementOutput = copyAnnouncementOutput;

window.setupGitHubErrorReporting = function() {
  const token = prompt('Enter your GitHub Personal Access Token for error reporting:');
  if (token && token.startsWith('ghp_')) {
    localStorage.setItem('simulate_deployed_token', token);
    console.log('‚úÖ GitHub token stored (simulating deployed environment)');
    
    fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.login) {
        console.log(`‚úÖ Token validated for user: ${data.login}`);
        alert(`GitHub token setup successful!\nUser: ${data.login}\nError reporting is now active.\n\nNote: This simulates the deployed environment.`);
      } else {
        console.error('‚ùå Token validation failed:', data);
        alert('Token validation failed. Please check your token.');
      }
    })
    .catch(err => {
      console.error('‚ùå Token test failed:', err);
      alert('Token test failed. Please check your internet connection.');
    });
  } else {
    alert('Invalid token. GitHub tokens start with "ghp_"');
  }
};

window.testGitHubErrorReporting = function() {
  console.log('üß™ Testing GitHub error reporting...');
  logErrorToGitHub('TEST001', 'Manual test error', 'This is a test error to verify GitHub Issues integration', null, {
    testType: 'Manual test',
    timestamp: new Date().toISOString(),
    testUser: 'FrontEndConsole'
  });
};

window.checkGitHubTokenStatus = function() {
  const storedToken = localStorage.getItem('github_error_token_encrypted');
  if (storedToken) {
    try {
      const decrypted = atob(storedToken.split('').reverse().join(''));
      if (decrypted.startsWith('ghp_')) {
        console.log('‚úÖ GitHub token found in localStorage');
        console.log('‚úÖ Token format appears valid');
        return true;
      } else {
        console.log('‚ùå Token format invalid');
        return false;
      }
    } catch (e) {
      console.log('‚ùå Failed to decode stored token');
      return false;
    }
  } else {
    console.log('‚ùå No GitHub token found in localStorage');
    return false;
  }
};

    window.addEventListener('error', function(event) {
      handleError('Uncaught JavaScript error occurred', event.error, {
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        message: event.message
      });
    });

    window.addEventListener('unhandledrejection', function(event) {
      handleError('Unhandled promise rejection', event.reason, {
        promise: event.promise
      });
      event.preventDefault();
    });

  </script>
</div>